<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì„¤ì • - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
        }

        /* --- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ë°” --- */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--primary-color); font-weight: bold; }

        /* --- ë©”ì¸ ì»¨í…ì¸  --- */
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0; color: #2c3e50; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; }
        .form-group label small { font-weight: normal; color: #888; margin-left: 5px; }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }
        /* ë†’ì´ ì¡°ì • */
        .form-textarea { min-height: 150px; resize: vertical; line-height: 1.6; }
        
        /* ì½ê¸° ì „ìš© ìŠ¤íƒ€ì¼ */
        .readonly-field {
            background-color: #f9f9f9;
            color: #555;
            cursor: default;
        }

        .btn-link {
            background: none; border: none; color: var(--primary-color); 
            font-size: 0.9rem; cursor: pointer; text-decoration: underline; padding: 0;
        }

        .btn-save {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        .btn-save:hover { background-color: #357abd; }

        @media (max-width: 600px) {
            .navbar { flex-direction: column; align-items: stretch; gap: 10px; }
            .container { margin: 15px; padding: 15px; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item active"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item" data-target="plot.html"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="write_scene.html"><i class="fas fa-layer-group"></i> ì¥ë©´ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
        <a href="#" class="nav-item" data-target="plan.html"><i class="fas fa-magic"></i> ê¸°íš</a>
        <a href="#" class="nav-item" data-target="roadmap.html"><i class="fas fa-magic"></i> ë¡œë“œë§µ</a>
        <a href="#" class="nav-item" data-target="treatment.html"><i class="fas fa-magic"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</a>
    </div>
</nav>

<div class="container">
    <h2><i class="fas fa-cog"></i> ì‘í’ˆ ê¸°ë³¸ ì„¤ì •</h2>
    
    <div class="form-group">
        <label>ì†Œì„¤ ì œëª©</label>
        <input type="text" id="title" class="form-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div class="form-group">
        <label>
            ì‘í’ˆ ì¤„ê±°ë¦¬ (í”Œë¡¯ ì „ì²´ ìš”ì•½) 
        </label>
        <textarea id="plotDetails" class="form-textarea" placeholder="í”Œë¡¯ íƒ­ì—ì„œ íšŒì°¨ë¥¼ ë“±ë¡í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
    </div>

    <div class="form-group">
        <label>ë“±ì¥ì¸ë¬¼ ì„¤ì • (Character Details)</label>
        <textarea id="characterDetails" class="form-textarea" placeholder="ì£¼ìš” ë“±ì¥ì¸ë¬¼ì˜ ì´ë¦„, ì„±ê²©, ê´€ê³„ ë“±ì„ ììœ ë¡­ê²Œ ì„œìˆ í•˜ì„¸ìš”."></textarea>
    </div>

    <div class="form-group">
        <label>ë©”ëª¨ / ê¸°íƒ€ ì„¤ì • (World Setting)</label>
        <textarea id="worldSetting" class="form-textarea" style="height: 100px;" placeholder="ì¥ë¥´, íƒ€ê²Ÿ ë…ìì¸µ ë“± ê¸°ì–µí•´ì•¼ í•  ë©”ëª¨ë¥¼ ì ì–´ë‘ì„¸ìš”."></textarea>
    </div>

    <button class="btn-save" onclick="saveSettings()">
        <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
    </button>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        loadData();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadData() {
        try {
            // ğŸŒŸ [ìˆ˜ì •ë¨] ì„¤ì •(settings)ê³¼ ì—í”¼ì†Œë“œ(episodes) ë™ì‹œ í˜¸ì¶œ
            const [settingsRes, episodesRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`),
                fetch(`/api/episodes?setting_id=${settingId}`) // ì—í”¼ì†Œë“œ ë¦¬ìŠ¤íŠ¸ í˜¸ì¶œ
            ]);

            if (!settingsRes.ok) throw new Error("ì„¤ì • ë¡œë“œ ì‹¤íŒ¨");
            
            const settings = await settingsRes.json();
            
            // 1. ê¸°ë³¸ ì„¤ì • ë°”ì¸ë”©
            document.getElementById('title').value = settings.title || '';
            document.getElementById('characterDetails').value = settings.characterDetails || '';
            document.getElementById('worldSetting').value = settings.worldSetting || '';

            // 2. ğŸŒŸ ì—í”¼ì†Œë“œ ëª©ë¡ì„ 'ì¤„ê±°ë¦¬' ì¹¸ì— í‘œì‹œ
            if (episodesRes.ok) {
                const episodes = await episodesRes.json();
                
                if (episodes.length === 0) {
                    document.getElementById('plotDetails').value = "(ì•„ì§ ë“±ë¡ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤. 'í”Œë¡¯' íƒ­ì—ì„œ ì—í”¼ì†Œë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.)";
                } else {
                    // íšŒì°¨ ìˆœì„œ ì •ë ¬
                    episodes.sort((a, b) => a.episode_number - b.episode_number);
                    
                    // í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ì˜ˆ: 1í™”. ì œëª© - ë‚´ìš©ìš”ì•½)
                    const plotSummary = episodes.map(ep => {
                        const contentSnippet = ep.content ? ep.content : 'ë‚´ìš© ì—†ìŒ';
                        return `[ì œ ${ep.episode_number}í™”] ${ep.title}\n - ${contentSnippet}`;
                    }).join('\n\n');
                    
                    document.getElementById('plotDetails').value = plotSummary;
                }
            } else {
                document.getElementById('plotDetails').value = "í”Œë¡¯ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            }

            // ê¸°ì¡´ ë°ì´í„° ë³´ì¡´ìš©
            window.currentData = settings; 

        } catch (e) {
            console.error(e);
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ë°ì´í„° ì €ì¥í•˜ê¸°
    async function saveSettings() {
        const title = document.getElementById('title').value;
        const plotDetails = document.getElementById('plotDetails').value;
        const worldSetting = document.getElementById('worldSetting').value;
        const characterDetails = document.getElementById('characterDetails').value;
        
        // ğŸŒŸ [ì£¼ì˜] plotDetailsëŠ” episodes í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¨ ì½ê¸° ì „ìš©ì´ë¯€ë¡œ ì €ì¥ ëŒ€ìƒì—ì„œ ì œì™¸í•˜ê±°ë‚˜,
        // settings í…Œì´ë¸”ì˜ í•´ë‹¹ ì»¬ëŸ¼ì„ ì‚¬ìš©í•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.
        // ë‹¤ë§Œ DB êµ¬ì¡°ìƒ plotDetails ì»¬ëŸ¼ì´ ìˆë‹¤ë©´ í˜„ì¬ ë³´ì—¬ì§€ëŠ” í…ìŠ¤íŠ¸ë¥¼ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” í˜¼ë€ì„ ë§‰ê¸° ìœ„í•´ í™”ë©´ì˜ plotDetails ê°’ì€ ì €ì¥í•˜ì§€ ì•Šê³ , ê¸°ì¡´ ê°’ì„ ìœ ì§€í•˜ê±°ë‚˜ ë¬´ì‹œí•©ë‹ˆë‹¤.

        if (!title.trim()) {
            alert("ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            return;
        }

        const payload = {
            id: settingId,
            title: title,
            worldSetting: worldSetting,
            characterDetails: characterDetails, 
            
            // plotDetails: ... (ì œì™¸: episodes í…Œì´ë¸”ì´ ì›ë³¸ì´ë¯€ë¡œ)
            plotDetails: plotDetails, // ê¸°ì¡´ ê°’ ìœ ì§€ (ë˜ëŠ” ê³µë°±)

            previousContent: window.currentData?.previousContent || '',
            episode_number: window.currentData?.episode_number || 1,
            roadmaps: window.currentData?.roadmaps || ''
        };

        try {
            const response = await fetch('/api/save-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadData(); // ê°±ì‹ 
            } else {
                const err = await response.json();
                alert("ì €ì¥ ì‹¤íŒ¨: " + err.error);
            }
        } catch (e) {
            console.error(e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    init();
</script>

</body>
</html>