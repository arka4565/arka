<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë“±ì¥ì¸ë¬¼ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter í°íŠ¸ ì‚¬ìš© */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f9;
    }
    .container-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .input-style {
      border: 1px solid #d1d5db;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .input-style:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
      outline: none;
    }
    /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
    /* AI ìƒì„± ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .ai-char-card {
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }
    .ai-char-card:hover {
      background-color: #f0f4ff;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .ai-char-card.selected {
      border-left: 5px solid #4f46e5;
      background-color: #eef2ff;
    } /* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    .nav-link {
      @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out;
    }
  </style>
</head>
!-- ìƒë‹¨ ë©”ë‰´ ì¶”ê°€ë¥¼ ìœ„í•´ body ìŠ¤íƒ€ì¼ ì¡°ì • -->
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center h-14 sm:h-16">
            
            <div class="flex-shrink-0 flex items-center pr-4">
                <a href="#" class="text-gray-800 text-lg font-bold whitespace-nowrap">
                   ì†Œì„¤ì‘ë²•
                </a>
            </div>

            <div class="flex-1 flex items-center justify-end min-w-0">
                
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1 w-full sm:w-auto no-scrollbar">
                    
                    <a href="/" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê¸€ì“°ê¸°
                    </a>
                    
                    <a href="/index3" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ì„¸ê³„ê´€
                    </a>
                    
                    <a href="/index4" class="px-3 py-2 rounded-md text-sm sm:text-base font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" aria-current="page">
                        ì—í”¼ì†Œë“œ
                    </a>
                    
                    <a href="/index2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ë“±ì¥ì¸ë¬¼
                    </a>
                    
                    <a href="/storys2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ìƒì„¸í¸ì§‘
                    </a>
                    
                    <a href="/storys1" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê²€ì¦
                    </a>
                </div>
            </div>

        </div>
    </div>
</nav>

<style>
    /* Chrome, Safari, Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>


<div id="app" class="mt-16 sm:mt-20 w-full max-w-4xl bg-white shadow-2xl rounded-xl p-4 sm:p-8 border border-gray-100 mb-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800">í”Œë¡¯ ê¸°ë°˜ ë“±ì¥ì¸ë¬¼ ê´€ë¦¬</h1>
    <p class="text-gray-500">íŠ¹ì • ì„¤ì •(í”Œë¡¯)ì„ ì„ íƒí•˜ê³ , í•´ë‹¹ í”Œë¡¯ì— í•„ìš”í•œ ë“±ì¥ì¸ë¬¼ì„ ì¶”ê°€í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
  </header>

  <!-- ë¡œë”© ë° ì˜¤ë¥˜ ë©”ì‹œì§€ -->
  <div id="message-container" class="mb-4 hidden">
    <div id="loading-spinner" class="text-center p-4 text-indigo-600 hidden">
      <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      ë°ì´í„° ë¡œë“œ ì¤‘...
    </div>
    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg hidden" role="alert">
      <strong class="font-bold">ì˜¤ë¥˜ ë°œìƒ!</strong>
      <span id="error-text" class="block sm:inline"></span>
    </div>
  </div>

  <!-- 1. ì„¤ì • ì„ íƒ ì˜ì—­ -->
  <div class="container-card p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. í”Œë¡¯ ì„¤ì • ì„ íƒ</h2>
    <div class="flex flex-col md:flex-row items-center gap-4">
      <select id="setting-select" class="input-style flex-grow w-full md:w-auto bg-white disabled:bg-gray-100">
        <option value="" disabled selected>ì„¤ì •(í”Œë¡¯)ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
      <div class="text-sm text-gray-500 w-full md:w-auto">í˜„ì¬ ì„ íƒ ID: <span id="selected-setting-id" class="font-mono font-semibold text-indigo-600">ì—†ìŒ</span></div>
    </div>
  </div>

  <!-- 2. AI ê¸°ë°˜ ë“±ì¥ì¸ë¬¼ êµ¬ì„± ì„¹ì…˜ -->
  <div class="container-card p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. AI ê¸°ë°˜ ë“±ì¥ì¸ë¬¼ êµ¬ì„±</h2>
    <form id="ai-character-form">
      <p class="text-sm text-gray-500 mb-3">ì„ íƒëœ í”Œë¡¯ì— ë§ì¶° í•„ìš”í•œ ë“±ì¥ì¸ë¬¼ì„ AIì—ê²Œ ìš”ì²­í•˜ì„¸ìš”. **(í˜„ì¬ í”Œë¡¯ì— ì£¼ì¸ê³µì´ ì´ë¯¸ ìˆë‹¤ë©´, AIëŠ” ì£¼ì¸ê³µì„ ì¶”ì²œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)**</p>

      <textarea id="ai-prompt" rows="2" required class="input-style w-full resize-none mb-4" placeholder="AI ë“±ì¥ì¸ë¬¼ ìƒì„± ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (í•„ìˆ˜)"></textarea>

      <button type="submit" id="ai-generate-btn" disabled class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors disabled:bg-green-300 flex items-center justify-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M4.343 4.343l-.707.707m1.414 14.142l-.707.707m12.728-.707l-.707-.707M6.343 17.657l-4.243 4.243M17.657 6.343l4.243-4.243m-1.414 14.142l4.243-4.243"></path></svg>
        AIë¡œ ë“±ì¥ì¸ë¬¼ êµ¬ì„±í•˜ê¸°
      </button>
    </form>

    <!-- AI ìƒì„± ê²°ê³¼ ê²€í†  ì˜ì—­ -->
    <div id="ai-results-container" class="mt-6 hidden">
      <h3 class="text-lg font-semibold text-gray-700 mb-3">AI ìƒì„± ê²°ê³¼ ê²€í† </h3>
      <p class="text-sm text-gray-500 mb-3">ì›í•˜ëŠ” ë“±ì¥ì¸ë¬¼ì„ ì„ íƒ(ì²´í¬)í•˜ê³ , ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ì„¤ëª…ì„ í™•ì¸í•œ í›„ ì €ì¥í•˜ì„¸ìš”.</p>
      <div id="ai-characters-review" class="space-y-3 p-3 bg-gray-50 border rounded-lg max-h-80 overflow-y-auto">
        <!-- AI ìƒì„± ë“±ì¥ì¸ë¬¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
      </div>
      <button id="ai-save-selected-btn" disabled class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors mt-4 disabled:bg-indigo-300">
        ì„ íƒëœ ë“±ì¥ì¸ë¬¼ DBì— ì¶”ê°€
      </button>
    </div>
  </div>

  <!-- 3. ë“±ì¥ì¸ë¬¼ ì¶”ê°€/ë“±ë¡ ì˜ì—­ (ê¸°ì¡´ ìˆ˜ë™ ì¶”ê°€) -->
  <div class="container-card p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">3. ìƒˆë¡œìš´ ë“±ì¥ì¸ë¬¼ ìˆ˜ë™ ì¶”ê°€</h2>
    <form id="add-character-form">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label for="char-name" class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
          <input type="text" id="char-name" required class="input-style w-full" placeholder="ë“±ì¥ì¸ë¬¼ ì´ë¦„ (í•„ìˆ˜)">
        </div>
        <div>
          <label for="char-role" class="block text-sm font-medium text-gray-700 mb-1">ì—­í• </label>
          <input type="text" id="char-role" class="input-style w-full" placeholder="ì˜ˆ: ì£¼ì¸ê³µ, ì•…ë‹¹, ì¡°ë ¥ì">
        </div>
        <div class="md:col-span-3">
          <label for="char-desc" class="block text-sm font-medium text-gray-700 mb-1">ìƒì„¸ ì„¤ëª…</label>
          <textarea id="char-desc" rows="3" class="input-style w-full resize-none" placeholder="ì„±ê²©, ì™¸í˜•, ëŠ¥ë ¥ ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ "></textarea>
        </div>
      </div>
      <button type="submit" id="add-char-btn" disabled class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors disabled:bg-indigo-300">
        ë“±ì¥ì¸ë¬¼ ì¶”ê°€í•˜ê¸°
      </button>
    </form>
  </div>

  <!-- 4. ë“±ì¥ì¸ë¬¼ ëª©ë¡ ì˜ì—­ -->
  <div class="container-card p-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">4. ë“±ë¡ëœ ë“±ì¥ì¸ë¬¼ ëª©ë¡ (<span id="char-count">0</span>ëª…)</h2>
    <div id="characters-list" class="space-y-4">
      <p id="list-placeholder" class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">
        ì„¤ì •ì„ ì„ íƒí•˜ì‹œë©´ ë“±ì¥ì¸ë¬¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </p>
      <!-- ë“±ì¥ì¸ë¬¼ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
    </div>
  </div>
</div>

<!-- ë“±ì¥ì¸ë¬¼ ìƒì„¸ ì •ë³´ & ìˆ˜ì • ëª¨ë‹¬ íŒì—… -->
<div id="detail-modal" class="modal-overlay hidden">
  <div class="bg-white rounded-xl p-6 w-11/12 max-w-lg shadow-2xl relative transform transition-all scale-100 opacity-100">
    <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ë“±ì¥ì¸ë¬¼ ìƒì„¸ ì •ë³´ ë° ìˆ˜ì •</h3>

    <form id="edit-character-form" data-editing-id="">
      <div class="space-y-4 mb-6">
        <div>
          <label for="edit-char-name" class="block text-sm font-semibold text-gray-700 mb-1">ì´ë¦„</label>
          <input type="text" id="edit-char-name" required class="input-style w-full text-lg font-bold" />
        </div>
        <div>
          <label for="edit-char-role" class="block text-sm font-semibold text-gray-700 mb-1">ì—­í• </label>
          <input type="text" id="edit-char-role" class="input-style w-full text-base" />
        </div>
        <div class="pt-2 border-t mt-4">
          <label for="edit-char-description" class="block text-base font-semibold text-gray-700 mb-1">ìƒì„¸ ì„¤ëª…</label>
          <textarea id="edit-char-description" rows="6" class="input-style w-full resize-y text-gray-700"></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button type="button" id="modal-close-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">ë‹«ê¸°</button>
        <button type="submit" id="modal-save-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors">
          ìˆ˜ì • ë‚´ìš© ì €ì¥
        </button>
      </div>
    </form>

    <!-- X ë‹«ê¸° ë²„íŠ¼ -->
    <button id="modal-close-x-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
  </div>
</div>

<script>
  // í˜„ì¬ëŠ” Firebase ëŒ€ì‹  ê°€ìƒì˜ MySQL API ì—”ë“œí¬ì¸íŠ¸ì™€ í†µì‹ í•©ë‹ˆë‹¤.
  const apiBaseUrl = '/api';
  const POLLING_INTERVAL = 5000; // 5ì´ˆë§ˆë‹¤ ë“±ì¥ì¸ë¬¼ ëª©ë¡ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ëŒ€ì²´)

  let pollingIntervalId = null; // ë“±ì¥ì¸ë¬¼ ëª©ë¡ í´ë§ì„ ìœ„í•œ Interval ID

  const settingSelect = document.getElementById('setting-select');
  const selectedSettingIdSpan = document.getElementById('selected-setting-id');
  const addCharForm = document.getElementById('add-character-form');
  const addCharBtn = document.getElementById('add-char-btn');
  const charactersList = document.getElementById('characters-list');
  const listPlaceholder = document.getElementById('list-placeholder');
  const charCountSpan = document.getElementById('char-count');
  const loadingSpinner = document.getElementById('loading-spinner');
  const errorMessageDiv = document.getElementById('error-message');
  const errorTextSpan = document.getElementById('error-text');

  // AI ê´€ë ¨ DOM ìš”ì†Œ
  const aiCharacterForm = document.getElementById('ai-character-form');
  const aiPromptTextarea = document.getElementById('ai-prompt');
  const aiGenerateBtn = document.getElementById('ai-generate-btn');
  const aiResultsContainer = document.getElementById('ai-results-container');
  const aiCharactersReview = document.getElementById('ai-characters-review');
  const aiSaveSelectedBtn = document.getElementById('ai-save-selected-btn');

  // ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œ
  const detailModal = document.getElementById('detail-modal');
  const editCharForm = document.getElementById('edit-character-form');
  const editCharName = document.getElementById('edit-char-name');
  const editCharRole = document.getElementById('edit-char-role');
  const editCharDescription = document.getElementById('edit-char-description');
  const modalCloseBtn = document.getElementById('modal-close-btn');
  const modalCloseXBtn = document.getElementById('modal-close-x-btn');

  let selectedSettingId = null;
  let currentEditingCharId = null;
  let aiGeneratedCharacters = []; // AIê°€ ìƒì„±í•œ ì„ì‹œ ìºë¦­í„° ëª©ë¡

  // â­ï¸ [ìƒˆë¡œ ì¶”ê°€ëœ ì „ì—­ ë³€ìˆ˜]
  let allSettingsCache = []; // ëª¨ë“  ì„¤ì • ì •ë³´ë¥¼ ì €ì¥ (description í¬í•¨)
  let currentSelectedSetting = null; // í˜„ì¬ ì„ íƒëœ ì„¤ì •(í”Œë¡¯) ê°ì²´

  // í˜„ì¬ ì„¤ì •ì— ë¡œë“œëœ ë“±ì¥ì¸ë¬¼ ëª©ë¡ ì €ì¥ (ì£¼ì¸ê³µ ì²´í¬ìš©)
  let currentSettingCharacters = [];

  const modelName = 'gemini-2.5-flash';
 
  // JSON ìŠ¤í‚¤ë§ˆ: AIê°€ ìƒì„±í•  ë“±ì¥ì¸ë¬¼ ê°ì²´ ë°°ì—´ ì •ì˜
  const CHARACTER_SCHEMA = {
    type: "ARRAY",
    description: "A list of characters for the story plot.",
    items: {
      type: "OBJECT",
      properties: {
        name: { type: "STRING", description: "The full name of the character, in Korean." },
        role: { type: "STRING", description: "The role of the character (e.g., protagonist, rival, assistant, side character), in Korean." },
        description: { type: "STRING", description: "A detailed description of the character's personality, appearance, and abilities. Must be at least 100 characters long, in Korean." }
      },
      propertyOrdering: ["name", "role", "description"],
      required: ["name", "role", "description"]
    }
  };


  // UI ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
  function showLoading(show) {
    loadingSpinner.classList.toggle('hidden', !show);
    // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ í‘œì‹œ/ìˆ¨ê¹€ì€ ì—ëŸ¬ ë©”ì‹œì§€ ìƒíƒœì— ë”°ë¼ ê²°ì •
    const isErrorVisible = !errorMessageDiv.classList.contains('hidden');
    document.getElementById('message-container').classList.toggle('hidden', !show && !isErrorVisible);
  }

  function showError(message) {
    errorTextSpan.textContent = message;
    errorMessageDiv.classList.remove('hidden');
    document.getElementById('message-container').classList.remove('hidden');
    showLoading(false);
  }

  function hideError() {
    errorMessageDiv.classList.add('hidden');
    document.getElementById('message-container').classList.add('hidden');
  }

  function truncateText(text, length) {
    if (!text) return '';
    if (text.length > length) {
      return text.substring(0, length) + '...';
    }
    return text;
  }

  async function fetchWithExponentialBackoff(url, options = {}, maxRetries = 3) {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        const response = await fetch(url, options);

        if (response.ok) {
          return response;
        }

        if (attempt === maxRetries - 1) {
          const errorBody = await response.text();
          throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status} ${response.statusText}. ìƒì„¸: ${errorBody}`);
        }

      } catch (error) {
        console.warn(`API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempt + 1}/${maxRetries}): ${error.message}`);
        if (attempt === maxRetries - 1) {
          throw new Error(`ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: ${error.message}`);
        }
      }

      const delay = Math.pow(2, attempt) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  // -----------------------------------------------------
  // AI ê¸°ë°˜ ë“±ì¥ì¸ë¬¼ ìƒì„± ë¡œì§
  // -----------------------------------------------------

  async function generateCharactersAI(prompt, settingId) {
    hideError();
    aiGenerateBtn.disabled = true;
    aiGenerateBtn.textContent = 'AIê°€ ë“±ì¥ì¸ë¬¼ êµ¬ì„± ì¤‘...';
    showLoading(true);

    let systemInstruction = "" +
            "ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì‘ê°€ì´ì ì‹¬ë¦¬í•™ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n" +
            "    ì‚¬ìš©ìì˜ ìš”ì²­ì„ ê¸°ë°˜ìœ¼ë¡œ, ì†Œì„¤ ì†ì—ì„œ ê¹Šì€ ë§¤ë ¥ì„ ë°œì‚°í•  ìˆ˜ ìˆëŠ” ì…ì²´ì ì¸ ë“±ì¥ì¸ë¬¼ì„ JSON í˜•ì‹ì˜ ë°°ì—´ë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”.\n" +
            "    ê° ë“±ì¥ì¸ë¬¼ì€ ì´ë¦„, ì—­í• , ê·¸ë¦¬ê³  ì„±ê²©, ì™¸í˜•, ë°°ê²½, ë‚´ì  ê°ˆë“±ì„ í¬í•¨í•˜ëŠ” 100ì ì´ìƒì˜ ìƒì„¸ ì„¤ëª…ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.\n" +
            "    ì‘ë‹µì€ ì˜¤ì§ JSON ë°ì´í„°ë§Œ í¬í•¨í•´ì•¼ í•˜ë©°, í•œêµ­ì–´ë¡œ ì‘ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤." ;

    const hasProtagonist = currentSettingCharacters.some(char => char.role && char.role.includes('ì£¼ì¸ê³µ'));

    // â­ï¸ [ìˆ˜ì •ëœ ë¶€ë¶„] settingId ëŒ€ì‹  currentSelectedSettingì˜ descriptionì„ ì‚¬ìš©
    const settingDescription = currentSelectedSetting?.worldSetting || "ì„ íƒëœ í”Œë¡¯ì˜ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
    const userQuery = `í˜„ì¬ í”Œë¡¯ì˜ ìƒì„¸ ì„¤ì •ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: [${settingDescription}]. ì‚¬ìš©ìì˜ ë“±ì¥ì¸ë¬¼ ìƒì„± ìš”ì²­ì€ "${prompt}"ì…ë‹ˆë‹¤.`;

    if (hasProtagonist) {
      // ì´ë¯¸ ì£¼ì¸ê³µì´ ìˆë‹¤ë©´ AIì—ê²Œ ì£¼ì¸ê³µì„ ìƒì„±í•˜ì§€ ì•Šë„ë¡ ëª…í™•í•˜ê²Œ ì§€ì‹œí•©ë‹ˆë‹¤.
      const protagonistName = currentSettingCharacters.find(char => char.role && char.role.includes('ì£¼ì¸ê³µ'))?.name || "ê¸°ì¡´ ì£¼ì¸ê³µ";
      const exclusionMessage = `[ì¤‘ìš” ì§€ì¹¨]: í˜„ì¬ í”Œë¡¯ì—ëŠ” ì´ë¯¸ ì£¼ì¸ê³µ(${protagonistName})ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ AIê°€ ìƒì„±í•˜ëŠ” ë“±ì¥ì¸ë¬¼ ëª©ë¡ì—ëŠ” 'ì£¼ì¸ê³µ' ì—­í• ì„ í¬í•¨í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ì˜¤ì§ ì£¼ì¸ê³µì„ ì œì™¸í•œ ì¡°ë ¥ì, ë¼ì´ë²Œ, ì•…ë‹¹, ì£¼ë³€ ì¸ë¬¼ ë“± ë‹¤ë¥¸ ì—­í• ë§Œ ìƒì„±í•´ ì£¼ì‹­ì‹œì˜¤.`;
      systemInstruction += `\n\n${exclusionMessage}`;
    }
    //console.log(userQuery)
   // console.log(systemInstruction)
   // ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
	const proxyUrl = '/api/generate-text';
	
	const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: { parts: [{ text: systemInstruction }] },
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: CHARACTER_SCHEMA
      }
	};
	
	const requestBody = {
	  model: modelName,
	  payload: payload
	};
	
    try {
      const response = await fetchWithExponentialBackoff(proxyUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const result = await response.json();
      const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

      if (!text) {
        throw new Error("AIê°€ ìœ íš¨í•œ JSONì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì‘ë‹µ ì—†ìŒ)");
      }

      // JSON íŒŒì‹±
      const generatedChars = JSON.parse(text);
      if (!Array.isArray(generatedChars)) {
        throw new Error("AI ì‘ë‹µì´ JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
      }

      aiGeneratedCharacters = generatedChars.map(char => ({
        ...char,
        // ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒ ìƒíƒœë¡œ ë§Œë“­ë‹ˆë‹¤.
        selected: true
      }));

      renderAIResults(aiGeneratedCharacters);

    } catch (error) {
      console.error("AI ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
      showError(`AI ë“±ì¥ì¸ë¬¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
      aiResultsContainer.classList.add('hidden'); // ì˜¤ë¥˜ ì‹œ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
    } finally {
      showLoading(false);
      aiGenerateBtn.disabled = false;
      aiGenerateBtn.textContent = 'AIë¡œ ë“±ì¥ì¸ë¬¼ êµ¬ì„±í•˜ê¸°';
    }
  }

  // AI ìƒì„± ê²°ê³¼ë¥¼ í™”ë©´ì— ë Œë”ë§
  function renderAIResults(chars) {
    aiCharactersReview.innerHTML = '';
    if (chars.length === 0) {
      aiCharactersReview.innerHTML = '<p class="text-gray-500 text-center py-2">AIê°€ ë“±ì¥ì¸ë¬¼ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìš”ì²­ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
      aiSaveSelectedBtn.disabled = true;
      aiResultsContainer.classList.remove('hidden');
      return;
    }

    chars.forEach((char, index) => {
      const card = document.createElement('div');
      card.className = `ai-char-card p-3 border rounded-lg flex items-center justify-between ${char.selected ? 'selected' : ''}`;
      card.setAttribute('data-index', index);
      card.onclick = () => toggleAICharSelection(index);

      card.innerHTML = `
        <div class="flex items-center space-x-3 flex-grow">
          <input type="checkbox" id="ai-char-check-${index}" data-index="${index}" ${char.selected ? 'checked' : ''} class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500" onclick="event.stopPropagation(); toggleAICharSelection(${index});">
          <div class="flex-grow">
            <h4 class="font-bold text-gray-800">${char.name} <span class="text-sm font-normal text-indigo-500 ml-2">(${char.role})</span></h4>
            <p class="text-xs text-gray-500 mt-1">${truncateText(char.description, 60)}</p>
          </div>
        </div>
      `;
      aiCharactersReview.appendChild(card);
    });

    aiSaveSelectedBtn.disabled = chars.filter(c => c.selected).length === 0;
    aiResultsContainer.classList.remove('hidden');
  }

  // AI ìºë¦­í„° ì„ íƒ/í•´ì œ í† ê¸€
  window.toggleAICharSelection = function(index) {
    const char = aiGeneratedCharacters[index];
    if (char) {
      char.selected = !char.selected;
      renderAIResults(aiGeneratedCharacters);
    }
  }

  // AI ìƒì„± ë“±ì¥ì¸ë¬¼ ì €ì¥
  async function saveAISelectedCharacters() {
    const selectedChars = aiGeneratedCharacters.filter(c => c.selected);
    if (selectedChars.length === 0) return;

    aiSaveSelectedBtn.disabled = true;
    aiSaveSelectedBtn.textContent = 'DBì— ì €ì¥ ì¤‘...';
    showLoading(true);

    try {
      const url = `${apiBaseUrl}/characters/bulk`;
      const charData = selectedChars.map(char => ({
        setting_id: selectedSettingId,
        name: char.name,
        role: char.role,
        description: char.description
      }));

      const response = await fetchWithExponentialBackoff(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ characters: charData })
      });

      if (!response.ok) {
        throw new Error(`ëŒ€ëŸ‰ ì €ì¥ ì‹¤íŒ¨: ${response.statusText}`);
      }

      // ì„±ê³µ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë° AI ê²°ê³¼ ì´ˆê¸°í™”
      fetchCharacters(selectedSettingId);
      aiResultsContainer.classList.add('hidden');
      aiGeneratedCharacters = [];

    } catch (error) {
      console.error("AI ìƒì„± ë“±ì¥ì¸ë¬¼ ì €ì¥ ì˜¤ë¥˜:", error);
      showError(`ì„ íƒëœ ë“±ì¥ì¸ë¬¼ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      showLoading(false);
      aiSaveSelectedBtn.disabled = false;
      aiSaveSelectedBtn.textContent = 'ì„ íƒëœ ë“±ì¥ì¸ë¬¼ DBì— ì¶”ê°€';
    }
  }

  // -----------------------------------------------------
  // CRUD ë° ì„¤ì • ë¡œì§ (ê¸°ì¡´ í•¨ìˆ˜)
  // -----------------------------------------------------

  // ì„¤ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function fetchSettings() {
    showLoading(true);
    try {
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/settings-list`);
      const settings = await response.json();

      // â­ï¸ [ìˆ˜ì •ëœ ë¶€ë¶„] ì „ì²´ ì„¤ì • ëª©ë¡ ìºì‹±
      allSettingsCache = settings;

      settingSelect.innerHTML = '<option value="" disabled selected>ì„¤ì •(í”Œë¡¯)ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      settings.forEach(setting => {
        const option = document.createElement('option');
        option.value = setting.id;
        option.textContent = `${setting.id}: ${truncateText(setting.title, 30)}`;
        settingSelect.appendChild(option);
      });

      // ê°€ì¥ ìµœê·¼ì— ì‚¬ìš©í•œ ì„¤ì • IDê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
      const lastSettingId = localStorage.getItem('lastSettingId');
      if (lastSettingId && settings.some(s => s.id.toString() === lastSettingId)) {
        settingSelect.value = lastSettingId;
        handleSettingChange({ target: settingSelect });
      }

    } catch (error) {
      console.error("ì„¤ì • ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
      showError(`ì„¤ì • ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  // ë“±ì¥ì¸ë¬¼ ì¹´ë“œ ìƒì„± í•¨ìˆ˜
  function createCharacterCard(char) {
    const card = document.createElement('div');
    card.className = 'char-card p-4 bg-white border border-gray-200 rounded-lg shadow hover:shadow-md transition-shadow flex justify-between items-center';
    card.setAttribute('data-char-id', char.id);

    // ë‚´ìš© ì˜ì—­
    const content = document.createElement('div');
    content.className = 'flex-grow cursor-pointer'
    content.onclick = () => showCharacterModal(char);

    content.innerHTML = `
        <h3 class="text-lg font-bold text-gray-800">${char.name} <span class="text-sm font-normal text-indigo-500 ml-2">(${char.role || 'ì—­í•  ë¯¸ì§€ì •'})</span></h3>
        <p class="text-sm text-gray-600 mt-1">${truncateText(char.description, 80)}</p>
    `;

    // ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ (ì‚­ì œ)
    const actions = document.createElement('div');
    actions.className = 'ml-4 flex-shrink-0';
    actions.innerHTML = `
        <button data-char-id="${char.id}" class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-full transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
        </button>
    `;
    actions.querySelector('.delete-btn').addEventListener('click', handleDeleteCharacter);

    card.appendChild(content);
    card.appendChild(actions);
    return card;
  }

  // ë“±ì¥ì¸ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
  async function fetchCharacters(settingId) {
    if (!settingId) return;

    // í´ë§ ì¬ì‹œì‘ ì‹œ ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
    if (pollingIntervalId) {
      clearInterval(pollingIntervalId);
    }

    // í´ë§ ë¡œì§ ì •ì˜ (5ì´ˆ ê°„ê²©)
    const startPolling = async () => {
      await updateCharacters(settingId);
      pollingIntervalId = setInterval(async () => {
        await updateCharacters(settingId);
      }, POLLING_INTERVAL);
    };

    // ì²« ë¡œë“œ ë° í´ë§ ì‹œì‘
    await startPolling();
  }

  // ë“±ì¥ì¸ë¬¼ ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§
  async function updateCharacters(settingId) {
    showLoading(true);
    try {
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/characters?setting_id=${settingId}`);
      const characters = await response.json();

      // í˜„ì¬ ì„¤ì •ì— ë¡œë“œëœ ë“±ì¥ì¸ë¬¼ ëª©ë¡ ì €ì¥ (ì£¼ì¸ê³µ ì²´í¬ìš©)
      currentSettingCharacters = characters;

      charactersList.innerHTML = '';
      charCountSpan.textContent = characters.length;
      listPlaceholder.classList.toggle('hidden', characters.length > 0);

      characters.forEach(char => {
        charactersList.appendChild(createCharacterCard(char));
      });

    } catch (error) {
      console.error("ë“±ì¥ì¸ë¬¼ ë¡œë“œ ì˜¤ë¥˜:", error);
      showError(`ë“±ì¥ì¸ë¬¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  // ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  function handleSettingChange(event) {
    selectedSettingId = event.target.value;
    localStorage.setItem('lastSettingId', selectedSettingId);
    selectedSettingIdSpan.textContent = selectedSettingId;

    // â­ï¸ [ìˆ˜ì •ëœ ë¶€ë¶„] currentSelectedSetting ì—…ë°ì´íŠ¸
    currentSelectedSetting = allSettingsCache.find(s => s.id.toString() === selectedSettingId);

    // AI/ìˆ˜ë™ ì¶”ê°€ ë²„íŠ¼ í™œì„±í™”
    addCharBtn.disabled = false;
    aiGenerateBtn.disabled = false;

    // ë“±ì¥ì¸ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
    fetchCharacters(selectedSettingId);

    // AI ìƒì„± ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
    aiResultsContainer.classList.add('hidden');
    aiGeneratedCharacters = [];
  }

  // ë“±ì¥ì¸ë¬¼ ì¶”ê°€
  async function handleAddCharacter(e) {
    e.preventDefault();
    if (!selectedSettingId) {
      showError('ë¨¼ì € í”Œë¡¯ ì„¤ì •ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }

    const name = document.getElementById('char-name').value.trim();
    const role = document.getElementById('char-role').value.trim();
    const description = document.getElementById('char-desc').value.trim();

    if (!name) return;

    addCharBtn.disabled = true;
    addCharBtn.textContent = 'ì¶”ê°€ ì¤‘...';

    const newChar = {
      setting_id: selectedSettingId,
      name,
      role,
      description
    };

    try {
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/characters`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newChar)
      });

      if (!response.ok) {
        throw new Error(`APIê°€ ë“±ì¥ì¸ë¬¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
      }

      // ì„±ê³µ í›„ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      addCharForm.reset();
      fetchCharacters(selectedSettingId);

    } catch (error) {
      console.error("ë“±ì¥ì¸ë¬¼ ì¶”ê°€ ì˜¤ë¥˜:", error);
      showError(`ë“±ì¥ì¸ë¬¼ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      addCharBtn.disabled = false;
      addCharBtn.textContent = 'ë“±ì¥ì¸ë¬¼ ì¶”ê°€í•˜ê¸°';
    }
  }

  // ëª¨ë‹¬ í‘œì‹œ ë° ë°ì´í„° ë¡œë“œ
  function showCharacterModal(char) {
    currentEditingCharId = char.id;
    editCharForm.setAttribute('data-editing-id', char.id);
    editCharName.value = char.name;
    editCharRole.value = char.role || '';
    editCharDescription.value = char.description || '';

    detailModal.classList.remove('hidden');
  }

  // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
  function hideCharacterModal() {
    detailModal.classList.add('hidden');
    currentEditingCharId = null;
    editCharForm.removeAttribute('data-editing-id');
  }

  // ë“±ì¥ì¸ë¬¼ ìˆ˜ì •
  async function handleEditCharacter(e) {
    e.preventDefault();
    const charId = e.target.getAttribute('data-editing-id');
    if (!charId) return;

    const saveBtn = document.getElementById('modal-save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'ì €ì¥ ì¤‘...';

    const updatedChar = {
      name: editCharName.value.trim(),
      role: editCharRole.value.trim(),
      description: editCharDescription.value.trim()
    };

    try {
      const url = `${apiBaseUrl}/characters/${charId}`;
      const response = await fetchWithExponentialBackoff(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedChar)
      });

      if (!response.ok) {
        throw new Error(`APIê°€ ë“±ì¥ì¸ë¬¼ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
      }

      hideCharacterModal();
      fetchCharacters(selectedSettingId);

    } catch (error) {
      console.error("ë“±ì¥ì¸ë¬¼ ìˆ˜ì • ì˜¤ë¥˜:", error);
      showError(`ë“±ì¥ì¸ë¬¼ ìˆ˜ì • ì‹¤íŒ¨: ${error.message}`);
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'ìˆ˜ì • ë‚´ìš© ì €ì¥';
    }
  }

  // ë“±ì¥ì¸ë¬¼ ì‚­ì œ
  async function handleDeleteCharacter(e) {
    const charId = e.currentTarget.getAttribute('data-char-id');
    if (!charId || !selectedSettingId) return;

    e.currentTarget.disabled = true;

    try {
      const url = `${apiBaseUrl}/characters/${charId}`;
      const response = await fetchWithExponentialBackoff(url, {
        method: 'DELETE'
      });

      if (response.status !== 204 && response.status !== 200) {
        throw new Error(`APIê°€ ë“±ì¥ì¸ë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
      }

      fetchCharacters(selectedSettingId);

    } catch (error) {
      console.error("ë“±ì¥ì¸ë¬¼ ì‚­ì œ ì˜¤ë¥˜:", error);
      showError(`ë“±ì¥ì¸ë¬¼ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
      e.currentTarget.disabled = false;
    }
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  modalCloseBtn.addEventListener('click', hideCharacterModal);
  modalCloseXBtn.addEventListener('click', hideCharacterModal);
  detailModal.addEventListener('click', (e) => {
    if (e.target === detailModal) {
      hideCharacterModal();
    }
  });

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  settingSelect.addEventListener('change', handleSettingChange);
  addCharForm.addEventListener('submit', handleAddCharacter);
  editCharForm.addEventListener('submit', handleEditCharacter);
  aiCharacterForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!selectedSettingId) {
      showError('ë¨¼ì € í”Œë¡¯ ì„¤ì •ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
    const prompt = aiPromptTextarea.value.trim();
    if (prompt) {
      generateCharactersAI(prompt, selectedSettingId);
    }
  });
  aiSaveSelectedBtn.addEventListener('click', saveAISelectedCharacters);


  // ì´ˆê¸°í™”
  fetchSettings();

</script>
</body>
</html>