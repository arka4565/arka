<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†Œì„¤ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --map-color: #3498db; /* ë¡œë“œë§µ ê°•ì¡°ìƒ‰ */
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ --- */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--map-color); font-weight: bold; } 

        /* --- ë©”ì¸ ì»¨í…ì¸  --- */
        .container {
            flex: 1;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 { 
            border-left: 5px solid var(--map-color); 
            padding-left: 10px; 
            margin: 0; 
            color: var(--map-color); 
        }

        /* AI ì…ë ¥ ë° ë²„íŠ¼ ì˜ì—­ */
        .ai-input-section {
            background: #f0f7ff;
            border: 1px solid var(--map-color);
            border-radius: 8px;
            padding: 15px;
        }
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .map-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 100px; /* ë†’ì´ ì¦ê°€ */
            resize: vertical;
            font-family: inherit;
        }
        .btn-generate {
            background: var(--map-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
        }
        .btn-generate:hover { background: #2980b9; }

        /* ë¡œë“œë§µ ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        .roadmap-result {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 10px;
        }
        .result-header h3 { margin: 0; color: #555; }
        .btn-save-roadmap {
            background: #50c878;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .result-content {
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
            font-family: monospace; /* ì„œì‹ êµ¬ë¶„ì„ ìœ„í•´ í°íŠ¸ ë³€ê²½ */
            font-size: 0.95rem;
            line-height: 1.6;
            min-height: 300px; /* ë†’ì´ ì¦ê°€ */
        }
        .empty-state { text-align: center; color: #999; padding: 50px; }

        @media (max-width: 600px) {
            .container { margin: 15px; padding: 15px; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item" data-target="plot.html"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
        </div>
</nav>

<div class="container">
    <h2><i class="fas fa-map-marked-alt"></i> ì†Œì„¤ ìƒì„¸ ë¡œë“œë§µ êµ¬ì„±</h2>

    <div class="ai-input-section">
        <div class="input-group">
            <label class="input-label">ìš”ì²­ ì‚¬í•­ <small>(Part ë° ì‚¬ê±´ êµ¬ì„± ì§€ì‹œ)</small></label>
            <textarea id="aiPrompt" class="map-textarea" placeholder="ì˜ˆì‹œ: ë¡œë“œë§µì˜ ì‚¬ê±´ì˜ ë¶„ëŸ‰ì€ 3í™”ë¡œ êµ¬ì„±í•´ì¤˜. ë“±ì¥ì¸ë¬¼ì€ í•´ë‹¹ ì‚¬ê±´ì— ë‚˜ì˜¤ëŠ” ì¸ë¬¼ë¡œë§Œ êµ¬ì„±í•´ì¤˜. ì¤„ê±°ë¦¬ì—ì„œ ì•ˆ ë‚˜ì˜¤ë©´ ë“±ì¥ì¸ë¬¼ ëª©ë¡ì—ì„œ ì•ˆ ë‚˜ì˜¤ê²Œ í•´ì¤˜. íŒŒíŠ¸1ì— ì‚¬ê±´ 2ê°œë§Œ êµ¬ì„±í•´ì¤˜."></textarea>
        </div>
        
        <button id="btnGenerate" class="btn-generate" onclick="generateRoadmap()">
            <i class="fas fa-bolt"></i> ë¡œë“œë§µ ìƒì„± ì‹œì‘
        </button>
    </div>

    <div class="roadmap-result">
        <div class="result-header">
            <h3>ìƒì„± ê²°ê³¼</h3>
            <button id="btnSaveMap" class="btn-save-roadmap" onclick="saveRoadmap()" style="display:none;">
                <i class="fas fa-save"></i> ì €ì¥ (settingsì— ë°˜ì˜)
            </button>
        </div>
        <div id="roadmapContent" class="result-content empty-state">
            ì„¸ê³„ê´€, ìºë¦­í„° ì„¤ì •ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„¸ ë¡œë“œë§µì„ ìƒì„±í•´ë³´ì„¸ìš”.
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let contextData = ""; 
    let currentRoadmap = ""; 
    let currentSettings = {}; // settings í…Œì´ë¸”ì˜ ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥

    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData(); 
        await loadRoadmapData(); 
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    // AIì—ê²Œ ì „ë‹¬í•  ë°°ê²½ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ì„¸ê³„ê´€, ìºë¦­í„° ë“±)
    async function loadContextData() {
        try {
            const [sRes, wRes, cRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`).then(r => r.json()),
                fetch(`/api/worldsettings?setting_id=${settingId}`).then(r => r.json()),
                fetch(`/api/characters?setting_id=${settingId}`).then(r => r.json())
            ]);
            
            currentSettings = sRes; // settings ë°ì´í„° ì €ì¥
            
            // AI í”„ë¡¬í”„íŠ¸ì— ë“¤ì–´ê°ˆ ìƒì„¸ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
            contextData = `
            [ì‘í’ˆ ì œëª©]: ${sRes.title || 'ë¯¸ì •'}
            [ì‘í’ˆ ë¡œê·¸ë¼ì¸(ì¤„ê±°ë¦¬ ê°œìš”)]: ${sRes.plotDetails || 'ë¯¸ì •'}
            [ê¸°íƒ€ ì„¤ì •/ë©”ëª¨]: ${sRes.worldSetting || 'ì—†ìŒ'}

            [ì„¸ê³„ê´€ ì„¤ì • ëª©ë¡]: ${wRes.map(w => w.title + ": " + w.description.substring(0, 100)).join('\n') || 'ì—†ìŒ'}
            
            [ë“±ì¥ì¸ë¬¼ ìƒì„¸ ëª©ë¡]: ${cRes.map(c => `${c.name} (${c.role}, ${c.description.substring(0, 100)})`).join('\n') || 'ì—†ìŒ'}
            `;
        } catch (e) { console.warn("Context load failed", e); }
    }

    // ê¸°ì¡´ ë¡œë“œë§µ ë°ì´í„° ë¡œë“œ
    async function loadRoadmapData() {
        const contentEl = document.getElementById('roadmapContent');
        const saveBtn = document.getElementById('btnSaveMap');
        
        try {
            const res = await fetch(`/api/load-settings?id=${settingId}`);
            const settings = await res.json();
            
            currentRoadmap = settings.roadmap || ""; // settings í…Œì´ë¸”ì˜ roadmap ì»¬ëŸ¼ ê°€ì •
            
            if (currentRoadmap.trim()) {
                contentEl.innerText = currentRoadmap;
                contentEl.classList.remove('empty-state');
                saveBtn.style.display = 'block';
            } else {
                contentEl.innerText = "ì„¸ê³„ê´€, ìºë¦­í„° ì„¤ì •ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„¸ ë¡œë“œë§µì„ ìƒì„±í•´ë³´ì„¸ìš”.";
                contentEl.classList.add('empty-state');
                saveBtn.style.display = 'none';
            }

        } catch (e) {
            console.error("ë¡œë“œë§µ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
        }
    }

    // ğŸŒŸ ë¡œë“œë§µ ìƒì„± ìš”ì²­
    async function generateRoadmap() {
        const prompt = document.getElementById('aiPrompt').value.trim();
        
        if (!prompt) return alert("ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.getElementById('btnGenerate');
        const contentEl = document.getElementById('roadmapContent');
        const originalBtnHTML = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œë“œë§µ ìƒì„± ì¤‘...';
        contentEl.innerText = "AIê°€ ì•„ì´ë””ì–´ë¥¼ êµ¬ìƒí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

        try {
            const fullPrompt = `
                [ì—­í• ] ì „ë¬¸ ì›¹ì†Œì„¤ êµ¬ì„± ì‘ê°€ ë° í”Œë¡¯ ë””ìì´ë„ˆ
                [ì‘í’ˆ ì •ë³´]
                ${contextData}

                [ìš”ì²­ ì‚¬í•­]
                ${prompt}

                [ì¶œë ¥ ì¡°ê±´]
                1. ìš”ì²­ ì‚¬í•­ê³¼ ì‘í’ˆ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì†Œì„¤ì˜ ìƒì„¸ ë¡œë“œë§µ**ì„ ì‘ì„±í•˜ì„¸ìš”.
                2. ë¡œë“œë§µì€ Part > ì‚¬ê±´(Sub-Arc) > íšŒì°¨(Episode)ì˜ 3ë‹¨ê³„ ê³„ì¸µ êµ¬ì¡°ë¥¼ ë”°ë¥´ì„¸ìš”.
                3. **í•µì‹¬ í…Œë§ˆ, Part ì¤„ê±°ë¦¬, ì‚¬ê±´ ì¤„ê±°ë¦¬, íšŒì°¨ ì¤„ê±°ë¦¬**ëŠ” ëª¨ë‘ ê°œë³„ì ìœ¼ë¡œ ì‘ì„±í•˜ê³ , **ë“±ì¥ì¸ë¬¼ì€ í•´ë‹¹ íšŒì°¨/ì‚¬ê±´ì— ì‹¤ì œë¡œ í•„ìš”í•œ ì¸ë¬¼ë§Œ** ë‚˜ì—´í•˜ì„¸ìš”.
                4. ì•„ë˜ ì˜ˆì‹œì™€ ì •í™•íˆ ë™ì¼í•œ í˜•ì‹(ë²ˆí˜¸, ê¸°í˜¸, ì¤„ë°”ê¿ˆ)ìœ¼ë¡œ, **ì¤„ê¸€ í…ìŠ¤íŠ¸**ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.

                [ì¶œë ¥ ì˜ˆì‹œ - Part 1, ì‚¬ê±´ 1, 2ë§Œ êµ¬ì„±]
                
                [Part 1. ê°ì„±ì˜ ì‹œì‘ (1í™”~50í™”)]
                 â—‹ í•µì‹¬í…Œë§ˆ: ë¬´ëŠ¥ë ¥ìì—ì„œ ê¸°ì ì˜ ì‹œê³µìë¡œ ê±°ë“­ë‚˜ê¸°
                 â—‹ Part1 ì¤„ê±°ë¦¬: ì•„ë²„ì§€ì™€ í˜•ì œë“¤ì˜ ì˜¤í•´ ì†ì—ì„œ Fê¸‰ìœ¼ë¡œ ê°ì„±í•œ ì¥í•œë¹›ì´ ë˜ì „ ì‹œê³µì ëŠ¥ë ¥ì„ ë°œê²¬í•˜ê³ , ì´ë¥¼ í™œìš©í•´ íƒœì‚° ê·¸ë£¹ ë‚´ì—ì„œ ìì‹ ë§Œì˜ ì…ì§€ë¥¼ ë‹¤ì ¸ë‚˜ê°€ëŠ” ì´ˆê¸° ì„±ì¥ ê³¼ì •ì„ ë‹¤ë£¬ë‹¤.
                
                 ì‚¬ê±´ 1: [Fê¸‰ ê°ì„±ê³¼ ìµœì´ˆì˜ ì¦ëª… (1í™”~3í™”)]
                  - í•µì‹¬í…Œë§ˆ: ë§ˆì§€ë…¸ì„  ê·¹ë³µê³¼ ê°€ì¡±ì˜ ì¸ì •
                  - ì‚¬ê±´ 1 ì¤„ê±°ë¦¬: 26ì„¸ ìƒì¼ì— Fê¸‰ ì‹œê³µìë¡œ ê°ì„±í•œ í•œë¹›ì´, ìì‹ ì˜ ëŠ¥ë ¥ì´ íìì¬ë¡œë„ B+ê¸‰ ë‚´êµ¬ë„ ë²½ì„ ë§Œë“¤ ìˆ˜ ìˆìŒì„ ë°œê²¬í•˜ê³ , ê°€ì¡±ë“¤ ì•ì—ì„œ ìµœì´ˆì˜ ë†€ë¼ìš´ ê²°ê³¼ë¥¼ ì¦ëª…í•˜ëŠ” ì´ì•¼ê¸°. (300ì ë‚´ì™¸)
                   â—‹ [ì œ1í™”] íƒœì‚°ì˜ ë§‰ë‚´, ìƒˆë²½ì„ ì—´ë‹¤
                     â–· 26ì„¸ ìƒì¼ ìì •ì— ê°ì„± ë§ˆì§€ë…¸ì„ ì„ ë„˜ê¸´ í•œë¹›ì´ Fê¸‰ ì‹œê³µìë¡œ ê°ì„±í•˜ê³ , ì§€í•˜ì‹¤ ì‘ì—…ì‹¤ì—ì„œ [ì¸¡ëŸ‰]ê³¼ [ì‹œê³µ] ìŠ¤í‚¬ì„ ì´ìš©í•´ B+ê¸‰ ë¸”ë¡ì„ ë§Œë“¤ì–´ë‚¸ë‹¤. (300ì ë‚´ì™¸)
                     â–· ë“±ì¥ì¸ë¬¼: ì¥í•œë¹›
                   â—‹ [ì œ2í™”] B+ê¸‰ì˜ ì¶©ê²©
                     â–· ì•„ì¹¨ ì‹íƒì—ì„œ ê°€ì¡±ë“¤ ì•ì—ì„œ ëŠ¥ë ¥ì„ ê³µê°œí•˜ê³ , Sê¸‰ íƒ±ì»¤ì¸ í°í˜• ì¥í•œì„±ì´ ì§ì ‘ ì£¼ë¨¹ìœ¼ë¡œ ë¸”ë¡ì˜ ë‚´êµ¬ë„ë¥¼ ì‹œí—˜í•˜ë©° ì¶©ê²©ì„ ë°›ëŠ”ë‹¤. (300ì ë‚´ì™¸)
                     â–· ë“±ì¥ì¸ë¬¼: ì¥í•œë¹›, ì¥íƒœì‚°, ì¥í•œì„±, ì¥í•œê²°, ì¥í•œë³„
                   â—‹ [ì œ3í™”] ë¦¬ëª¨ë¸ë§ì˜ ì„ ì „í¬ê³ 
                     â–· íƒœì‚° íšŒì¥ì˜ ì§€ì§€ì™€ í˜•ì œë“¤ì˜ í˜‘ë ¥ì„ ì–»ì€ í•œë¹›ì´, íƒœì‚° ê±´ì„¤ì˜ ë§Œë…„ ì ì í”„ë¡œì íŠ¸ì¸ [ìš©ì‚° Fê¸‰ ê²Œì´íŠ¸ ë³´ìˆ˜ ê³µì‚¬]ë¥¼ ì²« í”„ë¡œì íŠ¸ë¡œ ìì›í•œë‹¤. (300ì ë‚´ì™¸)
                     â–· ë“±ì¥ì¸ë¬¼: ì¥í•œë¹›, ì¥íƒœì‚°, ê¹€ì„±ì§„

                 ì‚¬ê±´ 2: [ì²« í˜„ì¥, Fê¸‰ ê²Œì´íŠ¸ì˜ ì´ë©´ (4í™”~5í™”)]
                  - í•µì‹¬í…Œë§ˆ: ì•ˆì „ ì œì¼ì£¼ì˜ì™€ í˜„ì¥ì˜ ë¹„íš¨ìœ¨ì„± ê·¹ë³µ
                  - ì‚¬ê±´ 2 ì¤„ê±°ë¦¬: í•œë¹›ì´ ì²« ë˜ì „ í˜„ì¥ì— íˆ¬ì…ë˜ì–´ ê¸°ì¡´ ê±´ì„¤ ë°©ì‹ì˜ ë¹„íš¨ìœ¨ì„±ì„ ê¹¨ë‹«ê³ , [ì¸¡ëŸ‰] ëŠ¥ë ¥ìœ¼ë¡œ ë˜ì „ì˜ êµ¬ì¡°ì  ì•½ì ì„ ì°¾ì•„ë‚´ì–´ ìƒˆë¡œìš´ ê³µë²•ì„ ì œì‹œí•˜ëŠ” ë‚´ìš©. (300ì ë‚´ì™¸)
                   â—‹ [ì œ4í™”] ì„¤ê³„ë„ê°€ í•„ìš”í•´
                     â–· í•œë¹›ì´ ìš©ì‚° Fê¸‰ ê²Œì´íŠ¸ì— ë„ì°©í•˜ì§€ë§Œ, í˜„ì¥ì€ ì„ì‹œë°©í¸ì ì¸ ë³´ìˆ˜ë¡œ ê°€ë“ ì°¨ ìˆê³ , ë°•ì² ìš° ì´ì‚¬ ë“± ê±´ì„¤ ì „ë¬¸ê°€ë“¤ì´ ê·¸ì˜ ì ŠìŒì„ ì˜ì‹¬í•œë‹¤. (300ì ë‚´ì™¸)
                     â–· ë“±ì¥ì¸ë¬¼: ì¥í•œë¹›, ë°•ì² ìš°, ê¹€ê¸°ì² 
                   â—‹ [ì œ5í™”] ì•ˆì „ ë£¨íŠ¸ ê°œì²™
                     â–· í•œë¹›ì´ [ì¸¡ëŸ‰] ìŠ¤í‚¬ë¡œ ë˜ì „ì˜ ë§ˆë‚˜ ë°°ì—´ê³¼ êµ¬ì¡°ì  ì•½ì ì„ ë¶„ì„í•´ ê¸°ì¡´ë³´ë‹¤ í›¨ì”¬ ì•ˆì „í•˜ê³  ë¹ ë¥¸ ë¦¬ëª¨ë¸ë§ ê²½ë¡œë¥¼ ì œì‹œí•œë‹¤. ë°•ì² ìš° ì´ì‚¬ê°€ ë†€ë¼ì›€ì„ í‘œí•œë‹¤. (300ì ë‚´ì™¸)
                     â–· ë“±ì¥ì¸ë¬¼: ì¥í•œë¹›, ë°•ì² ìš°

                 â—‹ Part1 ë“±ì¥ì¸ë¬¼ : ì¥í•œë¹›, ì¥íƒœì‚°, ì¥í•œì„±, ì¥í•œê²°, ì¥í•œë³„, ë°•ì² ìš°, ê¹€ì„±ì§„, ê¹€ê¸°ì²  (Part 1ì— ë“±ì¥í•˜ëŠ” ëª¨ë“  ì¸ë¬¼)
            `;

            const payload = {
                model: "gemini-2.5-flash", // ë³µì¡í•œ êµ¬ì¡° ì„¤ê³„ì—ëŠ” Pro ëª¨ë¸ ì¶”ì²œ
                payload: {
                    contents: [{ parts: [{ text: fullPrompt }] }]
                }
            };
            
            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            const resultText = data.candidates[0].content.parts[0].text;
            
            currentRoadmap = resultText; // ì „ì—­ ë³€ìˆ˜ì— ì„ì‹œ ì €ì¥
            
            contentEl.innerText = resultText;
            contentEl.classList.remove('empty-state');
            document.getElementById('btnSaveMap').style.display = 'block';

        } catch (e) {
            console.error("ë¡œë“œë§µ ìƒì„± ì˜¤ë¥˜:", e);
            contentEl.innerText = `ë¡œë“œë§µ ìƒì„± ì‹¤íŒ¨: ${e.message}`;
            currentRoadmap = "";
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        }
    }

    // ë¡œë“œë§µ ì €ì¥ (settings í…Œì´ë¸”ì˜ 'roadmap' ì»¬ëŸ¼ì— ì €ì¥)
    async function saveRoadmap() {
        if (!currentRoadmap) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        
        const btn = document.getElementById('btnSaveMap');
        const originalBtnHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';

        try {
            // settings í…Œì´ë¸”ì˜ ë‹¤ë¥¸ ì»¬ëŸ¼ì€ ê¸°ì¡´ ê°’ì„ ìœ ì§€í•´ì•¼ í•˜ë¯€ë¡œ currentSettings ì‚¬ìš©
            const payload = {
                id: settingId,
                title: currentSettings.title || '', 
                plotDetails: currentSettings.plotDetails || '', 
                worldSetting: currentSettings.worldSetting || '', 
                characterDetails: currentSettings.characterDetails || '',
                
                roadmap: currentRoadmap // ğŸŒŸ ë¡œë“œë§µ ì €ì¥
            };

            const response = await fetch('/api/save-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("ë¡œë“œë§µì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                await loadRoadmapData(); 
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        } catch (e) {
            console.error("ì €ì¥ ì˜¤ë¥˜:", e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        }
    }

    init();
</script>

</body>
</html>