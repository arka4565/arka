<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #9b59b6;
            --bg-color: #f4f6f8;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

/* ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar {
            background-color: var(--nav-bg); color: white; padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px;
            border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--primary-color); font-weight: bold; }

        
        .container { display: flex; flex: 1; overflow: hidden; flex-direction: row; }
        
        .control-panel {
            width: 380px; background: white; border-right: 1px solid #ddd;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 10; overflow-y: auto;
        }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 0.9rem; color: #555; margin-bottom: 5px; }
        textarea, select, input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; resize: none; font-family: inherit; }
        textarea:focus, input:focus, select:focus { border-color: var(--primary-color); outline: none; }

        .mode-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mode-btn {
            padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;
            cursor: pointer; text-align: center; font-size: 0.85rem; transition: all 0.2s;
        }
        .mode-btn:hover { background: #eee; }
        .mode-btn.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .btn-generate {
            background: var(--primary-color); color: white; border: none; padding: 15px;
            border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .btn-generate:disabled { background: #ccc; }

        .right-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
        
        .tab-header { display: flex; border-bottom: 1px solid #ddd; background: #f9f9f9; }
        .tab-btn {
            flex: 1; padding: 15px; cursor: pointer; text-align: center; font-weight: bold; color: #777;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-btn.active { background: white; color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-btn:hover { background: #eee; }

        .tab-content { display: none; flex: 1; padding: 20px; overflow-y: auto; background-image: radial-gradient(#e1e1e1 1px, transparent 1px); background-size: 20px 20px; }
        .tab-content.active { display: block; }

        .idea-card {
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color);
            position: relative; animation: fadeIn 0.5s ease; border: 1px solid #eee;
        }
        .idea-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .idea-type { font-size: 0.8rem; background: #eee; padding: 4px 8px; border-radius: 4px; color: #666; font-weight: bold; }
        .idea-content { white-space: pre-wrap; line-height: 1.6; color: #444; font-size: 1rem; }
        .idea-meta { 
            font-size: 0.85rem; color: #666; margin-top: 15px; 
            background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; 
        }

        .card-actions { display: flex; gap: 10px; align-items: center; }
        .btn-icon { background: none; border: none; cursor: pointer; color: #999; font-size: 1.1rem; transition: color 0.2s; padding: 5px; }
        .btn-icon:hover { color: var(--primary-color); }
        .btn-icon.delete:hover { color: #e74c3c; }

        .save-input-area { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .save-input-area h3 { margin: 0 0 10px 0; font-size: 1rem; color: #555; }
        .btn-save-manual { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; float: right; margin-top: 10px; font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: white; width: 90%; max-width: 800px; padding: 25px; border-radius: 12px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-body { margin: 20px 0; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;}
        .btn-modal { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-cancel { background: #eee; color: #555; }

        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .control-panel { width: 100%; height: auto; border-right: none; max-height: 40vh; }
            .right-area { flex: 1; }
        }
    </style>
</head>
<body>

<script src="include.js"></script>
<div data-include="nav.html"></div>

<div class="container">
    <aside class="control-panel">
        <div>
            <h2 style="margin:0; color:var(--primary-color);"><i class="fas fa-brain"></i> ë¸Œë ˆì¸ìŠ¤í† ë°</h2>
            <p style="font-size:0.85rem; color:#666; margin-top:5px;">AIì™€ í•¨ê»˜ ì•„ì´ë””ì–´ë¥¼ ë°œì‚°í•˜ê³  ì €ì¥í•˜ì„¸ìš”.</p>
        </div>

        <div class="input-group">
            <label>ì‚¬ê³  ë°©ì‹ (Mode)</label>
            <div class="mode-cards" id="modeContainer">
                <div class="mode-btn selected" onclick="selectMode('next_episode', this)">ğŸ”œ ë‹¤ìŒ í™” ì¶”ì²œ</div>
                <div class="mode-btn" onclick="selectMode('random', this)">ğŸ² ëœë¤ ë°œì‚°</div>
                <div class="mode-btn" onclick="selectMode('scamper', this)">âš¡ ë¹„í‹€ê¸°(SCAMPER)</div>
                <div class="mode-btn" onclick="selectMode('whatif', this)">ğŸ”„ ë§Œì•½ì—(What If)</div>
                <div class="mode-btn" onclick="selectMode('conflict', this)">ğŸ”¥ ìœ„ê¸°/ê°ˆë“±</div>
                <div class="mode-btn" onclick="selectMode('title', this)">ğŸ·ï¸ ì œëª© ì§“ê¸°</div>
                <div class="mode-btn" onclick="selectMode('item', this)">ğŸ’ ì•„ì´í…œ/ìŠ¤í‚¬</div>
            </div>
        </div>

        <div style="border-top:1px solid #eee; padding-top:15px; margin-top:5px;">
            <label style="color:var(--primary-color); margin-bottom:10px;"><i class="fas fa-book-reader"></i> ì°¸ê³  ìë£Œ ë²”ìœ„</label>
            <div class="input-group" style="margin-bottom:10px;">
                <div style="font-size:0.8rem; color:#666;">ì¤„ê±°ë¦¬ (Plot)</div>
                <div style="display:flex; gap:5px;">
                    <select id="plotStartEp" style="flex:1;"><option value="">ì„ íƒ</option></select> ~ <select id="plotEndEp" style="flex:1;"><option value="">ì„ íƒ</option></select>
                </div>
            </div>
            <div class="input-group">
                <div style="font-size:0.8rem; color:#666;">ë³¸ë¬¸ (Content)</div>
                <div style="display:flex; gap:5px;">
                    <select id="contentStartEp" style="flex:1;"><option value="">ì„ íƒ</option></select> ~ <select id="contentEndEp" style="flex:1;"><option value="">ì„ íƒ</option></select>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>ê³ ë¯¼ê±°ë¦¬ / í‚¤ì›Œë“œ</label>
            <textarea id="userInput" rows="3" placeholder="ì˜ˆ: 15í™” ì´í›„ ì „ê°œê°€ ë§‰í˜”ì–´. ë°˜ì „ì´ í•„ìš”í•´."></textarea>
        </div>

        <button class="btn-generate" onclick="generateIdea()">
            <i class="fas fa-bolt"></i> ì•„ì´ë””ì–´ ìƒì„±
        </button>
    </aside>

    <main class="right-area">
        <div class="tab-header">
            <div class="tab-btn active" onclick="switchRightTab('result')"><i class="fas fa-magic"></i> AI ìƒì„± ê²°ê³¼</div>
            <div class="tab-btn" onclick="switchRightTab('saved')"><i class="fas fa-archive"></i> ì•„ì´ë””ì–´ ë³´ê´€í•¨</div>
        </div>

        <div id="tab-result" class="tab-content active">
            <div id="resultContainer">
                <div style="text-align:center; color:#999; margin-top:50px;">
                    <i class="far fa-lightbulb" style="font-size:3rem; margin-bottom:20px; opacity:0.3;"></i>
                    <p>ì¢Œì¸¡ì—ì„œ 'ì•„ì´ë””ì–´ ìƒì„±'ì„ ëˆ„ë¥´ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <div id="tab-saved" class="tab-content">
            <div class="save-input-area">
                <h3><i class="fas fa-pen"></i> ì•„ì´ë””ì–´ ì§ì ‘ ê¸°ë¡</h3>
                <textarea id="manualIdeaInput" style="width:100%; height:80px;" placeholder="ë– ì˜¤ë¥¸ ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ë©”ëª¨í•˜ì„¸ìš”."></textarea>
                <div style="overflow:hidden;">
                    <button class="btn-save-manual" onclick="saveManualIdea()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>

            <h3><i class="fas fa-list"></i> ì €ì¥ëœ ì•„ì´ë””ì–´ ëª©ë¡</h3>
            <div id="savedListContainer">
                <div style="text-align:center; padding:20px; color:#999;">ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </main>
</div>

<div id="treatmentModal" class="modal-overlay">
    <div class="modal" style="max-width: 800px;">
        <h3>ğŸ¬ ì•„ì´ë””ì–´ë¡œ ì”¬(Scene) êµ¬ì„±í•˜ê¸°</h3>
        <div class="modal-body">
            
            <input type="hidden" id="modalSystemPrompt">

            <div id="treatmentInputArea">
                <p style="color:#666; margin-bottom:15px;">ì•„ì´ë””ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¥ë©´ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</p>
                <div class="input-group" style="margin-bottom:15px;">
                    <label>ìƒì„±í•  íšŒì°¨ ë²ˆí˜¸</label>
                    <input type="number" id="targetEpNum" placeholder="ì˜ˆ: 15" style="width:100%;">
                </div>
                <div class="input-group">
                    <label>ì•„ì´ë””ì–´ ë‚´ìš©</label>
                    <textarea id="modalIdeaContent" rows="4" readonly style="background:#f9f9f9;"></textarea>
                </div>
            </div>

            <div id="treatmentPreviewArea" style="display:none; margin-top:20px; border-top:2px solid #eee; padding-top:20px;">
                <h4 style="margin:0 0 10px 0; color:#2c3e50;">ğŸ“œ ìƒì„± ê²°ê³¼ í™•ì¸ (ìˆ˜ì • ê°€ëŠ¥)</h4>
                <p style="font-size:0.85rem; color:#888; margin-bottom:10px;">ë‚´ìš©ì„ ê²€í† í•˜ê³  ìˆ˜ì •í•œ ë’¤ 'ìµœì¢… ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                
                <div id="scenePreviewList" style="max-height: 400px; overflow-y: auto; padding-right:5px; margin-bottom:15px;"></div>
            </div>

        </div>

        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeTreatmentModal()">ë‹«ê¸°</button>
            <button class="btn-modal btn-primary" id="btnGenPreview" onclick="previewTreatment()">
                <i class="fas fa-magic"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ì´ˆì•ˆ ìƒì„±
            </button>
            <button class="btn-modal btn-primary" id="btnSaveFinal" onclick="saveScenesFinal()" style="display:none; background-color:#27ae60;">
                <i class="fas fa-save"></i> í™•ì¸ ë° DB ì €ì¥
            </button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');
    let currentMode = 'next_episode';
    
    let globalStories = []; 
    let globalWorld = [];
    let globalChars = [];

    async function init() {
        if (!settingId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); return; }
        setupNav(); 
        await loadAllData();
        loadSavedIdeas();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    window.switchRightTab = function(tabName) {
        document.querySelectorAll('.right-area .tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.right-area .tab-content').forEach(content => content.classList.remove('active'));
        
        const buttons = document.querySelectorAll('.right-area .tab-btn');
        if(tabName === 'result') buttons[0].classList.add('active');
        else buttons[1].classList.add('active');

        document.getElementById(`tab-${tabName}`).classList.add('active');
        if(tabName === 'saved') loadSavedIdeas();
    }

    async function loadAllData() {
        try {
            const [wRes, cRes, sRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`),
                fetch(`/api/stories?setting_id=${settingId}`)
            ]);
            globalWorld = await wRes.json();
            globalChars = await cRes.json();
            if (sRes.ok) {
                globalStories = await sRes.json();
                globalStories.sort((a,b) => a.episode_number - b.episode_number);
                initRangeSelects();
            }
        } catch (e) { console.warn("Data load fail:", e); }
    }

    function initRangeSelects() {
        const selects = ['plotStartEp', 'plotEndEp', 'contentStartEp', 'contentEndEp'];
        if (globalStories.length === 0) return;
        selects.forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">ì„ íƒ ì•ˆí•¨</option>';
            globalStories.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.episode_number;
                opt.innerText = `${s.episode_number}í™”`;
                el.appendChild(opt);
            });
        });
    }

    window.selectMode = function(mode, el) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('selected'));
        el.classList.add('selected');
    }

    // --- 1. AI ìƒì„± ë¡œì§ (systemPrompt ì €ì¥) ---
    window.generateIdea = async function() {
        let input = document.getElementById('userInput').value;
        if (!input.trim() && currentMode !== 'next_episode') return alert("ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        if (!input.trim() && currentMode === 'next_episode') input = "ë‹¤ìŒ íšŒì°¨ì— ì´ì–´ì§ˆ í¥ë¯¸ë¡œìš´ ì „ê°œë¥¼ ì¶”ì²œí•´ì¤˜.";

        const btn = document.querySelector('.btn-generate');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒê° ì¤‘...';

        try {
            const pStart = document.getElementById('plotStartEp').value;
            const pEnd = document.getElementById('plotEndEp').value;
            const cStart = document.getElementById('contentStartEp').value;
            const cEnd = document.getElementById('contentEndEp').value;

            const plotRangeStr = (pStart && pEnd) ? `${pStart}~${pEnd}í™”` : "";
            const contentRangeStr = (cStart && cEnd) ? `${cStart}~${cEnd}í™”` : "";

            let contextText = `[ì„¸ê³„ê´€]: ${globalWorld.slice(0,5).map(w=>w.title).join(',')}\n[ì¸ë¬¼]: ${globalChars.slice(0,5).map(c=>c.name).join(',')}`;
            
            if(pStart && pEnd) {
                const plots = globalStories.filter(s=>s.episode_number>=Math.min(pStart,pEnd) && s.episode_number<=Math.max(pStart,pEnd));
                contextText += `\n[ì°¸ê³  ì¤„ê±°ë¦¬]:\n${plots.map(s=>`(${s.episode_number}í™”) ${s.content_plot||''}`).join('\n')}`;
            }
            if(cStart && cEnd) {
                 const contents = globalStories.filter(s=>s.episode_number>=Math.min(cStart,cEnd) && s.episode_number<=Math.max(cStart,cEnd));
                 contextText += `\n[ì°¸ê³  ë³¸ë¬¸(ë°œì·Œ)]:\n${contents.map(s=>`(${s.episode_number}í™”) ${s.content ? s.content.slice(0, 300) + "..." : ""}`).join('\n')}`;
            }

            const role = "ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì‘ê°€ì´ì ì°½ì˜ë ¥ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.";
            let systemPrompt = "";
            if (currentMode === 'next_episode') systemPrompt = `${role} ë‹¤ìŒ í™” ì‹œë‚˜ë¦¬ì˜¤ 3ê°€ì§€ë¥¼ 'ê¸°-ìŠ¹-ì „-ê²°'ë¡œ ì œì•ˆí•˜ì„¸ìš”.`;
            else systemPrompt = `${role} ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•˜ì„¸ìš”.`;

            const fullPrompt = `${contextText}\n\n[ì‚¬ìš©ì ì…ë ¥] "${input}"\n\n[ìš”ì²­] ìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì•„ì´ë””ì–´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`;

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gemini-3-flash-preview",
                    payload: {
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    }
                })
            });
            
            const data = await res.json();
            const resultText = data.candidates[0].content.parts[0].text;
            
            const metaData = {
                plotRange: plotRangeStr,
                contentRange: contentRangeStr,
                userInput: input,
                systemPrompt: systemPrompt // ğŸŒŸ ë©”íƒ€ë°ì´í„°ì— systemPrompt ì¶”ê°€
            };

            addResultCard(resultText, currentMode, metaData);
            switchRightTab('result'); 

        } catch (e) { alert("ì˜¤ë¥˜: " + e.message); } 
        finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // ğŸŒŸ [ìˆ˜ì •] ì¹´ë“œ ìƒì„± ì‹œ systemPrompt ì €ì¥
    function addResultCard(text, type, metaData) {
        const container = document.getElementById('resultContainer');
        if (container.querySelector('.fa-lightbulb')) container.innerHTML = '';

        const card = document.createElement('div');
        card.className = 'idea-card';
        
        card.dataset.plotRange = metaData ? metaData.plotRange : "";
        card.dataset.contentRange = metaData ? metaData.contentRange : "";
        card.dataset.userInput = metaData ? encodeURIComponent(metaData.userInput) : "";
        card.dataset.systemPrompt = metaData ? encodeURIComponent(metaData.systemPrompt || "") : ""; // ğŸŒŸ ì €ì¥
        card.dataset.type = type;

        card.innerHTML = `
            <div class="idea-header">
                <span class="idea-type">${type}</span>
                <div class="card-actions">
                    <button class="btn-icon" onclick="copyText(this)" title="ë³µì‚¬"><i class="far fa-copy"></i></button>
                    <button class="btn-icon" onclick="saveFromCard(this)" title="ë³´ê´€í•¨ì— ì €ì¥"><i class="fas fa-save"></i></button>
                </div>
            </div>
            <div class="idea-content">${text}</div>
            <div class="idea-meta">
                ${metaData && metaData.userInput ? `<strong>Q:</strong> ${metaData.userInput}<br>` : ''}
                ${metaData && metaData.plotRange ? `<span style="margin-right:10px;">ğŸ“š ì¤„ê±°ë¦¬: ${metaData.plotRange}</span>` : ''}
                ${metaData && metaData.contentRange ? `<span>ğŸ“– ë³¸ë¬¸: ${metaData.contentRange}</span>` : ''}
            </div>
        `;
        container.prepend(card);
    }

    window.copyText = function(btn) {
        const content = btn.closest('.idea-card').querySelector('.idea-content').innerText;
        navigator.clipboard.writeText(content).then(() => alert("ë³µì‚¬ë¨"));
    }

    // --- 2. ì•„ì´ë””ì–´ ì €ì¥ ë° ë³´ê´€í•¨ ë¡œì§ ---

    window.saveFromCard = async function(btn) {
        const card = btn.closest('.idea-card');
        const content = card.querySelector('.idea-content').innerText;
        
        const type = card.dataset.type;
        const plotRange = card.dataset.plotRange;
        const contentRange = card.dataset.contentRange;
        const userInput = decodeURIComponent(card.dataset.userInput || "");
        const systemPrompt = decodeURIComponent(card.dataset.systemPrompt || ""); // ğŸŒŸ ê°€ì ¸ì˜¤ê¸°

        await saveIdeaToDB({ type, content, plotRange, contentRange, userInput, systemPrompt });
    }

    window.saveManualIdea = async function() {
        const content = document.getElementById('manualIdeaInput').value;
        if (!content.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        await saveIdeaToDB({ type: "manual", content: content, userInput: "ì§ì ‘ ì…ë ¥", systemPrompt: "ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ì‘ê°€ì…ë‹ˆë‹¤." });
        document.getElementById('manualIdeaInput').value = '';
    }

    // ğŸŒŸ [ìˆ˜ì •] DB ì „ì†¡ ì‹œ systemPrompt í¬í•¨
    async function saveIdeaToDB(data) {
        try {
            const res = await fetch('/api/ideas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    setting_id: settingId, 
                    type: data.type, 
                    content: data.content,
                    plot_range: data.plotRange,
                    content_range: data.contentRange,
                    user_input: data.userInput,
                    systemPrompt: data.systemPrompt // ğŸŒŸ ì „ì†¡
                })
            });
            if (res.ok) {
                alert("ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                if(document.getElementById('tab-saved').classList.contains('active')) loadSavedIdeas();
            }
        } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
    }

    // ğŸŒŸ [ìˆ˜ì •] ë³´ê´€í•¨ ë¡œë“œ ë° ëª¨ë‹¬ ì—´ê¸° ì‹œ systemPrompt ì „ë‹¬
    async function loadSavedIdeas() {
        const container = document.getElementById('savedListContainer');
        try {
            const res = await fetch(`/api/ideas?setting_id=${settingId}`);
            const ideas = await res.json();
            
            container.innerHTML = '';
            if (ideas.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">ì €ì¥ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            ideas.forEach(idea => {
                const card = document.createElement('div');
                card.className = 'idea-card';
                card.style.borderLeftColor = '#2ecc71'; 
                const date = new Date(idea.created_at).toLocaleDateString();
                
                // ğŸŒŸ openTreatmentModal í˜¸ì¶œ ì‹œ systemPrompt ì „ë‹¬ (encodeURIComponentë¡œ ì•ˆì „í•˜ê²Œ)
                card.innerHTML = `
                    <div class="idea-header">
                        <span class="idea-type">${idea.type || 'Memo'} (${date})</span>
                        <div class="card-actions">
                            <button class="btn-icon" onclick="openTreatmentModal('${encodeURIComponent(idea.content)}', '${encodeURIComponent(idea.systemPrompt || '')}')" title="ì´ ì•„ì´ë””ì–´ë¡œ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ì‘ì„±"><i class="fas fa-film"></i></button>
                            <button class="btn-icon delete" onclick="deleteIdea(${idea.id})" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="idea-content" style="max-height:150px; overflow-y:auto;">${idea.content}</div>
                    <div class="idea-meta">
                        ${idea.user_input ? `<strong>Q:</strong> ${idea.user_input}<br>` : ''}
                        ${idea.plot_range ? `<span style="margin-right:10px;">ğŸ“š ì¤„ê±°ë¦¬: ${idea.plot_range}</span>` : ''}
                        ${idea.content_range ? `<span>ğŸ“– ë³¸ë¬¸: ${idea.content_range}</span>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        } catch(e) { console.error(e); }
    }

    window.deleteIdea = async function(id) {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/ideas/${id}`, { method: 'DELETE' });
        loadSavedIdeas();
    }

    // --- 3. íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ë¯¸ë¦¬ë³´ê¸° & ì €ì¥ ë¡œì§ ---

    // ğŸŒŸ [ìˆ˜ì •] ëª¨ë‹¬ ì—´ ë•Œ systemPrompt ì„¤ì •
    window.openTreatmentModal = function(encodedContent, encodedPrompt) {
        const content = decodeURIComponent(encodedContent);
        const prompt = decodeURIComponent(encodedPrompt || "");
        
        document.getElementById('modalIdeaContent').value = content;
        document.getElementById('modalSystemPrompt').value = prompt; // ğŸŒŸ hidden inputì— ì €ì¥
        
        let nextEp = 1;
        if(globalStories.length > 0) nextEp = globalStories[globalStories.length-1].episode_number + 1;
        document.getElementById('targetEpNum').value = nextEp;

        document.getElementById('treatmentModal').style.display = 'flex';
    }

    // ğŸŒŸ [ìˆ˜ì •] íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ìƒì„± ì‹œ ì €ì¥ëœ systemPrompt ì‚¬ìš©
    window.previewTreatment = async function() {
        const ideaContent = document.getElementById('modalIdeaContent').value;
        const epNum = document.getElementById('targetEpNum').value;
        const systemPrompt = document.getElementById('modalSystemPrompt').value;
        
        if(!epNum) return alert("íšŒì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.getElementById('btnGenPreview');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‘ê°€ ë¹™ì˜ ì¤‘...';

        try {
            // 1. ğŸŒ ì„¸ê³„ê´€ ë° ìºë¦­í„° ì •ë³´ ë¬¸ìì—´ë¡œ ë³€í™˜
            // (globalWorld, globalCharsëŠ” init()ì—ì„œ ì´ë¯¸ ë¡œë“œëœ ì „ì—­ ë³€ìˆ˜ì…ë‹ˆë‹¤)
            const worldText = globalWorld.length > 0 
                ? globalWorld.map(w => `- ${w.title}: ${w.description} (í‚¤ì›Œë“œ: ${w.keywords})`).join('\n')
                : "íŠ¹ë³„í•œ ì„¸ê³„ê´€ ì„¤ì • ì—†ìŒ.";

            const charText = globalChars.length > 0
                ? globalChars.map(c => `- ${c.name} (${c.role}): ${c.description}`).join('\n')
                : "íŠ¹ë³„í•œ ìºë¦­í„° ì„¤ì • ì—†ìŒ.";

            // 2. ğŸ“š ì„ íƒëœ ë²”ìœ„ì˜ ì¤„ê±°ë¦¬/ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸° (ë§¥ë½ ë³´ê°•)
            const pStart = document.getElementById('plotStartEp').value;
            const pEnd = document.getElementById('plotEndEp').value;
            let storyContext = "";

            if(pStart && pEnd && globalStories.length > 0) {
                const plots = globalStories.filter(s => 
                    s.episode_number >= Math.min(pStart, pEnd) && 
                    s.episode_number <= Math.max(pStart, pEnd)
                );
                if(plots.length > 0) {
                    storyContext = `[ì´ì „ ì´ì•¼ê¸° íë¦„ (${pStart}~${pEnd}í™”)]\n` + 
                                   plots.map(s => `(${s.episode_number}í™”) ${s.content_plot || 'ì¤„ê±°ë¦¬ ì—†ìŒ'}`).join('\n');
                }
            }

            // 3. âœï¸ í”„ë¡¬í”„íŠ¸ ì‘ì„± (í†¤ì•¤ë§¤ë„ˆ, ëŒ€ì‚¬ëŸ‰, ìŠ¤íƒ€ì¼ ê°•ë ¥ ì§€ì‹œ)
            const prompt = `
                ${systemPrompt ? `[ì‹œìŠ¤í…œ ì„¤ì •] ${systemPrompt}` : ''}

                [ì—­í• ]
                ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ê³„ì˜ 'ê¹€ì€ìˆ™'ì´ë¼ ë¶ˆë¦¬ëŠ” ì²œì¬ ë“œë¼ë§ˆ ì‘ê°€ì…ë‹ˆë‹¤. 
                ìºë¦­í„°ì˜ 'í‹°í‚¤íƒ€ì¹´'ê°€ ì‚´ì•„ìˆê³ , ì¥ë©´ ë¬˜ì‚¬ê°€ ìƒë™ê° ë„˜ì¹˜ëŠ” ê²ƒì´ íŠ¹ì§•ì…ë‹ˆë‹¤.

                [í˜„ì¬ ì‘í’ˆ ì„¤ì •]
                1. ì„¸ê³„ê´€:
                ${worldText}

                2. ë“±ì¥ì¸ë¬¼ (ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ë°˜ë“œì‹œ ë°˜ì˜í•  ê²ƒ):
                ${charText}

                ${storyContext}

                [ì‘ì—… ìš”ì²­]
                ìœ„ [ì„¤ì •]ê³¼ ì•„ë˜ [ì•„ì´ë””ì–´]ë¥¼ ê²°í•©í•˜ì—¬ **ì œ ${epNum}í™”ì˜ ìƒì„¸ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸**ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.
                
                [í•µì‹¬ ì•„ì´ë””ì–´]
                ${ideaContent}

                [â­â­â­ í•„ìˆ˜ ì§‘í•„ ê°€ì´ë“œë¼ì¸ (ë°˜ë“œì‹œ ì¤€ìˆ˜)]
                1. **êµ¬ì„±:** ì „ì²´ ë‚´ìš©ì„ ê¸°ìŠ¹ì „ê²°ì´ ìˆëŠ” **8ê°œì˜ Scene(ì¥ë©´)**ìœ¼ë¡œ ë‚˜ëˆ„ì„¸ìš”.
                2. **ë¶„ëŸ‰:** ê° Sceneë§ˆë‹¤ **ëŒ€ì‚¬ë¥¼ ìµœì†Œ 7~10íšŒ ì´ìƒ** ì£¼ê³ ë°›ë„ë¡ ê¸¸ê²Œ ì‘ì„±í•˜ì„¸ìš”. ë‚´ìš©ì´ ì§§ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤.
                3. **í˜•ì‹ (Script Format):** ì„œìˆ í˜• ì¤„ê¸€ ê¸ˆì§€. ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
                   - **ì§€ë¬¸:** (ìƒí™©, í–‰ë™, í‘œì • ë¬˜ì‚¬)
                   - **ì´ë¦„:** "ëŒ€ì‚¬ ë‚´ìš©"
                4. **í†¤ì•¤ë§¤ë„ˆ:** - ìºë¦­í„° ì„¤ì •ì„ ì°¸ê³ í•˜ì—¬ ê°ì ê³ ìœ ì˜ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                   - ìƒí™©ì— ë§ëŠ” ìœ ë¨¸, ê¸´ì¥ê°, ê°ì •ì„ ì„ ì‚´ë¦¬ì„¸ìš”.
                   - ì§€ë¬¸ì€ êµ¬ì²´ì ì´ê³  ì‹œê°ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ì„¸ìš”. (ì˜ˆ: "ë¯¼ìš°ê°€ ì›ƒì—ˆë‹¤" (X) -> "ë¯¼ìš°ê°€ ì–´ì´ì—†ë‹¤ëŠ” ë“¯ í”¼ì‹ ì›ƒìœ¼ë©° ë¨¸ë¦¬ë¥¼ ì“¸ì–´ë„˜ê¸´ë‹¤." (O))

                [ì¶œë ¥ í¬ë§· (JSON Only)]
                ë°˜ë“œì‹œ ì„¤ëª… ì—†ì´ ì•„ë˜ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.
                [
                    {
                        "title": "ì†Œì œëª© (ì˜ˆ: ìƒˆë²½ì˜ ì¹¨ì…ì)", 
                        "description": "ì§€ë¬¸: ì¹ í‘ ê°™ì€ ì–´ë‘  ì†, ë†ì¥ ìš¸íƒ€ë¦¬ ë„ˆë¨¸ë¡œ ë¶‰ì€ ì•ˆê´‘ì´ ë²ˆëœ©ì¸ë‹¤.\\nëŸ­ìŠ¤: \\"ì£¼êµ°! ê¸°ìƒí•˜ì‹­ì‹œì˜¤! ì ë“¤ì´ ëª°ë ¤ì˜µë‹ˆë‹¤!\\"\\në¯¼ìš°: (ë¹„ëª½ì‚¬ëª½í•˜ë©°) \\"ì•„... ë˜ ì¥ìƒˆë¼ë“¤ì´ì•¼?\\"\\nì§€ë¬¸: ë¯¼ìš°ê°€ ê·€ì°®ë‹¤ëŠ” ë“¯ í•˜í’ˆì„ í•˜ë©° ëª½ë‘¥ì´ë¥¼ ì§‘ì–´ ë“ ë‹¤."
                    }
                ]
            `;

            // 4. API ìš”ì²­
            const aiRes = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gemini-3-flash-preview",
                    payload: { contents: [{ parts: [{ text: prompt }] }] }
                })
            });
            const aiData = await aiRes.json();
            let text = aiData.candidates[0].content.parts[0].text;
            
            // JSON íŒŒì‹±
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (!jsonMatch) throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: AIê°€ í˜•ì‹ì„ ì§€í‚¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            
            const rawScenes = JSON.parse(jsonMatch[0]);

            // ë¯¸ë¦¬ë³´ê¸° UI ë Œë”ë§
            renderPreviewList(rawScenes);

            // UI ë³€ê²½
            document.getElementById('treatmentPreviewArea').style.display = 'block';
            document.getElementById('btnGenPreview').style.display = 'none';
            document.getElementById('btnSaveFinal').style.display = 'block';

        } catch (e) {
            console.error(e);
            alert("ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function renderPreviewList(scenes) {
        const listEl = document.getElementById('scenePreviewList');
        listEl.innerHTML = '';

        scenes.forEach((scene, index) => {
            const div = document.createElement('div');
            div.style.cssText = "background:#fff; border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:10px;";
            div.innerHTML = `
                <div style="font-weight:bold; color:#2ecc71; margin-bottom:5px;">Scene ${index + 1}</div>
                <input type="text" class="preview-title" value="${scene.title}" placeholder="ì”¬ ì œëª©" style="width:100%; margin-bottom:5px; font-weight:bold;">
                <textarea class="preview-desc" rows="3" style="width:100%; resize:vertical;" placeholder="ì”¬ ë‚´ìš©">${scene.description}</textarea>
            `;
            listEl.appendChild(div);
        });
    }

    window.saveScenesFinal = async function() {
        const epNum = document.getElementById('targetEpNum').value;
        const listEl = document.getElementById('scenePreviewList');
        const sceneDivs = listEl.querySelectorAll('div[style*="background"]');

        if (sceneDivs.length === 0) return alert("ì €ì¥í•  ì”¬ì´ ì—†ìŠµë‹ˆë‹¤.");

        let combinedDescription = "";

        sceneDivs.forEach((div, index) => {
            const title = div.querySelector('.preview-title').value;
            const desc = div.querySelector('.preview-desc').value;
            combinedDescription += `==Scene ${index + 1}. ${title}==:\n${desc}\n\n`;
        });

        const scenesToSave = [{
            scene_number: 1,
            title: `${epNum}í™” í†µí•© íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸`,
            description: combinedDescription.trim()
        }];

        try {
            const res = await fetch('/api/scenes/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    setting_id: settingId,
                    episode_number: epNum,
                    scenes: scenesToSave
                })
            });

            if (res.ok) {
                alert(`ì €ì¥ ì™„ë£Œ!`);
                closeTreatmentModal();
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }

    window.closeTreatmentModal = function() {
        document.getElementById('treatmentModal').style.display = 'none';
        
        setTimeout(() => {
            document.getElementById('treatmentPreviewArea').style.display = 'none';
            document.getElementById('scenePreviewList').innerHTML = '';
            document.getElementById('btnGenPreview').style.display = 'block';
            document.getElementById('btnSaveFinal').style.display = 'none';
        }, 300);
    }

    init();
</script>

</body>
</html>