<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì„¤ í”Œë¡¯ ë° ì—í”¼ì†Œë“œ ê´€ë¦¬ (ë‚´ìš© ê²€ì¦ ë° ìˆ˜ì •)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root { font-family: 'Inter', sans-serif; }
        .ai-output-container {
            white-space: pre-wrap;
            background-color: #f7f7f7;
            border-left: 4px solid #3b82f6;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .nav-link { @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out; }
    </style>
</head>
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-lg">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center justify-between h-14 sm:h-16">
            <div class="flex-1 flex items-center justify-start">
                <a href="#" class="flex-shrink-0 text-gray-800 text-lg font-bold"></a>
            </div>
            <div class="flex items-center sm:ml-6">
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1">
                    <a href="/" class="nav-link hover:bg-gray-100">ê¸€ì“°ê¸°</a>
                    <a href="/index3" class="nav-link hover:bg-gray-100">ì„¸ê³„ê´€êµ¬ì„±ê´€ë¦¬</a>
                    <a href="/index4" class="nav-link hover:bg-gray-100">ì—í”¼ì†Œë“œìƒì„±ê¸°</a>
                    <a href="/index2" class="nav-link hover:bg-gray-100">ë“±ì¥ì¸ë¬¼ê´€ë¦¬</a>
                    <a href="/storys2" class="nav-link hover:bg-gray-100">íšŒì°¨ ìƒì„¸ í¸ì§‘</a>
                    <a href="/storys1" class="nav-link bg-blue-100 text-blue-800 hover:bg-blue-200" aria-current="page">ì†Œì„¤ ë‚´ìš© ê²€ì¦</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<div id="app" class="mt-16 sm:mt-20 w-full max-w-7xl bg-white shadow-2xl rounded-xl p-4 sm:p-8 border border-gray-100 mb-8 flex flex-col lg:flex-row gap-6">

    <div class="lg:w-1/3 border-r border-gray-200 p-6 flex flex-col">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">í”Œë¡¯ ì„¤ì • ëª©ë¡</h2>
        <p id="system-info" class="text-xs text-gray-500 mb-4">API ìƒíƒœ: ì—°ê²° ì¤‘...</p>
        <div id="plot-list-container" class="flex-grow space-y-2 overflow-y-auto custom-scroll" style="max-height: 60vh;">
            <p id="loading-plots" class="text-center text-blue-500">
                <span class="spinner inline-block align-middle mr-2"></span> ì„¤ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </p>
        </div>
        <button id="refresh-data-button" class="mt-4 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg text-sm">
            ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        </button>
    </div>

    <div class="lg:w-2/3 p-6 flex flex-col">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
            <span id="selected-plot-title" class="text-indigo-600">ì„ íƒëœ ì„¤ì • ì—†ìŒ</span>
        </h2>

        <div class="flex-grow grid grid-rows-[max-content_1fr] gap-6">
            <div class="border rounded-xl p-4 shadow-sm bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">íšŒì°¨ ëª©ë¡</h3>
                <div id="episode-list-container" class="h-32 max-h-32 overflow-y-auto custom-scroll space-y-1">
                    <p id="episode-placeholder" class="text-gray-400 text-center mt-8">ì„¤ì •ì„ ì„ íƒí•˜ì‹œë©´ íšŒì°¨ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="border rounded-xl p-4 shadow-md flex flex-col">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2 flex justify-between items-center">
                    <span id="selected-episode-title" class="text-blue-600">íšŒì°¨ ìƒì„¸ ë‚´ìš©</span>
                    <span id="current-episode-info" class="text-xs text-gray-400"></span>
                </h3>

                <div id="episode-detail-content" class="flex-grow overflow-y-auto custom-scroll mb-4 text-gray-700 text-sm h-64 border p-2 rounded bg-gray-50">
                    <p class="text-gray-400 text-center mt-20">íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>

                <div id="ai-section" class="pt-4 border-t">
                    <button id="ai-analysis-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center mb-4" disabled>
                        <span id="ai-button-text">ì†Œì„¤ ë‚´ìš© ê²€ì¦ ë° ë¶„ì„ (ë¦¬í¬íŠ¸ ìƒì„±)</span>
                        <span id="ai-spinner" class="spinner ml-3 hidden"></span>
                    </button>

                    <div id="ai-output" class="p-4 rounded-lg ai-output-container text-sm hidden mb-4 max-h-60 overflow-y-auto custom-scroll">
                        </div>
                </div>

                <div id="rewrite-section" class="pt-4 border-t border-gray-300 mt-2 hidden">
                    <h4 class="font-bold text-gray-800 mb-2">âœï¸ ë‚´ìš© ê°œì„  ë° ì €ì¥</h4>
                    
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">ê°œì„  ìš”ì²­ ì‚¬í•­ (Prompt)</label>
                        <textarea id="rewrite-instructions" class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="2" placeholder="ì˜ˆ: ì£¼ì¸ê³µì˜ ê°ì •ì„ ë” ê²©í•˜ê²Œ í‘œí˜„í•´ì¤˜, ë§ˆì§€ë§‰ ëŒ€ì‚¬ë¥¼ ì¢€ ë” ë¹„ê¼¬ë“¯ì´ ìˆ˜ì •í•´ì¤˜..."></textarea>
                    </div>
                    
                    <button id="ai-rewrite-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow flex items-center justify-center mb-4">
                        <span id="rewrite-button-text">AIë¡œ ë‚´ìš© ë‹¤ì‹œ ì“°ê¸° (Rewrite)</span>
                        <span id="rewrite-spinner" class="spinner ml-3 hidden" style="border-top-color: white;"></span>
                    </button>

                    <div id="rewrite-result-container" class="hidden">
                        <label class="block text-xs font-medium text-gray-600 mb-1">ìˆ˜ì •ëœ ë‚´ìš© (í¸ì§‘ í›„ ì €ì¥ ê°€ëŠ¥)</label>
                        <textarea id="revised-content-editor" class="w-full p-3 border border-green-400 rounded-md text-sm bg-white focus:outline-none h-64 custom-scroll font-medium text-gray-800"></textarea>
                        
                        <div class="flex gap-2 mt-2">
                            <button id="save-revision-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition transform active:scale-95">
                                ë³€ê²½ ë‚´ìš© ì €ì¥í•˜ê¸° (DB ë°˜ì˜)
                            </button>
                            <button onclick="document.getElementById('rewrite-result-container').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- ê¸€ë¡œë²Œ ë³€ìˆ˜ ë° ì„¤ì • ---
    const API_BASE_URL = 'http://localhost:3000/api';

    // Gemini API ì„¤ì • (í´ë¼ì´ì–¸íŠ¸ ì§ì ‘ í˜¸ì¶œ)
    const GEMINI_MODEL = "gemini-3.0-flash";
    const API_KEY = "AIzaSyCzR2rKB7ZtwYrXUZsE65_DkVyJlXXscqU"; // âš ï¸ ì‹¤ì œ ë°°í¬ ì‹œì—ëŠ” ì„œë²„ í”„ë¡ì‹œ ì‚¬ìš© ê¶Œì¥
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;

    let allSettings = [];
    let currentSettingStories = [];
    let selectedSettingId = null;
    let selectedStoryId = null;
    let currentStoryData = null; // í˜„ì¬ ì„ íƒëœ ìŠ¤í† ë¦¬ ê°ì²´ ë³´ê´€ìš©
    
    // [ì¶”ê°€] ìƒì„¸ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° (ì„¸ê³„ê´€, ìºë¦­í„° ë“±)
    let contextData = ""; 

    // UI ìš”ì†Œ
    const plotListContainer = document.getElementById('plot-list-container');
    const episodeListContainer = document.getElementById('episode-list-container');
    const episodeDetailContent = document.getElementById('episode-detail-content');
    const selectedPlotTitle = document.getElementById('selected-plot-title');
    const selectedEpisodeTitle = document.getElementById('selected-episode-title');
    
    // ë¶„ì„ ê´€ë ¨ ë²„íŠ¼
    const aiAnalysisButton = document.getElementById('ai-analysis-button');
    const aiButtonText = document.getElementById('ai-button-text');
    const aiSpinner = document.getElementById('ai-spinner');
    const aiOutput = document.getElementById('ai-output');
    
    // ìˆ˜ì • ê´€ë ¨ ë²„íŠ¼
    const rewriteSection = document.getElementById('rewrite-section');
    const rewriteInstructions = document.getElementById('rewrite-instructions');
    const aiRewriteButton = document.getElementById('ai-rewrite-button');
    const rewriteButtonText = document.getElementById('rewrite-button-text');
    const rewriteSpinner = document.getElementById('rewrite-spinner');
    const rewriteResultContainer = document.getElementById('rewrite-result-container');
    const revisedContentEditor = document.getElementById('revised-content-editor');
    const saveRevisionButton = document.getElementById('save-revision-button');

    const loadingPlots = document.getElementById('loading-plots');
    const systemInfo = document.getElementById('system-info');
    const episodePlaceholder = document.getElementById('episode-placeholder');

    // --- ì´ˆê¸°í™” ë° URL íŒŒë¼ë¯¸í„° í™•ì¸ ---
    window.onload = async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const paramId = urlParams.get('setting_id') || urlParams.get('id');

        await fetchSettings(); // ì „ì²´ ëª©ë¡ ë¨¼ì € ë¡œë“œ

        // URL íŒŒë¼ë¯¸í„°ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ì„¤ì • ìë™ ì„ íƒ
        if (paramId) {
            await handlePlotSelection(paramId);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.getElementById('refresh-data-button').addEventListener('click', () => fetchSettings());
        aiAnalysisButton.addEventListener('click', performAIAnalysis);
        aiRewriteButton.addEventListener('click', performRewrite);
        saveRevisionButton.addEventListener('click', saveRevisedStory);
    };

    // --- API í†µì‹  ---

    async function fetchSettings() {
        if(loadingPlots) loadingPlots.classList.remove('hidden');
        try {
            const response = await fetch(`${API_BASE_URL}/settings-list`);
            if (!response.ok) throw new Error('Network response was not ok');
            allSettings = await response.json();
            renderPlotList();
            systemInfo.textContent = `API ìƒíƒœ: ì—°ê²° ì„±ê³µ (${allSettings.length}ê°œ ì„¤ì •)`;
        } catch (error) {
            console.error(error);
            systemInfo.textContent = 'API ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨';
            if(loadingPlots) loadingPlots.innerHTML = `<p class="text-red-500">ì„œë²„ ì—°ê²° ì‹¤íŒ¨</p>`;
        } finally {
            if(loadingPlots) loadingPlots.classList.add('hidden');
        }
    }

    // [í•µì‹¬] ì„¤ì • ì„ íƒ ì‹œ ìƒì„¸ ì»¨í…ìŠ¤íŠ¸(ì„¸ê³„ê´€, ìºë¦­í„°) ë¡œë“œ
    async function loadContextData(settingId) {
        try {
            // Promise.allë¡œ ë³‘ë ¬ ìš”ì²­
            const [sRes, wRes, cRes] = await Promise.all([
                fetch(`${API_BASE_URL}/load-settings?id=${settingId}`).then(r => r.json()),
                fetch(`${API_BASE_URL}/worldsettings?setting_id=${settingId}`).then(r => r.json()),
                fetch(`${API_BASE_URL}/characters?setting_id=${settingId}`).then(r => r.json())
            ]);

            // AIì—ê²Œ ì „ë‹¬í•  ìƒì„¸ ë¬¸ìì—´ ìƒì„±
            contextData = `
[ì œëª©]: ${sRes.title}

[ì„¸ê³„ê´€ ìƒì„¸]: 
${Array.isArray(wRes) && wRes.length > 0 ? wRes.map(w => `- ${w.title}: ${w.description} (í‚¤ì›Œë“œ: ${w.keywords || ''})`).join('\n') : 'ìƒì„¸ ì„¸ê³„ê´€ ì •ë³´ ì—†ìŒ'}

[ì£¼ìš” ë“±ì¥ì¸ë¬¼]: 
${Array.isArray(cRes) && cRes.length > 0 ? cRes.map(c => `- ${c.name} (${c.role}): ${c.description}`).join('\n') : 'ìƒì„¸ ë“±ì¥ì¸ë¬¼ ì •ë³´ ì—†ìŒ'}
            
[ê¸°ë³¸ í”Œë¡¯]: ${sRes.plotDetails || 'ì—†ìŒ'}
            `;
            console.log("Context Loaded:", contextData);

        } catch (e) { 
            console.warn("Context load failed", e);
            contextData = "ìƒì„¸ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨. ê¸°ë³¸ ì •ë³´ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.";
        }
    }

    async function handlePlotSelection(settingId) {
        selectedSettingId = settingId.toString();
        selectedStoryId = null;

        const setting = allSettings.find(p => p.id.toString() === selectedSettingId);
        if (setting) {
            selectedPlotTitle.textContent = setting.title;
        }

        renderPlotList(); // UI ê°±ì‹  (ì„ íƒ í‘œì‹œ)
        
        // íšŒì°¨ ë¡œë“œ
        await fetchStoriesForSetting(selectedSettingId);
        
        // [ì¤‘ìš”] ìƒì„¸ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ (AIìš©)
        await loadContextData(selectedSettingId);
        
        renderEpisodeDetail();
    }

    async function fetchStoriesForSetting(settingId) {
        episodeListContainer.innerHTML = `<p class="text-center text-blue-500 mt-8"><span class="spinner inline-block align-middle mr-2"></span> ë¡œë”© ì¤‘...</p>`;
        try {
            const response = await fetch(`${API_BASE_URL}/stories?setting_id=${settingId}`);
            currentSettingStories = await response.json();
            renderEpisodeList();
        } catch (error) {
            episodeListContainer.innerHTML = `<p class="text-red-500 text-center">íšŒì°¨ ë¡œë“œ ì‹¤íŒ¨</p>`;
        }
    }

    async function saveRevisedStory() {
        if (!selectedStoryId || !currentStoryData) return;

        const newContent = revisedContentEditor.value;
        if (!newContent.trim()) {
            alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm("ì •ë§ë¡œ ì´ ë‚´ìš©ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)")) return;

        try {
            const response = await fetch(`${API_BASE_URL}/stories/${selectedStoryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    episode_number: currentStoryData.episode_number,
                    title: currentStoryData.title,
                    content: newContent
                })
            });

            if (!response.ok) throw new Error('Save failed');

            alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            
            // UI ê°±ì‹ 
            currentStoryData.content = newContent; 
            renderEpisodeDetail(false); 
            rewriteResultContainer.classList.add('hidden'); 
            rewriteInstructions.value = ""; 

        } catch (error) {
            console.error(error);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
    }

    // --- ë Œë”ë§ í•¨ìˆ˜ ---

    function renderPlotList() {
        plotListContainer.innerHTML = '';
        allSettings.forEach(setting => {
            const isActive = setting.id.toString() === selectedSettingId;
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg cursor-pointer transition ${isActive ? 'bg-indigo-100 border-indigo-500 border-2' : 'bg-white hover:bg-gray-100 border border-gray-200'}`;
            div.innerHTML = `<h4 class="font-semibold text-gray-700">${setting.title}</h4>`;
            div.onclick = () => handlePlotSelection(setting.id.toString());
            plotListContainer.appendChild(div);
        });
    }

    function renderEpisodeList() {
        episodeListContainer.innerHTML = '';
        if (currentSettingStories.length === 0) {
            episodeListContainer.innerHTML = `<p class="text-gray-400 text-center mt-4">íšŒì°¨ ì—†ìŒ</p>`;
            return;
        }
        currentSettingStories.forEach(story => {
            const isActive = story.id.toString() === selectedStoryId;
            const div = document.createElement('div');
            div.className = `p-2 rounded-md cursor-pointer text-sm ${isActive ? 'bg-blue-100 text-blue-700 font-bold' : 'hover:bg-gray-50 text-gray-600'}`;
            div.innerText = `[${story.episode_number}í™”] ${story.title || 'ì œëª© ì—†ìŒ'}`;
            div.onclick = () => {
                selectedStoryId = story.id.toString();
                currentStoryData = story; 
                renderEpisodeList();
                renderEpisodeDetail();
            };
            episodeListContainer.appendChild(div);
        });
    }

    function renderEpisodeDetail(shouldScroll = true) {
        if (!selectedStoryId || !currentStoryData) {
            selectedEpisodeTitle.textContent = "íšŒì°¨ ìƒì„¸ ë‚´ìš©";
            episodeDetailContent.innerHTML = `<p class="text-gray-400 text-center mt-20">íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>`;
            aiAnalysisButton.disabled = true;
            rewriteSection.classList.add('hidden');
            return;
        }

        selectedEpisodeTitle.textContent = `[${currentStoryData.episode_number}í™”] ${currentStoryData.title}`;
        episodeDetailContent.innerHTML = `<div class="whitespace-pre-wrap leading-relaxed">${currentStoryData.content || 'ë‚´ìš© ì—†ìŒ'}</div>`;
        
        if (shouldScroll) episodeDetailContent.scrollTop = 0;

        aiAnalysisButton.disabled = false;
        rewriteSection.classList.remove('hidden');
        rewriteResultContainer.classList.add('hidden'); 
        aiOutput.classList.add('hidden');
    }

    // --- AI ë¡œì§ (ìƒì„¸ contextData í™œìš©) ---

    // 1. ë¶„ì„
    async function performAIAnalysis() {
        if (!selectedSettingId || !selectedStoryId) return;

        aiButtonText.textContent = 'ë¶„ì„ ì¤‘...';
        aiSpinner.classList.remove('hidden');
        aiAnalysisButton.disabled = true;
        aiOutput.classList.add('hidden');

        const systemPrompt = "ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ì†Œì„¤ ì—ë””í„°ì…ë‹ˆë‹¤. ì œê³µëœ [ìƒì„¸ ì„¸ê³„ê´€ ë° ì„¤ì •]ê³¼ [í˜„ì¬ íšŒì°¨ ë‚´ìš©]ì„ ë°”íƒ•ìœ¼ë¡œ ë‚´ìš©ì˜ ê°œì—°ì„±ì„ ê²€ì¦í•˜ê³  í˜¹ì€ ëª¨ìˆœë˜ëŠ” ë¶€ë¶„ì€ ì—†ëŠ”ì§€ ëª…í™•í•˜ê²Œ ë¶„ì„, ìºë¦­í„°ì˜ í–‰ë™ì´ ì„¤ì •ê³¼ ë¶€í•©í•˜ëŠ”ì§€ í™•ì¸í•˜ë©°, ë‹¤ìŒ ì „ê°œë¥¼ ì˜ˆìƒí•˜ëŠ” ë¦¬í¬íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.";
        
        // [ìˆ˜ì •] contextData ì‚¬ìš©
        const userQuery = `
${contextData}

**[í˜„ì¬ íšŒì°¨ ë‚´ìš© (Episode ${currentStoryData.episode_number})]**
${currentStoryData.content}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };

        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ë¶„ì„ ì‹¤íŒ¨";
            
            aiOutput.innerHTML = `<h4 class="font-bold text-gray-800 mb-2">ğŸ“Š ìƒì„¸ ë¶„ì„ ê²°ê³¼</h4><div class="prose text-sm">${text.replace(/\n/g, '<br>')}</div>`;
            aiOutput.classList.remove('hidden');

        } catch (error) {
            alert("AI ë¶„ì„ ì˜¤ë¥˜: " + error.message);
        } finally {
            aiButtonText.textContent = 'ì†Œì„¤ ë‚´ìš© ê²€ì¦ ë° ë¶„ì„ (ë¦¬í¬íŠ¸ ìƒì„±)';
            aiSpinner.classList.add('hidden');
            aiAnalysisButton.disabled = false;
        }
    }

    // 2. ë‹¤ì‹œ ì“°ê¸°
    async function performRewrite() {
        if (!selectedSettingId || !selectedStoryId) return;
        
        const instructions = rewriteInstructions.value.trim();
        if (!instructions) {
            alert("ê°œì„  ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        rewriteButtonText.textContent = 'AIê°€ ë‹¤ì‹œ ì“°ëŠ” ì¤‘...';
        rewriteSpinner.classList.remove('hidden');
        aiRewriteButton.disabled = true;

        const systemPrompt = `ë‹¹ì‹ ì€ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì†Œì„¤ ì‘ê°€ì…ë‹ˆë‹¤. 
ì‚¬ìš©ìì˜ [ìš”ì²­ ì‚¬í•­]ì„ ë°˜ì˜í•˜ì—¬ [í˜„ì¬ ì›ê³ ]ë¥¼ **ì²˜ìŒë¶€í„° ëê¹Œì§€ ë‹¤ì‹œ ì‘ì„±**í•˜ì„¸ìš”.
ì¶œë ¥ì€ ì˜¤ì§ **ìˆ˜ì •ëœ ì†Œì„¤ ë³¸ë¬¸**ë§Œ ì œê³µí•˜ì„¸ìš”.
[ìƒì„¸ ì„¸ê³„ê´€ ë° ì„¤ì •]ì„ ì² ì €íˆ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.`;

        // [ìˆ˜ì •] contextData ì‚¬ìš©
        const userQuery = `
${contextData}

**[í˜„ì¬ ì›ê³ ]**
${currentStoryData.content}

**[ìš”ì²­ ì‚¬í•­ (ì´ ë‚´ìš©ì„ ë°˜ì˜í•˜ì—¬ ìˆ˜ì •)]**
${instructions}
`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
        };

        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            let newText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (newText) {
                revisedContentEditor.value = newText;
                rewriteResultContainer.classList.remove('hidden');
                rewriteResultContainer.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("AIê°€ ë‚´ìš©ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }

        } catch (error) {
            alert("ìˆ˜ì • ìš”ì²­ ì˜¤ë¥˜: " + error.message);
        } finally {
            rewriteButtonText.textContent = 'AIë¡œ ë‚´ìš© ë‹¤ì‹œ ì“°ê¸° (Rewrite)';
            rewriteSpinner.classList.add('hidden');
            aiRewriteButton.disabled = false;
        }
    }
</script>
</body>
</html>