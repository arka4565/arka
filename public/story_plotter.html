<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì„¤ í”Œë¡¯ ë° ì—í”¼ì†Œë“œ ê´€ë¦¬ (MySQL/API ì—°ë™)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSSë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì‚¬ìš©ì ì§€ì • ìŠ¤íƒ€ì¼ë„ ì¶”ê°€í•©ë‹ˆë‹¤. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
        .ai-output-container {
            white-space: pre-wrap;
            background-color: #f7f7f7;
            border-left: 4px solid #3b82f6;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        } /* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .nav-link {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out;
        }
    </style>
</head>
!-- ìƒë‹¨ ë©”ë‰´ ì¶”ê°€ë¥¼ ìœ„í•´ body ìŠ¤íƒ€ì¼ ì¡°ì • -->
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-lg">
   <nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center h-14 sm:h-16">
            
            <div class="flex-shrink-0 flex items-center pr-4">
                <a href="#" class="text-gray-800 text-lg font-bold whitespace-nowrap">
                   ì†Œì„¤ì‘ë²•
                </a>
            </div>

            <div class="flex-1 flex items-center justify-end min-w-0">
                
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1 w-full sm:w-auto no-scrollbar">
                    
                    <a href="/" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê¸€ì“°ê¸°
                    </a>
                    
                    <a href="/index3" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ì„¸ê³„ê´€
                    </a>
                    
                    <a href="/index4" class="px-3 py-2 rounded-md text-sm sm:text-base font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" aria-current="page">
                        ì—í”¼ì†Œë“œ
                    </a>
                    
                    <a href="/index2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ë“±ì¥ì¸ë¬¼
                    </a>
                    
                    <a href="/storys2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ìƒì„¸í¸ì§‘
                    </a>
                    
                    <a href="/storys1" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê²€ì¦
                    </a>
                </div>
            </div>

        </div>
    </div>
</nav>

<style>
    /* Chrome, Safari, Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>


<div id="app" class="mt-16 sm:mt-20 w-full max-w-7xl bg-white shadow-2xl rounded-xl p-4 sm:p-8 border border-gray-100 mb-8 flex flex-col lg:flex-row gap-6">

    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°”: í”Œë¡¯ ëª©ë¡ (Settings) -->
    <div class="lg:w-1/3 border-r border-gray-200 p-6 flex flex-col">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">
            í”Œë¡¯ ì„¤ì • ëª©ë¡ (Settings)
        </h2>
        <p id="system-info" class="text-xs text-gray-500 mb-4">API ìƒíƒœ: ì—°ê²° ì¤‘...</p>
        <div id="plot-list-container" class="flex-grow space-y-2 overflow-y-auto custom-scroll">
            <p id="loading-plots" class="text-center text-blue-500">
                <span class="spinner inline-block align-middle mr-2"></span>
                ì„¤ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </p>
            <!-- ì„¤ì • ëª©ë¡ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. (allSettings ì‚¬ìš©) -->
        </div>
        <!-- onclick ì œê±° í›„ ID ì¶”ê°€ -->
        <button id="add-plot-button" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
            + ìƒˆ ì„¤ì • ì¶”ê°€ (ê¸°ëŠ¥ ë¯¸êµ¬í˜„)
        </button>
        <!-- onclick ì œê±° í›„ ID ì¶”ê°€ -->
        <button id="refresh-data-button" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg text-sm">
            ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        </button>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì½˜í…ì¸  -->
    <div class="lg:w-2/3 p-6 flex flex-col">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
            <span id="selected-plot-title" class="text-indigo-600">ì„ íƒëœ ì„¤ì • ì—†ìŒ</span>
        </h2>

        <!-- íšŒì°¨ ëª©ë¡ ë° ìƒì„¸ ë‚´ìš© ì˜ì—­: grid-rows-[max-content_1fr]ë¡œ ë³€ê²½í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ ìµœì†Œí™” -->
        <div class="flex-grow grid grid-rows-[max-content_1fr] gap-6">

            <!-- ìƒë‹¨: íšŒì°¨ ëª©ë¡ (Stories) -->
            <div class="border rounded-xl p-4 shadow-sm bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">
                    íšŒì°¨ ëª©ë¡ (Stories)
                </h3>
                <!-- h-48ì€ ëª©ë¡ì´ ë„ˆë¬´ ê¸¸ ë•Œ ìŠ¤í¬ë¡¤ì´ ìƒê¸°ëŠ” ìµœëŒ€ ë†’ì´ë¡œ ì‘ë™í•©ë‹ˆë‹¤. -->
                <div id="episode-list-container" class="h-48 max-h-48 overflow-y-auto custom-scroll space-y-1">
                    <p id="episode-placeholder" class="text-gray-400 text-center mt-8">ì„¤ì •ì„ ì„ íƒí•˜ì‹œë©´ íšŒì°¨ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                    <!-- íšŒì°¨ ëª©ë¡ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. (currentSettingStories ì‚¬ìš©) -->
                </div>
            </div>

            <!-- í•˜ë‹¨: íšŒì°¨ ìƒì„¸ ë‚´ìš© ë° AI ë¶„ì„ -->
            <div class="border rounded-xl p-4 shadow-md flex flex-col">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">
                    <span id="selected-episode-title" class="text-blue-600">íšŒì°¨ ìƒì„¸ ë‚´ìš©</span>
                </h3>

                <div id="episode-detail-content" class="flex-grow overflow-y-auto custom-scroll mb-4 text-gray-700 text-sm">
                    <p class="text-gray-400 text-center mt-8">íšŒì°¨ë¥¼ ì„ íƒí•˜ì‹œë©´ ìƒì„¸ ë‚´ìš©ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                    <!-- ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
                </div>

                <div id="ai-section" class="pt-4 border-t">
                    <!-- onclick ì œê±° -->
                    <button id="ai-analysis-button"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                            disabled>
                        <span id="ai-button-text">ì†Œì„¤ ë‚´ìš© ê²€ì¦ ë° ë‹¤ìŒ ì „ê°œ ì˜ˆìƒ</span>
                        <span id="ai-spinner" class="spinner ml-3 hidden"></span>
                    </button>

                    <div id="ai-output" class="mt-4 p-4 rounded-lg ai-output-container text-sm hidden">
                        <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- ê¸€ë¡œë²Œ ë³€ìˆ˜ ë° ì„¤ì • ---

    // ì„œë²„ì˜ API ê¸°ë³¸ URL (index.jsê°€ ì‹¤í–‰ë˜ëŠ” ê³³)
    const API_BASE_URL = '/api';

    const modelName = 'gemini-2.5-pro';
    // ìƒíƒœ ë³€ìˆ˜
    let allSettings = []; // í”Œë¡¯ -> Settings
    let currentSettingStories = []; // ì—í”¼ì†Œë“œ -> Stories
    let selectedSettingId = null;
    let selectedStoryId = null;

    // UI ìš”ì†Œ (ì´ë¦„ ìœ ì§€)
    const plotListContainer = document.getElementById('plot-list-container');
    const episodeListContainer = document.getElementById('episode-list-container');
    const episodeDetailContent = document.getElementById('episode-detail-content');
    const selectedPlotTitle = document.getElementById('selected-plot-title');
    const selectedEpisodeTitle = document.getElementById('selected-episode-title');

    // ë²„íŠ¼ ìš”ì†Œ (ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©ì„ ìœ„í•´ IDë¡œ ì§ì ‘ ê°€ì ¸ì˜µë‹ˆë‹¤)
    const addPlotButton = document.getElementById('add-plot-button');
    const refreshDataButton = document.getElementById('refresh-data-button');
    const aiAnalysisButton = document.getElementById('ai-analysis-button');

    const aiButtonText = document.getElementById('ai-button-text');
    const aiSpinner = document.getElementById('ai-spinner');
    const aiOutput = document.getElementById('ai-output');
    const loadingPlots = document.getElementById('loading-plots');
    const systemInfo = document.getElementById('system-info');
    const episodePlaceholder = document.getElementById('episode-placeholder');


    // AI API ì„¤ì • (Gemini APIëŠ” ì„œë²„ í†µì‹ ê³¼ ë³„ê°œë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ í˜¸ì¶œë¨)
    const GEMINI_MODEL = "gemini-2.5-pro";
    
    // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

    // Exponential Backoffì„ ì‚¬ìš©í•œ API í˜¸ì¶œ ì¬ì‹œë„ ë¡œì§
    async function retryWithExponentialBackoff(fetcher, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetcher();
                if (!response.ok) {
                    // ì„œë²„ì—ì„œ ë³´ë‚¸ JSON ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.
                    let errorDetail = '';
                    try {
                        errorDetail = await response.json();
                        errorDetail = JSON.stringify(errorDetail);
                    } catch {
                        errorDetail = await response.text();
                        errorDetail = errorDetail.substring(0, 50) + '...';
                    }
                    console.error("API Response Error:", errorDetail);
                    throw new Error(`API call failed with status ${response.status}: ${errorDetail}`);
                }
                return response;
            } catch (error) {
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw error;
                }
            }
        }
    }

    // --- MySQL API ë°ì´í„° í†µì‹  (Settings/Stories ê¸°ì¤€) ---

    async function fetchSettings() {
        if(loadingPlots) loadingPlots.classList.remove('hidden');
        systemInfo.textContent = 'API ìƒíƒœ: ì„¤ì • ëª©ë¡ ìš”ì²­ ì¤‘...';
        try {
            // API ê²½ë¡œ: /api/settings-list
            const response = await fetch(`${API_BASE_URL}/settings-list`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            allSettings = await response.json(); // allSettingsì— ì„¤ì • ë°ì´í„° ì €ì¥
            renderPlotList();

            systemInfo.textContent = `API ìƒíƒœ: ì—°ê²° ì„±ê³µ (${allSettings.length}ê°œ ì„¤ì • ë¡œë“œ)`;

            if (selectedSettingId && allSettings.find(p => p.id.toString() === selectedSettingId)) {
                handlePlotSelection(selectedSettingId, false);
            } else {
                selectedSettingId = null;
                selectedStoryId = null;
                renderEpisodeList();
                renderEpisodeDetail();
            }

        } catch (error) {
            console.error("Failed to fetch settings from API:", error);
            if (loadingPlots) {
                loadingPlots.innerHTML = `<p class="text-red-500">API ì—°ê²° ì‹¤íŒ¨. index.jsê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: ${error.message}</p>`;
            }
            systemInfo.textContent = 'API ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨';
        } finally {
            if (loadingPlots) {
                loadingPlots.classList.add('hidden');
                if (allSettings.length === 0) {
                    loadingPlots.classList.remove('hidden');
                    loadingPlots.innerHTML = `<p class="text-gray-500">ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. index.jsë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</p>`;
                }
            }
        }
    }

    async function fetchStoriesForSetting(settingId) {
        episodeListContainer.innerHTML = `<p class="text-center text-blue-500 mt-8"><span class="spinner inline-block align-middle mr-2"></span> íšŒì°¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
        systemInfo.textContent = `API ìƒíƒœ: íšŒì°¨ ëª©ë¡ ìš”ì²­ ì¤‘ (Setting ID: ${settingId})...`;

        try {
            // API ê²½ë¡œ: /api/load-episodes
            const response = await fetch(`${API_BASE_URL}/load-episodes?setting_id=${settingId}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            currentSettingStories = await response.json(); // currentSettingStoriesì— íšŒì°¨ ë°ì´í„° ì €ì¥
            renderEpisodeList(); // íšŒì°¨ ë°ì´í„° ë Œë”ë§
            systemInfo.textContent = `API ìƒíƒœ: ì—°ê²° ì„±ê³µ (${currentSettingStories.length}ê°œ íšŒì°¨ ë¡œë“œ)`;

            if (selectedStoryId && !currentSettingStories.find(e => e.id.toString() === selectedStoryId)) {
                selectedStoryId = null;
                renderEpisodeDetail();
            } else if (selectedStoryId) {
                renderEpisodeDetail(false);
            }

        } catch (error) {
            console.error("Failed to fetch stories from API:", error);
            if (episodeListContainer) {
                episodeListContainer.innerHTML = `<p class="text-red-500 text-center mt-8">íšŒì°¨ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
            }
            systemInfo.textContent = 'API ìƒíƒœ: íšŒì°¨ ë¡œë“œ ì‹¤íŒ¨';
        }
    }

    // --- UI ë Œë”ë§ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

    // í”Œë¡¯ ì„¤ì • ëª©ë¡ ë Œë”ë§ (plot-list-container)
    function renderPlotList() {
        plotListContainer.innerHTML = '';

        if (allSettings.length === 0) return;

        allSettings.forEach(setting => {
            const settingIdStr = setting.id.toString();
            const isActive = settingIdStr === selectedSettingId;
            const plotElement = document.createElement('div');
            plotElement.className = `p-3 rounded-lg cursor-pointer transition duration-150 ${isActive ? 'bg-indigo-100 border-indigo-500 border-2' : 'bg-white hover:bg-gray-100 border border-gray-200'}`;
            plotElement.innerHTML = `
                    <h4 class="font-semibold ${isActive ? 'text-indigo-700' : 'text-gray-700'}">${setting.title}</h4>
                    <p class="text-xs text-gray-500 truncate">
                        ì„¸ê³„ê´€: ${setting.worldSetting || 'N/A'} | ìºë¦­í„°: ${setting.characterDetails ? setting.characterDetails.substring(0, 20) + '...' : 'N/A'}
                    </p>
                `;
            plotElement.onclick = () => handlePlotSelection(settingIdStr);
            plotListContainer.appendChild(plotElement); // â­ plotListContainerì— ì¶”ê°€
        });
    }

    async function handlePlotSelection(settingId, shouldFetch = true) {
        selectedSettingId = settingId.toString();
        selectedStoryId = null;

        const selectedSetting = allSettings.find(p => p.id.toString() === selectedSettingId);

        if (selectedSetting) {
            selectedPlotTitle.textContent = selectedSetting.title;
            selectedPlotTitle.title = selectedSetting.plotDetails;
        }

        renderPlotList();
        renderEpisodeDetail();
        if(aiAnalysisButton) aiAnalysisButton.disabled = true;
        if(aiOutput) aiOutput.classList.add('hidden');

        if (shouldFetch) {
            await fetchStoriesForSetting(selectedSettingId);
        }
    }

    // íšŒì°¨ ëª©ë¡ ë Œë”ë§ (episode-list-container)
    function renderEpisodeList() {
        episodeListContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
        if(aiAnalysisButton) aiAnalysisButton.disabled = true;

        if (!selectedSettingId) {
            if (episodePlaceholder) {
                episodePlaceholder.classList.remove('hidden');
            }
            return;
        }

        if (episodePlaceholder) {
            episodePlaceholder.classList.add('hidden');
        }

        // â­ currentSettingStoriesë¥¼ ì‚¬ìš©í•˜ì—¬ íšŒì°¨ ë°ì´í„° í™•ì¸
        if (currentSettingStories.length === 0) {
            episodeListContainer.innerHTML = `<p class="text-gray-400 text-center mt-8">ì´ ì„¤ì •ì— ëŒ€í•œ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            return;
        }

        // â­ currentSettingStoriesì˜ ê° ìŠ¤í† ë¦¬ ìš”ì†Œë¥¼ ë Œë”ë§
        currentSettingStories.forEach(story => {
            const storyIdStr = story.id.toString();
            const isActive = storyIdStr === selectedStoryId;
            const episodeElement = document.createElement('div');
            episodeElement.className = `p-2 rounded-md cursor-pointer transition duration-100 ${isActive ? 'bg-blue-100 font-medium' : 'hover:bg-gray-50'}`;
            episodeElement.innerHTML = `
                    <span class="text-sm ${isActive ? 'text-blue-700' : 'text-gray-600'}">
                       [${story.episode_number}í™”] ${story.prompt || 'ì œëª© ì—†ìŒ'}
                    </span>
                `;
            episodeElement.onclick = () => handleEpisodeSelection(storyIdStr);
            episodeListContainer.appendChild(episodeElement); // â­ episodeListContainerì— ì¶”ê°€
        });
    }

    function handleEpisodeSelection(storyId, shouldScroll = true) {
        selectedStoryId = storyId.toString();
        renderEpisodeList();
        renderEpisodeDetail(shouldScroll);
        if(aiAnalysisButton) aiAnalysisButton.disabled = false;
    }

    function renderEpisodeDetail(shouldScroll = true) {
        const selectedStory = currentSettingStories.find(e => e.id.toString() === selectedStoryId);
        const selectedSetting = allSettings.find(p => p.id.toString() === selectedSettingId);
        if(aiOutput) aiOutput.classList.add('hidden');

        if (!selectedStory || !selectedSetting) {
            selectedEpisodeTitle.textContent = 'íšŒì°¨ ìƒì„¸ ë‚´ìš©';
            episodeDetailContent.innerHTML = `<p class="text-gray-400 text-center mt-8">íšŒì°¨ë¥¼ ì„ íƒí•˜ì‹œë©´ ìƒì„¸ ë‚´ìš©ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>`;
            if(aiAnalysisButton) aiAnalysisButton.disabled = true;
            return;
        }

        selectedEpisodeTitle.textContent = `[${selectedStory.episode_number}í™”] ${selectedStory.prompt || 'ì œëª© ì—†ìŒ'}`;

        // íšŒì°¨ ë‚´ìš©ì´ ë¹„ì–´ìˆì„ ê²½ìš° í‘œì‹œí•  ë©”ì‹œì§€
        const episodeContent = selectedStory.content || 'ì´ íšŒì°¨ì˜ ë‚´ìš©ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.';


        episodeDetailContent.innerHTML = `
                <div class="space-y-4">
                    <!-- ì„¤ì • ìƒì„¸: í† ê¸€ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½ -->
                    <div id="setting-detail-card" class="bg-gray-50 rounded-lg border border-gray-200 shadow-inner">
                        <div id="settings-header" class="p-3 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition duration-150">
                            <h4 class="font-bold text-gray-700">ğŸ“Œ ì„¤ì • ìƒì„¸ ë³´ê¸° (í´ë¦­í•˜ì—¬ í† ê¸€)</h4>
                            <span id="toggle-icon" class="text-gray-500 transform transition-transform duration-300">â–¼</span>
                        </div>
                        <div id="settings-body" class="p-3 pt-0 hidden">
                            <p class="text-xs text-gray-600">
                                <strong>ì„¸ê³„ê´€:</strong> ${selectedSetting.worldSetting}<br>
                                <strong>ìºë¦­í„° ìƒì„¸:</strong> ${selectedSetting.characterDetails}<br>
                                <strong>í”Œë¡¯ ìƒì„¸:</strong> ${selectedSetting.plotDetails}
                            </p>
                        </div>
                    </div>

                    <!-- íšŒì°¨ ë‚´ìš© (í•µì‹¬ ë‚´ìš©ì„ ë³„ë„ ë°•ìŠ¤ë¡œ ê°•ì¡°) -->
                    <div class="p-3 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-2 border-b pb-1">íšŒì°¨ ë‚´ìš© (Episode ${selectedStory.episode_number})</h4>
                        <p class="whitespace-pre-wrap text-sm text-gray-700">${episodeContent}</p>
                    </div>
                </div>
            `;

        // í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€
        const settingsHeader = document.getElementById('settings-header');
        const settingsBody = document.getElementById('settings-body');
        const toggleIcon = document.getElementById('toggle-icon');

        settingsHeader.onclick = () => {
            const isHidden = settingsBody.classList.toggle('hidden');
            if (isHidden) {
                toggleIcon.textContent = 'â–¼'; // ë‹«í˜
            } else {
                toggleIcon.textContent = 'â–²'; // ì—´ë¦¼
            }
        };

        if (shouldScroll) {
            episodeDetailContent.scrollTop = 0;
        }
    }

    // --- Gemini API í˜¸ì¶œ ë¡œì§ (AI ë¶„ì„) ---

    async function performAIAnalysis() {
        if (!selectedSettingId || !selectedStoryId) return;

        const selectedSetting = allSettings.find(p => p.id.toString() === selectedSettingId);
        const selectedStory = currentSettingStories.find(e => e.id.toString() === selectedStoryId);

        if (!selectedSetting || !selectedStory) return;

        if(aiOutput) aiOutput.classList.add('hidden');
        if(aiButtonText) aiButtonText.textContent = 'ë¶„ì„ ì¤‘...';
        if(aiSpinner) aiSpinner.classList.remove('hidden');
        if(aiAnalysisButton) aiAnalysisButton.disabled = true;

        const systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ì†Œì„¤ í”Œë¡¯ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì œê³µí•œ í”Œë¡¯ ì„¤ì •ê³¼ ìµœì‹  íšŒì°¨ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì„¸ ê°€ì§€ í•­ëª©ì„ ë¶„ì„í•˜ì—¬ ìƒì„¸í•˜ê³  ì „ë¬¸ì ì¸ í•œêµ­ì–´ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•˜ì„¸ìš”:
1.  **ë‚´ìš© ê²€ì¦ (Consistency Check):** í”Œë¡¯ì˜ **ì„¸ê³„ê´€ ì„¤ì •(worldSetting)**, **ìºë¦­í„° ìƒì„¸(characterDetails)**, **í”Œë¡¯ ìƒì„¸(plotDetails)**ì™€ í˜„ì¬ íšŒì°¨ ë‚´ìš©ì´ ì¼ì¹˜í•˜ëŠ”ì§€, í˜¹ì€ ëª¨ìˆœë˜ëŠ” ë¶€ë¶„ì€ ì—†ëŠ”ì§€ ëª…í™•í•˜ê²Œ ë¶„ì„í•©ë‹ˆë‹¤.
2.  **ë‹¤ìŒ ì „ê°œ ì˜ˆìƒ (Future Trajectory):** í˜„ì¬ íšŒì°¨ì˜ ê²°ë§ì´ë‚˜ ì‚¬ê±´ì„ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ë…¼ë¦¬ì ì´ê±°ë‚˜ í¥ë¯¸ë¡œìš´ ë‹¤ìŒ íšŒì°¨ì˜ ì „ê°œ ë°©í–¥ì„ 2~3ê°€ì§€ ì œì•ˆí•©ë‹ˆë‹¤.
3.  **ì ì¬ì  ë¬¸ì œì  ë° ê°œì„ ì  (Risks & Improvements):** í”Œë¡¯ì˜ í¥ë¯¸ë„, ê°œì—°ì„±, ë…ìì˜ ë°˜ì‘ ë“±ì„ ê³ ë ¤í•˜ì—¬ í˜„ì¬ ë‚´ìš©ì´ ì•ˆê³  ìˆëŠ” ì ì¬ì  ìœ„í—˜ ìš”ì†Œë‚˜, ë…ìë¥¼ ë” ëŒì–´ë‹¹ê¸¸ ìˆ˜ ìˆëŠ” ê°œì„ ì ì„ ì œì‹œí•©ë‹ˆë‹¤.

ê²°ê³¼ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ì œëª© ì™¸ì— ë‹¤ë¥¸ ë¶€ì œëª©ì´ë‚˜ ì„¹ì…˜ êµ¬ë¶„ìë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;

        // ìƒˆ ì„¤ì • í•„ë“œ ì‚¬ìš©
        const userQuery = `**[í”Œë¡¯ ì„¤ì •]**
- ì œëª©: ${selectedSetting.title}
- ì„¸ê³„ê´€ ì„¤ì •: ${selectedSetting.worldSetting}
- ìºë¦­í„° ìƒì„¸: ${selectedSetting.characterDetails}
- í”Œë¡¯ ìƒì„¸: ${selectedSetting.plotDetails}

**[ìµœì‹  íšŒì°¨ ë‚´ìš©]**
- íšŒì°¨ ë²ˆí˜¸: ${selectedStory.episode_number}
- ë‚´ìš©: ${selectedStory.content}

ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ„ ì„¸ ê°€ì§€ í•­ëª©ì— ëŒ€í•œ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;

       
			// ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
			const proxyUrl = '/api/generate-text';
			
            const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
             };
			
			const requestBody = {
			  model: modelName,
			  payload: payload
			};			
            
        const fetcher = () => fetch(proxyUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        try {
            const response = await retryWithExponentialBackoff(fetcher);
            const result = await response.json();

            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                let outputHtml = `<h4 class="font-bold text-lg text-gray-800 mb-3">AI ë¶„ì„ ë¦¬í¬íŠ¸</h4>`;
                outputHtml += `<div class="prose max-w-none">${text.replace(/\n/g, '<br>')}</div>`;

                if (sources.length > 0) {
                    outputHtml += '<div class="mt-4 pt-3 border-t border-gray-200">';
                    outputHtml += '<p class="font-semibold text-xs text-gray-600 mb-1">ì°¸ê³  ìë£Œ:</p>';
                    sources.forEach((source) => {
                        outputHtml += `<p class="text-xs text-gray-500 truncate"><a href="${source.uri}" target="_blank" class="hover:text-blue-500">${source.title || source.uri}</a></p>`;
                    });
                    outputHtml += '</div>';
                }

                if(aiOutput) {
                    aiOutput.innerHTML = outputHtml;
                    aiOutput.classList.remove('hidden');
                }

            } else {
                if(aiOutput) {
                    aiOutput.innerHTML = '<p class="text-red-500">ì£„ì†¡í•©ë‹ˆë‹¤. AI ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                    aiOutput.classList.remove('hidden');
                }
            }

        } catch (error) {
            console.error("AI Analysis Failed:", error);
            if(aiOutput) {
                aiOutput.innerHTML = `<p class="text-red-500">AI ë¶„ì„ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                aiOutput.classList.remove('hidden');
            }
        } finally {
            if(aiButtonText) aiButtonText.textContent = 'ì†Œì„¤ ë‚´ìš© ê²€ì¦ ë° ë‹¤ìŒ ì „ê°œ ì˜ˆìƒ';
            if(aiSpinner) aiSpinner.classList.add('hidden');
            if(aiAnalysisButton) aiAnalysisButton.disabled = false;

            if (aiOutput) {
                aiOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }

    function handleAddPlotClick() {
        alert("ìƒˆ ì„¤ì • ì¶”ê°€ ê¸°ëŠ¥ì€ í˜„ì¬ UIì— êµ¬í˜„ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í†µí•´ ì§ì ‘ ë°ì´í„°ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.");
    }

    function initApp(isRefresh = false) {
        if (isRefresh) {
            systemInfo.textContent = 'API ìƒíƒœ: ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
        }
        fetchSettings();
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
    function setupEventListeners() {
        // ìƒˆ ì„¤ì • ì¶”ê°€ ë²„íŠ¼
        if (addPlotButton) {
            addPlotButton.addEventListener('click', handleAddPlotClick);
        }
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        if (refreshDataButton) {
            refreshDataButton.addEventListener('click', () => initApp(true));
        }
        // AI ë¶„ì„ ë²„íŠ¼ (ì˜¤ë¥˜ ë°œìƒ ì§€ì )
        if (aiAnalysisButton) {
            aiAnalysisButton.addEventListener('click', performAIAnalysis);
        }
    }

    // --- ì‹œì‘: í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì•± ì´ˆê¸°í™” ---
    window.onload = function() {
        setupEventListeners();
        initApp();
    };

</script>
</body>
</html>