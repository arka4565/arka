<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¸€ì“°ê¸° AI ë°ëª¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter í°íŠ¸ ì‚¬ìš© */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f6;
    }
    /* í…ìŠ¤íŠ¸ ì˜ì—­ì˜ ê·¸ë¦¼ì ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    textarea {
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    /* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    .nav-link {
      @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out;
    }
  </style>
</head>
!-- ìƒë‹¨ ë©”ë‰´ ì¶”ê°€ë¥¼ ìœ„í•´ body ìŠ¤íƒ€ì¼ ì¡°ì • -->
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center h-14 sm:h-16">
            
            <div class="flex-shrink-0 flex items-center pr-4">
                <a href="#" class="text-gray-800 text-lg font-bold whitespace-nowrap">
                   ì†Œì„¤ì‘ë²•
                </a>
            </div>

            <div class="flex-1 flex items-center justify-end min-w-0">
                
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1 w-full sm:w-auto no-scrollbar">
                    
                    <a href="/" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê¸€ì“°ê¸°
                    </a>
                    
                    <a href="/index3" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ì„¸ê³„ê´€
                    </a>
                    
                    <a href="/index4" class="px-3 py-2 rounded-md text-sm sm:text-base font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" aria-current="page">
                        ì—í”¼ì†Œë“œ
                    </a>
                    
                    <a href="/index2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ë“±ì¥ì¸ë¬¼
                    </a>
                    
                    <a href="/storys2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ìƒì„¸í¸ì§‘
                    </a>
                    
                    <a href="/storys1" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê²€ì¦
                    </a>
                </div>
            </div>

        </div>
    </div>
</nav>

<style>
    /* Chrome, Safari, Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    } 
</style>

<div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 border border-gray-100">
  <h1 class="text-3xl font-bold text-gray-800 mb-2">ê¸€ì“°ê¸° AI ë°ëª¨ (MySQL DB ì—°ë™)</h1>
  <p class="text-gray-600 mb-6">ëª¨ë“  í”Œë¡¯ ì„¤ì •ê³¼ íšŒì°¨ ë°ì´í„°ëŠ” **MySQL ë°ì´í„°ë² ì´ìŠ¤**ì— ì €ì¥ë©ë‹ˆë‹¤.</p>

  <!-- Plot Management (í”Œë¡¯ ê´€ë¦¬ ì˜ì—­) -->
  <div class="p-4 mb-6 bg-yellow-50 rounded-lg border border-yellow-200">
    <div id="dbStatus" class="font-medium text-sm text-yellow-800 mb-4">
      DB ìƒíƒœ: ì„œë²„ ì—°ê²° ì¤‘...
    </div>

    <!-- 1. Plot Name (í”Œë¡¯ ì´ë¦„ - DB: settings.title) -->
    <div class="mb-4">
      <label for="plotNameInput" class="block text-sm font-medium text-gray-700 mb-2">
        í˜„ì¬ í”Œë¡¯ ì´ë¦„ (DB ì»¬ëŸ¼: `title`): <span id="currentPlotIdDisplay" class="text-xs font-normal text-gray-500">(ìƒˆ í”Œë¡¯)</span>
      </label>
      <input type="text" id="plotNameInput" placeholder="ì˜ˆ: 'ë‹¤í¬ íŒíƒ€ì§€ - íšŒê·€í•œ ì„±ê¸°ì‚¬'"
             class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 ease-in-out shadow-inner">
    </div>

    <!-- 2. Save Button (ì €ì¥ ë²„íŠ¼) -->
    <div class="flex flex-wrap gap-3 mb-4">
      <!-- Save Button now takes full width -->
      <button id="saveButton" onclick="saveCustomSettings()"
              class="w-full px-4 py-2 bg-purple-600 text-white font-semibold text-sm rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 ease-in-out">
        í˜„ì¬ ì„¤ì • ì €ì¥ / ì—…ë°ì´íŠ¸
      </button>
    </div>

    <!-- 3. Plot Selection and Load/Delete (í”Œë¡¯ ì„ íƒ ë° ë¡œë“œ/ì‚­ì œ) -->
    <div class="mt-4 pt-4 border-t border-yellow-200">
      <label for="plotSelector" class="block text-sm font-medium text-gray-700 mb-2">ì €ì¥ëœ í”Œë¡¯ ë¶ˆëŸ¬ì˜¤ê¸°:</label>
      <div class="flex flex-wrap gap-3">
        <select id="plotSelector"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out min-w-40">
          <option value="">-- ìƒˆ í”Œë¡¯ ì‹œì‘ --</option>
        </select>
        <button id="loadPlotButton" onclick="loadSelectedPlot()" disabled
                class="px-4 py-2 bg-blue-600 text-white font-semibold text-sm rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out disabled:opacity-50">
          ì„ íƒ í”Œë¡¯ ë¡œë“œ
        </button>
        <button id="deletePlotButton" onclick="deleteSelectedPlot()" disabled
                class="px-4 py-2 bg-red-500 text-white font-semibold text-sm rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition duration-300 ease-in-out disabled:opacity-50">
          ì„ íƒ í”Œë¡¯ ì‚­ì œ
        </button>
      </div>
    </div>
  </div>

  <!-- ì†Œì„¤ ì½”ì–´ ì„¤ì • ê·¸ë£¹ (1. ì„¸ê³„ê´€, 2. ë“±ì¥ì¸ë¬¼) -->
  <h2 class="text-lg font-semibold text-gray-700 mb-3 mt-6 border-b pb-2">ì†Œì„¤ ì½”ì–´ ì„¤ì •</h2>
  <div class="grid md:grid-cols-2 gap-6 mb-4">
    <div>
      <label for="worldSetting" class="block text-sm font-medium text-gray-700 mb-2">1. ì„¸ê³„ê´€ ì„¤ì • (ë¬¸ì²´ ë° ë°°ê²½):</label>
      <textarea id="worldSetting" rows="5" placeholder="ì˜ˆ: ì–´ë‘¡ê³  ëƒ‰ì†Œì ì¸ ë””ìŠ¤í† í”¼ì•„, ê³ ëŒ€ ë™ì–‘í’ì˜ ë¬´í˜‘ ì„¸ê³„, ë°ê³  í¬ë§ì°¬ íŒíƒ€ì§€ ë“± ë°°ê²½ê³¼ ë¬¸ì²´ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…."
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 ease-in-out resize-none shadow-inner"></textarea>
    </div>
    <div>
      <label for="characterDetails" class="block text-sm font-medium text-gray-700 mb-2">2. ë“±ì¥ì¸ë¬¼ ìƒì„¸ ì •ë³´:</label>
      <textarea id="characterDetails" rows="5" placeholder="ì˜ˆ: ì£¼ì¸ê³µ 'ì¹´ì´'ëŠ” 20ëŒ€, ì´ì„±ì ì´ê³  ì°¨ë¶„í•˜ë©° ê³¼ê±°ì˜ ìƒì²˜ê°€ ìˆìŒ. ë³´ì¡° ì¸ë¬¼ 'ì—˜ë¼'ëŠ” ì¾Œí™œí•˜ê³  ë‚™ì²œì ì„."
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 ease-in-out resize-none shadow-inner"></textarea>
    </div>
  </div>

  <!-- 3. í”Œë¡¯ ë° ì „ì²´ ì¤„ê±°ë¦¬ -->
  <div class="mb-4">
    <label for="plotDetails" class="block text-sm font-medium text-gray-700 mb-2">3. í”Œë¡¯ ë° ì „ì²´ ì¤„ê±°ë¦¬:</label>
    <textarea id="plotDetails" rows="4" placeholder="ì˜ˆ: ì£¼ìš” ê°ˆë“±, 5ë¶€ì‘ êµ¬ì„±, ê° ë¶€ì˜ í•µì‹¬ ëª©í‘œ ë“± ì „ì²´ ìŠ¤í† ë¦¬ê°€ í˜ëŸ¬ê°ˆ ë°©í–¥ì„ ìƒì„¸íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”."
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150 ease-in-out resize-none shadow-inner"></textarea>
  </div>

  <!-- 4. ì´ì „í™” ë‚´ìš© ìš”ì•½ -->
  <h2 class="text-lg font-semibold text-gray-700 mb-3 mt-6 border-b pb-2">í˜„ì¬ ì‘ì„± Context ë° ìš”ì²­</h2>

  <div class="mb-4">
    <label for="previousContent" class="block text-sm font-medium text-gray-700 mb-2">4. ì´ì „í™” ë‚´ìš© ìš”ì•½ (200ì ë‚´ì™¸):</label>
    <textarea id="previousContent" rows="3" placeholder="ì˜ˆ: ì£¼ì¸ê³µ ì¹´ì´ê°€ ì—˜ë¼ë¥¼ ì„¤ë“í•˜ì—¬ ë™ë§¹ì„ ë§ºê³ , ë§ˆì™•ì„±ìœ¼ë¡œ ê°€ëŠ” í¬íƒˆ ì•ì—ì„œ ë§ˆì£¼ì¹œ ì•”ì‚´ìë“¤ì„ ë¬¼ë¦¬ì³¤ë‹¤."
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out resize-none shadow-inner"></textarea>
  </div>

  <!-- 5. ì´ë²ˆì— ìƒì„±í•˜ê³  ì‹¶ì€ ë‚´ìš© (ê¸€ì“°ê¸° ìš”ì²­) -->
  <div class="mb-4">
    <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">5. ì´ë²ˆì— ìƒì„±í•˜ê³  ì‹¶ì€ ë‚´ìš©:</label>
    <textarea id="prompt" rows="4" placeholder="ì˜ˆ: ì¹´ì´ì™€ ì—˜ë¼ê°€ í¬íƒˆì„ ë„˜ì–´ ë§ˆì™•ì„±ìœ¼ë¡œ ì§„ì…í•˜ëŠ” ì¥ë©´ì„ ë¬˜ì‚¬í•´ ì£¼ì„¸ìš”."
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out resize-none shadow-inner"></textarea>
  </div>

  <!-- íšŒì°¨ ë²ˆí˜¸ (DB: settings.episode_number) -->
  <div class="mb-4">
    <label for="episodeNumber" class="block text-sm font-medium text-gray-700 mb-2">
      ë‹¤ìŒ íšŒì°¨ ë²ˆí˜¸ (ìë™ ì¦ê°€):
    </label>
    <input type="number" id="episodeNumber" value="1" min="1"
           class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 shadow-inner cursor-not-allowed">
  </div>

  <!-- ë²„íŠ¼ ë° ë¡œë”© ì¸ë””ì¼€ì´í„° -->
  <div class="flex items-center space-x-4 mb-6">
    <button id="generateButton" onclick="generateText()"
            class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
      ê¸€ ìƒì„±í•˜ê¸°
    </button>
    <div id="loadingIndicator" class="hidden flex items-center space-x-2 text-blue-600">
      <svg class="animate-spin h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>ìƒì„± ì¤‘...</span>
    </div>
  </div>

  <!-- ê²°ê³¼ ì¶œë ¥ ì˜ì—­ -->
  <div class="mt-8 pt-6 border-t border-gray-200">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">ìƒì„±ëœ ê¸€:</h2>
    <div id="resultContainer" class="min-h-[150px] p-4 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap text-gray-800 shadow-sm">
      <!-- ì—¬ê¸°ì— ê²°ê³¼ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
    <div class="mt-4">
      <!-- ğŸŒŸ íšŒì°¨ ì €ì¥ ê¸°ëŠ¥ ë²„íŠ¼ ğŸŒŸ -->
      <button id="saveEpisodeButton" onclick="saveStoryEpisode()" disabled
              class="px-4 py-2 bg-green-600 text-white font-semibold text-sm rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
        ìƒì„±ëœ ê¸€ (íšŒì°¨) ì €ì¥
      </button>
      <span id="episodeSaveStatus" class="ml-4 text-sm text-gray-600"></span>
    </div>
    <div id="errorMessage" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
      <!-- ì—¬ê¸°ì— ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <!-- í˜„ì¬ ì €ì¥ëœ íšŒì°¨ ëª©ë¡ -->
  <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <h3 class="text-lg font-semibold text-blue-800 mb-2">ì €ì¥ëœ ì†Œì„¤ íšŒì°¨ ëª©ë¡</h3>
    <div id="episodeList" class="text-sm text-blue-700 max-h-48 overflow-y-auto">
      ë°ì´í„° ë¡œë“œ ì¤‘...
    </div>
  </div>
</div>

<script>

  // --- ê¸€ë¡œë²Œ ìƒìˆ˜ ë° ë³€ìˆ˜ ì„¤ì • ---
  const modelName = 'gemini-2.5-flash';
  // UI elements references (ì£¼ìš” UI ìš”ì†Œ ì°¸ì¡°)
  const worldSettingInput = document.getElementById('worldSetting');
  const characterDetailsInput = document.getElementById('characterDetails');
  const plotDetailsInput = document.getElementById('plotDetails');
  const previousContentInput = document.getElementById('previousContent');
  const promptInput = document.getElementById('prompt');
  const plotNameInput = document.getElementById('plotNameInput'); // Title input
  const plotSelector = document.getElementById('plotSelector');
  const currentPlotIdDisplay = document.getElementById('currentPlotIdDisplay');
  const episodeNumberInput = document.getElementById('episodeNumber');

  // State and buttons (ìƒíƒœ ë° ë²„íŠ¼)
  const dbStatus = document.getElementById('dbStatus');
  const generateButton = document.getElementById('generateButton');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const resultContainer = document.getElementById('resultContainer');
  const errorMessage = document.getElementById('errorMessage');
  const saveButton = document.getElementById('saveButton');
  const loadPlotButton = document.getElementById('loadPlotButton');
  const deletePlotButton = document.getElementById('deletePlotButton');

  // EPISODE/STORY ê´€ë ¨ UI ìš”ì†Œ ì´ë¦„ ë³€ê²½
  const saveEpisodeButton = document.getElementById('saveEpisodeButton');
  const episodeSaveStatus = document.getElementById('episodeSaveStatus');
  const episodeList = document.getElementById('episodeList');

  let currentPlotId = null; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ í”Œë¡¯ì˜ ID (ìƒˆ í”Œë¡¯ì´ë©´ null)

  /**
   * Display error message (ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ)
   * @param {string} message - Error message to display (í‘œì‹œí•  ì˜¤ë¥˜ ë©”ì‹œì§€)
   * @param {boolean} isFatal - trueë©´ DB ìƒíƒœë„ ì—…ë°ì´íŠ¸
   */
  function displayError(message, isFatal = false) {
    errorMessage.textContent = `ì˜¤ë¥˜: ${message}`;
    errorMessage.classList.remove('hidden');
    if (isFatal) {
      dbStatus.textContent = `âŒ DB ìƒíƒœ: ì˜¤ë¥˜ ë°œìƒ! ${message.substring(0, 50)}...`;
    }
  }

  /**
   * Clear all form fields and reset to 'New Plot' state (ëª¨ë“  í¼ í•„ë“œ ì´ˆê¸°í™”)
   */
  function clearForm() {
    plotNameInput.value = '';
    worldSettingInput.value = '';
    characterDetailsInput.value = '';
    plotDetailsInput.value = '';
    previousContentInput.value = '';
    promptInput.value = '';
    episodeNumberInput.value = '1';
    currentPlotIdDisplay.textContent = '(ìƒˆ í”Œë¡¯)';
    currentPlotId = null;
    resultContainer.textContent = '';
    episodeSaveStatus.textContent = '';

    // íšŒì°¨ ëª©ë¡ ì´ˆê¸°í™”
    episodeList.innerHTML = '<p class="italic text-gray-500">ì €ì¥ëœ ì†Œì„¤ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤. í”Œë¡¯ì„ ë¡œë“œí•˜ê±°ë‚˜ ì €ì¥í•˜ì„¸ìš”.</p>';

    // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
    plotSelector.value = "";
    loadPlotButton.disabled = true;
    deletePlotButton.disabled = true;
  }

  // =======================================================
  // API Call Utilities (API í˜¸ì¶œ ìœ í‹¸ë¦¬í‹°)
  // =======================================================

  /**
   * Fetch API Wrapper
   * @param {string} url
   * @param {object} options
   */
  async function apiFetch(url, options = {}) {
    errorMessage.classList.add('hidden');
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: `HTTP status ${response.status}` }));
        throw new Error(`[${response.status}] ${errorData.error || response.statusText}`);
      }
      return response.json();
    } catch (error) {
      console.error("API Call Error:", error);
      displayError(`ì„œë²„ ì˜¤ë¥˜: ${error.message}`, true);
      throw error; // Re-throw to be handled by the caller
    }
  }

  // =======================================================
  // Plot Management Logic (í”Œë¡¯ ê´€ë¦¬ ë¡œì§)
  // =======================================================

  /**
   * Update the plot selector dropdown from the server (ì„œë²„ì—ì„œ í”Œë¡¯ ëª©ë¡ì„ ê°€ì ¸ì™€ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸)
   */
  async function populatePlotSelector() {
    dbStatus.textContent = "DB ìƒíƒœ: í”Œë¡¯ ëª©ë¡ ë¡œë“œ ì¤‘...";
    try {
      const plots = await apiFetch('/api/settings-list');

      plotSelector.innerHTML = '<option value="">-- ìƒˆ í”Œë¡¯ ì‹œì‘ --</option>';

      plots.forEach(plot => {
        const option = document.createElement('option');
        option.value = plot.id;
        option.textContent = `[${plot.episode_number}í™”] ${plot.title}`; // íšŒì°¨ ë²ˆí˜¸ í¬í•¨í•˜ì—¬ í‘œì‹œ
        plotSelector.appendChild(option);
      });

      // í˜„ì¬ ë¡œë“œëœ í”Œë¡¯ì„ ì„ íƒ
      if (currentPlotId) {
        plotSelector.value = currentPlotId;
        loadPlotButton.disabled = false;
        deletePlotButton.disabled = false;
      } else if (plots.length > 0) {
        // ì²« ë¡œë“œ ì‹œ, ì²« ë²ˆì§¸ í”Œë¡¯ì„ ìë™ìœ¼ë¡œ ì„ íƒí•˜ë„ë¡ ì„¤ì •
        plotSelector.value = plots[0].id;
      }
      dbStatus.textContent = `DB ìƒíƒœ: í”Œë¡¯ ëª©ë¡ ë¡œë“œ ì™„ë£Œ. (${plots.length}ê°œ)`;

    } catch (error) {
      dbStatus.textContent = "âŒ DB ìƒíƒœ: í”Œë¡¯ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨. ì„œë²„ ë° DB ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.";
    }
  }
  /**
   Â  Â * Load and display world settings into the dedicated textarea
   Â  Â * @param {number} settingId - The ID of the current plot setting
   Â  Â */
  async function loadAndDisplayWorldSettings(settingId) {
    if (!settingId) {
      worldSettingInput.value = '';
      return;
    }
    try {
      const settings = await apiFetch(`/api/worldsettings?setting_id=${settingId}`);

      if (settings.length === 0) {
        // ë§Œì•½ ìƒì„¸ ì„¤ì •ì´ ì—†ë‹¤ë©´, settings í…Œì´ë¸”ì˜ ê¸°ì¡´ í•„ë“œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        // ì´ë¯¸ loadSelectedPlotì—ì„œ plotData.worldSettingì´ ë¡œë“œë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì¶”ê°€ ì‘ì—…ì€ ìƒëµí•©ë‹ˆë‹¤.
        // ì´ ê²½ìš°, ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•˜ê±°ë‚˜ ì´í›„ì— ìƒì„¸ í…Œì´ë¸”ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
        if (!worldSettingInput.value.trim()) {
          worldSettingInput.value = 'ë“±ë¡ëœ ì„¸ê³„ê´€ ìƒì„¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. (DB: world_settings)';
        }
        return;
      }

      // ìƒì„¸ í…Œì´ë¸”ì˜ ë‚´ìš©ì„ í•©ì³ì„œ í‘œì‹œ
      const formattedText = settings.map(s =>
              `=== ${s.title} ===\n${s.description || 'ë‚´ìš© ì—†ìŒ'}`
      ).join('\n\n---\n\n');

      worldSettingInput.value = formattedText;
    } catch (error) {
      worldSettingInput.value = `âš ï¸ ì„¸ê³„ê´€ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
      console.error("ì„¸ê³„ê´€ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:", error);
    }
  }

  /**
   Â  Â * Load and display characters into the dedicated textarea
   Â  Â * @param {number} settingId - The ID of the current plot setting
   Â  Â */
  async function loadAndDisplayCharacters(settingId) {
    if (!settingId) {
      characterDetailsInput.value = '';
      return;
    }
    try {
      const characters = await apiFetch(`/api/characters?setting_id=${settingId}`);

      if (characters.length === 0) {
        // ë§Œì•½ ìƒì„¸ ì„¤ì •ì´ ì—†ë‹¤ë©´, settings í…Œì´ë¸”ì˜ ê¸°ì¡´ í•„ë“œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        // ì´ë¯¸ loadSelectedPlotì—ì„œ plotData.characterDetailsê°€ ë¡œë“œë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì¶”ê°€ ì‘ì—…ì€ ìƒëµí•©ë‹ˆë‹¤.
        if (!characterDetailsInput.value.trim()) {
          characterDetailsInput.value = 'ë“±ë¡ëœ ë“±ì¥ì¸ë¬¼ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (DB: characters)';
        }
        return;
      }

      // ìƒì„¸ í…Œì´ë¸”ì˜ ë‚´ìš©ì„ í•©ì³ì„œ í‘œì‹œ
      const formattedText = characters.map(c =>
              `=== ${c.name} (ì—­í• : ${c.role || 'ë¯¸ì§€ì •'}) ===\n${c.description || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}`
      ).join('\n\n---\n\n');

      characterDetailsInput.value = formattedText;
    } catch (error) {
      characterDetailsInput.value = `âš ï¸ ë“±ì¥ì¸ë¬¼ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
      console.error("ë“±ì¥ì¸ë¬¼ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:", error);
    }
  }
  /**
   * Load the selected plot into the form (ì„ íƒëœ í”Œë¡¯ì„ í¼ì— ë¡œë“œ)
   */
  window.loadSelectedPlot = async function() {
    const plotIdToLoad = plotSelector.value;
    if (!plotIdToLoad) {
      clearForm(); // IDê°€ ì—†ìœ¼ë©´ ìƒˆ í”Œë¡¯ ìƒíƒœë¡œ ì´ˆê¸°í™”
      dbStatus.textContent = 'DB ìƒíƒœ: ìƒˆ í”Œë¡¯ ì‘ì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤.';
      return;
    }

    dbStatus.textContent = "í”Œë¡¯ ë¡œë“œ ì¤‘...";

    try {
      const plotData = await apiFetch(`/api/load-settings?id=${plotIdToLoad}`);

      currentPlotId = plotData.id;
      plotNameInput.value = plotData.title || '';
      worldSettingInput.value = plotData.worldSetting || '';
      characterDetailsInput.value = plotData.characterDetails || '';
      plotDetailsInput.value = plotData.plotDetails || '';
      previousContentInput.value = plotData.previousContent || '';
      // DBì—ì„œ episode_numberë¥¼ ê°€ì ¸ì™€ ì„¤ì •
      episodeNumberInput.value = plotData.episode_number || '1';

      currentPlotIdDisplay.textContent = `(ID: ${currentPlotId})`;
      dbStatus.textContent = `DB ìƒíƒœ: í”Œë¡¯ '${plotData.title}' ë¡œë“œ ì™„ë£Œ. (${new Date().toLocaleTimeString()})`;

      loadPlotButton.disabled = false;
      deletePlotButton.disabled = false;

      // ğŸŒŸ ìƒì„¸ í…Œì´ë¸”ì—ì„œ ì„¸ê³„ê´€ ë° ë“±ì¥ì¸ë¬¼ ë°ì´í„° ë¡œë“œ ë° ë®ì–´ì“°ê¸° ğŸŒŸ
      // ì´ ë¡œì§ì´ ë©”ì¸ í…Œì´ë¸”ì˜ í•„ë“œ ë‚´ìš©ì„ ë®ì–´ì“°ê³ , ì—¬ëŸ¬ ê°œì˜ ìƒì„¸ ì„¤ì •ì„ í•©ì³ì„œ í‘œì‹œí•©ë‹ˆë‹¤.
      await loadAndDisplayWorldSettings(currentPlotId);
      await loadAndDisplayCharacters(currentPlotId);
      // ë¡œë“œ í›„ ì—°ê²°ëœ íšŒì°¨ ëª©ë¡ ì—…ë°ì´íŠ¸
      await updateEpisodeList(currentPlotId);

    } catch (error) {
      displayError(`í”Œë¡¯ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
      clearForm();
    }
  }

  /**
   * Save or update plot settings (í”Œë¡¯ ì„¤ì • ì €ì¥/ì—…ë°ì´íŠ¸)
   */
  window.saveCustomSettings = async function() {
    const plotTitle = plotNameInput.value.trim();
    const nextEpisodeNum = parseInt(episodeNumberInput.value, 10);

    if (!plotTitle) {
      displayError("í”Œë¡¯ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const payload = {
      id: currentPlotId, // IDê°€ nullì´ë©´ INSERT, ìˆìœ¼ë©´ UPDATE
      title: plotTitle,
      worldSetting: worldSettingInput.value.trim(),
      characterDetails: characterDetailsInput.value.trim(),
      plotDetails: plotDetailsInput.value.trim(),
      previousContent: previousContentInput.value.trim(),
      episode_number: nextEpisodeNum
    };

    dbStatus.textContent = "ì €ì¥ ì¤‘...";

    try {
      const result = await apiFetch('/api/save-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      currentPlotId = result.id; // ì‚½ì… ì‹œ ìƒˆë¡œ ë°›ì€ ID ì—…ë°ì´íŠ¸
      currentPlotIdDisplay.textContent = `(ID: ${currentPlotId})`;
      dbStatus.textContent = `DB ìƒíƒœ: í”Œë¡¯ '${plotTitle}' ì €ì¥/ì—…ë°ì´íŠ¸ ì™„ë£Œ. ID: ${currentPlotId} (${new Date().toLocaleTimeString()})`;

      await populatePlotSelector(); // ë“œë¡­ë‹¤ìš´ ìƒˆë¡œ ê³ ì¹¨
      plotSelector.value = currentPlotId; // í˜„ì¬ í”Œë¡¯ ì„ íƒ ìœ ì§€
      loadPlotButton.disabled = false;
      deletePlotButton.disabled = false;

    } catch (error) {
      // displayErrorëŠ” apiFetchì—ì„œ ì²˜ë¦¬ë¨
    }
  }

  /**
   * Delete the selected plot (ì„ íƒëœ í”Œë¡¯ ì‚­ì œ)
   */
  window.deleteSelectedPlot = async function() {
    const plotIdToDelete = plotSelector.value;
    const plotTitle = plotSelector.options[plotSelector.selectedIndex].text;

    if (!plotIdToDelete) return;

    // Note: Using window.confirm() for simple demo feedback.
    if (!confirm(`ì •ë§ë¡œ í”Œë¡¯ '${plotTitle}'ì™€ ê´€ë ¨ëœ ëª¨ë“  ì„¤ì • ë° ì €ì¥ëœ íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }

    dbStatus.textContent = "í”Œë¡¯ ë° íšŒì°¨ ì‚­ì œ ì¤‘...";

    try {
      await apiFetch(`/api/delete-settings?id=${plotIdToDelete}`, {
        method: 'DELETE'
      });

      dbStatus.textContent = `DB ìƒíƒœ: í”Œë¡¯ '${plotTitle}' ë° ê´€ë ¨ íšŒì°¨ ì‚­ì œ ì™„ë£Œ.`;

      // ì‚­ì œëœ í”Œë¡¯ì´ í˜„ì¬ ë¡œë“œëœ í”Œë¡¯ì´ë©´ í¼ ì´ˆê¸°í™”
      if (currentPlotId === plotIdToDelete) {
        clearForm();
      }

      await populatePlotSelector(); // ë“œë¡­ë‹¤ìš´ ìƒˆë¡œ ê³ ì¹¨
      // ì‚­ì œ í›„ ëª©ë¡ì´ ë¹„ì–´ìˆì§€ ì•Šë‹¤ë©´, ì²« ë²ˆì§¸ í”Œë¡¯ì„ ë¡œë“œ
      if (plotSelector.options.length > 1) {
        plotSelector.value = plotSelector.options[1].value;
        loadSelectedPlot();
      } else {
        clearForm();
        dbStatus.textContent = 'DB ìƒíƒœ: ì €ì¥ëœ í”Œë¡¯ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í”Œë¡¯ì„ ì‘ì„±í•˜ê³  ì €ì¥í•˜ì„¸ìš”.';
      }

    } catch (error) {
      // displayErrorëŠ” apiFetchì—ì„œ ì²˜ë¦¬ë¨
    }
  }

  // =======================================================
  // Story Episode Logic (ì†Œì„¤ íšŒì°¨ ì €ì¥ ë° ë¡œë“œ ë¡œì§)
  // =======================================================

  /**
   * Save generated story as an Episode (ìƒì„±ëœ ê¸€ì„ íšŒì°¨ë¡œ ì €ì¥)
   */
  window.saveStoryEpisode = async function() {
    const content = resultContainer.textContent.trim();
    const promptText = promptInput.value.trim();
    const episodeNum = parseInt(episodeNumberInput.value, 10) - 1; // ë°©ê¸ˆ ìƒì„±ëœ ê¸€ì€ 'ë‹¤ìŒ íšŒì°¨' ë²ˆí˜¸ì˜ -1

    if (!currentPlotId) {
      displayError("íšŒì°¨ë¥¼ ì €ì¥í•˜ê¸° ì „ì— ë¨¼ì € í”Œë¡¯ì„ ì €ì¥í•˜ê±°ë‚˜ ë¡œë“œí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!content || content.includes("ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤")) return;

    saveEpisodeButton.disabled = true;
    episodeSaveStatus.textContent = "íšŒì°¨ ì €ì¥ ì¤‘...";
    episodeSaveStatus.className = "text-sm mt-0 font-medium text-gray-600";

    const payload = {
      setting_id: currentPlotId, // stories.setting_id
      prompt: promptText, // stories.prompt
      content: content, // stories.content (LONGTEXT)
      episode_number: episodeNum // stories.episode_number
    };

    dbStatus.textContent = "íšŒì°¨ ë°ì´í„° ì €ì¥ ì¤‘...";

    try {
      const result = await apiFetch('/api/save-story', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      episodeSaveStatus.textContent = `âœ… ì œ ${episodeNum}í™” ì €ì¥ ì™„ë£Œ! (DB ID: ${result.id})`;
      episodeSaveStatus.className = "text-sm mt-0 font-bold text-green-600";
      dbStatus.textContent = `DB ìƒíƒœ: íšŒì°¨ ì €ì¥ ì™„ë£Œ. ID: ${result.id} (${new Date().toLocaleTimeString()})`;

      // íšŒì°¨ ì €ì¥ í›„ ëª©ë¡ ì—…ë°ì´íŠ¸ ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
      await updateEpisodeList(currentPlotId);
      await populatePlotSelector();

    } catch (e) {
      episodeSaveStatus.textContent = "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
      episodeSaveStatus.className = "text-sm mt-0 font-bold text-red-600";
      // displayErrorëŠ” apiFetchì—ì„œ ì²˜ë¦¬ë¨
    } finally {
      saveEpisodeButton.disabled = false;
    }
  }

  /**
   * Update the list of saved episodes in the UI (UIì— ì €ì¥ëœ íšŒì°¨ ëª©ë¡ ì—…ë°ì´íŠ¸)
   * @param {number} settingId - The ID of the current plot setting
   */
  async function updateEpisodeList(settingId) {
    if (!settingId) {
      episodeList.innerHTML = '<p class="italic text-gray-500">í”Œë¡¯ì„ ë¡œë“œí•˜ë©´ ì €ì¥ëœ íšŒì°¨ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>';
      return;
    }

    episodeList.innerHTML = '<div class="text-center py-4 text-gray-500">íšŒì°¨ ëª©ë¡ ë¡œë“œ ì¤‘...</div>';

    try {
      const episodes = await apiFetch(`/api/load-episodes?setting_id=${settingId}`);

      if (episodes.length === 0) {
        episodeList.innerHTML = '<p class="italic text-gray-500">ì €ì¥ëœ ì†Œì„¤ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      episodeList.innerHTML = episodes.map((episode) => {
        const time = new Date(episode.created_at).toLocaleTimeString();
        // promptì˜ ì•ë¶€ë¶„ì„ ì˜ë¼ì„œ í‘œì‹œ
        const promptSnippet = episode.prompt.trim().substring(0, 30) + (episode.prompt.trim().length > 30 ? '...' : '');

        return `
                    <div class="mb-2 p-2 border-b border-blue-100 last:border-b-0 flex justify-between items-center">
                        <span class="font-bold text-blue-900 truncate flex-grow">
                            ì œ ${episode.episode_number}í™”: ${promptSnippet}
                        </span>
                        <span class="text-xs text-gray-500 ml-4 flex-shrink-0">(${time})</span>
                    </div>
                `;
      }).join('');
    } catch (error) {
      episodeList.innerHTML = `<p class="text-red-500">íšŒì°¨ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
    }
  }

  // =======================================================
  // AI Simulation Functions (AI ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜)
  // =======================================================

  /**
   * Simulate AI generating text based on prompt and settings (í”„ë¡¬í”„íŠ¸ì™€ ì„¤ì •ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸€ ìƒì„± ì‹œë®¬ë ˆì´ì…˜)
   */
  window.generateText = async function() {
    const userPrompt = promptInput.value.trim();
    const worldSetting = worldSettingInput.value.trim();
    const characterDetails = characterDetailsInput.value.trim();
    const plotDetails = plotDetailsInput.value.trim();
    const previousContent = previousContentInput.value.trim();

    if (!userPrompt) {
      displayError("ê¸€ì“°ê¸° ìš”ì²­(í”„ë¡¬í”„íŠ¸)ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!plotNameInput.value.trim()) {
      displayError("í”Œë¡¯ ì´ë¦„ì„ ì§€ì •í•˜ê³  ë¨¼ì € ì„¤ì •ì„ ì €ì¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    // ----------------------------------------------------------------------------------
    // ğŸŒŸğŸŒŸğŸŒŸ ì‚¬ìš©ì ì œê³µ: ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ ë° ê°•ë ¥í•œ ì§‘í•„ í”„ë¡¬í”„íŠ¸ ì ìš© ğŸŒŸğŸŒŸğŸŒŸ
    // ----------------------------------------------------------------------------------
    let systemInstruction = `âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

3. ì‘ì—…íë¦„ì€ ì²¨ë¶€í•œ 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì— ìˆëŠ” í•´ë‹¹ ì‘ì—…ì˜ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

4. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì˜ "## í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)"ì„ ë°˜ì˜í•©ë‹ˆë‹¤.


ì—­í•  (Context)

ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ë¶„ì•¼ì˜ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì‘ê°€ì´ì ì˜¤íƒ€ì¿  ë¬¸í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‹¬ì§€ì–´ ì¸í„°ë„· ë°©ì†¡, ë²„ì¸„ì–¼ ë°©ì†¡ ë“± ê´€ë ¨ ì‚¬ì—…ì— ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ìœ íŠœë¸Œë‚˜ ì‡¼ì¸ , í‹°í†¡ê´€ë ¨ ì»¨í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.


ì „ì²´ ê¸€ì—ëŒ€í•œ ë°°ê²½ ë° ì„¤ì • (Context)

- ì§‘í•„ ëª©í‘œ: (ì‚¬ìš©ìì˜ ì„¤ì •ë“¤ ë˜ëŠ” ê°„ë‹¨í•œ ì¤„ê±°ë¦¬ ìŠ¤í† ë¦¬ ë“±ë“± ë°°ê²½ê³¼ ì“°ê³ ì í•˜ëŠ” ê¸€ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„)

- íƒ€ê²Ÿ ë…ì:

- í•µì‹¬ ë©”ì‹œì§€: (ì£¼ì œ? ë˜ëŠ” ëª©í‘œ?)

- ë…ì°½ì  ê´€ì :  (ë…ì°½ì ì¸ ì„¤ì • ë˜ëŠ” ì„¸ê³„ê´€?)

- í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:  (ì–´ë–¤ ë¬¸í™”? ê´€ìŠµ? ë“±ë“± ìœ„ ë¶„ë¦¬ëœ í•­ëª©ì„ í†µí•©ìœ¼ë¡œ í•´ë„ ë¨.)


- ë¶„ëŸ‰: 1íšŒë‹¹ í•œê¸€ ê¸€ìë¡œ ì•½ 6000ì (ê³µë°± ë¯¸í¬í•¨).
              A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€. (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì)

- ë¬¸ë‹¨ í˜•ì‹: Aíƒ€ì… ì„œì‹: ì›¹ì†Œì„¤ ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.



1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤. í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

3. ë§ˆí¬ì—… ì œê±° :

 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

ê¸€ì“°ê¸° ì§€ì‹œì‚¬í•­ (Style & Action)

ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.
- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©, ê°ˆë“±ê³¼ í•´ê²°ì˜ ê·¹ì  êµ¬ì„±.
- íŠ¹ìˆ˜ í˜•ì‹: ì‹œì²­ì(ë…ì) ê´€ë ¨ ì„œìˆ ì€ ì±„íŒ…ì°½ í˜•ì‹ìœ¼ë¡œ ìµœëŒ€í•œ ì±„íŒ…ì˜ ì¬ë¯¸ë¡œ ì„œìˆ .


ì‘ì—… íë¦„ (Action)

ì…ë ¥ ì¡°ê±´ë³„ ì²˜ë¦¬

1. "ì‹œì‘" ì…ë ¥ ì‹œ

- ì‚¬ìš©ìê°€ ì…ë ¥í•œ 1íšŒë¶„ëŸ‰ í”Œë¡¯ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìœ„ ê·œì¹™ëŒ€ë¡œ ì›ê³ ë¥¼ ì‘ì„±.


ì¶œë ¥ í˜•ì‹ (Result)

- ì–¸ì–´: í•œêµ­ì–´

- í˜•ì‹: ìš”ì²­ëœ í˜ì´ì§€ ìˆ˜ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„±ëœ ì›ê³ ë¥¼ ê¼­!! ë§ˆí¬ë‹¤ìš´ íƒìŠ¤íŠ¸ ë¬¸ì„œë¡œ ì œê³µ.

- íƒ€ì´í‹€: ì›ê³ ì˜ ì œëª© ì‘ì„±

- ë¶„ëŸ‰: 1íšŒë‹¹ í•œê¸€ ê¸€ìë¡œ ì•½ 6000ì (ê³µë°± ë¯¸í¬í•¨).
              A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).



í’ˆì§ˆ ê¸°ì¤€

- ë²„ì¶”ì–¼ ìœ íŠœë²„ì™€ ì›¹ì†Œì„¤ì„ ì¦ê¸°ëŠ” ë…ìê°€ ì‰½ê²Œ ì´í•´í•˜ê³  ëª°ì…í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€.

- ì›¹ì†Œì„¤ì˜ ê³ ìœ í•œ íŠ¹ì„±ê³¼ ë§¤ë ¥ êµ¬í˜„.

- AI ê²€ì¶œê¸°ë¥¼ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì“°ê¸°.

- ëª¨ë“  AI ê²€ì¶œ íšŒí”¼ ì›ì¹™ì˜ ì² ì €í•œ ì ìš©.


ì‘ì—… íë¦„ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”Œë¡¯ì„ ê¸°ë³¸ìœ¼ë¡œ 1íšŒë¶„ ê¸€ì“°ê¸°ì— ëŒ€í•œ ìƒì„¸ ì ˆì°¨ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.


ì²« ì¶œë ¥  : ì´ì œ ë³¸ë¬¸ ì‘ì„±ì„ ì‹œì‘ í•˜ê² ìŠµë‹ˆë‹¤.


í™•ì •ëœ ê°œìš”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ì²­ ë¶„ëŸ‰ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„± ì›ê³ ë¥¼ ì‘ì„±.


ì‘ì„± ê²°ê³¼:
- ì´ ë¶„ëŸ‰: [ì‹¤ì œ ì‘ì„±ëœ í•œê¸€ ê¸€ì ìˆ˜].
- ì˜ˆìƒ í˜ì´ì§€: ì•½ [í˜ì´ì§€ ìˆ˜]í˜ì´ì§€.

í’ˆì§ˆ ì²´í¬:
- âœ… ë¶„ëŸ‰ ì ì •ì„± (Â±5% ì´ë‚´).
- âœ… ëª©ì°¨ìƒ ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš© ì ì ˆì„±.
- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).
- âœ… ì›ê³ ì˜ íƒ€ì´í‹€ ì‘ì„±.

âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­

1. ë¶„ëŸ‰ ì¤€ìˆ˜ëŠ” Â±5% ì´ë‚´ë¡œ ì—„ê²©íˆ ê´€ë¦¬.
2. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
3. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.




í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.
`;

    // ----------------------------------------------------------------------------------
    // ğŸŒŸğŸŒŸğŸŒŸ ê¸°ì¡´ ì„¤ì • ì •ë³´ ë° í•™ìŠµ ì»¨í…ìŠ¤íŠ¸ ì£¼ì… ğŸŒŸğŸŒŸğŸŒŸ
    // ----------------------------------------------------------------------------------

    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì„¤ì •ì„ ìœ„ì—ì„œ ì •ì˜í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì˜ 'Context' ì„¹ì…˜ì— ë™ì ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.

    systemInstruction += "\n\n--- [í˜„ì¬ ê¸€ì˜ êµ¬ì²´ì  ì„¤ì • ì •ë³´ (ì‚¬ìš©ì ì…ë ¥)] ---\n";

    if (worldSetting) { systemInstruction += `\n[1. ì„¸ê³„ê´€ ì„¤ì •]\n${worldSetting}\n`; }
    if (characterDetails) { systemInstruction += `\n[2. ë“±ì¥ì¸ë¬¼ ìƒì„¸ ì •ë³´]\n${characterDetails}\n`; }
    if (plotDetails) { systemInstruction += `\n[3. í”Œë¡¯ ë° ì „ì²´ ì¤„ê±°ë¦¬]\n${plotDetails}\n`; }
    if (previousContent) { systemInstruction += `\n[4. ì´ì „í™” ë‚´ìš© ìš”ì•½]\n${previousContent}\n`; }

    // UI ìƒíƒœ ì—…ë°ì´íŠ¸
    generateButton.disabled = true;
    loadingIndicator.classList.remove('hidden');
    resultContainer.textContent = 'ê¸€ì“°ê¸° AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
    errorMessage.classList.add('hidden');

       // ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
    const proxyUrl = '/api/generate-text';
    
    // Gemini APIê°€ ì‹¤ì œë¡œ ë°›ì„ Payload
    const geminiPayload = {
      contents: [{ parts: [{ text: userPrompt }] }],
      systemInstruction: { parts: [{ text: systemInstruction }] },
    };
     // í”„ë¡ì‹œ ì„œë²„ë¡œ ë³´ë‚¼ Payload (modelê³¼ Geminiìš© payloadë¥¼ ê°ìŒˆ)
    const requestBody = {
      model: modelName,
      payload: geminiPayload
    };
    
    const maxRetries = 5;
    let retryDelay = 1000;

    for (let i = 0; i < maxRetries; i++) {
      try {
        const response = await fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });


        if (!response.ok) {
          const errorBody = await response.json();
          const errorMessage = errorBody.error?.message || `ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (HTTP ${response.status})`;
          if (errorMessage.includes("too long") || errorMessage.includes("exhausted")) {
            throw new Error(`[í† í° ì´ˆê³¼ ì˜¤ë¥˜] ì„¤ì •, í•™ìŠµ ë°ì´í„°, ìš”ì²­ì˜ ì „ì²´ ê¸¸ì´ê°€ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìŠµ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê±°ë‚˜ ì„¤ì •ì„ ê°„ê²°í•˜ê²Œ í•´ì£¼ì„¸ìš”.`);
          }
          throw new Error(`HTTP ì˜¤ë¥˜ ${response.status}: ${errorMessage}`);
        }

        const result = await response.json();

        const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (generatedText) {
          resultContainer.textContent = generatedText;
          // ìƒì„±ëœ ê¸€ì´ ê´œì°®ìœ¼ë©´ ë‹¤ìŒ íšŒì°¨ ë²ˆí˜¸ ìë™ ì¦ê°€
          const nextEpisode = parseInt(episodeNumberInput.value, 10) + 1;
          episodeNumberInput.value = nextEpisode;

          // ë‹¤ìŒ íšŒì°¨ ë²ˆí˜¸ë¥¼ DBì—ë„ ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ë²ˆ ë¡œë“œë¥¼ ìœ„í•´)
          await saveCustomSettings();

          // ğŸŒŸ ì„±ê³µì ìœ¼ë¡œ ê²°ê³¼ê°€ ìƒì„±ë˜ë©´ ì €ì¥ ë²„íŠ¼ í™œì„±í™” ğŸŒŸ
          saveEpisodeButton.disabled = false;
        } else {
          resultContainer.textContent = 'API ì‘ë‹µì—ì„œ ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì•ˆì „ í•„í„°ì— ê±¸ë ¸ê±°ë‚˜ ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜)';
          displayError('API ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜ ë˜ëŠ” ë‚´ìš© ëˆ„ë½.');
        }

        break;

      } catch (error) {
        console.error('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);

        if (i < maxRetries - 1) {
          await new Promise(resolve => setTimeout(resolve, retryDelay));
          retryDelay *= 2;
        } else {
          resultContainer.textContent = '';
          displayError(`í…ìŠ¤íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${error.message})`);
        }
      }
    }

    // UI ìƒíƒœ ë³µêµ¬
    generateButton.disabled = false;
    loadingIndicator.classList.add('hidden');

  }



  /**
   * Application initialization (ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”)
   */
  async function initializeApp() {
    dbStatus.textContent = `DB ìƒíƒœ: ì„œë²„ì— ì—°ê²° ì¤‘...`;

    await populatePlotSelector();

    // populatePlotSelectorê°€ ì™„ë£Œëœ í›„ ì²« ë²ˆì§¸ í”Œë¡¯ì„ ìë™ìœ¼ë¡œ ë¡œë“œ ì‹œë„
    if (plotSelector.value) {
      await loadSelectedPlot();
    } else {
      clearForm();
      dbStatus.textContent = 'DB ìƒíƒœ: ì €ì¥ëœ í”Œë¡¯ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í”Œë¡¯ì„ ì‘ì„±í•˜ê³  ì €ì¥í•˜ì„¸ìš”.';
    }
  }

  // Event listeners for select change (ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ)
  plotSelector.addEventListener('change', () => {
    // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ, ì„ íƒëœ í”Œë¡¯ì„ ë¡œë“œ
    loadSelectedPlot();
  });

  // Run initialization on page load (í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰)
  window.onload = initializeApp;

</script>

</body>
</html>