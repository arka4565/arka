<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì°¨ ìƒì„¸ í¸ì§‘ ë° AI ê°œì„  ë„êµ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSSë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì‚¬ìš©ì ì§€ì • ìŠ¤íƒ€ì¼ë„ ì¶”ê°€í•©ë‹ˆë‹¤. */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .read-only-content {
            white-space: pre-wrap;
            min-height: 200px;
            background-color: #f8fafc; /* blue-50 */
            border: 1px solid #e2e8f0; /* slate-200 */
        } /* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .nav-link {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out;
        }
    </style>
</head>
!-- ìƒë‹¨ ë©”ë‰´ ì¶”ê°€ë¥¼ ìœ„í•´ body ìŠ¤íƒ€ì¼ ì¡°ì • -->
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center h-14 sm:h-16">
            
            <div class="flex-shrink-0 flex items-center pr-4">
                <a href="#" class="text-gray-800 text-lg font-bold whitespace-nowrap">
                   ì†Œì„¤ì‘ë²•
                </a>
            </div>

            <div class="flex-1 flex items-center justify-end min-w-0">
                
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1 w-full sm:w-auto no-scrollbar">
                    
                    <a href="/" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê¸€ì“°ê¸°
                    </a>
                    
                    <a href="/index3" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ì„¸ê³„ê´€
                    </a>
                    
                    <a href="/index4" class="px-3 py-2 rounded-md text-sm sm:text-base font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" aria-current="page">
                        ì—í”¼ì†Œë“œ
                    </a>
                    
                    <a href="/index2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ë“±ì¥ì¸ë¬¼
                    </a>
                    
                    <a href="/storys2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ìƒì„¸í¸ì§‘
                    </a>
                    
                    <a href="/storys1" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê²€ì¦
                    </a>
                </div>
            </div>

        </div>
    </div>
</nav>

<style>
    /* Chrome, Safari, Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>


<div id="app" class="mt-16 sm:mt-20 w-full max-w-7xl bg-white shadow-2xl rounded-xl p-4 sm:p-8 border border-gray-100 mb-8">

    <h2 class="text-3xl font-bold text-gray-800 mb-2 border-b pb-3">
        íšŒì°¨ ìƒì„¸ í¸ì§‘ ë° AI ê°œì„  ë„êµ¬
    </h2>

    <!-- í”Œë¡¯ ì„¤ì • ë° íšŒì°¨ ì„ íƒ UI -->
    <div class="flex flex-wrap items-center space-x-3 mb-6">

        <!-- í”Œë¡¯ ì„¤ì • ì„ íƒ ë“œë¡­ë‹¤ìš´ (ìƒˆë¡œ ì¶”ê°€ë¨) -->
        <label for="plot-selector" class="font-medium text-gray-700 whitespace-nowrap">í”Œë¡¯ ì„¤ì • ì„ íƒ:</label>
        <select id="plot-selector" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 min-w-[200px]" disabled>
            <option value="">í”Œë¡¯ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
        </select>

        <!-- ê¸°ì¡´ íšŒì°¨ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <label for="episode-selector" class="font-medium text-gray-700 whitespace-nowrap">íšŒì°¨ ì„ íƒ:</label>
        <select id="episode-selector" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 min-w-[150px]" disabled>
            <option value="">ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš”</option>
        </select>

        <p id="system-info" class="text-xs text-gray-500 ml-auto mt-2 md:mt-0">API ìƒíƒœ: ì—°ê²° ì¤‘...</p>
    </div>

    <div id="content-area" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- ì™¼ìª½ ì„¹ì…˜: íšŒì°¨ ë‚´ìš© í¸ì§‘ (2/3 ì˜ì—­) -->
        <div class="lg:col-span-2 flex flex-col space-y-4">

            <!-- ì„¤ì • ìƒì„¸ ì •ë³´ (í† ê¸€ ê°€ëŠ¥) -->
            <div id="setting-detail-card" class="bg-gray-50 rounded-xl border border-gray-200 shadow-sm">
                <div id="settings-header" class="p-4 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition duration-150">
                    <h4 class="font-bold text-gray-700">ğŸ“Œ í”Œë¡¯ ì„¤ì • ìƒì„¸ ë³´ê¸° (í´ë¦­í•˜ì—¬ í† ê¸€)</h4>
                    <span id="settings-toggle-icon" class="text-gray-500 transform transition-transform duration-300">â–¼</span>
                </div>
                <div id="settings-body" class="p-4 pt-0 hidden text-sm">
                    <p class="text-gray-600">
                        <strong>ì„¸ê³„ê´€:</strong> <span id="setting-world"></span><br>
                        <strong>ìºë¦­í„° ìƒì„¸:</strong> <span id="setting-character"></span><br>
                        <strong>í”Œë¡¯ ìƒì„¸:</strong> <span id="setting-plot"></span>
                    </p>
                </div>
            </div>

            <!-- íšŒì°¨ ë‚´ìš© ì—ë””í„° (í† ê¸€ ê°€ëŠ¥) -->
            <div id="story-editor-card" class="border rounded-xl shadow-md bg-white flex flex-col">
                <div id="editor-header" class="p-4 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition duration-150 rounded-t-xl">
                    <h3 class="text-xl font-semibold text-blue-600">
                        <span id="selected-episode-title">íšŒì°¨ ë‚´ìš© í¸ì§‘</span> (í´ë¦­í•˜ì—¬ í† ê¸€)
                    </h3>
                    <span id="editor-toggle-icon" class="text-gray-500 transform transition-transform duration-300">â–¼</span>
                </div>
                <div id="editor-body" class="p-4 pt-0 hidden flex-grow">
                         <textarea id="story-content-editor"
                                   class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500 custom-scroll text-sm"
                                   rows="20"
                                   placeholder="íšŒì°¨ ë‚´ìš©ì„ í¸ì§‘í•˜ê±°ë‚˜, AIë¡œ ìƒì„±ëœ ì´ˆì•ˆì„ ì ìš©í•˜ì„¸ìš”."></textarea>
                    <!-- **ìƒˆë¡œ ì¶”ê°€ëœ 'ìˆ˜ì • ë‚´ìš© ì €ì¥' ë²„íŠ¼** -->
                    <button id="save-edited-content-button"
                            class="mt-3 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        ìˆ˜ì • ë‚´ìš© ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜)
                    </button>
                    <p id="save-message" class="text-center text-sm mt-2 hidden"></p>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜: AI ê°œì„  ë° ìƒˆ ë‚´ìš© ì‘ì„± (1/3 ì˜ì—­) -->
        <div class="lg:col-span-1 flex flex-col space-y-4">

            <!-- AI ê°œì„  í”„ë¡¬í”„íŠ¸ ì„¹ì…˜ -->
            <div class="border rounded-xl p-4 shadow-md bg-white">
                <h3 class="text-xl font-semibold text-purple-600 mb-3 border-b pb-2">
                    AI ê°œì„  í”„ë¡¬í”„íŠ¸
                </h3>

                <textarea id="improvement-prompt"
                          class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-purple-500 focus:border-purple-500 custom-scroll text-sm mb-4"
                          rows="6"
                          placeholder="ì˜ˆ: 'ì£¼ì¸ê³µì˜ ê°ì •ì„ ì„ ë” ê°•ì¡°í•˜ê³ , ë°°ê²½ ë¬˜ì‚¬ë¥¼ ë™ì–‘ì ì¸ ëŠë‚Œìœ¼ë¡œ ìˆ˜ì •í•´ì¤˜.'"></textarea>

                <button id="rewrite-story-button"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                    <span id="rewrite-button-text">AIë¡œ ìƒˆ ë‚´ìš© ì‘ì„±</span>
                    <span id="rewrite-spinner" class="spinner ml-3 hidden"></span>
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    * ìƒˆ ë‚´ìš©ì€ ì•„ë˜ 'ì´ˆì•ˆ'ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- AI ìƒì„± ì´ˆì•ˆ ì„¹ì…˜ (Staging Area) -->
            <div class="border rounded-xl p-4 shadow-md bg-white flex-grow">
                <h3 class="text-xl font-semibold text-green-600 mb-3 border-b pb-2">
                    AI ìƒì„± ì´ˆì•ˆ (Draft)
                </h3>

                <div id="ai-draft-output" class="read-only-content p-3 rounded-lg overflow-y-auto custom-scroll text-sm">
                    ì—¬ê¸°ì— AIê°€ ì¬ì‘ì„±í•œ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.
                </div>

                <!-- AI ë³€ê²½ ì‚¬ìœ  í‘œì‹œ ì˜ì—­ -->
                <div id="ai-reason-area" class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg hidden">
                    <h4 class="font-semibold text-yellow-800 mb-1">ğŸ’¡ ë³€ê²½ ìš”ì•½ (ì €ì¥ë˜ì§€ ì•ŠìŒ)</h4>
                    <p id="ai-reason-output" class="text-sm text-gray-700"></p>
                </div>
                <!-- END AI ë³€ê²½ ì‚¬ìœ  í‘œì‹œ ì˜ì—­ -->

                <button id="apply-draft-button"
                        class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    ìƒˆ ë‚´ìš© ì ìš© ë° ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ì— ì¦‰ì‹œ ë°˜ì˜)
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    * ì ìš©í•˜ë©´ í¸ì§‘ê¸°ì— ë°˜ì˜ë˜ë©°, ë™ì‹œì— ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- ê¸€ë¡œë²Œ ë³€ìˆ˜ ë° ì„¤ì • ---

    // ì„œë²„ì˜ API ê¸°ë³¸ URL (index.jsê°€ ì‹¤í–‰ë˜ëŠ” ê³³)
    // **ì£¼ì˜**: ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì´ URLì„ Canvas í™˜ê²½ ë³€ìˆ˜ ë“±ìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
    const API_BASE_URL = '/api';

    const modelName = 'gemini-2.5-pro';
    // ìƒíƒœ ë³€ìˆ˜
    let allSettings = [];
    let currentSettingStories = [];
    let selectedSettingId = null;
    let selectedStoryId = null;

    // UI ìš”ì†Œ
    const plotSelector = document.getElementById('plot-selector');
    const episodeSelector = document.getElementById('episode-selector');
    const systemInfo = document.getElementById('system-info');
    const storyContentEditor = document.getElementById('story-content-editor');
    const selectedEpisodeTitle = document.getElementById('selected-episode-title');
    const improvementPrompt = document.getElementById('improvement-prompt');
    const rewriteStoryButton = document.getElementById('rewrite-story-button');
    const rewriteButtonText = document.getElementById('rewrite-button-text');
    const rewriteSpinner = document.getElementById('rewrite-spinner');
    const saveMessage = document.getElementById('save-message');
    const saveEditedContentButton = document.getElementById('save-edited-content-button'); // ìƒˆë¡œ ì¶”ê°€ëœ ë²„íŠ¼

    // ì„¤ì • ìƒì„¸ UI ìš”ì†Œ
    const settingsHeader = document.getElementById('settings-header');
    const settingsBody = document.getElementById('settings-body');
    const settingsToggleIcon = document.getElementById('settings-toggle-icon');
    const settingWorld = document.getElementById('setting-world');
    const settingCharacter = document.getElementById('setting-character');
    const settingPlot = document.getElementById('setting-plot');

    // íšŒì°¨ ì—ë””í„° í† ê¸€ UI ìš”ì†Œ
    const editorHeader = document.getElementById('editor-header');
    const editorBody = document.getElementById('editor-body');
    const editorToggleIcon = document.getElementById('editor-toggle-icon');

    // AI ìƒì„± ì´ˆì•ˆ UI ìš”ì†Œ
    const aiDraftOutput = document.getElementById('ai-draft-output');
    const aiReasonArea = document.getElementById('ai-reason-area');
    const aiReasonOutput = document.getElementById('ai-reason-output');
    const applyDraftButton = document.getElementById('apply-draft-button');

    // AI API ì„¤ì • (Gemini APIëŠ” ì„œë²„ í†µì‹ ê³¼ ë³„ê°œë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ í˜¸ì¶œë¨)
    const GEMINI_MODEL = "gemini-2.5-pro";
   
	// AI ì‘ë‹µì˜ JSON ìŠ¤í‚¤ë§ˆ ì •ì˜ (ë‚´ìš©ê³¼ ë³€ê²½ ì‚¬ìœ ë¥¼ ë°›ê¸° ìœ„í•¨)
    const RESPONSE_SCHEMA = {
        type: "OBJECT",
        properties: {
            rewrittenContent: {
                type: "STRING",
                description: "The full, newly rewritten content of the story episode, based on all settings and the user's request."
            },
            reasonForChange: {
                type: "STRING",
                description: "A concise, single-paragraph summary in Korean explaining the core changes made, referring to the user's prompt and the plot settings."
            }
        },
        required: ["rewrittenContent", "reasonForChange"]
    };


    // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

    // Exponential Backoffì„ ì‚¬ìš©í•œ API í˜¸ì¶œ ì¬ì‹œë„ ë¡œì§
    async function retryWithExponentialBackoff(fetcher, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetcher();
                if (!response.ok) {
                    let errorDetail = '';
                    try {
                        errorDetail = await response.json();
                        errorDetail = JSON.stringify(errorDetail, null, 2);
                    } catch {
                        errorDetail = await response.text();
                        errorDetail = errorDetail.substring(0, 50) + '...';
                    }
                    console.error("API Response Error:", errorDetail);
                    if (i < maxRetries - 1) {
                        throw new Error(`Retrying: API call failed with status ${response.status}`);
                    } else {
                        throw new Error(`API call failed with status ${response.status}: ${errorDetail}`);
                    }
                }
                return response;
            } catch (error) {
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw error;
                }
            }
        }
    }

    // --- ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€ë˜ê±°ë‚˜ ìˆ˜ì •ë¨) ---

    /**
     * í˜„ì¬ íšŒì°¨ì˜ ë‚´ìš©ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤ (UPDATE).
     * @param {string} contentToSave - ì €ì¥í•  íšŒì°¨ ë‚´ìš©
     * @param {string} source - 'draft' ë˜ëŠ” 'manual' (ë©”ì‹œì§€ êµ¬ë¶„ì„ ìœ„í•¨)
     */
    async function saveStoryContent(contentToSave, source = 'manual') {
        if (!selectedSettingId || !selectedStoryId) {
            showMessage('ì €ì¥í•  ì„¤ì • ë˜ëŠ” íšŒì°¨ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'text-red-500');
            return;
        }
        if (!contentToSave) {
            showMessage('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'text-red-500');
            return;
        }

        // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
        saveEditedContentButton.disabled = true;
        if (source === 'manual') {
            saveEditedContentButton.textContent = 'ì €ì¥ ì¤‘...';
        } else if (source === 'draft') {
            applyDraftButton.disabled = true;
            applyDraftButton.textContent = 'ì €ì¥ ì¤‘...';
        }

        showMessage('ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ìš”ì²­ ì¤‘...', 'text-gray-500');

        try {
            const response = await fetch(`${API_BASE_URL}/update-story-content`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    setting_id: selectedSettingId,
                    story_id: selectedStoryId,
                    content: contentToSave
                })
            });

            if (!response.ok) {
                const errorJson = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜' }));
                throw new Error(errorJson.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
            }

            // ì„±ê³µ ë©”ì‹œì§€
            if (source === 'manual') {
                showMessage('âœ… ìˆ˜ì •ëœ ë‚´ìš©ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'text-indigo-600');
            } else if (source === 'draft') {
                showMessage('âœ… AI ì´ˆì•ˆì´ ì ìš©ë˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'text-green-600');
                // AI ì‘ì—… ì™„ë£Œ í›„, ì—ë””í„°ì— ì ìš©ëœ ë‚´ìš©ìœ¼ë¡œ í˜„ì¬ íšŒì°¨ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ (UI ë™ê¸°í™”)
                const selectedStory = currentSettingStories.find(e => e.id.toString() === selectedStoryId);
                if (selectedStory) {
                    selectedStory.content = contentToSave;
                }
            }

            // ì—ë””í„° ë‚´ìš©ì´ í˜„ì¬ ì €ì¥ëœ ë‚´ìš©ê³¼ ê°™ìœ¼ë¯€ë¡œ UI ë™ê¸°í™”
            storyContentEditor.value = contentToSave;

        } catch (error) {
            console.error("Failed to save content:", error);
            showMessage(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'text-red-600');
        } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            saveEditedContentButton.disabled = false;
            saveEditedContentButton.textContent = 'ìˆ˜ì • ë‚´ìš© ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜)';

            applyDraftButton.disabled = applyDraftButton.textContent === 'ì €ì¥ ì¤‘...'; // Draft ë²„íŠ¼ì€ ì €ì¥ í›„ì— ë¹„í™œì„±í™”
            applyDraftButton.textContent = 'ìƒˆ ë‚´ìš© ì ìš© ë° ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ì— ì¦‰ì‹œ ë°˜ì˜)';
        }
    }

    // --- ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ---

    // ëª¨ë“  ì„¤ì • ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ í”Œë¡¯ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ì±„ì›ë‹ˆë‹¤. (ìë™ ì„ íƒ ì—†ìŒ)
    async function fetchSettingsAndInit() {
        systemInfo.textContent = 'API ìƒíƒœ: ì„¤ì • ëª©ë¡ ìš”ì²­ ì¤‘...';
        try {
            const response = await fetch(`${API_BASE_URL}/settings-list`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            allSettings = await response.json();

            renderPlotSelector();

            if (allSettings.length === 0) {
                systemInfo.textContent = 'API ìƒíƒœ: ë°ì´í„° ì—†ìŒ. index.jsì—ì„œ ì„¤ì • ì¶”ê°€ í•„ìš”.';
                renderSettingDetails({worldSetting: 'N/A', characterDetails: 'N/A', plotDetails: 'N/A'});
            }

        } catch (error) {
            console.error("Failed to fetch settings:", error);
            systemInfo.textContent = `API ìƒíƒœ: ì—°ê²° ì‹¤íŒ¨ (${error.message})`;
            plotSelector.innerHTML = '<option value="">ì—°ê²° ì‹¤íŒ¨</option>';
        }
    }

    // ìƒˆë¡œìš´ í•¨ìˆ˜: í”Œë¡¯ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
    function renderPlotSelector() {
        plotSelector.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--- í”Œë¡¯ ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš” ---';
        plotSelector.appendChild(defaultOption);

        if (allSettings.length > 0) {
            allSettings.forEach(setting => {
                const option = document.createElement('option');
                option.value = setting.id.toString();
                option.textContent = setting.title;
                plotSelector.appendChild(option);
            });
            plotSelector.disabled = false;
        } else {
            plotSelector.innerHTML = '<option value="">í”Œë¡¯ ì„¤ì • ì—†ìŒ</option>';
            plotSelector.disabled = true;
        }
    }

    // íŠ¹ì • ì„¤ì • IDì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  íšŒì°¨ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    async function fetchStoriesForSetting(settingId) {
        if (!settingId) {
            selectedSettingId = null;
            currentSettingStories = [];
            renderSettingDetails({worldSetting: 'N/A', characterDetails: 'N/A', plotDetails: 'N/A'});
            renderEpisodeSelector();
            renderStoryDetail(); // ìƒì„¸ ë‚´ìš© ì´ˆê¸°í™”
            systemInfo.textContent = 'API ìƒíƒœ: í”Œë¡¯ ì„¤ì •ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            return;
        }

        selectedSettingId = settingId.toString();
        systemInfo.textContent = `API ìƒíƒœ: íšŒì°¨ ëª©ë¡ ìš”ì²­ ì¤‘ (Setting ID: ${selectedSettingId})...`;

        try {
            const response = await fetch(`${API_BASE_URL}/load-episodes?setting_id=${selectedSettingId}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            currentSettingStories = await response.json();

            // ì„¤ì • ì œëª© ì—…ë°ì´íŠ¸ ë° ìƒì„¸ ì •ë³´ ë Œë”ë§
            const selectedSetting = allSettings.find(p => p.id.toString() === selectedSettingId);
            if (selectedSetting) {
                renderSettingDetails(selectedSetting);
            }

            renderEpisodeSelector();

            if (currentSettingStories.length > 0) {
                // ì²« ë²ˆì§¸ íšŒì°¨ë¥¼ ìë™ìœ¼ë¡œ ì„ íƒí•˜ê³  ìƒì„¸ ë‚´ìš©ì„ ë Œë”ë§ (íšŒì°¨ëŠ” ìë™ ì„ íƒ)
                selectedStoryId = currentSettingStories[0].id.toString();
                handleEpisodeSelection(selectedStoryId, false);
                systemInfo.textContent = `API ìƒíƒœ: ${currentSettingStories.length}ê°œ íšŒì°¨ ë¡œë“œ ì™„ë£Œ.`;
            } else {
                systemInfo.textContent = 'API ìƒíƒœ: ì„ íƒëœ ì„¤ì •ì— íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.';
                selectedStoryId = null;
                renderStoryDetail();
            }

        } catch (error) {
            console.error("Failed to fetch stories:", error);
            systemInfo.textContent = 'API ìƒíƒœ: íšŒì°¨ ë¡œë“œ ì‹¤íŒ¨';
        }
    }

    // --- UI ë Œë”ë§ í•¨ìˆ˜ ---

    // íšŒì°¨ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
    function renderEpisodeSelector() {
        episodeSelector.innerHTML = '';

        if (currentSettingStories.length === 0) {
            episodeSelector.innerHTML = '<option value="">íšŒì°¨ ì—†ìŒ</option>';
            episodeSelector.disabled = true;
            return;
        }

        currentSettingStories.forEach(story => {
            const option = document.createElement('option');
            option.value = story.id.toString();
            option.textContent = `[${story.episode_number}í™”] ${story.prompt.substring(0, 20)  || 'ì œëª© ì—†ìŒ'}`;
            episodeSelector.appendChild(option);
        });

        episodeSelector.value = selectedStoryId;
        episodeSelector.disabled = false;
        rewriteStoryButton.disabled = false;
    }

    // ì„¤ì • ìƒì„¸ ì •ë³´ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
    function renderSettingDetails(setting) {
        settingWorld.textContent = setting.worldSetting || 'N/A';
        settingCharacter.textContent = setting.characterDetails || 'N/A';
        settingPlot.textContent = setting.plotDetails || 'N/A';
    }

    // ì„ íƒëœ íšŒì°¨ì˜ ìƒì„¸ ë‚´ìš©ì„ ì—ë””í„°ì— ë¡œë“œí•©ë‹ˆë‹¤.
    function renderStoryDetail(shouldScroll = true) {
        const selectedStory = currentSettingStories.find(e => e.id.toString() === selectedStoryId);

        // UI ìƒíƒœ ì´ˆê¸°í™”
        storyContentEditor.disabled = !selectedStory;
        rewriteStoryButton.disabled = !selectedStory;
        improvementPrompt.disabled = !selectedStory;
        saveEditedContentButton.disabled = !selectedStory; // ì €ì¥ ë²„íŠ¼ ìƒíƒœ
        applyDraftButton.disabled = true;
        aiDraftOutput.textContent = 'ì—¬ê¸°ì— AIê°€ ì¬ì‘ì„±í•œ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.';
        aiReasonArea.classList.add('hidden');
        aiReasonOutput.textContent = '';
        saveMessage.classList.add('hidden');

        if (!selectedStory) {
            selectedEpisodeTitle.textContent = 'íšŒì°¨ ë‚´ìš© í¸ì§‘';
            storyContentEditor.value = 'í”Œë¡¯ ì„¤ì • ë˜ëŠ” íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
            return;
        }

        selectedEpisodeTitle.textContent = `[${selectedStory.episode_number}í™”] ${selectedStory.prompt.substring(0, 20)  || 'ì œëª© ì—†ìŒ'}`;

        // í˜„ì¬ ë‚´ìš©ì„ ì—ë””í„°ì— ë¡œë“œ
        storyContentEditor.value = selectedStory.content || '';

        if (shouldScroll) {
            storyContentEditor.scrollTop = 0;
        }
    }

    // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

    // íšŒì°¨ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ
    function handleEpisodeSelection(storyId, shouldScroll = true) {
        selectedStoryId = storyId.toString();
        episodeSelector.value = selectedStoryId; // ë“œë¡­ë‹¤ìš´ ê°’ ë™ê¸°í™”
        renderStoryDetail(shouldScroll);
    }

    /**
     * AI ì¬ì‘ì„± API í˜¸ì¶œ ë¡œì§
     * @param {string} customPrompt - ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸
     */
    async function callGeminiRewrite(customPrompt) {
        if (!selectedSettingId || !selectedStoryId) return;

        const selectedSetting = allSettings.find(p => p.id.toString() === selectedSettingId);
        const selectedStory = currentSettingStories.find(e => e.id.toString() === selectedStoryId);
        const currentContent = storyContentEditor.value; // í¸ì§‘ê¸° ìµœì‹  ë‚´ìš© ì‚¬ìš©

        if (!selectedSetting || !selectedStory) return;

        if (!customPrompt.trim()) {
            showMessage("ê°œì„  í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", 'text-red-500');
            return;
        }

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸
        rewriteStoryButton.disabled = true;
        applyDraftButton.disabled = true;
        rewriteButtonText.textContent = 'ì‘ì„± ì¤‘...';
        rewriteSpinner.classList.remove('hidden');
        aiDraftOutput.textContent = 'AIê°€ ë‚´ìš©ì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...';
        aiReasonArea.classList.add('hidden');
        aiReasonOutput.textContent = '';


        const systemPrompt = `âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

3. ì‘ì—…íë¦„ì€ ì²¨ë¶€í•œ 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì— ìˆëŠ” í•´ë‹¹ ì‘ì—…ì˜ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

4. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì˜ "## í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)"ì„ ë°˜ì˜í•©ë‹ˆë‹¤.


ì—­í•  (Context)

ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ë¶„ì•¼ì˜ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì‘ê°€ì´ì ì›¹ì†Œì„¤ ë¬¸í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‹¬ì§€ì–´ ì¸í„°ë„· ë°©ì†¡, ë²„ì¸„ì–¼ ë°©ì†¡ ë“± ê´€ë ¨ ì‚¬ì—…ì— ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ìœ íŠœë¸Œë‚˜ ì‡¼ì¸ , í‹°í†¡ê´€ë ¨ ì»¨í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.


ì „ì²´ ê¸€ì—ëŒ€í•œ ë°°ê²½ ë° ì„¤ì • (Context)

- ì§‘í•„ ëª©í‘œ: (ì‚¬ìš©ìì˜ ì„¤ì •ë“¤ ë˜ëŠ” ê°„ë‹¨í•œ ì¤„ê±°ë¦¬ ìŠ¤í† ë¦¬ ë“±ë“± ë°°ê²½ê³¼ ì“°ê³ ì í•˜ëŠ” ê¸€ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„)

- íƒ€ê²Ÿ ë…ì:

- í•µì‹¬ ë©”ì‹œì§€: (ì£¼ì œ? ë˜ëŠ” ëª©í‘œ?)

- ë…ì°½ì  ê´€ì :  (ë…ì°½ì ì¸ ì„¤ì • ë˜ëŠ” ì„¸ê³„ê´€?)

- í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:  (ì–´ë–¤ ë¬¸í™”? ê´€ìŠµ? ë“±ë“± ìœ„ ë¶„ë¦¬ëœ í•­ëª©ì„ í†µí•©ìœ¼ë¡œ í•´ë„ ë¨.)


- ë¶„ëŸ‰: 1íšŒë‹¹ í•œê¸€ ê¸€ìë¡œ ì•½ 6000ì (ê³µë°± ë¯¸í¬í•¨).
              A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€. (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì)

- ë¬¸ë‹¨ í˜•ì‹: Aíƒ€ì… ì„œì‹: ì›¹ì†Œì„¤ ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.


1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

í•œ ì¸ë¬¼ì˜ ë§ì€ í•˜ë‚˜ë¡œ í•©ì³ì„œ ì„œìˆ í•©ë‹ˆë‹¤.

í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

3. ë§ˆí¬ì—… ì œê±° :

 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

ê¸€ì“°ê¸° ì§€ì‹œì‚¬í•­ (Style & Action)

ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.
- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©, ê°ˆë“±ê³¼ í•´ê²°ì˜ ê·¹ì  êµ¬ì„±.
- íŠ¹ìˆ˜ í˜•ì‹: ì‹œì²­ì(ë…ì) ê´€ë ¨ ì„œìˆ ì€ ì±„íŒ…ì°½ í˜•ì‹ìœ¼ë¡œ ìµœëŒ€í•œ ì±„íŒ…ì˜ ì¬ë¯¸ë¡œ ì„œìˆ .


ì‘ì—… íë¦„ (Action)

ì…ë ¥ ì¡°ê±´ë³„ ì²˜ë¦¬

1. "ì‹œì‘" ì…ë ¥ ì‹œ

- ì‚¬ìš©ìê°€ ì…ë ¥í•œ 1íšŒë¶„ëŸ‰ í”Œë¡¯ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìœ„ ê·œì¹™ëŒ€ë¡œ ì›ê³ ë¥¼ ì‘ì„±.


ì¶œë ¥ í˜•ì‹ (Result)

- ì–¸ì–´: í•œêµ­ì–´

- í˜•ì‹: ìš”ì²­ëœ í˜ì´ì§€ ìˆ˜ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„±ëœ ì›ê³ ë¥¼ ê¼­!! ë§ˆí¬ë‹¤ìš´ íƒìŠ¤íŠ¸ ë¬¸ì„œë¡œ ì œê³µ.

- íƒ€ì´í‹€: ì›ê³ ì˜ ì œëª© ì‘ì„±

- ë¶„ëŸ‰: 1íšŒë‹¹ í•œê¸€ ê¸€ìë¡œ ì•½ 6000ì (ê³µë°± ë¯¸í¬í•¨).
              A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).



í’ˆì§ˆ ê¸°ì¤€

- ì›¹ì†Œì„¤ì„ ì¦ê¸°ëŠ” ë…ìê°€ ì‰½ê²Œ ì´í•´í•˜ê³  ëª°ì…í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€.

- ì›¹ì†Œì„¤ì˜ ê³ ìœ í•œ íŠ¹ì„±ê³¼ ë§¤ë ¥ êµ¬í˜„.

- AI ê²€ì¶œê¸°ë¥¼ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì“°ê¸°.

- ëª¨ë“  AI ê²€ì¶œ íšŒí”¼ ì›ì¹™ì˜ ì² ì €í•œ ì ìš©.


ì‘ì—… íë¦„ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”Œë¡¯ì„ ê¸°ë³¸ìœ¼ë¡œ 1íšŒë¶„ ê¸€ì“°ê¸°ì— ëŒ€í•œ ìƒì„¸ ì ˆì°¨ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.


ì²« ì¶œë ¥  : ì´ì œ ë³¸ë¬¸ ì‘ì„±ì„ ì‹œì‘ í•˜ê² ìŠµë‹ˆë‹¤.


í™•ì •ëœ ê°œìš”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ì²­ ë¶„ëŸ‰ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„± ì›ê³ ë¥¼ ì‘ì„±.


ì‘ì„± ê²°ê³¼:
- ì´ ë¶„ëŸ‰: [ì‹¤ì œ ì‘ì„±ëœ í•œê¸€ ê¸€ì ìˆ˜].
- ì˜ˆìƒ í˜ì´ì§€: ì•½ [í˜ì´ì§€ ìˆ˜]í˜ì´ì§€.

í’ˆì§ˆ ì²´í¬:
- âœ… ë¶„ëŸ‰ ì ì •ì„± (Â±5% ì´ë‚´).
- âœ… ëª©ì°¨ìƒ ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš© ì ì ˆì„±.
- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).
- âœ… ì›ê³ ì˜ íƒ€ì´í‹€ ì‘ì„±.

âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­

1. ë¶„ëŸ‰ ì¤€ìˆ˜ëŠ” Â±5% ì´ë‚´ë¡œ ì—„ê²©íˆ ê´€ë¦¬.
2. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
3. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.


í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.

 **ì„¸ê³„ê´€**
 ${selectedSetting.worldSetting} 
 **ìºë¦­í„° ìƒì„¸**
 ${selectedSetting.characterDetails} 
**[ì›ë³¸ íšŒì°¨ ë‚´ìš©]**
${currentContent}

        `;


        const userQuery = `
**[ì‚¬ìš©ìì˜ ê°œì„  ìš”ì²­]**
${customPrompt}
`;

        
		// ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
			const proxyUrl = '/api/generate-text';
			
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
				generationConfig: {
					responseMimeType: "application/json",
					responseSchema: RESPONSE_SCHEMA
				}
            };
			
			const requestBody = {
			  model: modelName,
			  payload: payload
			};
			
			
        const fetcher = () => fetch(proxyUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        try {
            const response = await retryWithExponentialBackoff(fetcher);
            const result = await response.json();

            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const jsonText = candidate.content.parts[0].text.trim();
                let parsedJson;
                try {
                    // JSON ì‘ë‹µì˜ ì²« ì¤„/ë§ˆì§€ë§‰ ì¤„ì— ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œê±°
                    const cleanJsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    parsedJson = JSON.parse(cleanJsonText);
                } catch (e) {
                    throw new Error("Failed to parse AI response as JSON. ì›ë³¸ í…ìŠ¤íŠ¸: " + jsonText.substring(0, 100) + '...');
                }

                const newDraftContent = parsedJson.rewrittenContent || 'AIê°€ ë‚´ìš©ì„ ì œê³µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                const reason = parsedJson.reasonForChange || 'AIê°€ ë³€ê²½ ì‚¬ìœ ë¥¼ ì œê³µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';

                // ì¬ì‘ì„± ëª¨ë“œ ê²°ê³¼ ì²˜ë¦¬: ì´ˆì•ˆ(Draft) ì˜ì—­ì— í‘œì‹œ
                aiDraftOutput.textContent = newDraftContent;
                // ë‚´ìš©ì´ ìˆì–´ì•¼ë§Œ ì ìš© ê°€ëŠ¥
                applyDraftButton.disabled = newDraftContent === 'AIê°€ ë‚´ìš©ì„ ì œê³µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' || newDraftContent === '';

                // ë³€ê²½ ì‚¬ìœ  í‘œì‹œ
                aiReasonOutput.textContent = reason;
                aiReasonArea.classList.remove('hidden');

                showMessage("AIê°€ ìƒˆë¡œìš´ ì´ˆì•ˆê³¼ ë³€ê²½ ìš”ì•½ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤. 'ìƒˆ ë‚´ìš© ì ìš© ë° ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì •í•˜ì„¸ìš”.", 'text-green-600');
                aiDraftOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } else {
                aiDraftOutput.textContent = 'AI ì¬ì‘ì„± ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                showMessage('AI ì¬ì‘ì„± ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'text-red-500');
                aiReasonArea.classList.add('hidden');
            }

        } catch (error) {
            console.error("AI Operation Failed:", error);
            aiDraftOutput.textContent = `AI ì¬ì‘ì„± ì‹¤íŒ¨: ${error.message}`;
            showMessage(`AI ì¬ì‘ì„± ì‹¤íŒ¨: ${error.message}`, 'text-red-600');
            aiReasonArea.classList.add('hidden');
        } finally {
            rewriteButtonText.textContent = 'AIë¡œ ìƒˆ ë‚´ìš© ì‘ì„±';
            rewriteSpinner.classList.add('hidden');
            rewriteStoryButton.disabled = false;
        }
    }

    // AI ì´ˆì•ˆ ë‚´ìš©ì„ ë©”ì¸ ì—ë””í„°ì— ì ìš©í•˜ê³  ì¦‰ì‹œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ìš”ì²­ ì‚¬í•­)
    async function applyDraftContent() {
        const draftContent = aiDraftOutput.textContent.trim();
        if (draftContent && draftContent !== 'ì—¬ê¸°ì— AIê°€ ì¬ì‘ì„±í•œ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.' && draftContent !== 'AIê°€ ë‚´ìš©ì„ ì œê³µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.') {

            // 1. ì´ˆì•ˆì„ í¸ì§‘ê¸°ì— ë°˜ì˜
            storyContentEditor.value = draftContent;
            editorBody.classList.remove('hidden');
            editorToggleIcon.textContent = 'â–²';
            storyContentEditor.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // 2. ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
            await saveStoryContent(draftContent, 'draft');

        } else {
            showMessage("ì ìš©í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € AIë¡œ ìƒˆ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.", 'text-red-500');
        }
    }

    // --- ë©”ì‹œì§€ ë° í† ê¸€ UI í•¨ìˆ˜ ---

    // ë©”ì‹œì§€ë¥¼ ì ì‹œ í‘œì‹œí•˜ëŠ” ìœ í‹¸ë¦¬í‹°
    function showMessage(text, colorClass) {
        saveMessage.textContent = text;
        saveMessage.className = `text-center text-sm mt-2 ${colorClass} font-medium`;
        saveMessage.classList.remove('hidden');

        // 'ì €ì¥ ì¤‘...' ë©”ì‹œì§€ëŠ” ì œê±°í•˜ì§€ ì•ŠìŒ. ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ë§Œ ì ì‹œ í‘œì‹œ
        if (!text.includes('ì €ì¥ ìš”ì²­ ì¤‘...')) {
            setTimeout(() => {
                saveMessage.classList.add('hidden');
            }, 5000);
        }
    }

    // í† ê¸€ ê¸°ëŠ¥ ê³µí†µ í•¨ìˆ˜
    function setupToggle(header, body, icon) {
        header.addEventListener('click', () => {
            const isHidden = body.classList.toggle('hidden');
            icon.textContent = isHidden ? 'â–¼' : 'â–²';
        });
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì´ˆê¸°í™” ---
    function setupEventListeners() {
        // í”Œë¡¯ ì„¤ì • ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        plotSelector.addEventListener('change', (e) => {
            const newSettingId = e.target.value;
            if (newSettingId) {
                fetchStoriesForSetting(newSettingId);
            } else {
                fetchStoriesForSetting(null); // ì„¤ì • ë¯¸ì„ íƒ ì‹œ ì´ˆê¸°í™”
            }
        });

        // íšŒì°¨ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        episodeSelector.addEventListener('change', (e) => handleEpisodeSelection(e.target.value));

        // AI ì¬ì‘ì„± ë²„íŠ¼ ì´ë²¤íŠ¸
        rewriteStoryButton.addEventListener('click', () => callGeminiRewrite(improvementPrompt.value));

        // AI ì´ˆì•ˆ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸ (ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ë¡œì§ í¬í•¨)
        applyDraftButton.addEventListener('click', applyDraftContent);

        // ìˆ˜ì • ë‚´ìš© ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ (ìˆ˜ë™ ì €ì¥)
        saveEditedContentButton.addEventListener('click', () => saveStoryContent(storyContentEditor.value, 'manual'));

        // ì„¤ì • ìƒì„¸ í† ê¸€ ì´ë²¤íŠ¸
        setupToggle(settingsHeader, settingsBody, settingsToggleIcon);

        // íšŒì°¨ ë‚´ìš© í¸ì§‘ í† ê¸€ ì´ë²¤íŠ¸
        setupToggle(editorHeader, editorBody, editorToggleIcon);
    }

    // ì•± ì´ˆê¸°í™” í•¨ìˆ˜
    window.onload = function() {
        setupEventListeners();
        fetchSettingsAndInit();
    };

</script>
</body>
</html>