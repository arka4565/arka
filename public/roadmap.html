<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Novel Assistant - Roadmap Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --accent-color: #27ae60;
            --text-color: #333;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ --- */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 1000;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--primary-color); font-weight: bold; }

        /* --- ë©”ì¸ ì»¨í…Œì´ë„ˆ --- */
        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }
        header h1 { margin: 0 0 10px 0; color: var(--secondary-color); }
        header p { color: #666; margin: 0; }

        /* --- Part List Styles --- */
        .section-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .section-header::before {
            content: ''; display: block; width: 6px; height: 24px;
            background-color: var(--primary-color);
            margin-right: 10px; border-radius: 3px;
        }

        .part-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .part-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 180px; 
        }
        .part-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.2);
            border-color: var(--primary-color);
        }
        .part-badge {
            display: inline-block;
            background-color: #f1f3f5;
            color: #495057;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .part-card h3 {
            font-size: 1.1rem; margin: 0 0 10px 0; color: var(--secondary-color);
            line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .part-card p.preview {
            font-size: 0.9rem; color: #868e96; margin: 0;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1;
        }

        /* --- Event Cards Styles --- */
        .event-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .event-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 15px; border-bottom: 1px solid #f1f3f5; padding-bottom: 15px; gap: 10px;
        }
        .event-title-box { display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .event-title { font-size: 1.3rem; font-weight: bold; color: var(--secondary-color); }
        .event-range { 
            display: inline-block; background: var(--primary-color); color: #fff; 
            padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; width: fit-content;
        }

        .btn-action-group { display: flex; gap: 5px; }
        
        .save-btn {
            background-color: var(--accent-color); color: white; border: none; padding: 8px 16px;
            border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .save-btn:hover { background-color: #219150; }
        .save-btn.saved { background-color: #bdc3c7; cursor: default; }
        
        .edit-btn {
            background-color: white; color: #555; border: 1px solid #ddd; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        .edit-btn:hover { background-color: #f0f0f0; }

        .event-theme {
            background-color: #f8f9fa; color: #555; padding: 12px; border-radius: 8px;
            margin-bottom: 15px; font-style: italic; border-left: 4px solid #ced4da;
        }
        .event-content { font-size: 1.05rem; line-height: 1.7; color: #333; white-space: pre-wrap; }

        /* ìˆ˜ì • ëª¨ë“œìš© ìŠ¤íƒ€ì¼ */
        .edit-input { width: 100%; padding: 8px; margin-bottom: 5px; border: 1px solid #3498db; border-radius: 4px; font-size: 1rem; }
        .edit-textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #3498db; border-radius: 6px; font-size: 1rem; resize: vertical; line-height: 1.6; }
        .event-edit-form { display: none; margin-top: 10px; }
        .event-edit-form.active { display: block; }

        /* Utilities */
        .hidden { display: none !important; }
        #loading { text-align: center; margin: 50px 0; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-outline { background: transparent; border: 1px solid #868e96; color: #868e96; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .btn-outline:hover { background: #f1f3f5; }
        
        .ai-generate-bar {
            background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #bbdefb;
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="javascript:void(0)" onclick="location.href='index.html'" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="javascript:void(0)" onclick="movePage('settings.html')" class="nav-item"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="javascript:void(0)" onclick="movePage('world.html')" class="nav-item"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="javascript:void(0)" onclick="movePage('characters.html')" class="nav-item"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="javascript:void(0)" onclick="movePage('plot.html')" class="nav-item"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="javascript:void(0)" onclick="movePage('write.html')" class="nav-item"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="javascript:void(0)" onclick="movePage('write_scene.html')" class="nav-item"><i class="fas fa-layer-group"></i>ì¥ë©´ì§‘í•„</a>
        <a href="javascript:void(0)" onclick="movePage('edit.html')" class="nav-item"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
        <a href="javascript:void(0)" onclick="movePage('plan.html')" class="nav-item"><i class="fas fa-layer-group"></i> ê¸°íš</a>
        <a href="javascript:void(0)" onclick="movePage('roadmap.html')" class="nav-item active"><i class="fas fa-map-signs"></i> ë¡œë“œë§µ</a>
        <a href="javascript:void(0)" onclick="movePage('treatment.html')" class="nav-item "><i class="fas fa-file-alt"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</a>
    </div>
</nav>

<div class="container">
    <header>
        <h1>ğŸ“… ì‚¬ê±´ ê¸°íš (Roadmap Builder)</h1>
        <p>Partë¥¼ ì„ íƒí•˜ì—¬ ìƒì„¸ ì‚¬ê±´ì„ ê¸°íší•˜ê±°ë‚˜, ì´ë¯¸ ì €ì¥ëœ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”.</p>
    </header>

    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div id="part-selection-area">
        <div class="section-header">ì‘ì—…í•  Part ì„ íƒ</div>
        <div id="part-list" class="part-grid"></div>
        <div id="empty-msg" style="text-align: center; color: #999; display: none; padding: 30px;">
            <p>âš ï¸ ì €ì¥ëœ Part ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. [ê¸°íš] í˜ì´ì§€ì—ì„œ ë¨¼ì € êµ¬ì¡°ë¥¼ ì„¤ê³„í•´ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <div id="roadmap-result-area" class="hidden">
        <div class="top-controls">
            <div class="section-header">ìƒì„¸ ì‚¬ê±´ ë¦¬ìŠ¤íŠ¸ (Event List)</div>
            <button class="btn-outline" onclick="resetSelection()">ğŸ”„ Part ëª©ë¡ìœ¼ë¡œ</button>
        </div>

        <div class="ai-generate-bar">
            <span><i class="fas fa-magic"></i> AIì—ê²Œ ì‚¬ê±´ êµ¬ì„±ì„ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span>
            <button class="save-btn" style="background:#4a90e2;" onclick="callAiGeneration()">
                AI ìƒì„± ìš”ì²­
            </button>
        </div>

        <div id="roadmap-container"></div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id') || urlParams.get('id');
    
    let currentSettings = {}; 
    let currentWorldSetting = ""; 
    let currentPart = null; // ì„ íƒëœ Part ê°ì²´
    let contextData = ""; 
    let parsedParts = [];     

    function movePage(page) {
        if (settingId) location.href = `${page}?setting_id=${settingId}`;
        else location.href = page;
    }

    window.onload = async function() {
        if (!settingId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); return; }
        
        // ì´ˆê¸° ë¡œë”© ì‹œì—ëŠ” ëª©ë¡ í™”ë©´ì„ ë³´ì—¬ì¤Œ
        document.getElementById('part-selection-area').classList.remove('hidden');
        document.getElementById('roadmap-result-area').classList.add('hidden');

        try {
            await loadContextData(); 
            await loadSettingData(settingId);
        } catch (error) { console.error(error); }
    };

    // 1. Context ë¡œë“œ
    async function loadContextData() {
        try {
            const [sRes, wRes, cRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`).then(r => r.json()),
                fetch(`/api/worldsettings?setting_id=${settingId}`).then(r => r.json()),
                fetch(`/api/characters?setting_id=${settingId}`).then(r => r.json())
            ]);
            currentSettings = sRes; 
              contextData = `
                [ì‘í’ˆ ì œëª©]: ${sRes.title || 'ë¯¸ì •'}
                [ì„¸ê³„ê´€ ìš”ì•½]: ${Array.isArray(wRes) ? wRes.map(w => w.title + ": " + w.description).join('\n') : 'ì—†ìŒ'}
                [ì£¼ìš” ë“±ì¥ì¸ë¬¼]: ${Array.isArray(cRes) ? cRes.map(c => `${c.name} (${c.role}): ${c.description}`).join('\n') : 'ì—†ìŒ'}
                `;
        } catch (e) { console.warn("Context load failed", e); }
    }

    // 2. Part ëª©ë¡ ë¡œë“œ
    async function loadSettingData(id) {
        showLoading("Part ëª©ë¡ ë¡œë”© ì¤‘...");
        try {
            const response = await fetch(`/api/load-settings?id=${id}`);
            if (!response.ok) throw new Error("DB ì—°ê²° ì‹¤íŒ¨");
            const data = await response.json();
            currentWorldSetting = data.worldSetting || "ì¼ë°˜ì ì¸ íŒíƒ€ì§€ ì„¸ê³„ê´€";
            parseAndRenderParts(data.roadmaps);
        } catch (error) {
            console.error(error);
            document.getElementById('empty-msg').style.display = 'block';
            document.getElementById('empty-msg').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + error.message;
        } finally { hideLoading(); }
    }

    function parseAndRenderParts(rawData) {
        const listContainer = document.getElementById('part-list');
        listContainer.innerHTML = '';
        parsedParts = [];

        if (!rawData) {
            document.getElementById('empty-msg').style.display = 'block';
            return;
        }

        try {
            let jsonData = (typeof rawData === 'string') ? JSON.parse(rawData) : rawData;
            if (Array.isArray(jsonData)) {
                parsedParts = jsonData.map((item, idx) => ({ ...item, partIndex: item.part || (idx+1) }));
                
                parsedParts.forEach((part, index) => {
                    const card = document.createElement('div');
                    card.className = 'part-card';
                    card.onclick = () => selectPart(index);
                    card.innerHTML = `
                        <div>
                            <span class="part-badge">Part ${part.partIndex}</span>
                            <h3>${part.title}</h3>
                            <p class="preview">${part.content}</p>
                        </div>
                        <div style="text-align: right; margin-top: 10px; font-weight: bold; color: var(--primary-color);">
                            ìƒì„¸ ë³´ê¸° &rarr;
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            } else {
                document.getElementById('empty-msg').style.display = 'block';
            }
        } catch (e) { 
            console.error(e); 
            document.getElementById('empty-msg').innerText = "ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜";
            document.getElementById('empty-msg').style.display = 'block';
        }
    }

    // 3. Part ì„ íƒ -> ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™ (íŠ•ê¹€ ë°©ì§€ ë¡œì§ ì ìš©)
    async function selectPart(index) {
        currentPart = parsedParts[index];
        
        // ğŸŒŸ [ì¤‘ìš”] ë¬´ì¡°ê±´ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì „í™˜í•˜ê³  ëª©ë¡ì€ ìˆ¨ê¹€
        document.getElementById('part-selection-area').classList.add('hidden');
        document.getElementById('roadmap-result-area').classList.remove('hidden');
        
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        document.getElementById('roadmap-container').innerHTML = '';

        // DB ì¡°íšŒ ì‹œì‘
        showLoading(`'${currentPart.title}' ë°ì´í„° ì¡°íšŒ ì¤‘...`);
        
        try {
            const response = await fetch(`/api/roadmap?setting_id=${settingId}&part_index=${currentPart.partIndex}`);
            
            if (!response.ok) throw new Error("ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨");
            
            const events = await response.json();
            
            if (events && events.length > 0) {
                // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë Œë”ë§
                renderEvents(events);
            } else {
                // ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ (ëª©ë¡ìœ¼ë¡œ ì•ˆ íŠ•ê¹€)
                document.getElementById('roadmap-container').innerHTML = 
                    `<div style="text-align:center; padding:40px; color:#666; background:#f9f9f9; border-radius:8px;">
                        <i class="fas fa-file-invoice" style="font-size:2rem; margin-bottom:10px;"></i><br>
                        ì´ Partì— ì €ì¥ëœ ì‚¬ê±´ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        ìœ„ <b>'AI ìƒì„± ìš”ì²­'</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‚¬ê±´ì„ ê¸°íší•´ë³´ì„¸ìš”.
                    </div>`;
            }
        } catch (e) {
            console.error(e);
            document.getElementById('roadmap-container').innerHTML = 
                `<div style="text-align:center; padding:20px; color:red;">ì˜¤ë¥˜ ë°œìƒ: ${e.message}</div>`;
        } finally {
            hideLoading(); // ë¡œë”©ë§Œ ë” (í™”ë©´ ì „í™˜ X)
        }
    }

    // 4. AI ìƒì„± í˜¸ì¶œ
    async function callAiGeneration() {
        // [ìˆ˜ì • í¬ì¸íŠ¸ 1] selectedPartê°€ ì•„ë‹ˆë¼ currentPartë¥¼ ì²´í¬í•´ì•¼ í•¨
        if (!currentPart) {
            alert("ì„ íƒëœ Partê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        const btn = document.querySelector('.ai-generate-bar button');
        btn.disabled = true; 
        btn.innerText = "ìƒì„± ì¤‘...";
        
        try {
			// ğŸŒŸ 1. ì•ë’¤ Part ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Context Awareness)
            let prevPartContext = "ì´ì „ Part ì •ë³´ ì—†ìŒ (ì´ì•¼ê¸°ì˜ ì‹œì‘)";
            let nextPartContext = "ë‹¤ìŒ Part ì •ë³´ ì—†ìŒ (ì´ì•¼ê¸°ì˜ ê²°ë§)";
			// ì „ì²´ ëª©ë¡ì—ì„œ í˜„ì¬ Partì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
            const currentIndex = parsedParts.findIndex(p => p.partIndex === currentPart.partIndex);
            
            if (currentIndex > 0) {
                // (1) ì´ì „ Part ì°¾ê¸°
				if (currentPart.partIndex > 1) {
                const prevIndex = currentPart.partIndex - 1;
                
                // (1) ì´ì „ Partì˜ ëª¨ë“  ì‚¬ê±´ ê°€ì ¸ì˜¤ê¸°
                const res = await fetch(`/api/roadmap?setting_id=${settingId}&part_index=${prevIndex}`);
               
                if (res.ok) {
                    const prevEvents = await res.json();
                     //console.log(prevEvents);
                    if (prevEvents && prevEvents.length > 0) {
                        // (2) event_order ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë§ˆì§€ë§‰ ì‚¬ê±´ì´ 0ë²ˆìœ¼ë¡œ ì˜¤ê²Œ)
                        prevEvents.sort((a, b) => b.event_order - a.event_order);
                        
                        // (3) ìƒìœ„ 3ê°œë§Œ ì¶”ì¶œ (Last 3)
                        const last3Events = prevEvents.slice(0, 3);
                        
                        // (4) AIì—ê²ŒëŠ” ì‹œê°„ ìˆœì„œëŒ€ë¡œ(ì˜¤ë¦„ì°¨ìˆœ) ë³´ì—¬ì£¼ê¸° ìœ„í•´ ë‹¤ì‹œ ì •ë ¬
                        last3Events.sort((a, b) => a.event_order - b.event_order);
                        
                        // (5) í…ìŠ¤íŠ¸ ë³€í™˜
                        const eventTexts = last3Events.map(e => 
                            `   - ${e.content}`
                        ).join('\n');

                        prevPartContext = `
                        [ì´ì „ ì±•í„°]
                        ${eventTexts}
                        
                        â€» ì—°ê²° ì§€ì¹¨: ìœ„ ì‚¬ê±´ë“¤ì˜ ê²°ê³¼ì™€ ê°ì •ì„ ì´ í˜„ì¬ ì±•í„°ì˜ ë„ì…ë¶€ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤.
                        `;
                    }
                }
            }
               

                // (2) ë‹¤ìŒ Part ì°¾ê¸°
				if (currentIndex < parsedParts.length - 1 && parsedParts[currentIndex + 1]) {
						const nextPart = parsedParts[currentIndex + 1];
						
						
						nextPartContext = `
						[ë‹¤ìŒ ì±•í„°]
						- ${nextPart.content}
						
						â€» ì—°ê²°ì„± ì§€ì¹¨: ì´ Partì˜ í›„ë°˜ë¶€ ì‚¬ê±´ë“¤ì€ ìœ„ 'ë‹¤ìŒ ì±•í„°'ì˜ ì‚¬ê±´ì´ ì‹œì‘ë  ìˆ˜ ìˆëŠ” ê³„ê¸°ë‚˜ ë¶„ìœ„ê¸°ë¥¼ ì¡°ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ë¶„ìœ„ê¸°ë¥¼ ì¡°ì„±í•˜ëŠ” ê²ƒì´ì§€ ì´ë²ˆ Partì˜ ì‚¬ê±´ì— 'ë‹¤ìŒ ì±•í„°'ì˜ ë‚´ìš©ì´ ë“¤ì–´ê°€ë©´ ì•ˆë©ë‹ˆë‹¤.
						`;
				  
				}
			
				if (currentIndex < parsedParts.length - 2 && parsedParts[currentIndex + 2]) {	
				    const nextPart = parsedParts[currentIndex + 1];
                    const nextPart2 = parsedParts[currentIndex + 2];
					
                    nextPartContext = `
                    [ë‹¤ìŒ ì±•í„°]
					 - ${nextPart.content}
                     - ${nextPart2.content}
                    
                    â€» ì—°ê²°ì„± ì§€ì¹¨: ì´ Partì˜ í›„ë°˜ë¶€ ì‚¬ê±´ë“¤ì€ ìœ„ 'ë‹¤ìŒ ì±•í„°'ì˜ ì‚¬ê±´ì´ ì‹œì‘ë  ìˆ˜ ìˆëŠ” ê³„ê¸°ë‚˜ ë¶„ìœ„ê¸°ë¥¼ ì¡°ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ë¶„ìœ„ê¸°ë¥¼ ì¡°ì„±í•˜ëŠ” ê²ƒì´ì§€ ì´ë²ˆ Partì˜ ì‚¬ê±´ì— 'ë‹¤ìŒ ì±•í„°'ì˜ ë‚´ìš©ì´ ë“¤ì–´ê°€ë©´ ì•ˆë©ë‹ˆë‹¤.
                    `;
                }
            }
			
            const systemPrompt = `
                ### [Role]
                ë‹¹ì‹ ì€ ì†Œì„¤ì˜ ì±•í„°(Part)ë¥¼ ë¶„ì„í•˜ì—¬ êµ¬ì²´ì ì¸ 'ì‚¬ê±´(Event)' ë¦¬ìŠ¤íŠ¸ë¡œ ê¸°íší•˜ëŠ” ìŠ¤í† ë¦¬ë³´ë“œ ì‘ê°€ì…ë‹ˆë‹¤.

                ### [ì‘í’ˆ ì •ë³´]
                ${contextData}

                ### [Coverage & Scope Rules] (ë§¤ìš° ì¤‘ìš”!)
                1. ì‚¬ìš©ìê°€ ì œì‹œí•œ Partì˜ ë²”ìœ„(ì˜ˆ: 1í™”~25í™”)ë¥¼ **ì²˜ìŒë¶€í„° ëê¹Œì§€ ë¹ ì§ì—†ì´** ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
                2. ê° ì‚¬ê±´ì€ **2~3í™” ë¶„ëŸ‰**ìœ¼ë¡œ ë°°ë¶„í•˜ì‹­ì‹œì˜¤.
                3. **ê³„ì‚° ì˜ˆì‹œ:** ë§Œì•½ Partê°€ 25í™” ë¶„ëŸ‰ì´ë¼ë©´, 2~3í™”ì”© ë‚˜ëˆ„ì—ˆì„ ë•Œ **ì´ 8ê°œì—ì„œ 12ê°œì˜ ì‚¬ê±´**ì´ ë‚˜ì™€ì•¼ í•©ë‹ˆë‹¤.
                4. **ë§ˆì§€ë§‰ ì‚¬ê±´**ì˜ ë íšŒì°¨ëŠ” ë°˜ë“œì‹œ Partì˜ **ë§ˆì§€ë§‰ íšŒì°¨ì™€ ì¼ì¹˜**í•´ì•¼ í•©ë‹ˆë‹¤.

				[Output Format] (Strictly JSON)
				ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì€ **JSON ë°°ì—´ í¬ë§·**ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

				[
				  {
					"title": "ì‚¬ê±´ ì œëª©",
					"range": "Xí™”~Yí™”",
					"theme": "í•µì‹¬ í…Œë§ˆ (ê°ì •/í‚¤ì›Œë“œ)",
					"content": "ìƒì„¸ ì¤„ê±°ë¦¬ (400ì ì´ìƒ)"
				  },
				  ...
				]
                `;

                // User Prompt
                const userPrompt = `
                ë‹¤ìŒ [Part ì •ë³´]ë¥¼ ë°”íƒ•ìœ¼ë¡œ 2~3í™” ë¶„ëŸ‰ì˜ ì‚¬ê±´ ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„¸íˆ ì‘ì„±í•´ì¤˜.

                [Part ì •ë³´]
                - ì œëª©: ${currentPart.title}
                - íšŒì°¨ ë²”ìœ„: ${currentPart.range}
                - ë‚´ìš©: ${currentPart.content}
				ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ **${currentPart.range}** ì‚¬ì´ì˜ ìƒì„¸ ì‚¬ê±´ ë¦¬ìŠ¤íŠ¸ë¥¼ JSONìœ¼ë¡œ ì‘ì„±í•´ì¤˜.
				ì ˆëŒ€ë¡œ 1í™”ë¶€í„° ì‹œì‘í•˜ì§€ ë§ê³ , **${currentPart.range}**ì— ë§ëŠ” íšŒì°¨ ë²ˆí˜¸ë¥¼ ë§¤ê²¨ì•¼ í•´.
				
				[Context Flow]
				1. ${prevPartContext}
				2. ${nextPartContext}
				
				ìœ„ [Context Flow]ë¥¼ ì°¸ê³ í•˜ì—¬ ì•ë’¤ ë‚´ìš©ì´ ë§¤ë„ëŸ½ê²Œ ì—°ê²°ë˜ë„ë¡ ì‚¬ê±´ì„ êµ¬ì„±í•´ì•¼ í•´.
                `;
				console.log(systemPrompt)
				console.log(userPrompt)
                const response = await fetch('/api/generate-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gemini-2.5-flash", // ëª¨ë¸ëª… í™•ì¸ (2.5ëŠ” ì•„ì§ ì—†ê±°ë‚˜ proì¼ ìˆ˜ ìˆìŒ)
                        payload: {
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        }
                    })
                });
				if (!response.ok) throw new Error("AI í˜¸ì¶œ ì‹¤íŒ¨");
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if(text) parseAndRenderAiResult(text);

        } catch(e) { alert("AI ìƒì„± ì‹¤íŒ¨: " + e.message); }
        finally { btn.disabled = false; btn.innerText = "AI ìƒì„± ìš”ì²­"; }
    }

    // 5. AI ê²°ê³¼ íŒŒì‹± ë° ë Œë”ë§ (JSON ë°©ì‹)
    function parseAndRenderAiResult(text) {
        const container = document.getElementById('roadmap-container');
        container.innerHTML = ''; 

        try {
            // 1. ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ëŸ­(```json ... ```) ì œê±°
            let cleanJson = text.replace(/```json|```/g, '').trim();
            
            // 2. JSON íŒŒì‹±
            const eventsData = JSON.parse(cleanJson);

            // 3. ë°°ì—´ì¸ì§€ í™•ì¸ í›„ ë³€í™˜
            if (!Array.isArray(eventsData)) throw new Error("ë°ì´í„° í˜•ì‹ì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");

            const events = eventsData.map((item, index) => {
                return {
                    event_order: index + 1,
                    title: item.title || "ì œëª© ì—†ìŒ",
                    episode_range: item.range || "ë¯¸ì •",
                    theme: item.theme || "",
                    content: item.content || ""
                };
            });

            // 4. ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
            renderEvents(events);

        } catch (e) {
            console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
            console.log("ì›ë³¸ í…ìŠ¤íŠ¸:", text);
            alert("AI ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (JSON Parsing Error)");
            
            // (ì„ íƒì‚¬í•­) íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ë¼ë„ ë³´ì—¬ì£¼ê¸°
            container.innerHTML = `<div class="event-card"><div class="event-content" style="color:red;">ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨.<br>ì›ë³¸ ë‚´ìš©:<br>${text}</div></div>`;
        }
    }

    // 6. ì´ë²¤íŠ¸ ëª©ë¡ ë Œë”ë§ (View & Edit ëª¨ë“œ)
    function renderEvents(events) {
        const container = document.getElementById('roadmap-container');
        // append í•˜ì§€ ì•Šê³  ë¹„ìš´ ë’¤ ë Œë”ë§ (ì¤‘ë³µ ë°©ì§€)
        container.innerHTML = '';

        events.forEach((evt, idx) => {
            const card = document.createElement('div');
            card.className = 'event-card';
            const uniqueId = `evt-${Date.now()}-${idx}`;
            
            // View Mode HTML
            const viewHtml = `
                <div id="view-${uniqueId}">
                    <div class="event-header">
                        <div class="event-title-box">
                            <span class="event-title">#${evt.event_order}. ${evt.title}</span>
                            ${evt.episode_range ? `<span class="event-range">${evt.episode_range}</span>` : ''}
                        </div>
                        <div class="btn-action-group">
                            <button class="edit-btn" onclick="toggleEdit('${uniqueId}')"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                            <button class="save-btn ${evt.id ? 'saved' : ''}" onclick='saveToDB(this, ${JSON.stringify(evt).replace(/'/g, "&#39;")})'>
                                ${evt.id ? 'âœ… ì €ì¥ë¨' : 'ğŸ’¾ ì €ì¥'}
                            </button>
                        </div>
                    </div>
                    ${evt.theme ? `<div class="event-theme">ğŸ’¡ ${evt.theme}</div>` : ''}
                    <div class="event-content">${evt.content}</div>
                </div>
            `;

            // Edit Mode HTML
            const editHtml = `
                <div id="edit-${uniqueId}" class="event-edit-form">
                    <label>ì œëª©</label>
                    <input type="text" id="input-title-${uniqueId}" class="edit-input" value="${evt.title}">
                    <label>íšŒì°¨ ë²”ìœ„ (ì˜ˆ: 1~3í™”)</label>
                    <input type="text" id="input-range-${uniqueId}" class="edit-input" value="${evt.episode_range || ''}">
                    <label>í•µì‹¬ í…Œë§ˆ</label>
                    <input type="text" id="input-theme-${uniqueId}" class="edit-input" value="${evt.theme || ''}">
                    <label>ì¤„ê±°ë¦¬</label>
                    <textarea id="input-content-${uniqueId}" class="edit-textarea">${evt.content}</textarea>
                    
                    <div style="text-align:right; margin-top:10px;">
                        <button class="save-btn" style="display:inline-flex;" onclick="confirmEdit('${uniqueId}', ${evt.event_order})">í™•ì¸</button>
                        <button class="edit-btn" onclick="toggleEdit('${uniqueId}')">ì·¨ì†Œ</button>
                    </div>
                </div>
            `;

            card.innerHTML = viewHtml + editHtml;
            container.appendChild(card);
        });
    }

    // 7. í¸ì§‘ í† ê¸€
    function toggleEdit(uid) {
        const viewDiv = document.getElementById(`view-${uid}`);
        const editDiv = document.getElementById(`edit-${uid}`);
        
        if (editDiv.style.display === 'block') {
            editDiv.style.display = 'none';
            viewDiv.style.display = 'block';
        } else {
            editDiv.style.display = 'block';
            viewDiv.style.display = 'none';
        }
    }

    // 8. í¸ì§‘ í™•ì¸ (í™”ë©´ ê°±ì‹  ë° ì €ì¥ ë²„íŠ¼ í™œì„±í™”)
    function confirmEdit(uid, order) {
        const title = document.getElementById(`input-title-${uid}`).value;
        const range = document.getElementById(`input-range-${uid}`).value;
        const theme = document.getElementById(`input-theme-${uid}`).value;
        const content = document.getElementById(`input-content-${uid}`).value;

        // View ê°±ì‹ 
        const viewDiv = document.getElementById(`view-${uid}`);
        viewDiv.querySelector('.event-title').innerText = `#${order}. ${title}`;
        
        const rangeSpan = viewDiv.querySelector('.event-range');
        if(rangeSpan) rangeSpan.innerText = range; // rangeSpanì´ ì—†ìœ¼ë©´ ìƒì„±í•´ì•¼ í•˜ì§€ë§Œ ê°„ë‹¨íˆ ì²˜ë¦¬

        const themeDiv = viewDiv.querySelector('.event-theme');
        if(themeDiv) themeDiv.innerText = `ğŸ’¡ ${theme}`;
        
        viewDiv.querySelector('.event-content').innerText = content;

        // ì €ì¥ ë²„íŠ¼ ê°±ì‹  (ë°ì´í„° ë°”ì¸ë”© ì—…ë°ì´íŠ¸)
        const saveBtn = viewDiv.querySelector('.save-btn');
        saveBtn.innerText = "ğŸ’¾ ì €ì¥ (ìˆ˜ì •ë¨)";
        saveBtn.classList.remove('saved');
        
        // ìƒˆ ë°ì´í„° ê°ì²´ ìƒì„±
        const newData = {
            setting_id: settingId,
            part_index: currentPart.partIndex,
            event_order: order,
            title: title,
            episode_range: range,
            theme: theme,
            content: content
        };
        
        // ë²„íŠ¼ onclick ì´ë²¤íŠ¸ ì¬ë°”ì¸ë”©
        saveBtn.onclick = () => saveToDB(saveBtn, newData);

        toggleEdit(uid);
    }

    // 9. DB ì €ì¥
    async function saveToDB(btnElement, data) {
        if (!confirm(`'${data.title}' ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        // í•„ìˆ˜ ë°ì´í„° ë³´ê°•
        data.setting_id = settingId;
        data.part_index = currentPart.partIndex;

        const originalText = btnElement.innerText;
        btnElement.disabled = true;
        btnElement.innerText = "â³ ì €ì¥ ì¤‘...";

        try {
            const response = await fetch('/api/roadmap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                btnElement.innerText = "âœ… ì €ì¥ë¨";
                btnElement.classList.add('saved');
                btnElement.disabled = false; 
            } else {
                const err = await response.json();
                alert("ì €ì¥ ì‹¤íŒ¨: " + err.error);
                btnElement.disabled = false;
                btnElement.innerText = originalText;
            }
        } catch (error) {
            console.error(error);
            alert("ì˜¤ë¥˜ ë°œìƒ");
            btnElement.disabled = false;
            btnElement.innerText = originalText;
        }
    }

    // 10. UI ìœ í‹¸ë¦¬í‹°
    function resetSelection() {
        document.getElementById('part-selection-area').classList.remove('hidden');
        document.getElementById('roadmap-result-area').classList.add('hidden');
        document.getElementById('roadmap-container').innerHTML = '';
        currentPart = null;
    }

    function showLoading(msg) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading-text').innerText = msg;
        // ë¡œë”© ì¤‘ì—ëŠ” ë¦¬ìŠ¤íŠ¸ë§Œ ìˆ¨ê¹€ (ê²°ê³¼ í™”ë©´ì—ì„œ ë¡œë”©í•  ë•ŒëŠ” ìœ ì§€í•  ìˆ˜ë„ ìˆìŒ)
        // ì—¬ê¸°ì„œëŠ” ëª…í™•ì„±ì„ ìœ„í•´ ë‘˜ ë‹¤ ìˆ¨ê¹€ ì²˜ë¦¬ ì•ˆ í•˜ê³  ì˜¤ë²„ë ˆì´ ëŠë‚Œìœ¼ë¡œ ê°€ê±°ë‚˜,
        // ì•„ë‹ˆë©´ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì¤Œ.
    }

    // ğŸŒŸ [í•µì‹¬] Hide Loading ìˆ˜ì •: í™”ë©´ ì „í™˜ ë¡œì§ ì œê±°í•˜ê³  ë¡œë”©ë°”ë§Œ ë”
    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }
</script>
</body>
</html>