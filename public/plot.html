<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í”Œë¡¯ êµ¬ì„± - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --plot-color: #9b59b6; 
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
            --danger-color: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--plot-color); font-weight: bold; }

        /* ë ˆì´ì•„ì›ƒ */
        .container { display: flex; flex: 1; overflow: hidden; }

        /* ì¢Œì¸¡ ëª©ë¡ */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title { font-weight: bold; color: var(--plot-color); font-size: 1.1rem; }
        .btn-add {
            background: var(--plot-color); color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px;
        }
        .plot-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .plot-card {
            background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .plot-card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.05); }
        .plot-card.active { border: 2px solid var(--plot-color); background: #fdfbff; }
        .card-num { font-size: 0.8rem; color: #888; margin-bottom: 5px; font-weight: bold; }
        .card-title { font-size: 1rem; font-weight: bold; margin-bottom: 8px; color: #333; }
        .card-preview { font-size: 0.85rem; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ìš°ì¸¡ ì—ë””í„° */
        .main-editor { flex: 1; display: flex; flex-direction: column; background: white; padding: 20px; overflow-y: auto; }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        
        .input-title { 
            font-size: 1.4rem; font-weight: bold; border: none; 
            border-bottom: 2px solid #eee; width: 100%; padding: 5px; outline: none; color: #2c3e50; 
            transition: border-color 0.3s;
        }
        .input-title:focus { border-bottom-color: var(--plot-color); }

        .action-group { display: flex; gap: 8px; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-base {
            padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px; transition: all 0.2s;
        }
        
        .btn-copy {
            background: white; border: 1px solid #aaa; color: #555;
        }
        .btn-copy:hover { background: #f0f0f0; color: #333; border-color: #888; }

        .btn-delete { 
            background: white; border: 1px solid var(--danger-color); color: var(--danger-color); 
        }
        .btn-delete:hover { background: var(--danger-color); color: white; }
        
        .btn-save { 
            background: var(--plot-color); color: white; border: none; font-weight: bold; 
        }
        .btn-save:hover { background: #8e44ad; }
        
        .content-area { display: flex; flex: 1; gap: 20px; min-height: 400px; }
        .text-editor {
            flex: 2; width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 20px;
            font-size: 1rem; line-height: 1.6; resize: none; font-family: inherit;
        }
        .text-editor:focus { outline: 2px solid var(--plot-color); border-color: transparent; }

        /* AI íŒ¨ë„ */
        .ai-sidebar {
            flex: 1; background: #fdfbff; border: 1px solid #e1bee7; border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .ai-label { font-weight: bold; color: var(--plot-color); margin-bottom: 5px; display: block; }
        .ai-input { width: 100%; padding: 10px; border: 1px solid #d1c4e9; border-radius: 6px; margin-bottom: 8px; }
        .btn-ai { width: 100%; background: var(--plot-color); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; }
        .ai-result { flex: 1; background: white; border: 1px dashed #d1c4e9; border-radius: 6px; padding: 10px; font-size: 0.9rem; overflow-y: auto; white-space: pre-wrap; }
        .btn-apply-ai { margin-top: 5px; background: #50c878; color: white; border: none; padding: 5px; width: 100%; border-radius: 4px; cursor: pointer; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #aaa; text-align: center; }

        @media (max-width: 900px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; height: 200px; border-right: none; border-bottom: 1px solid #ddd; }
            .content-area { flex-direction: column; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item active"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
    </div>
</nav>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <span class="header-title"><i class="fas fa-list-ol"></i> íšŒì°¨ ëª©ë¡</span>
            <button class="btn-add" onclick="createNewEpisode()"><i class="fas fa-plus"></i> ì¶”ê°€</button>
        </div>
        <div id="plotList" class="plot-list">
            <div style="text-align:center; padding:20px; color:#999;">ë¡œë”© ì¤‘...</div>
        </div>
    </aside>

    <main class="main-editor">
        <div id="editorWrapper" style="display:none; height:100%; flex-direction:column;">
            <div class="editor-header">
                <input type="text" id="episodeTitle" class="input-title" placeholder="íšŒì°¨ ì œëª© (ì˜ˆ: 1í™”. ë§Œë‚¨)">
                <div class="action-group">
                    <button class="btn-base btn-copy" onclick="copyCurrentPlot()"><i class="fas fa-copy"></i> ë³µì‚¬</button>
                    <button class="btn-base btn-delete" onclick="deleteCurrentEpisode()"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    <button class="btn-base btn-save" onclick="saveCurrentEpisode()"><i class="fas fa-save"></i> ì €ì¥</button>
                </div>
            </div>

            <div class="content-area">
                <textarea id="plotContent" class="text-editor" placeholder="ì´ íšŒì°¨ì˜ ì¤„ê±°ë¦¬(í”Œë¡¯)ë¥¼ êµ¬ìƒí•´ë³´ì„¸ìš”."></textarea>
                
                <div class="ai-sidebar">
                    <div>
                        <span class="ai-label"><i class="fas fa-lightbulb"></i> AI ì•„ì´ë””ì–´ ì œì•ˆ</span>
                        <input type="text" id="aiPrompt" class="ai-input" placeholder="ì˜ˆ: ë°˜ì „ ìš”ì†Œë¥¼ ì¶”ì²œí•´ì¤˜">
                        <button class="btn-ai" onclick="generateIdea()"><i class="fas fa-bolt"></i> ìƒì„±í•˜ê¸°</button>
                    </div>
                    <div class="ai-result" id="aiResultText">AI ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                    <button class="btn-apply-ai" onclick="applyAiResult()"><i class="fas fa-paste"></i> ë³¸ë¬¸ì— ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3>í”Œë¡¯ì„ êµ¬ìƒí•  íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        </div>
    </main>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let currentEpisodeId = null;
    let globalEpisodes = [];
    let contextData = "";

    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData();
        await loadEpisodeList();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    async function loadContextData() {
        try {
            const [wRes, cRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            const world = await wRes.json();
            const chars = await cRes.json();
            contextData = `[ì„¸ê³„ê´€]: ${world.map(w => w.title).join(', ')}\n[ë“±ì¥ì¸ë¬¼]: ${chars.map(c => `${c.name}(${c.role})`).join(', ')}`;
        } catch(e) { console.warn("Context load failed"); }
    }

    async function loadEpisodeList(targetId = null) {
        const listEl = document.getElementById('plotList');
        try {
            const res = await fetch(`/api/episodes?setting_id=${settingId}`);
            if(!res.ok) throw new Error("Load failed");
            
            globalEpisodes = await res.json();
            globalEpisodes.sort((a,b) => a.episode_number - b.episode_number);

            listEl.innerHTML = '';
            
            if(globalEpisodes.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">ì•„ì§ ë“±ë¡ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                showEditor(false);
                return;
            }

            globalEpisodes.forEach(ep => {
                const card = document.createElement('div');
                card.className = `plot-card ${ep.id === currentEpisodeId ? 'active' : ''}`;
                card.onclick = () => selectEpisode(ep);
                
                const preview = ep.content && ep.content.trim() ? ep.content.substring(0, 40) + '...' : 'ë‚´ìš© ì—†ìŒ';
                
                card.innerHTML = `
                    <div class="card-num">#${ep.episode_number}</div>
                    <div class="card-title">${ep.title}</div>
                    <div class="card-preview">${preview}</div>
                `;
                listEl.appendChild(card);
            });

            if (targetId) {
                const target = globalEpisodes.find(e => e.id === targetId);
                if (target) selectEpisode(target);
            } else if (currentEpisodeId) {
                const current = globalEpisodes.find(e => e.id === currentEpisodeId);
                if (current) {
                    // UI active ê°±ì‹  (ë¬´í•œë£¨í”„ ë°©ì§€)
                }
            }

        } catch (e) { console.error(e); }
    }

    function selectEpisode(ep) {
        currentEpisodeId = ep.id;
        showEditor(true);
        
        document.getElementById('episodeTitle').value = ep.title;
        document.getElementById('plotContent').value = ep.content || '';
        document.getElementById('aiResultText').innerText = "AI ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";

        const listEl = document.getElementById('plotList');
        Array.from(listEl.children).forEach(card => card.classList.remove('active'));
        
        const idx = globalEpisodes.findIndex(e => e.id === ep.id);
        if (listEl.children[idx]) listEl.children[idx].classList.add('active');
    }

    function showEditor(show) {
        document.getElementById('editorWrapper').style.display = show ? 'flex' : 'none';
        document.getElementById('emptyState').style.display = show ? 'none' : 'flex';
    }

    // ğŸŒŸ [ì¶”ê°€ë¨] í”Œë¡¯ ë‚´ìš© ë³µì‚¬ í•¨ìˆ˜
    function copyCurrentPlot() {
        const content = document.getElementById('plotContent').value;
        if (!content) {
            alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        navigator.clipboard.writeText(content).then(() => {
            alert("í”Œë¡¯ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }).catch(err => {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    async function createNewEpisode() {
        let maxNum = 0;
        if (globalEpisodes.length > 0) maxNum = Math.max(...globalEpisodes.map(e => e.episode_number));
        const nextNum = maxNum + 1;
        const title = `${nextNum}í™”: (ì œëª© ë¯¸ì •)`;

        try {
            const res = await fetch('/api/episodes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    setting_id: settingId,
                    episode_number: nextNum,
                    title: title,
                    content: " ", 
                    prompt: "Plot Outline"
                })
            });

            if (res.ok) {
                const result = await res.json();
                await loadEpisodeList(result.id);
            } else { alert("ì¶”ê°€ ì‹¤íŒ¨"); }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function saveCurrentEpisode() {
        if (!currentEpisodeId) return;
        
        const title = document.getElementById('episodeTitle').value;
        const content = document.getElementById('plotContent').value;
        
        const current = globalEpisodes.find(e => e.id === currentEpisodeId);
        const epNum = current ? current.episode_number : 999;

        try {
            const res = await fetch(`/api/episodes/${currentEpisodeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    episode_number: epNum,
                    title: title,
                    content: content
                })
            });

            if (res.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadEpisodeList(currentEpisodeId);
            } else { alert("ì €ì¥ ì‹¤íŒ¨"); }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function deleteCurrentEpisode() {
        if (!currentEpisodeId) return;
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetch(`/api/episodes/${currentEpisodeId}`, { method: 'DELETE' });
            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentEpisodeId = null;
                showEditor(false);
                loadEpisodeList();
            } else { alert("ì‚­ì œ ì‹¤íŒ¨"); }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function generateIdea() {
        const prompt = document.getElementById('aiPrompt').value;
        const content = document.getElementById('plotContent').value;
        if (!prompt) return alert("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const btn = document.querySelector('.btn-ai');
        btn.disabled = true; 
        btn.innerText = "ìƒì„± ì¤‘...";

        try {
            const payload = {
                model: "gemini-2.5-flash",
                payload: {
                    contents: [{
                        parts: [{
                            text: `[ë°°ê²½ì§€ì‹] ${contextData}\n[í˜„ì¬ í”Œë¡¯] ${content}\n[ìš”ì²­] ${prompt}\n[ì¡°ê±´] ì•„ì´ë””ì–´ 3ê°œ ì œì•ˆ.`
                        }]
                    }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            const result = data.candidates[0].content.parts[0].text;
            document.getElementById('aiResultText').innerText = result;

        } catch(e) { alert("AI ìƒì„± ì‹¤íŒ¨"); }
        finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-bolt"></i> ìƒì„±í•˜ê¸°';
        }
    }

    function applyAiResult() {
        const result = document.getElementById('aiResultText').innerText;
        if(result.includes("AI ê²°ê³¼ê°€")) return;
        const editor = document.getElementById('plotContent');
        editor.value += "\n\n[AI ì œì•ˆ]\n" + result;
        editor.scrollTop = editor.scrollHeight;
    }

    init();
</script>

</body>
</html>