<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í”Œë¡¯ & íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --plot-color: #9b59b6; 
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
            --danger-color: #e74c3c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            /* ëª¨ë°”ì¼ ì£¼ì†Œì°½ ëŒ€ì‘ ë†’ì´ */
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0; z-index: 1001;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px;
            border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--plot-color); font-weight: bold; }

        /* ë ˆì´ì•„ì›ƒ */
        .workspace-container {
            display: flex; flex: 1; overflow: hidden; position: relative;
        }

        /* ë°±ë“œë¡­ (ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë°°ê²½) */
        .sidebar-backdrop {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999;
        }

        /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px; background: #fff; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            z-index: 1000; transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 15px; background: white; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; color: var(--plot-color);
        }
        .btn-close-sidebar { display: none; background: none; border: none; font-size: 1.2rem; color: #666; cursor: pointer; }
        
        .plot-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 50px; }
        
        .plot-card {
            background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px;
            cursor: pointer; transition: all 0.2s;
        }
        .plot-card:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.05); }
        .plot-card.active { border: 2px solid var(--plot-color); background: #fdfbff; }
        .card-num { font-size: 0.8rem; color: #888; font-weight: bold; margin-bottom: 4px; }
        .card-title { font-weight: bold; font-size: 1rem; color: #333; }

        /* ë©”ì¸ ì—ë””í„° ì˜ì—­ */
        .main-editor {
            flex: 1; display: flex; flex-direction: column;
            background: white; padding: 20px; overflow-y: auto;
            position: relative; width: 100%;
        }
        
        .editor-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; gap: 10px; flex-shrink: 0;
        }
        /* ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ */
        .btn-mobile-menu {
            display: none; background: white; border: 1px solid #ddd;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; color: #555;
        }

        .input-title { 
            flex: 1; font-size: 1.2rem; font-weight: bold; border: none;
            border-bottom: 2px solid #eee; background: transparent; padding: 5px;
            min-width: 0; /* Flexbox ì¶•ì†Œ í—ˆìš© */
        }
        .input-title:focus { border-bottom-color: var(--plot-color); outline: none; }

        .action-group { display: flex; gap: 5px; align-items: center; flex-shrink: 0; }
        .btn-base {
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            font-weight: bold; border: none; white-space: nowrap;
        }
        .btn-delete { background: #fff; border: 1px solid var(--danger-color); color: var(--danger-color); }
        .btn-save { background: var(--plot-color); color: white; }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-container {
            display: flex; gap: 5px; margin-bottom: 0; border-bottom: 1px solid #ddd; flex-shrink: 0;
        }
        .tab-btn {
            flex: 1; padding: 10px; background: #f1f1f1; border: 1px solid #ddd; border-bottom: none;
            border-radius: 8px 8px 0 0; cursor: pointer; color: #666; font-weight: bold; font-size: 0.95rem;
        }
        .tab-btn.active { background: white; color: var(--plot-color); border-bottom: 2px solid white; margin-bottom: -1px; }
        
        .tab-content { display: none; flex: 1; flex-direction: column; gap: 10px; padding-top: 15px; height: 100%; overflow: hidden; }
        .tab-content.active { display: flex; }

        .text-editor {
            flex: 1; width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 15px;
            font-size: 1rem; line-height: 1.6; resize: none; background: white;
            font-family: 'Pretendard', sans-serif;
            /* ëª¨ë°”ì¼ í°íŠ¸ í™•ëŒ€ ë°©ì§€ */
            font-size: 16px;
        }
        .text-editor:focus { outline: 2px solid var(--plot-color); border-color: transparent; }

        /* AI ë„êµ¬ ì˜ì—­ */
        .ai-tools-area {
            background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee;
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex-shrink: 0;
        }
        .btn-ai-gen {
            background: #2c3e50; color: white; padding: 8px 15px; border-radius: 6px; 
            border: none; cursor: pointer; font-weight: bold; flex-grow: 1;
        }
        .btn-copy { background: white; border: 1px solid #ccc; color: #555; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .ai-status { font-size: 0.85rem; color: #666; width: 100%; }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #aaa; text-align: center;
        }

        /* ğŸŒŸ [í•µì‹¬] ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 900px) {
            /* ì‚¬ì´ë“œë°” Drawer í™” */
            .sidebar {
                position: absolute; top: 0; left: 0; height: 100%;
                transform: translateX(-100%);
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.active { transform: translateX(0); }
            
            .btn-close-sidebar { display: block; }
            .btn-mobile-menu { display: block; }
            .sidebar-backdrop.active { display: block; }

            .main-editor { padding: 15px; }
            .input-title { font-size: 1rem; }
            
            /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ê°„ì†Œí™” (ì•„ì´ì½˜ë§Œ ë‚¨ê¸°ê±°ë‚˜ ì¤„ì„) */
            .btn-save span, .btn-delete span { display: none; }
            .btn-save { padding: 8px 12px; }
            .btn-save::after { content: '\f0c7'; font-family: "Font Awesome 6 Free"; }
            .btn-delete { padding: 8px 12px; }
            .btn-delete::after { content: '\f1f8'; font-family: "Font Awesome 6 Free"; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item active"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
    </div>
</nav>

<div class="workspace-container container">
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>íšŒì°¨ ëª©ë¡</span>
            <button class="btn-close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <div id="plotList" class="plot-list">
            <div style="text-align:center; padding:20px; color:#999;">ë¡œë”© ì¤‘...</div>
        </div>
        <div style="padding:10px; border-top:1px solid #eee;">
             <button class="btn-add" style="width:100%;" onclick="createNewEpisode()">
                 <i class="fas fa-plus"></i> ìƒˆ íšŒì°¨ ì¶”ê°€
             </button>
        </div>
    </aside>

    <main class="main-editor">
        <div id="editorWrapper" style="display:none; height:100%; flex-direction:column;">
            <div class="editor-header">
                <button class="btn-mobile-menu" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                
                <input type="text" id="episodeTitle" class="input-title" placeholder="íšŒì°¨ ì œëª©">
                <div class="action-group">
                    <button class="btn-base btn-save" onclick="saveCurrentEpisode()"><span>ì €ì¥</span></button>
                    <button class="btn-base btn-delete" onclick="deleteCurrentEpisode()"><span>ì‚­ì œ</span></button>
                </div>
            </div>

            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('plot')">ğŸ“œ ì¤„ê±°ë¦¬</button>
                <button class="tab-btn" onclick="switchTab('treatment')">ğŸ¬ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</button>
            </div>

            <div id="tab-plot" class="tab-content active">
                <div class="ai-tools-area">
                    <button class="btn-copy" onclick="copyContent('plotContent')"><i class="fas fa-copy"></i> ë³µì‚¬</button>
                    <span class="ai-status">í•µì‹¬ ì¤„ê±°ë¦¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.</span>
                </div>
                <textarea id="plotContent" class="text-editor" placeholder="ì´ íšŒì°¨ì˜ ì¤„ê±°ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            </div>

            <div id="tab-treatment" class="tab-content">
                <div class="ai-tools-area">
                    <button class="btn-ai-gen" onclick="generateTreatment()"><i class="fas fa-magic"></i> AI ìƒì„±</button>
                    <button class="btn-copy" onclick="copyContent('treatmentContent')"><i class="fas fa-copy"></i></button>
                    <span id="treatmentStatus" class="ai-status">ì¤„ê±°ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¥ë©´ì„ êµ¬ì„±í•©ë‹ˆë‹¤.</span>
                </div>
                <textarea id="treatmentContent" class="text-editor" placeholder="AI ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ì§ì ‘ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”."></textarea>
            </div>

        </div>

        <div id="emptyState" class="empty-state">
            <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3>í¸ì§‘í•  íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
            <button class="btn-mobile-menu" style="display:inline-block; margin-top:15px; padding:10px 20px;" onclick="toggleSidebar()">
                <i class="fas fa-list"></i> ëª©ë¡ ì—´ê¸°
            </button>
        </div>
    </main>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let currentEpisodeId = null;
    let globalEpisodes = [];
    let contextData = "";

    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData();
        await loadEpisodeList();
    }
    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

	
	// ğŸŒŸ ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.querySelector('.sidebar-backdrop');
        sidebar.classList.toggle('active');
        backdrop.classList.toggle('active');
    }
    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // ë²„íŠ¼ í™œì„±í™” (ì´ë²¤íŠ¸ íƒ€ê²Ÿì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í…ìŠ¤íŠ¸ë‚˜ ìˆœì„œë¡œ ì°¾ìŒ)
        const buttons = document.querySelectorAll('.tab-btn');
        if (tabName === 'plot') buttons[0].classList.add('active');
        else buttons[1].classList.add('active');

        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    async function loadContextData() {
        try {
            const [wRes, cRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            const world = await wRes.json();
            const chars = await cRes.json();
            contextData = `[ì„¸ê³„ê´€]: ${world.map(w => w.title).join(', ')}\n[ë“±ì¥ì¸ë¬¼]: ${chars.map(c => `${c.name}(${c.role})`).join(', ')}`;
        } catch(e) { console.warn("Context load failed"); }
    }

    async function loadEpisodeList(targetId = null) {
        const listEl = document.getElementById('plotList');
        try {
            const res = await fetch(`/api/episodes?setting_id=${settingId}`);
            if(!res.ok) throw new Error("Load failed");
            
            globalEpisodes = await res.json();
            globalEpisodes.sort((a,b) => a.episode_number - b.episode_number);

            listEl.innerHTML = '';
            
            if(globalEpisodes.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                showEditor(false);
                return;
            }

            globalEpisodes.forEach(ep => {
                const card = document.createElement('div');
                card.className = `plot-card ${ep.id === currentEpisodeId ? 'active' : ''}`;
                card.onclick = () => selectEpisode(ep);
                
                card.innerHTML = `
                    <div class="card-num">#${ep.episode_number}</div>
                    <div class="card-title">${ep.title}</div>
                `;
                listEl.appendChild(card);
            });

            if (targetId) {
                const target = globalEpisodes.find(e => e.id === targetId);
                if (target) selectEpisode(target);
            }

        } catch (e) { console.error(e); }
    }

    function selectEpisode(ep) {
        currentEpisodeId = ep.id;
        showEditor(true);
        
        // ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('episodeTitle').value = ep.title;
        document.getElementById('plotContent').value = ep.content || '';
        // ğŸŒŸ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ë°ì´í„° ì±„ìš°ê¸° (DBì— treatment ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•¨)
        document.getElementById('treatmentContent').value = ep.treatment || '';

        // UI ê°±ì‹ 
        const listEl = document.getElementById('plotList');
        Array.from(listEl.children).forEach(card => card.classList.remove('active'));
        const idx = globalEpisodes.findIndex(e => e.id === ep.id);
        if (listEl.children[idx]) listEl.children[idx].classList.add('active');
		// ëª¨ë°”ì¼: ì„ íƒ ì‹œ ì‚¬ì´ë“œë°” ë‹«ê¸°
        if (window.innerWidth <= 900) toggleSidebar();
    }

    function showEditor(show) {
        document.getElementById('editorWrapper').style.display = show ? 'flex' : 'none';
        document.getElementById('emptyState').style.display = show ? 'none' : 'flex';
    }

    // ğŸŒŸ [í•µì‹¬] AI íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ìƒì„±
    async function generateTreatment() {
        const plot = document.getElementById('plotContent').value;
        const title = document.getElementById('episodeTitle').value;
        
        if (!plot.trim()) return alert("ë¨¼ì € 'ì¤„ê±°ë¦¬(Plot)' íƒ­ì— ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");

        const btn = document.querySelector('.btn-ai-gen');
        const statusEl = document.getElementById('treatmentStatus');
        const originalBtnHTML = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...';
        statusEl.innerText = "AIê°€ ì¥ë©´ì„ êµ¬ìƒ ì¤‘ì…ë‹ˆë‹¤...";

        try {
            const fullPrompt = `				
				[í˜„ì¬ íšŒì°¨ ì œëª©] ${title}
                [í˜„ì¬ íšŒì°¨ ì¤„ê±°ë¦¬]
                ${plot}

                [ìš”ì²­ ì‚¬í•­]
                ìœ„ ì¤„ê±°ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸ **íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸(Treatment)**ë¥¼ ì‘ì„±í•´ì¤˜.
				`
            const systemInstruction = `				
                [ì‘í’ˆ ì •ë³´]
                ${contextData}
				
                [ì—­í• ] ì „ë¬¸ ë“œë¼ë§ˆ ì‘ê°€ ë° ì›¹ì†Œì„¤ ê¸°íšì 

				1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

				2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

				3. ë§ˆí¬ì—… ì œê±° : ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

				4. ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±
					- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
					- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.
					- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©, ê°ˆë“±ê³¼ í•´ê²°ì˜ ê·¹ì  êµ¬ì„±.
					
                [ì¶œë ¥ ì¡°ê±´]
                1. ìš”ì²­ ì‚¬í•­(ì˜ˆ: ëª‡ í™”, ì–´ë–¤ ë‚´ìš©)ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸ **íšŒì°¨ë³„ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
                2. íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ëŠ” ë‹¤ìŒ 4ê°€ì§€ ì„¹ì…˜ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤: **ìš”ì•½, ë“±ì¥ ì¸ë¬¼, ì¥ë©´ êµ¬ì„±, ì„¤ì • ì²´í¬**.
                3. **ì¥ë©´ êµ¬ì„±(SCENE X)**ì€ ìµœì†Œ 7ì”¬ ì´ìƒìœ¼ë¡œ êµ¬ì„±í•˜ë©°, ê° ì”¬ì€ **ìƒí™©, ì‚¬ê±´, ê°ˆë“±, ì‹¬ë¦¬, ëŒ€ì‚¬/ì—°ì¶œ** ìš”ì†Œë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
                4. **ì¥ë©´ êµ¬ì„±(SCENE 8)**ì€ í•´ë‹¹ íšŒì°¨ì˜ ë§ˆì§€ë§‰ ì”¬ìœ¼ë¡œ **ìƒí™©, ì‚¬ê±´, ê°ˆë“±, ì‹¬ë¦¬, ëŒ€ì‚¬/ì—°ì¶œ, ENDING/HOOK** ìš”ì†Œë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
                5. **ë“±ì¥ ì¸ë¬¼** ëª©ë¡ì€ í•´ë‹¹ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ë‚´ìš©ì— ì‹¤ì œë¡œ ë“±ì¥í•˜ëŠ” ì¸ë¬¼ë§Œ ë‚˜ì—´í•˜ì„¸ìš”.
                6. ë°˜ë“œì‹œ ì•„ë˜ ì˜ˆì‹œì™€ ì •í™•íˆ ë™ì¼í•œ í˜•ì‹(ì œëª©, ë³„í‘œ, êµ¬ë¶„ì„ , ì½œë¡ )ìœ¼ë¡œ, **ì¤„ê¸€ í…ìŠ¤íŠ¸**ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.

                [ì¶œë ¥ ì˜ˆì‹œ]
                
                [ì œ Xí™”] íšŒì°¨ ì œëª©
                
                1. ìš”ì•½
                (íšŒì°¨ ì „ì²´ ì¤„ê±°ë¦¬ ìš”ì•½. 300ì ë‚´ì™¸)
                
                *
                
                2. ë“±ì¥ ì¸ë¬¼
                ì¥í•œë¹›, ì¥í•œì„±, ...
                
                *
                
                3. ì¥ë©´ êµ¬ì„± (X Scenes)
                SCENE 1: ì¥ë©´ ì œëª©
                 - ìƒí™©: (ë°°ê²½ ì„¤ëª…)
                 - ì‚¬ê±´: (êµ¬ì²´ì  í–‰ë™)
                 - ê°ˆë“±: (ì¸ë¬¼/ì™¸ë¶€ ê°ˆë“±)
                 - ì‹¬ë¦¬: (ì£¼ì¸ê³µ ë‚´ë©´)
                 - ëŒ€ì‚¬/ì—°ì¶œ: (í‚¤ ëŒ€ì‚¬ ë° ì—°ì¶œ í¬ì¸íŠ¸)

                SCENE 2: ì¥ë©´ ì œëª©
                * ... (ë°˜ë³µ) ...
                
				SCENE 8: ì¥ë©´ ì œëª©				
                 - ìƒí™©: (ë°°ê²½ ì„¤ëª…)
                 - ì‚¬ê±´: (êµ¬ì²´ì  í–‰ë™)
                 - ê°ˆë“±: (ì¸ë¬¼/ì™¸ë¶€ ê°ˆë“±)
                 - ì‹¬ë¦¬: (ì£¼ì¸ê³µ ë‚´ë©´)
                 - ëŒ€ì‚¬/ì—°ì¶œ: (í‚¤ ëŒ€ì‚¬ ë° ì—°ì¶œ í¬ì¸íŠ¸)
				 - ENDING/HOOK:(ENDING HOOK ë„£ê¸°) 
                *
                
                4. ì„¤ì • ì²´í¬
                * (í•´ë‹¹ íšŒì°¨ì—ì„œ ê°•ì¡°ëœ ì„¤ì •ì´ë‚˜ ìºë¦­í„° ì•„í¬ ì²´í¬)
            `;

            const payload = {
                model: "gemini-2.5-flash",
                payload: {
                    contents: [{ parts: [{ text: fullPrompt }] }],
					systemInstruction: { parts: [{ text: systemInstruction }] },
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            const result = data.candidates[0].content.parts[0].text;

            document.getElementById('treatmentContent').value = result;
            statusEl.innerText = "ìƒì„± ì™„ë£Œ! ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.";

        } catch(e) {
            console.error(e);
            alert("AI ìƒì„± ì‹¤íŒ¨");
            statusEl.innerText = "ì˜¤ë¥˜ ë°œìƒ";
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        }
    }

    async function createNewEpisode() {
        let maxNum = 0;
        if (globalEpisodes.length > 0) maxNum = Math.max(...globalEpisodes.map(e => e.episode_number));
        const nextNum = maxNum + 1;
        const title = `${nextNum}í™”: (ì œëª© ë¯¸ì •)`;

        try {
            const res = await fetch('/api/episodes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    setting_id: settingId,
                    episode_number: nextNum,
                    title: title,
                    content: " ", 
                    prompt: "Plot Outline"
                })
            });

            if (res.ok) {
                const result = await res.json();
                await loadEpisodeList(result.id);
				if (window.innerWidth <= 900) toggleSidebar();
            } else { alert("ì¶”ê°€ ì‹¤íŒ¨"); }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function saveCurrentEpisode() {
        if (!currentEpisodeId) return;
        
        const title = document.getElementById('episodeTitle').value;
        const content = document.getElementById('plotContent').value;
        // ğŸŒŸ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ë‚´ìš©ë„ í•¨ê»˜ ì €ì¥
        const treatment = document.getElementById('treatmentContent').value;
        
        const current = globalEpisodes.find(e => e.id === currentEpisodeId);
        const epNum = current ? current.episode_number : 999;

        try {
            const res = await fetch(`/api/episodes/${currentEpisodeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    episode_number: epNum,
                    title: title,
                    content: content,
                    treatment: treatment // ğŸŒŸ ì¶”ê°€ë¨
                })
            });

            if (res.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                // ë¡œì»¬ ë°ì´í„° ê°±ì‹ 
                const target = globalEpisodes.find(e => e.id === currentEpisodeId);
                if(target) {
                    target.title = title;
                    target.content = content;
                    target.treatment = treatment;
                }
                loadEpisodeList(currentEpisodeId); // ëª©ë¡ ì œëª© ë“± ê°±ì‹ 
            } else { alert("ì €ì¥ ì‹¤íŒ¨"); }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function deleteCurrentEpisode() {
        if (!currentEpisodeId) return;
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetch(`/api/episodes/${currentEpisodeId}`, { method: 'DELETE' });
            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentEpisodeId = null;
                showEditor(false);
                loadEpisodeList();
            } else { alert("ì‚­ì œ ì‹¤íŒ¨"); }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    function copyContent(elementId) {
        const content = document.getElementById(elementId).value;
        if (!content) return alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        navigator.clipboard.writeText(content).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
    }

    init();
</script>

</body>
</html>