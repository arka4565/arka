<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¥ë©´ë³„ ì§‘í•„ - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2ecc71; /* ì§‘í•„ ì§‘ì¤‘ ì»¬ëŸ¬ (ë…¹ìƒ‰ ê³„ì—´) */
            --bg-color: #f4f6f8;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --border-color: #ddd;
        }

        * { box-sizing: border-box; }

       body {
    font-family: 'Pretendard', sans-serif;
    background-color: var(--bg-color);
    margin: 0;
    display: flex; 
    flex-direction: column; 
    
    /* ë†’ì´ ì„¤ì • ìˆ˜ì • ë¶€ë¶„ */
    height: 100vh; /* êµ¬í˜• ë¸Œë¼ìš°ì € í˜¸í™˜ìš© */
    height: 100dvh; /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ëŒ€ì‘ */
    
    overflow: hidden;
}

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar {
            background-color: var(--nav-bg); color: white; padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px;
            border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--primary-color); font-weight: bold; }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .container { display: flex; flex: 1; overflow: hidden; }

        /* ì¢Œì¸¡: íšŒì°¨ ëª©ë¡ */
        .sidebar {
            width: 250px; background: white; border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;
        }
        .ep-item {
            padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;
        }
        .ep-item:hover { background: #f9f9f9; }
        .ep-item.active { background: #e8f5e9; border-left: 4px solid var(--primary-color); font-weight: bold; }

        /* ì¤‘ì•™: ì§‘í•„ ì˜ì—­ */
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }

        /* ìƒë‹¨ ì§„í–‰ë°” */
        .progress-bar {
            display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; flex-shrink: 0;
        }
        .scene-step {
            flex: 1; min-width: 80px; text-align: center; padding: 10px;
            background: #e0e0e0; border-radius: 6px; font-size: 0.9rem; cursor: pointer; color: #666;
            white-space: nowrap; font-weight: bold; border: 1px solid #ccc;
        }
        .scene-step.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .scene-step.done { background: #a5d6a7; color: #1b5e20; border-color: #81c784; }

        /* ì‘ì—… ì˜ì—­ ë¶„í•  (ì§€ì‹œë¬¸ vs ì—ë””í„°) */
        .workspace { display: flex; gap: 20px; flex: 1; min-height: 0; }
        
        /* ì™¼ìª½: íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ì§€ì‹œë¬¸ (Reference) */
        .ref-panel {
            flex: 1; background: white; border: 1px solid #ddd; border-radius: 8px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .ref-header { 
            background: #f8f9fa; padding: 10px 15px; font-weight: bold; color: #555; 
            border-bottom: 1px solid #eee; font-size: 0.95rem;
        }
        .ref-content { 
            padding: 15px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; color: #444; font-size: 0.95rem; flex: 1;
        }

        /* ì˜¤ë¥¸ìª½: ì—ë””í„° */
        .editor-panel {
            flex: 1.5; display: flex; flex-direction: column; gap: 10px;
        }
        .editor-header-bar { display: flex; justify-content: space-between; align-items: center; }
        
        .char-badge {
            margin-left:8px; font-size:0.85rem; color:#666; background:#eee; padding:2px 8px; border-radius:12px;
        }

        .editor-textarea {
            flex: 1; padding: 20px; border: 1px solid #ccc; border-radius: 8px;
            font-size: 1.05rem; line-height: 1.8; resize: none; font-family: 'Pretendard', sans-serif;
            outline: none;
        }
        .editor-textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2); }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .controls {
            margin-top: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-ai { background: #2c3e50; color: white; }
        .btn-prev { background: #95a5a6; color: white; }
        .btn-next { background: var(--primary-color); color: white; }
        .btn-save-all { background: #e67e22; color: white; }

        /* --- ê¸°ì¡´ .sidebar ìŠ¤íƒ€ì¼ ìˆ˜ì • ë° ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ ì¶”ê°€ --- */

/* ì‚¬ì´ë“œë°” ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
.sidebar {
    width: 250px; 
    background: white; 
    border-right: 1px solid var(--border-color);
    display: flex; 
    flex-direction: column; 
    flex-shrink: 0;
    transition: all 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
}

/* ëª©ë¡ ì»¨í…Œì´ë„ˆ (ë°ìŠ¤í¬íƒ‘ì€ í•­ìƒ ë³´ì„) */
.episode-list-container {
    overflow-y: auto;
    flex: 1;
}

/* ëª¨ë°”ì¼ìš© í† ê¸€ ë²„íŠ¼ (ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ìˆ¨ê¹€) */
.sidebar-toggle-btn {
    display: none; 
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    font-weight: bold;
    color: #555;
    justify-content: space-between;
    align-items: center;
}

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 900px) {
    .container { flex-direction: column; }
    .workspace { flex-direction: column; }
    .ref-panel { max-height: 150px; flex: none; }
    .editor-panel { flex: 1; }
.sidebar {
        width: 100%;
        height: auto; /* ê³ ì • ë†’ì´ ì œê±° */
        border-right: none;
        border-bottom: 1px solid var(--border-color);
    }

    /* í† ê¸€ ë²„íŠ¼ ë³´ì´ê²Œ ì„¤ì • */
    .sidebar-toggle-btn {
        display: flex; 
    }

    /* ëª©ë¡ ì»¨í…Œì´ë„ˆ: ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ (í† ê¸€) */
    .episode-list-container {
        display: none; 
        max-height: 300px; /* í¼ì³¤ì„ ë•Œ ìµœëŒ€ ë†’ì´ */
        border-top: 1px solid #eee;
    }

    /* í´ë˜ìŠ¤ê°€ ì¶”ê°€ë˜ë©´ ë³´ì´ê²Œ ì²˜ë¦¬ */
    .episode-list-container.show {
        display: block;
    }
    /* --- ì•„ë˜ ë‚´ìš©ì„ ì¶”ê°€/ìˆ˜ì •í•´ ì£¼ì„¸ìš” --- */

    /* 1. ë©”ì¸ ì˜ì—­ í•˜ë‹¨ì— ë„‰ë„‰í•œ ì—¬ë°± ì¶”ê°€ (ë²„íŠ¼ì´ ê°€ë ¤ì§€ì§€ ì•Šê²Œ í•¨) */
    .main-area {
        padding-bottom: 100px !important; 
    }

    /* 2. ë²„íŠ¼ë“¤ì´ ì¢ì€ í™”ë©´ì—ì„œë„ ë­‰ê°œì§€ì§€ ì•Šê³  ì¤„ë°”ê¿ˆë˜ë„ë¡ ì„¤ì • */
    .controls {
        flex-wrap: wrap;
        gap: 10px;
        /* í•„ìš”í•˜ë‹¤ë©´ ë²„íŠ¼ ì˜ì—­ì„ í™”ë©´ í•˜ë‹¨ì— ê³ ì • (ì„ íƒì‚¬í•­) */
        /* position: sticky; bottom: 0; background: var(--bg-color); z-index: 10; padding-bottom: 20px; */
    }
    
    /* ë²„íŠ¼ í¬ê¸° ì¡°ì • (í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ) */
    .btn {
        flex: 1; /* ë²„íŠ¼ë“¤ì´ ë„ˆë¹„ë¥¼ ê· ë“±í•˜ê²Œ ì°¨ì§€ */
        justify-content: center;
        padding: 12px 10px;
    }
    
    /* íŠ¹ì • ë²„íŠ¼(ì €ì¥ ë“±)ì´ ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
    .btn-save-all {
        min-width: 100%; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì €ì¥ ë²„íŠ¼ì„ í•œ ì¤„ ê½‰ ì°¨ê²Œ ë°°ì¹˜ */
        margin-left: 0 !important;
        margin-top: 10px;
    }
}
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item "><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item active" data-target="write_scene.html"><i class="fas fa-layer-group"></i>ì¥ë©´ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
        <a href="#" class="nav-item" data-target="plan.html"><i class="fas fa-magic"></i> ê¸°íš</a>
        <a href="#" class="nav-item" data-target="roadmap.html"><i class="fas fa-magic"></i> ë¡œë“œë§µ</a>
        <a href="#" class="nav-item" data-target="treatment.html"><i class="fas fa-magic"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</a>
    </div>
</nav>

<div class="container">
    <aside class="sidebar">
    <div class="sidebar-toggle-btn" onclick="toggleSidebarList()">
        <span id="currentEpTitleDisplay">ğŸ“‚ íšŒì°¨ ì„ íƒí•˜ê¸°</span>
        <i class="fas fa-chevron-down" id="toggleIcon"></i>
    </div>

    <div id="episodeList" class="episode-list-container">
        <div style="padding:15px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>
    </div>
</aside>

    <main class="main-area">
        <div id="sceneNavigator" class="progress-bar">
            </div>

        <div class="workspace">
            <div class="ref-panel">
                <div class="ref-header">
                    <i class="fas fa-map-signs"></i> <span id="currentSceneTitle">ì¥ë©´ ì§€ì‹œë¬¸</span>
                </div>
                <div id="sceneInstruction" class="ref-content">
                    ì™¼ìª½ ëª©ë¡ì—ì„œ ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•˜ë©´,<br>
                    ì„¤ì •ëœ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸(ì¥ë©´ êµ¬ì„±)ê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="editor-panel">
                <div class="editor-header-bar">
                    <div>
                        <span style="font-weight:bold; color:#333;">ğŸ“ ë³¸ë¬¸ ì‘ì„±</span>
                        <span id="sceneCharCount" class="char-badge">0ì</span>
                    </div>
                    <button class="btn btn-ai" onclick="generateSceneWithAI()">
                        <i class="fas fa-magic"></i> AI ì´ˆì•ˆ ìƒì„±
                    </button>
                </div>
                <textarea id="sceneEditor" class="editor-textarea" placeholder="ì´ ì¥ë©´ì˜ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..." oninput="updateSceneCharCount()"></textarea>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-prev" onclick="prevScene()"><i class="fas fa-arrow-left"></i> ì´ì „ ì¥ë©´</button>
            
            <div style="text-align:center; font-size:0.9rem; color:#666;">
                í˜„ì¬: <span id="currentStepDisplay">0 / 0</span>
            </div>

            <div>
                <button class="btn btn-next" onclick="nextScene()">ë‹¤ìŒ ì¥ë©´ <i class="fas fa-arrow-right"></i></button>
                <button class="btn btn-save-all" onclick="saveToStory()" style="margin-left:10px; display:none;" id="btnMerge">
                    <i class="fas fa-save"></i> ì „ì²´ í•©ì¹˜ê¸° (ì €ì¥)
                </button>
            </div>
        </div>
    </main>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let episodes = [];
    let currentEpId = null;
    let sceneData = []; // [{ title, instruction, content }]
    let currentSceneIndex = 0;
    let currentTreatmentHeader = ""; // ğŸŒŸ íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ ìƒë‹¨(ì„¤ì •, ì¸ë¬¼ ë“±) ì €ì¥ìš©
    // RAGìš© ì „ì²´ ë°ì´í„°
    let allWorldSettings = [];
    let allCharacters = [];

    async function init() {
        if (!settingId) return alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        setupNav();
        await loadContextData();
        await loadEpisodes();
    }
function toggleSidebarList() {
    const list = document.getElementById('episodeList');
    const icon = document.getElementById('toggleIcon');
    
    // show í´ë˜ìŠ¤ í† ê¸€
    if (list.classList.contains('show')) {
        list.classList.remove('show');
        icon.className = 'fas fa-chevron-down';
    } else {
        list.classList.add('show');
        icon.className = 'fas fa-chevron-up';
    }
}
    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    // 1. ì„¸ê³„ê´€/ìºë¦­í„° ë°ì´í„° ë¡œë“œ (ì €ì¥ë§Œ í•¨)
    async function loadContextData() {
        try {
            const [wRes, cRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            allWorldSettings = await wRes.json();
            allCharacters = await cRes.json();
        } catch(e) { console.warn("Context Load Error:", e); }
    }

    // 2. ì—í”¼ì†Œë“œ ëª©ë¡ ë¡œë“œ
    async function loadEpisodes() {
        try {
            const res = await fetch(`/api/episodes?setting_id=${settingId}`);
            episodes = await res.json();
            episodes.sort((a,b) => a.episode_number - b.episode_number);

            const listEl = document.getElementById('episodeList');
            listEl.innerHTML = '';
            
            if (episodes.length === 0) {
                listEl.innerHTML = '<div style="padding:15px; text-align:center;">ì‘ì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            episodes.forEach(ep => {
                const div = document.createElement('div');
                div.className = 'ep-item';
                div.innerHTML = `<span style="font-weight:bold;">#${ep.episode_number}</span> ${ep.title}`;
                div.onclick = () => selectEpisode(ep, div);
                listEl.appendChild(div);
            });
        } catch(e) { console.error(e); }
    }

    // 3. ì—í”¼ì†Œë“œ ì„ íƒ ë° íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ íŒŒì‹±
    function selectEpisode(ep, el) {
        currentEpId = ep.id;
        
        // ìŠ¤íƒ€ì¼ ì²˜ë¦¬
        document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
// [ì¶”ê°€ë¨] ëª¨ë°”ì¼ í† ê¸€ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì„ íƒí•œ íšŒì°¨ ì œëª© ë³´ì—¬ì£¼ê¸°)
    const toggleTitle = document.getElementById('currentEpTitleDisplay');
    if (toggleTitle) toggleTitle.innerText = `ğŸ“‚ ${ep.title}`;

    // [ì¶”ê°€ë¨] ëª¨ë°”ì¼ì´ë¼ë©´ ì„ íƒ í›„ ëª©ë¡ ìë™ìœ¼ë¡œ ë‹«ê¸°
    if (window.innerWidth <= 900) {
        toggleSidebarList(); // ëª©ë¡ ë‹«ê¸°
    }
        const treatmentText = ep.treatment || "";
        
        // íŒŒì‹± ì‹œì‘
        parseTreatmentToScenes(treatmentText);
        
        // UI ìƒì„±
        renderSceneNavigator();
        
        // ì²« ì”¬ ë¡œë“œ
        if (sceneData.length > 0) {
            loadScene(0);
        } else {
            alert("íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. 'í”Œë¡¯' íƒ­ì—ì„œ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.");
        }
    }

    // ğŸŒŸ [ìˆ˜ì •ë¨] íŒŒì‹± ë¡œì§: ì”¬ì´ ì‹œì‘ë˜ê¸° ì „ì˜ ë‚´ìš©ì„ 'í—¤ë”'ë¡œ ì €ì¥
    function parseTreatmentToScenes(text) {
        sceneData = [];
        currentTreatmentHeader = ""; // ì´ˆê¸°í™”
        
        if (!text || text.trim() === "") {
            sceneData.push({ title: "ì¥ë©´ 1", instruction: "ë‚´ìš© ì—†ìŒ", content: "" });
            return;
        }

        const lines = text.split(/\r?\n/);
        let currentScene = null;
        let buffer = [];

        // ì •ê·œì‹: SCENE 1, **SCENE 1, ### SCENE 1 ë“± ëª¨ë‘ í—ˆìš©
        const sceneHeaderRegex = /^[\*\#]*\s*SCENE\s*(\d+)(.*)/i;

        lines.forEach(line => {
            const match = line.match(sceneHeaderRegex);

            if (match) {
                // (1) ìƒˆë¡œìš´ ì”¬ì´ ì‹œì‘ë¨
                
                // ì´ì „ ì”¬ì´ ìˆì—ˆë‹¤ë©´ ì €ì¥
                if (currentScene) {
                    currentScene.instruction = buffer.join('\n').trim();
                    sceneData.push(currentScene);
                }

                // ìƒˆ ì”¬ ê°ì²´ ìƒì„±
                const sceneNum = match[1];
                const sceneTitle = match[2].replace(/[\*\:]/g, '').trim();

                currentScene = {
                    title: `SCENE ${sceneNum}: ${sceneTitle}`,
                    instruction: "", 
                    content: "" 
                };
                buffer = []; // ë²„í¼ ì´ˆê¸°í™”
            } else {
                // (2) ì”¬ í—¤ë”ê°€ ì•„ë‹˜ (ë‚´ìš©)
                if (currentScene) {
                    // í˜„ì¬ ì¡ê³  ìˆëŠ” ì”¬ì´ ìˆìœ¼ë©´ -> ì”¬ ë‚´ìš©ìœ¼ë¡œ ì¶”ê°€
                    buffer.push(line);
                } else {
                    // ğŸŒŸ [í•µì‹¬] ì•„ì§ ì²« ì”¬ì´ ì‹œì‘ ì•ˆ ë¨ -> 'í—¤ë”(ë“±ì¥ì¸ë¬¼/ì„¸ê³„ê´€)'ë¡œ ì €ì¥!
                    currentTreatmentHeader += line + "\n";
                }
            }
        });

        // ë§ˆì§€ë§‰ ì”¬ ì €ì¥
        if (currentScene) {
            currentScene.instruction = buffer.join('\n').trim();
            sceneData.push(currentScene);
        }

        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ì”¬ìœ¼ë¡œ
        if (sceneData.length === 0) {
            sceneData.push({ title: "ì „ì²´ ë‚´ìš©", instruction: text, content: "" });
        }
        
        console.log("íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸ í—¤ë” ì¶”ì¶œ ì™„ë£Œ:", currentTreatmentHeader); // ë””ë²„ê¹…ìš© í™•ì¸
    }

    function renderSceneNavigator() {
        const navEl = document.getElementById('sceneNavigator');
        navEl.innerHTML = '';
        
        sceneData.forEach((scene, idx) => {
            const btn = document.createElement('div');
            btn.className = 'scene-step';
            btn.innerText = `SCENE ${idx + 1}`;
            btn.onclick = () => { saveCurrentSceneBuffer(); loadScene(idx); };
            navEl.appendChild(btn);
        });
    }

    function saveCurrentSceneBuffer() {
        if (sceneData[currentSceneIndex]) {
            sceneData[currentSceneIndex].content = document.getElementById('sceneEditor').value;
        }
    }

    function loadScene(index) {
        if (index < 0 || index >= sceneData.length) return;
        
        currentSceneIndex = index;
        const scene = sceneData[index];

        document.getElementById('currentSceneTitle').innerText = scene.title;
        document.getElementById('sceneInstruction').innerText = scene.instruction;
        document.getElementById('sceneEditor').value = scene.content || "";
        
        updateNavUI();
        updateSceneCharCount();
    }

    function updateNavUI() {
        const steps = document.querySelectorAll('.scene-step');
        steps.forEach((s, i) => {
            s.classList.remove('active');
            if (sceneData[i].content && sceneData[i].content.trim().length > 10) s.classList.add('done');
            if (i === currentSceneIndex) s.classList.add('active');
        });

        document.getElementById('currentStepDisplay').innerText = `${currentSceneIndex + 1} / ${sceneData.length}`;
        
        const isLast = currentSceneIndex === sceneData.length - 1;
        document.getElementById('btnMerge').style.display = isLast ? 'inline-flex' : 'none';
        document.querySelector('.btn-next').style.display = isLast ? 'none' : 'inline-flex';
    }

    function prevScene() {
        saveCurrentSceneBuffer();
        if (currentSceneIndex > 0) loadScene(currentSceneIndex - 1);
    }

    function nextScene() {
        saveCurrentSceneBuffer();
        if (currentSceneIndex < sceneData.length - 1) loadScene(currentSceneIndex + 1);
    }

    function updateSceneCharCount() {
        const text = document.getElementById('sceneEditor').value;
        // ê³µë°± ì œì™¸ ê¸€ì ìˆ˜ (ë„¤ì´ë²„/ë¬¸í”¼ì•„ ê¸°ì¤€)
        const count = text.replace(/\s/g, '').length; 
        document.getElementById('sceneCharCount').innerText = `${count}ì (ê³µë°±ì œì™¸)`;
    }

    // ğŸŒŸ [RAG] í˜„ì¬ ì”¬ì— í•„ìš”í•œ ì„¤ì • ì¶”ì¶œ í•¨ìˆ˜
    function getRelevantContext(sceneText, headerText) {
        // ê²€ìƒ‰ ëŒ€ìƒ í…ìŠ¤íŠ¸ = í—¤ë”(ë“±ì¥ì¸ë¬¼/ì„¸ê³„ê´€ ëª©ë¡) + í˜„ì¬ ì”¬ ì§€ì‹œë¬¸
        const searchText = (headerText || "") + "\n" + (sceneText || "");

        // 1. ì„¸ê³„ê´€ í•„í„°ë§ (í‚¤ì›Œë“œ ë§¤ì¹­)
        let relevantWorld = allWorldSettings.filter(w => {
            // (A) ì œëª© í¬í•¨ ì—¬ë¶€
            if (searchText.includes(w.title)) return true;
            
            // (B) í‚¤ì›Œë“œ(#íƒœê·¸) í¬í•¨ ì—¬ë¶€
            if (w.keywords) {
                const keywords = w.keywords.split(',').map(k => k.trim());
                // í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ 'searchText'ì— ìˆìœ¼ë©´ í¬í•¨
                return keywords.some(k => k && searchText.includes(k));
            }
            return false;
        });

        // ğŸš¨ ì•ˆì „ì¥ì¹˜
        if (relevantWorld.length === 0) {
            relevantWorld = allWorldSettings.slice(0, 3);
        }

        // 2. ìºë¦­í„° í•„í„°ë§
        let relevantChars = allCharacters.filter(c => {
            // ìºë¦­í„° ì´ë¦„ì´ 'searchText' ì „ì²´ ì–´ë””ë“  ìˆìœ¼ë©´ ê°€ì ¸ì˜´
            return searchText.includes(c.name);
        });
        
        if (relevantChars.length === 0) {
            relevantChars = allCharacters.slice(0, 3);
        }

        // 3. í…ìŠ¤íŠ¸ ì¡°í•© (ê²°ê³¼ ë°˜í™˜)
        let context = "";
        if (relevantWorld.length > 0) {
            context += "[ê´€ë ¨ ì„¸ê³„ê´€ ì •ë³´]\n";
            context += relevantWorld.map(w => `ğŸ“Œ ${w.title}: ${w.description}`).join('\n\n');
            context += "\n\n";
        }
        if (relevantChars.length > 0) {
            context += "[ë“±ì¥ì¸ë¬¼ ì •ë³´ (ì´ë²ˆ íšŒì°¨ ê´€ë ¨)]\n"; // ë¬¸êµ¬ ì•½ê°„ ìˆ˜ì •
            context += relevantChars.map(c => `ğŸ‘¤ ${c.name} (${c.role})\n- íŠ¹ì§•: ${c.description}`).join('\n\n');
        }

        return context;
    }

    // 4. AI ìƒì„± (ìµœì í™”ëœ í”„ë¡¬í”„íŠ¸ ì ìš©)
    async function generateSceneWithAI() {
        const scene = sceneData[currentSceneIndex];
        if (!scene) return;

        const btn = document.querySelector('.btn-ai');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‘ì„± ì¤‘...';

        try {
            // RAG ì ìš©
			const optimizedContext = getRelevantContext(scene.instruction, currentTreatmentHeader);
            
			// (2) ğŸŒŸ [í•µì‹¬ ì¶”ê°€] ì§ì „ ì”¬ì˜ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            let previousSceneContent = "";
            if (currentSceneIndex > 0) {
                // ë°”ë¡œ ì• ì”¬ì˜ ë³¸ë¬¸ ë‚´ìš©ì„ ê°€ì ¸ì˜´
                const prevContent = sceneData[currentSceneIndex - 1].content;
                if (prevContent && prevContent.trim().length > 0) {
                    // í† í° ì ˆì•½ì„ ìœ„í•´ ë„ˆë¬´ ê¸¸ë©´ ë§ˆì§€ë§‰ 1000ì ì •ë„ë§Œ ì˜ë¼ì„œ ë³´ë‚¼ ìˆ˜ë„ ìˆìŒ
                    // ì—¬ê¸°ì„œëŠ” ë¬¸ë§¥ ì—°ê²°ì„ ìœ„í•´ ì „ì²´(í˜¹ì€ ë’¤ìª½)ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
                    previousSceneContent = prevContent.slice(-1500); // ë§ˆì§€ë§‰ 1500ìë§Œ ì°¸ì¡° (ì¶©ë¶„í•¨)
                }
            }
			
            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ëŒ€ì‚¬/ì§€ë¬¸ ë¶„ë¦¬, ì™„ê¸‰ ì¡°ì ˆ)
            let systemInstruction = `
    âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
3. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: ì¸ê°„ì ì¸ ê¸€ì“°ê¸° ë‰˜ì•™ìŠ¤ë¥¼ ìµœëŒ€í•œ ì‚´ë ¤ ì‘ì„±í•˜ì‹­ì‹œì˜¤.


ì—­í•  (Role & Context)

    ì—­í•  (Role & Context)

    ë‹¹ì‹ ì€ **'ëª°ì…ê°(Immersion)'ê³¼ 'ì†ë„ê°(Pacing)'ì˜ ê· í˜•ì„ ì•„ëŠ” ì¸ê¸° ì›¹ì†Œì„¤ ì‘ê°€**ì…ë‹ˆë‹¤.
    ë…ìê°€ ì§€ë£¨í•´í•˜ì§€ ì•Šë„ë¡ **ì‚¬ê±´ì„ ì „ê°œ**í•˜ë©´ì„œë„, ê°ì •ì´ì…ì´ í•„ìš”í•œ ìˆœê°„ì—ëŠ” **ë””í…Œì¼í•œ ë¬˜ì‚¬**ë¥¼ í†µí•´ ê¹Šì´ë¥¼ ë”í•´ì•¼ í•©ë‹ˆë‹¤.

    [ì‘ì„± ëª©í‘œ: 'í™©ê¸ˆ ë¹„ìœ¨']
    - **ë„ˆë¬´ ìš”ì•½í•˜ì§€ ë§ˆì‹œì˜¤:** "ì•„ì¹¨ì´ ë°ì•˜ë‹¤" ì²˜ëŸ¼ í‰ì¹˜ì§€ ë§ê³ , ì•„ì¹¨ì˜ ë¶„ìœ„ê¸°ë¥¼ ê°ê°ì ìœ¼ë¡œ ê·¸ë¦¬ì‹­ì‹œì˜¤.
    - **ë„ˆë¬´ ëŠ˜ì–´ì§€ì§€ë„ ë§ˆì‹œì˜¤:** ë¬¸ì„ ì—¬ëŠ” ë™ì‘ í•˜ë‚˜ë¥¼ 10ì¤„ì”© ë¬˜ì‚¬í•˜ì—¬ ë…ìë¥¼ ì§€ì¹˜ê²Œ í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
    - **í•µì‹¬:** ì´ì•¼ê¸°ê°€ **'ì§„í–‰'**ë˜ëŠ” ëŠë‚Œì„ ì£¼ë˜, ë…ìê°€ ìºë¦­í„°ì˜ **'ê°ì •'**ì„ ë†“ì¹˜ì§€ ì•Šë„ë¡ ì ì ˆíˆ ë¬˜ì‚¬í•˜ì‹­ì‹œì˜¤.
	- **ENDING/HOOK**ì´ ì—†ì„ê²½ìš° ë§ˆì§€ë§‰ ë¶€ë¶„ì— ì—¬ìš´ì´ë‚˜ ê¶ê¸ˆì¦ì„ ë‚¨ê¸°ëŠ” ë¬¸ì¥ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”.
    - **ëª©í‘œ ë¶„ëŸ‰: ê³µë°± ì œì™¸ í•œê¸€ 1000ì ì´ìƒ (ë§¤ìš° ì¤‘ìš”)**


    ìƒì„¸ ì‘ì„± ì§€ì¹¨ (Writing Guidelines)

    1. ìƒí™© - "ë¶„ìœ„ê¸°ë¥¼ ì¡°ì„±í•˜ë¼"
       - ëª¨ë“  ì‚¬ë¬¼ì„ ë‹¤ ë¬˜ì‚¬í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. **í˜„ì¬ ì¥ë©´ì˜ ë¶„ìœ„ê¸°ë¥¼ ê²°ì •ì§“ëŠ” ê°€ì¥ í•µì‹¬ì ì¸ ìš”ì†Œ(ì¡°ëª…, ì†Œë¦¬, ëƒ„ìƒˆ ë“±)** 1~2ê°€ì§€ë¥¼ í¬ì°©í•˜ì—¬ ì„íŒ©íŠ¸ ìˆê²Œ ì„œìˆ í•˜ì‹­ì‹œì˜¤.

    2. ì‚¬ê±´ - "ì˜ë¯¸ ìˆëŠ” í–‰ë™ ì„œìˆ "
       - í–‰ë™ì„ ë¬´ì˜ë¯¸í•˜ê²Œ ìª¼ê°œì§€ ë§ê³ , **ìºë¦­í„°ì˜ ì„±ê²©ì´ë‚˜ í˜„ì¬ ì‹¬ë¦¬ê°€ ë“œëŸ¬ë‚˜ëŠ” í–‰ë™** ìœ„ì£¼ë¡œ êµ¬ì²´í™”í•˜ì‹­ì‹œì˜¤.
       - ì˜ˆ: ë‹¨ìˆœíˆ "ë¬¼ì„ ë§ˆì…¨ë‹¤"ê°€ ì•„ë‹ˆë¼, "íƒ€ëŠ” ëª©ë§ˆë¦„ì— ì»µì„ ë‚šì•„ì±„ë“¯ ë“¤ì–´ ë¬¼ì„ ë“¤ì´ì¼°ë‹¤" ì²˜ëŸ¼ í–‰ë™ì˜ 'ë‰˜ì•™ìŠ¤'ë¥¼ ì‚´ë¦¬ì‹­ì‹œì˜¤.

    3. ê°ˆë“± - "ìœ„ê¸°ê°ì˜ êµ¬ì²´í™”"
       - ê°ˆë“±ì˜ ì›ì¸ì„ ëª…í™•íˆ í•˜ê³ , ê·¸ë¡œ ì¸í•´ ìºë¦­í„°ê°€ ëŠë¼ëŠ” ì••ë°•ê°ì„ **'ê°ê°ì '**ìœ¼ë¡œ í‘œí˜„í•˜ì‹­ì‹œì˜¤.
       - ê³ í†µ, ì´ˆì¡°í•¨, ë¶„ë…¸ ë“±ì€ ì¶”ìƒì ì¸ ë‹¨ì–´ë³´ë‹¤ ì‹ ì²´ ë°˜ì‘(ì‹¬ì¥ ë°•ë™, ê±°ì¹œ í˜¸í¡, ì‹ì€ë•€ ë“±)ê³¼ ê²°í•©í•˜ì—¬ ì„œìˆ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

    4. ì‹¬ë¦¬ - "ê³µê° ê°€ëŠ” ë°˜ì‘"
       - ë…ë°±ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì§€ë£¨í•´ì§‘ë‹ˆë‹¤. ì‚¬ê±´ì— ëŒ€í•œ **ì¦‰ê°ì ì´ê³  ì§ê´€ì ì¸ ë°˜ì‘**ì„ ë¨¼ì € ë³´ì—¬ì£¼ê³ , ì§§ê³  êµµì€ ë…ë°±ìœ¼ë¡œ ë‚´ë©´ì„ ì •ë¦¬í•˜ì‹­ì‹œì˜¤.

    5. ëŒ€ì‚¬ - "ìƒë™ê° ìˆëŠ” í‹°í‚¤íƒ€ì¹´"
       - ìºë¦­í„°ì˜ ë§íˆ¬ì™€ ì„±ê²©ì„ ë°˜ì˜í•˜ì—¬ **ì‚´ì•„ìˆëŠ” êµ¬ì–´ì²´**ë¥¼ êµ¬ì‚¬í•˜ì‹­ì‹œì˜¤.
       - ê¸´ ì„¤ëª…ì¡°ì˜ ëŒ€ì‚¬ë¥¼ í”¼í•˜ê³ , ì¸ë¬¼ ê°„ì— ì§§ê³  ë¹ ë¥´ê²Œ ì˜¤ê°€ëŠ” **ë¦¬ë“¬ê°(í‹°í‚¤íƒ€ì¹´)**ì„ ì‚´ë¦¬ì‹­ì‹œì˜¤.
       - ëŒ€ì‚¬ë§Œìœ¼ë¡œë„ ìƒí™©ì˜ ê¸´ë°•í•¨ì´ë‚˜ ì¸ë¬¼ì˜ ê°ì •ì´ ëŠê»´ì§€ë„ë¡ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    
	6. ì—°ì¶œ - "ë¹„ì–¸ì–´ì  ë¬˜ì‚¬ì™€ ë¬´ê²Œê°"
       - ëŒ€ì‚¬ ì‚¬ì´ì‚¬ì´ì— **í‘œì •, ì†ì§“, ì‹œì„  ì²˜ë¦¬** ë“±ì˜ ë¹„ì–¸ì–´ì  í–‰ë™(ì§€ë¬¸)ì„ ì ì ˆíˆ ë°°ì¹˜í•˜ì—¬ ì¥ë©´ì„ ì…ì²´ì ìœ¼ë¡œ ë§Œë“œì‹­ì‹œì˜¤.
       - **ì¤‘ìš”í•œ ëŒ€ì‚¬ ì§ì „**ì—ëŠ” ì •ì ì„ íë¥´ê²Œ í•˜ê±°ë‚˜, ìºë¦­í„°ì˜ ë¯¸ì„¸í•œ í‘œì • ë³€í™”ë¥¼ ë¬˜ì‚¬í•˜ì—¬ **ëŒ€ì‚¬ì— ë¬´ê²Œê°**ì„ ì‹¤ì–´ì£¼ì‹­ì‹œì˜¤.
       - ë§ˆì¹˜ ì¹´ë©”ë¼ê°€ ì¸ë¬¼ì„ í´ë¡œì¦ˆì—…í•˜ê±°ë‚˜ ì¤Œì•„ì›ƒí•˜ëŠ” ë“¯í•œ ì‹œê°ì  ì—°ì¶œì„ ê¸€ì— ë…¹ì—¬ë‚´ì‹­ì‹œì˜¤.

    6. ENDING/HOOK - "ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°"
       - ì–µì§€ë¡œ ëŠì§€ ë§ê³ , í•´ë‹¹ ì¥ë©´ì˜ ì‚¬ê±´ì´ ë§ˆë¬´ë¦¬ë˜ê±°ë‚˜ ë‹¤ìŒ ì¥ë©´ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì§€ì ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë¬¸ë‹¨ì„ ë§ºìœ¼ì‹­ì‹œì˜¤.
       - ë‹¤ë§Œ, ë§ˆì§€ë§‰ ë¬¸ì¥ì€ ë…ìì—ê²Œ ì—¬ìš´ì´ë‚˜ ê¶ê¸ˆì¦ì„ ë‚¨ê¸°ëŠ” ë¬¸ì¥ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.


    í˜•ì‹ ë° ê·œì¹™ (Formatting & Rules)

    1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

	ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

	ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

	ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤. í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

	ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ **í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±**í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

	ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

	3. ë§ˆí¬ì—… ì œê±° :

	 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.


    í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

	AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

	1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
	- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
	- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
	- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
	- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
	- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
	- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
	- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
	- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
	- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

	3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
	- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
	- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
	- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

	4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
	- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
	- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
	- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
	- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

	5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
	- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

	6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
	- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
	- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
	- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
	- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
	- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.
	
ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.

	[í’ˆì§ˆ ì²´í¬]
	- âœ… ë¶„ëŸ‰ ì ì •ì„± (Â±5% ì´ë‚´).
	- âœ… ëª©ì°¨ìƒ ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš© ì ì ˆì„±.
	- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
	- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
	- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).
	- âœ… ì›ê³ ì˜ íƒ€ì´í‹€ ì‘ì„±.

	[âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­]
	1. ë¶„ëŸ‰ ì¤€ìˆ˜ëŠ” Â±5% ì´ë‚´ë¡œ ì—„ê²©íˆ ê´€ë¦¬.
	2. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
	3. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.
	
    [ì°¸ê³  ì„¤ì •]
    ${optimizedContext}	
	`;
	
	let prompt = "";
            
            if (previousSceneContent) {
                prompt += `
    [ì§ì „ ì¥ë©´ ë‚´ìš© (ì´ ë‚´ìš©ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì‘ì„±)]
    ${previousSceneContent}
    --------------------------------------------------
    `;
            }
         prompt = `           
           [í˜„ì¬ ì¥ë©´ ì§€ì‹œë¬¸ (ì‘ì„±í•´ì•¼ í•  ë‚´ìš©)]
            ${scene.instruction}\n\n
	    
	[ìš”ì²­]
    ìœ„ [ì§ì „ ì¥ë©´]ì˜ íë¦„ì„ ì´ì–´ë°›ì•„, [í˜„ì¬ ì¥ë©´ ì§€ì‹œë¬¸]ì˜ ë‚´ìš©ì„ ì†Œì„¤ ë³¸ë¬¸ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.
    ë‚´ìš©ì„ ë°˜ë³µí•˜ì§€ ë§ê³ , ë°”ë¡œ ë‹¤ìŒ ë¬¸ì¥ë¶€í„° ì‹œì‘í•´.
        `;

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gemini-2.5-flash",
                    payload: {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    }
                })
            });
            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text;
            
            document.getElementById('sceneEditor').value = text;
            saveCurrentSceneBuffer();
            updateSceneCharCount();

        } catch(e) { 
            console.error(e);
            alert("AI ìƒì„± ì‹¤íŒ¨: " + e.message); 
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // 5. ì „ì²´ í•©ì¹˜ê¸° ë° ì €ì¥
    async function saveToStory() {
        saveCurrentSceneBuffer();
        if (!confirm("ëª¨ë“  ì¥ë©´ì„ í•©ì³ì„œ 'ì „ì²´ì§‘í•„(Stories)' íƒ­ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        // ì „ì²´ í…ìŠ¤íŠ¸ ë³‘í•©
        let fullContent = "";
        sceneData.forEach(s => {
            // fullContent += `\n\n*** ${s.title} ***\n\n`; // êµ¬ë¶„ì„ ì´ ì‹«ìœ¼ë©´ ì´ ì¤„ ì£¼ì„ ì²˜ë¦¬
            fullContent += s.content + "\n\n";
        });

        // í˜„ì¬ ì—í”¼ì†Œë“œ ì°¾ê¸° (story ID í™•ì¸ìš©)
        const sRes = await fetch(`/api/stories?setting_id=${settingId}`);
        const stories = await sRes.json();
        const currentEp = episodes.find(e => e.id === currentEpId);
        const existingStory = stories.find(s => s.episode_number === currentEp.episode_number);
// ì¥ë©´(Scene) ì„ íƒ í•¨ìˆ˜
    function selectScene(sceneData) {
        currentSceneId = sceneData.id;
        
        // 1. ê¸°ì¡´ ë°ì´í„° í™”ë©´ì— í‘œì‹œ (ì œëª©, ë³¸ë¬¸ ë“±)
        document.getElementById('sceneTitle').value = sceneData.title;
        document.getElementById('mainEditor').value = sceneData.content;
        
        // ... (ê¸°ì¡´ ì„ íƒ ë¡œì§ë“¤) ...

        // ğŸŒŸ [ì¶”ê°€ë¨] ìë™í™” ë¡œì§: ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ AI ìƒì„± ìë™ ì‹œì‘
        const currentContent = sceneData.content || "";
        
        if (currentContent.trim() === "") {
            console.log("ë‚´ìš©ì´ ë¹„ì–´ìˆì–´ AI ì´ˆì•ˆ ìƒì„±ì„ ìë™ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
            
            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë‚˜ ì•Œë¦¼ìœ¼ë¡œ ìë™ ì‹œì‘ë¨ì„ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
            // alert("ë‚´ìš©ì´ ì—†ì–´ AIê°€ ì´ˆì•ˆ ì‘ì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤!"); 
            
            // AI ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (ë²„íŠ¼ í´ë¦­ê³¼ ë™ì¼í•œ ë™ì‘)
            generateSceneAI(); 
        }
    }
	

        let url = '/api/stories';
        let method = 'POST';
        
        // ë°ì´í„° ì¤€ë¹„
        let body = {
            setting_id: settingId,
            episode_number: currentEp.episode_number,
            title: currentEp.title,
            content: fullContent,
            prompt: "Merged from Scenes"
        };

        if (existingStory) {
            url = `/api/stories/${existingStory.id}`;
            method = 'PUT';
            // PUTì€ idê°€ URLì— ìˆìœ¼ë¯€ë¡œ bodyì— id í¬í•¨ ì•ˆ í•´ë„ ë¨ (API êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¦„)
        }

        try {
            const saveRes = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (saveRes.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! 'ì „ì²´ì§‘í•„' íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.");
                //window.location.href = `write.html?setting_id=${settingId}`;
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨");
            }
        } catch(e) { alert("í†µì‹  ì˜¤ë¥˜"); }
    }

    init();
</script>

</body>
</html>