<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì„¸ê³„ê´€ - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --sub-text: #666;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --danger-color: #ff4d4f;
            --ai-color: #2e7d32;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--primary-color); font-weight: bold; }

        /* ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1000px; margin: 30px auto; padding: 20px; }

        /* AI ì„¹ì…˜ */
        .ai-section {
            background: white; border: 1px solid #c8e6c9; border-radius: 12px; padding: 20px;
            margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-header { font-size: 1.1rem; font-weight: bold; color: var(--ai-color); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .ai-desc { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .ai-textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            min-height: 80px; resize: vertical; font-family: inherit; margin-bottom: 10px;
        }
        .ai-textarea:focus { outline: 2px solid var(--ai-color); border-color: transparent; }
        
        .btn-ai-gen {
            width: 100%; background-color: var(--ai-color); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: background 0.2s;
        }
        .btn-ai-gen:hover { background-color: #1b5e20; }
        .btn-ai-gen:disabled { background-color: #a5d6a7; cursor: not-allowed; }

        /* í—¤ë” ë° ë²„íŠ¼ */
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-area h2 { margin: 0; border-left: 5px solid var(--primary-color); padding-left: 10px; }
        .btn-add {
            background-color: var(--primary-color); color: white; border: none; padding: 10px 18px;
            border-radius: 25px; font-size: 0.95rem; cursor: pointer; box-shadow: 0 4px 6px rgba(74, 144, 226, 0.3);
        }

        /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .world-card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee;
            min-height: 180px; display: flex; flex-direction: column; transition: transform 0.2s;
        }
        .world-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; color: #2c3e50; }
        .card-desc { 
            font-size: 0.9rem; color: #555; line-height: 1.5; flex-grow: 1; 
            white-space: pre-wrap; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical;
        }
        .card-actions { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 0.9rem; color: #999; }
        .action-btn:hover { color: var(--primary-color); }
        .action-btn.delete:hover { color: var(--danger-color); }

        /* ê³µí†µ ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-input, .form-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #eee; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

        /* ğŸŒŸ AI ë¯¸ë¦¬ë³´ê¸° ëª©ë¡ ìŠ¤íƒ€ì¼ (ì„ íƒí˜•) */
        .preview-list { display: flex; flex-direction: column; gap: 15px; margin: 15px 0; }
        .preview-item {
            border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fafafa;
            display: flex; gap: 15px; align-items: flex-start;
        }
        .preview-check { margin-top: 5px; transform: scale(1.3); cursor: pointer; }
        .preview-content { flex: 1; }
        .preview-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: #2e7d32; }
        .preview-desc { 
            font-size: 0.95rem; color: #444; line-height: 1.6; 
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
        }

        @media (max-width: 600px) {
            .navbar { flex-direction: column; align-items: stretch; gap: 10px; }
            .container { padding: 15px; margin: 10px auto; }
            .grid-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item active"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item" data-target="plot.html"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
        <a href="#" class="nav-item" data-target="plan.html"><i class="fas fa-magic"></i> ê¸°íš</a>
        <a href="#" class="nav-item" data-target="roadmap.html"><i class="fas fa-magic"></i> ë¡œë“œë§µ</a>
        <a href="#" class="nav-item" data-target="treatment.html"><i class="fas fa-magic"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</a>
    </div>
</nav>

<div class="container">
    
    <div class="ai-section">
        <div class="ai-header">
            <i class="fas fa-robot"></i> AI ê¸°ë°˜ ì„¸ê³„ê´€ êµ¬ì„±
        </div>
        <div class="ai-desc">
            ì„ íƒëœ í”Œë¡¯(íšŒì°¨)ì˜ íë¦„ì„ ë¶„ì„í•˜ì—¬ ì„¸ê³„ê´€ì„ ìƒì„±í•©ë‹ˆë‹¤.<br>
            <small class="text-gray-500">(íŠ¹ì • íšŒì°¨ ë²”ìœ„ì˜ ì‚¬ê±´ì„ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •ì„ ì§­ë‹ˆë‹¤.)</small>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
            <label style="font-weight:bold; color:#555; font-size:0.9rem;">ì°¸ê³  ë²”ìœ„:</label>
            <input type="number" id="startEp" class="form-input" style="width:80px; padding:8px;" placeholder="1" value="1">
            <span style="font-weight:bold;">~</span>
            <input type="number" id="endEp" class="form-input" style="width:80px; padding:8px;" placeholder="50">
            <span style="font-size:0.8rem; color:#888;">í™” (ë¹„ì›Œë‘ë©´ ì „ì²´)</span>
        </div>

        <textarea id="aiPrompt" class="ai-textarea" placeholder="ì•„ë˜ 'ğŸ² ì˜ˆì‹œ ë¬¸êµ¬' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ì²œë°›ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button type="button" onclick="setRandomPrompt()" style="background:#fff; border:1px solid #ddd; padding:10px 15px; border-radius:8px; cursor:pointer; color:#555; font-weight:bold; white-space:nowrap;">
                ğŸ² ì˜ˆì‹œ ë¬¸êµ¬
            </button>
            <button id="btnAiGen" class="btn-ai-gen" onclick="generateAiWorldSettings()" style="flex:1; margin-top:0;">
                <i class="fas fa-magic"></i> AIë¡œ ì„¸ê³„ê´€ êµ¬ì„±í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="header-area">
        <h2>ì„¸ê³„ê´€ ì„¤ì • ëª©ë¡</h2>
        <button class="btn-add" onclick="openModal('add')"><i class="fas fa-plus"></i> í•­ëª© ì¶”ê°€</button>
    </div>

    <div id="worldGrid" class="grid-container">
        <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: #999;">
            <i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...
        </div>
    </div>
</div>

<div id="worldModal" class="modal-overlay">
    <div class="modal">
        <h3 id="modalTitle">ì„¸ê³„ê´€ ì¶”ê°€</h3>
        <input type="hidden" id="editId">
        <div class="form-group">
            <label class="form-label">ì œëª© (í‚¤ì›Œë“œ)</label>
            <input type="text" id="inputTitle" class="form-input" placeholder="ì˜ˆ: ë§ˆë‚˜ ì‹œìŠ¤í…œ">
        </div>
        <div class="form-group">
            <label class="form-label">ìƒì„¸ ë‚´ìš©</label>
            <textarea id="inputDesc" class="form-textarea" placeholder="ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal('worldModal')">ì·¨ì†Œ</button>
            <button class="btn-submit" onclick="saveWorldSetting()">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="aiPreviewModal" class="modal-overlay">
    <div class="modal" style="max-width: 700px;">
        <h3><i class="fas fa-check-double"></i> ìƒì„±ëœ ì„¤ì • í™•ì¸</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
            ì €ì¥í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ê°ê° ë³„ë„ì˜ ì¹´ë“œë¡œ ì €ì¥ë©ë‹ˆë‹¤.)
        </p>
        
        <div id="aiResultList" class="preview-list">
            </div>

        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal('aiPreviewModal')">ì·¨ì†Œ</button>
            <button class="btn-submit" onclick="saveBulkWorldSettings()">ì„ íƒ í•­ëª© ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');
    
    let worldList = []; 
    let aiGeneratedData = []; // AI ê²°ê³¼ ì €ì¥ìš©

    const worldPrompts = [
        "ì´ ì†Œì„¤ì˜ ë¶„ìœ„ê¸°ì— ë§ëŠ” ë…ì°½ì ì¸ ì§€ë¦¬ì  íŠ¹ì„±ê³¼ ê¸°í›„, ì£¼ìš” ì‚°ì—… 3ê°€ì§€ë¥¼ ì„¤ì •í•´ì¤˜.",
        "ì´ ì„¸ê³„ì˜ ì‹ ë¶„ ì œë„ì™€ ì‚¬íšŒì  ê³„ê¸‰ êµ¬ì¡°, ê·¸ë¦¬ê³  ê³„ê¸‰ ê°„ì˜ ê°ˆë“± ìš”ì†Œë¥¼ ë§Œë“¤ì–´ì¤˜.",
        "ëŠ¥ë ¥ì— ë”°ë¥¸ 'ëŒ€ê°€'ë‚˜ 'íŒ¨ë„í‹°'ê°€ ì¡´ì¬í•˜ëŠ” ë…íŠ¹í•œ ëŠ¥ë ¥ì„ êµ¬ì²´ì ìœ¼ë¡œ ë§Œë“¤ì–´ì¤˜.",
        "ê²Œì´íŠ¸ê°€ ë°œìƒí•œ ì´í›„ ë°”ë€ í˜„ëŒ€ ì‚¬íšŒì˜ ë²•ë¥ ê³¼ í—Œí„°ë“¤ì˜ ë“±ê¸‰ ì²´ê³„ë¥¼ ì„¤ì •í•´ì¤˜.",
    ];

    function init() {
        if (!settingId) {
            alert("í”„ë¡œì íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        loadWorldSettings();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    function setRandomPrompt() {
        const randomIndex = Math.floor(Math.random() * worldPrompts.length);
        document.getElementById('aiPrompt').value = worldPrompts[randomIndex];
    }

    // --- ê¸°ë³¸ CRUD ---
    async function loadWorldSettings() {
        const grid = document.getElementById('worldGrid');
        try {
            const res = await fetch(`/api/worldsettings?setting_id=${settingId}`);
            worldList = await res.json();
            
            grid.innerHTML = '';
            if (worldList.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#aaa;">ë“±ë¡ëœ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            worldList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'world-card';
                card.onclick = (e) => { if(!e.target.closest('.action-btn')) openModal('edit', item.id); };

                card.innerHTML = `
                    <div class="card-title">${item.title}</div>
                    <div class="card-desc">${item.description || ''}</div>
                    <div class="card-actions">
                        <button class="action-btn delete" onclick="deleteWorldSetting(event, ${item.id})"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (e) { console.error(e); }
    }

    // --- ğŸŒŸ AI ìƒì„± ë¡œì§ (JSON ë°°ì—´ ìš”ì²­) ---
    async function generateAiWorldSettings() {
		const prompt = document.getElementById('aiPrompt').value.trim();
        const startEpInput = document.getElementById('startEp').value;
        const endEpInput = document.getElementById('endEp').value;
		
        if (!prompt) return alert("ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.getElementById('btnAiGen');
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...';

        try {
            // 1. ë°ì´í„° ë³‘ë ¬ ë¡œë“œ (ê¸°ë³¸ ì„¤ì • + ì—í”¼ì†Œë“œ ëª©ë¡)
            const [sRes, eRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`),
                fetch(`/api/episodes?setting_id=${settingId}`) // ì—í”¼ì†Œë“œ API í˜¸ì¶œ
            ]);

            const settings = await sRes.json();
            const allEpisodes = await eRes.json();
            
            // ê¸°ì¡´ ì„¸ê³„ê´€ ì œëª©ë“¤ (ì¤‘ë³µ ë°©ì§€ìš©)
            const existTitles = worldList.map(w => w.title).join(', ');

            // 2. ì—í”¼ì†Œë“œ í•„í„°ë§ ë° ìš”ì•½ ìƒì„±
            // ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ ì „ì²´ ë²”ìœ„ë¡œ ê°„ì£¼
            const startEp = startEpInput ? parseInt(startEpInput) : 1;
            const endEp = endEpInput ? parseInt(endEpInput) : 9999;

            // í•´ë‹¹ ë²”ìœ„ì˜ ì—í”¼ì†Œë“œë§Œ ê³¨ë¼ë‚´ê¸°
            const targetEpisodes = allEpisodes.filter(ep => 
                ep.episode_number >= startEp && ep.episode_number <= endEp
            );

            // AIì—ê²Œ ë³´ë‚¼ ì¤„ê±°ë¦¬ í…ìŠ¤íŠ¸ ë§Œë“¤ê¸° (í† í° ì ˆì•½ì„ ìœ„í•´ ê° íšŒì°¨ë‹¹ 300ì ë‚´ì™¸ë¡œ ìë¦„)
            let episodeSummary = "";
            if (targetEpisodes.length > 0) {
                episodeSummary = targetEpisodes.map(ep => {
                    const contentSnippet = ep.content ? ep.content.substring(0, 300).replace(/\n/g, ' ') : "ë‚´ìš© ì—†ìŒ";
                    return `- [${ep.episode_number}í™”: ${ep.title}] ${contentSnippet}...`;
                }).join('\n');
            } else {
                episodeSummary = "ì„ íƒëœ ë²”ìœ„ì— ì‘ì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤. (ì „ì²´ ì„¤ì • ì°¸ì¡°)";
            }

            // í”„ë¡¬í”„íŠ¸: JSON Array ìš”ì²­
            const fullPrompt = `
                [ì—­í• ] ì›¹ì†Œì„¤ ì„¸ê³„ê´€ ì„¤ì • ì‘ê°€
                [ì‘í’ˆ ì œëª©] ${settings.title}
				[í˜„ì¬ ì§„í–‰ëœ ì´ì•¼ê¸° íë¦„ (${startEp}í™” ~ ${endEp}í™”)]
                ${episodeSummary}
				
				[ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„¸ê³„ê´€ ì„¤ì •] ${existTitles}
				
                [ìš”ì²­ ì‚¬í•­]
                ${prompt}

                [ì¶œë ¥ ì¡°ê±´]
                1. ìœ„ ìš”ì²­ì— ë§ì¶° ì„¸ê³„ê´€ ì„¤ì •ì„ **3ê°€ì§€ì—ì„œ 5ê°€ì§€** ìƒì„±í•˜ì„¸ìš”.
                2. ê° í•­ëª©ì€ ì œëª©(Title)ê³¼ ìƒì„¸ ë‚´ìš©(Description)ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.
                3. ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì€ **JSON ë°°ì—´ í˜•ì‹(Array)**ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”. 
                4. **ì¤‘ìš”: description ì•ˆì—ëŠ” ì¤„ë°”ê¿ˆ(\\n)ê³¼ ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-, *)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± ìˆê²Œ ì‘ì„±í•˜ì„¸ìš”.**

                [JSON ì˜ˆì‹œ]
                [
                    { 
                        "title": "1. ëŒ€ë¶•ê´´ (2015ë…„)", 
                        "description": "- 2015ë…„ 7ì›”: ì „ ì„¸ê³„ ë™ì‹œë‹¤ë°œì  ê· ì—´ ë°œìƒ\\n- ì„œìš¸, ë‰´ìš• ë“± ì£¼ìš” ë„ì‹œ í”¼í•´\\n- ì¸ë¥˜ ë©¸ë§ ìœ„ê¸° ì§ë©´" 
                    },
                    { 
                        "title": "2. ê°ì„±ì˜ ì‹œì‘", 
                        "description": "- ëŒ€ë¶•ê´´ 2ì£¼ í›„ ì²« ê°ì„±ì ì¶œí˜„\\n- ì´ˆê¸°ì—ëŠ” ì „íˆ¬í˜• ëŠ¥ë ¥ìë§Œ ëŒ€ìš°ë°›ìŒ" 
                    }
                ]
            `;
			
			console.log(fullPrompt);
            const aiRes = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gemini-2.5-flash",
                    payload: { contents: [{ parts: [{ text: fullPrompt }] }] }
                })
            });
            const aiData = await aiRes.json();
            
            let text = aiData.candidates[0].content.parts[0].text;
            // JSON í¬ë§·íŒ… (ë§ˆí¬ë‹¤ìš´ ì œê±°)
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
            
            aiGeneratedData = JSON.parse(text);

            if (!Array.isArray(aiGeneratedData) || aiGeneratedData.length === 0) {
                throw new Error("ë°ì´í„° ìƒì„± ì‹¤íŒ¨");
            }

            // ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
            openAiPreviewModal();

        } catch (e) {
            console.error(e);
            alert("ìƒì„± ì‹¤íŒ¨: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }

    // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (ì²´í¬ë°•ìŠ¤)
    function openAiPreviewModal() {
        const listContainer = document.getElementById('aiResultList');
        listContainer.innerHTML = '';

        aiGeneratedData.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                <input type="checkbox" class="preview-check" id="world_chk_${idx}" checked>
                <div class="preview-content">
                    <div class="preview-title">${item.title}</div>
                    <div class="preview-desc">${item.description}</div>
                </div>
            `;
            listContainer.appendChild(div);
        });

        document.getElementById('aiPreviewModal').style.display = 'flex';
    }

    // ì„ íƒ í•­ëª© ëŒ€ëŸ‰ ì €ì¥
    async function saveBulkWorldSettings() {
        const selectedItems = [];
        aiGeneratedData.forEach((item, idx) => {
            const chk = document.getElementById(`world_chk_${idx}`);
            if (chk && chk.checked) selectedItems.push(item);
        });

        if (selectedItems.length === 0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

        try {
            // ë³‘ë ¬ ì €ì¥
            const promises = selectedItems.map(item => {
                return fetch('/api/worldsettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        setting_id: settingId,
                        title: item.title,
                        description: item.description
                    })
                });
            });

            await Promise.all(promises);

            alert(`${selectedItems.length}ê°œì˜ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeModal('aiPreviewModal');
            loadWorldSettings();
            document.getElementById('aiPrompt').value = '';

        } catch (e) {
            console.error(e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // --- ìˆ˜ë™ ëª¨ë‹¬ ê´€ë ¨ ---
    function openModal(mode, id = null) {
        const modal = document.getElementById('worldModal');
        document.getElementById('editId').value = id || '';
        document.getElementById('inputTitle').value = '';
        document.getElementById('inputDesc').value = '';

        if (mode === 'edit') {
            const item = worldList.find(w => w.id === id);
            if (item) {
                document.getElementById('inputTitle').value = item.title;
                document.getElementById('inputDesc').value = item.description;
            }
        }
        modal.style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    async function saveWorldSetting() {
        const id = document.getElementById('editId').value;
        const title = document.getElementById('inputTitle').value;
        if(!title) return alert("ì œëª© í•„ìˆ˜");

        const url = id ? `/api/worldsettings/${id}` : '/api/worldsettings';
        const method = id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    setting_id: settingId,
                    title: title,
                    description: document.getElementById('inputDesc').value
                })
            });
            if (res.ok) {
                closeModal('worldModal');
                loadWorldSettings();
            }
        } catch(e) { alert("ì˜¤ë¥˜"); }
    }

    async function deleteWorldSetting(e, id) {
        e.stopPropagation();
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/worldsettings/${id}`, { method: 'DELETE' });
        loadWorldSettings();
    }

    init();
</script>

</body>
</html>