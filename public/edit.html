<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¸ì§‘ ë° ê´€ë¦¬ - AI Novel Studio</title>
	<script src="auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... ê¸°ì¡´ CSS ìœ ì§€ ... */
        :root {
            --primary-color: #4a90e2;
            --edit-color: #8e44ad;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
            --danger-color: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ... ë„¤ë¹„ê²Œì´ì…˜ ë° ë ˆì´ì•„ì›ƒ CSS ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼) ... */
        .navbar { background-color: var(--nav-bg); color: var(--nav-text); padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 1001; }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item { color: #bdc3c7; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--edit-color); font-weight: bold; }
        .workspace-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar { width: 260px; background: #fff; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 1000; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--edit-color); background: #fdfbff; display: flex; justify-content: space-between; align-items: center; }
        .btn-close-sidebar { display: none; background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666; }
        .story-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; padding-bottom: 50px; }
        .story-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .story-item:hover { background: #f8f9fa; }
        .story-item.active { background: #f3e5f5; border-left: 4px solid var(--edit-color); font-weight: bold; }
        .story-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .sidebar-backdrop { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
        .main-area { flex: 1; display: flex; flex-direction: column; background: #f8f9fa; position: relative; width: 100%; }
        .top-tabs { display: flex; background: white; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .top-tab-btn { flex: 1; padding: 12px; border: none; background: none; font-size: 0.95rem; cursor: pointer; color: #777; border-bottom: 3px solid transparent; white-space: nowrap; }
        .top-tab-btn.active { color: var(--edit-color); border-bottom-color: var(--edit-color); font-weight: bold; }
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        .editor-container { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 15px; overflow-y: auto; padding-bottom: 80px; }
        .edit-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
        .btn-mobile-menu { display: none; background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: #555; }
        .story-title { font-size: 1.1rem; font-weight: bold; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* í…ìŠ¤íŠ¸ ì—ë””í„° ìŠ¤íƒ€ì¼ */
        .text-editor { flex: 1; width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; line-height: 1.8; resize: none; background: white; font-family: 'Pretendard', sans-serif; min-height: 200px; }
        .text-editor:focus { outline: 2px solid var(--edit-color); border-color: transparent; }
        
        /* AI íŒ¨ë„ ìŠ¤íƒ€ì¼ ìˆ˜ì •ë¨ */
        .ai-revision-panel { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e1bee7; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .panel-row { display: flex; flex-direction: column; gap: 5px; }
        .panel-label { color: var(--edit-color); font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .panel-label button { font-size: 0.8rem; padding: 2px 8px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; color: #555; }
        .panel-label button:hover { background: #f0f0f0; color: var(--edit-color); }
        
        .ai-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Pretendard', sans-serif; resize: vertical; }
        .ai-input:focus { border-color: var(--edit-color); outline: none; }
        
        .btn-ai-action { background: var(--edit-color); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; align-self: flex-end; width: 100%; }
        .btn-save { background: #2c3e50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }

        /* ... ê´€ë¦¬ íƒ­ ë° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ìœ ì§€ ... */
        .manage-container { padding: 20px; width: 100%; overflow-y: auto; padding-bottom: 80px; }
        .manage-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .manage-card h3 { margin-top: 0; color: #444; font-size: 1.1rem; }
        .export-btn { display: inline-flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; width: 100%; margin-bottom: 10px; justify-content: center; font-weight: bold; color: #555; }
        .export-btn:hover { background: #f0f7ff; color: var(--edit-color); border-color: var(--edit-color); }
        .btn-delete-project { background: white; color: var(--danger-color); border: 1px solid var(--danger-color); padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: white; width: 90%; max-width: 800px; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .diff-container { display: flex; gap: 10px; margin: 15px 0; flex: 1; overflow: hidden; min-height: 200px; }
        .diff-box { flex: 1; padding: 10px; border-radius: 6px; overflow-y: auto; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6; border: 1px solid #ddd; }
        .old-ver { background: #ffeef0; border-color: #ffccd0; }
        .new-ver { background: #e8f5e9; border-color: #c8e6c9; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; flex-shrink: 0; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            .sidebar.active { transform: translateX(0); }
            .btn-close-sidebar { display: block; }
            .btn-mobile-menu { display: block; }
            .sidebar-backdrop.active { display: block; }
            .diff-container { flex-direction: column; }
            .diff-box { max-height: 200px; }
            .text-editor { min-height: 150px; }
            .ai-revision-panel { margin-bottom: 40px; }
        }
    </style>
</head>
<body>


<script src="include.js"></script>
<div data-include="nav.html"></div>

<div class="workspace-container">
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span><i class="fas fa-list"></i> íšŒì°¨ ëª©ë¡</span>
            <button class="btn-close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <ul id="storyList" class="story-list">
            <li style="padding:15px; text-align:center;">ë¡œë”© ì¤‘...</li>
        </ul>
    </aside>

    <main class="main-area">
        <div class="top-tabs">
            <button class="top-tab-btn active" onclick="switchTab('edit')"><i class="fas fa-pen-nib"></i> AI ìœ¤ë¬¸</button>
            <button class="top-tab-btn" onclick="switchTab('manage')"><i class="fas fa-tasks"></i> ê´€ë¦¬/ë‚´ë³´ë‚´ê¸°</button>
        </div>

        <div id="tab-edit" class="tab-content active">
            <div class="editor-container">
                <div class="edit-header">
                    <div class="header-left">
                        <button class="btn-mobile-menu" onclick="toggleSidebar()"><i class="fas fa-bars"></i> ëª©ë¡</button>
                        <span id="currentTitle" class="story-title">íšŒì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                    </div>
                    <button class="btn-save" onclick="saveStory()"><i class="fas fa-save"></i> ì €ì¥</button>
                </div>

                <textarea id="mainEditor" class="text-editor" placeholder="ëª©ë¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”."></textarea>

                <div class="ai-revision-panel">
                    
                    <div class="panel-row">
                        <div class="panel-label">
                            <span><i class="fas fa-quote-right"></i> ìˆ˜ì •í•  ë³¸ë¬¸ (Target Text)</span>
                            <button onclick="getSelectionFromEditor()" title="ë©”ì¸ ì—ë””í„°ì—ì„œ ì„ íƒí•œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°"><i class="fas fa-arrow-down"></i> ì„ íƒ ê°€ì ¸ì˜¤ê¸°</button>
                        </div>
                        <textarea id="targetEditor" class="ai-input" style="height: 80px;" placeholder="ìˆ˜ì •í•˜ê³  ì‹¶ì€ ë¶€ë¶„ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ë¹„ì›Œë‘ë©´ ë©”ì¸ ì—ë””í„° ì „ì²´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤)"></textarea>
                    </div>

                    <div class="panel-row">
                        <div class="panel-label"><i class="fas fa-robot"></i> AI ìˆ˜ì • ì§€ì‹œ (Prompt)</div>
                        <input type="text" id="aiPrompt" class="ai-input" placeholder="ì˜ˆ: ì´ ë¶€ë¶„ì„ ë” ê°ì„±ì ìœ¼ë¡œ ë¬˜ì‚¬í•´ì¤˜, ëŒ€í™”ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë°”ê¿”ì¤˜">
                    </div>
                    
                    <button class="btn-ai-action" onclick="requestAiRevision()"><i class="fas fa-magic"></i> AI ìˆ˜ì • ì‹¤í–‰</button>
                </div>
            </div>
        </div>

        <div id="tab-manage" class="tab-content">
            <div class="manage-container">
                <div class="manage-card">
                    <h3><i class="fas fa-book"></i> ì„¤ì • ìë£Œ ë‚´ë³´ë‚´ê¸°</h3>
                    <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">ë¡œê·¸ë¼ì¸, ì„¸ê³„ê´€, ë“±ì¥ì¸ë¬¼ ì„¤ì •ì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                    <button class="export-btn" onclick="downloadSettingsTxt()"><i class="fas fa-file-alt"></i> ì„¤ì •ì§‘ ë‹¤ìš´ë¡œë“œ (.txt)</button>
                </div>
                <div class="manage-card">
                    <h3><i class="fas fa-file-export"></i> ë³¸ë¬¸ í…ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸°</h3>
                    <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">ì‘ì„±ëœ ëª¨ë“  íšŒì°¨ë¥¼ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ í•©ì¹©ë‹ˆë‹¤.</p>
                    <button class="export-btn" onclick="downloadTextFile()"><i class="fas fa-file-alt"></i> ì „ì²´ ë³¸ë¬¸ ë‹¤ìš´ë¡œë“œ (.txt)</button>
                    <button class="export-btn" onclick="copyToClipboard()"><i class="fas fa-copy"></i> í´ë¦½ë³´ë“œ ë³µì‚¬</button>
                </div>
                <div class="manage-card">
                    <h3><i class="fas fa-database"></i> ë°ì´í„° ë°±ì—…</h3>
                    <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p>
                    <button class="export-btn" onclick="downloadBackup()"><i class="fas fa-download"></i> ì „ì²´ ë°±ì—… (.json)</button>
                </div>
                <div class="manage-card" style="border-color:#ffcccc; background:#fff5f5;">
                    <h3 style="color:var(--danger-color);"><i class="fas fa-trash"></i> í”„ë¡œì íŠ¸ ì‚­ì œ</h3>
                    <button class="btn-delete-project" onclick="deleteProject()">ì˜êµ¬ ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="diffModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-check-circle"></i> AI ìˆ˜ì • í™•ì¸</h3>
        <p style="font-size:0.9rem; color:#666; margin-top:-10px; margin-bottom:10px;">
            <span id="diffModeBadge" style="background:#eee; padding:2px 6px; border-radius:4px; font-weight:bold;">ì „ì²´ ìˆ˜ì •</span> ëª¨ë“œì…ë‹ˆë‹¤.
        </p>
        <div class="diff-container">
            <div class="diff-box old-ver" id="oldTextContent"></div>
            <div class="diff-box new-ver" id="newTextContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-mobile-menu" onclick="closeDiffModal()" style="display:inline-block; border:1px solid #ddd;">ì·¨ì†Œ</button>
            <button class="btn-ai-action" onclick="applyAiResult()">ì ìš©í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // ê¸°ì¡´ ë³€ìˆ˜ë“¤
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');
   
    let currentStoryId = null;
    let globalStories = [];
    let contextData = ""; 
    let projectTitle = "Project";
	
    // ğŸŒŸ ìˆ˜ì •ì— ì‚¬ìš©ëœ ëª¨ë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜ (partial ë˜ëŠ” full)
    let lastEditMode = "full"; 
    let lastTargetOriginal = ""; // ë¶€ë¶„ ìˆ˜ì • ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥

    // ê¸°ì¡´ ì‹œìŠ¤í…œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ (ë‚´ìš©ì´ ê¸¸ì–´ì„œ ìƒëµëœ ë¶€ë¶„ì€ ìœ„ íŒŒì¼ ë‚´ìš©ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
	let systemInstruction = `âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

	ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

	1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	3. ì‘ì—…íë¦„ì€ ì²¨ë¶€í•œ 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì— ìˆëŠ” í•´ë‹¹ ì‘ì—…ì˜ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

	4. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì˜ "## í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)"ì„ ë°˜ì˜í•©ë‹ˆë‹¤.


	ì—­í•  (Context)

	ë‹¹ì‹ ì€ í•œêµ­ì˜ ì¸ê¸° ìˆëŠ” ì›¹ì†Œì„¤ ì‘ê°€ì…ë‹ˆë‹¤. ë…ìì˜ ëª°ì…ì„ ì´ëŒì–´ë‚´ëŠ” í•„ë ¥, ìƒë™ê° ë„˜ì¹˜ëŠ” ìºë¦­í„° ë¬˜ì‚¬, ê·¸ë¦¬ê³  'ê³ êµ¬ë§ˆ'ì™€ 'ì‚¬ì´ë‹¤'ë¥¼ ì ì ˆíˆ ì¡°ì ˆí•˜ëŠ” ëŠ¥ë ¥ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ ì¸ë¬¼ ê°„ì˜ ì¼€ë¯¸ìŠ¤íŠ¸ë¦¬(í‹°í‚¤íƒ€ì¹´)ì™€ ì¥ë¥´ë¬¼ì˜ í´ë¦¬ì…°ë¥¼ ë¹„íŠ¸ëŠ” ìœ ë¨¸ ì½”ë“œ, ê·¸ë¦¬ê³  ì£¼ì¸ê³µì˜ ë‚´ë©´ ì‹¬ë¦¬ë¥¼ ì„¬ì„¸í•˜ê²Œ ë¬˜ì‚¬í•˜ëŠ” ë° íƒì›”í•©ë‹ˆë‹¤.


	ì „ì²´ ê¸€ì—ëŒ€í•œ ë°°ê²½ ë° ì„¤ì • (Context)

	- ì§‘í•„ ëª©í‘œ: (ì‚¬ìš©ìì˜ ì„¤ì •ë“¤ ë˜ëŠ” ê°„ë‹¨í•œ ì¤„ê±°ë¦¬ ìŠ¤í† ë¦¬ ë“±ë“± ë°°ê²½ê³¼ ì“°ê³ ì í•˜ëŠ” ê¸€ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„)

	- íƒ€ê²Ÿ ë…ì:

	- í•µì‹¬ ë©”ì‹œì§€: (ì£¼ì œ? ë˜ëŠ” ëª©í‘œ?)

	- ë…ì°½ì  ê´€ì :  (ë…ì°½ì ì¸ ì„¤ì • ë˜ëŠ” ì„¸ê³„ê´€?)

	- í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:  (ì–´ë–¤ ë¬¸í™”? ê´€ìŠµ? ë“±ë“± ìœ„ ë¶„ë¦¬ëœ í•­ëª©ì„ í†µí•©ìœ¼ë¡œ í•´ë„ ë¨.)

	- ë¶„ëŸ‰: í•œê¸€ ê¸€ìë¡œ 6000ì ì´ìƒ(ê³µë°± ë¯¸í¬í•¨).
				  A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).

	- ë¬¸ë‹¨ í˜•ì‹: Aíƒ€ì… ì„œì‹: ì›¹ì†Œì„¤ ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.



	1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

	ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

	ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

	ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤. í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

	ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

	ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

	3. ë§ˆí¬ì—… ì œê±° :

	 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

	ê¸€ì“°ê¸° ì§€ì‹œì‚¬í•­ (Style & Action)

	ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

	
	- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
	- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.
	- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©, ê°ˆë“±ê³¼ í•´ê²°ì˜ ê·¹ì  êµ¬ì„±.
	- íŠ¹ìˆ˜ í˜•ì‹: ì‹œì²­ì(ë…ì) ê´€ë ¨ ì„œìˆ ì€ ì±„íŒ…ì°½ í˜•ì‹ìœ¼ë¡œ ìµœëŒ€í•œ ì±„íŒ…ì˜ ì¬ë¯¸ë¡œ ì„œìˆ .


	ì‘ì—… íë¦„ (Action)

	ì…ë ¥ ì¡°ê±´ë³„ ì²˜ë¦¬

	1. "ì‹œì‘" ì…ë ¥ ì‹œ

	- ì‚¬ìš©ìê°€ ì…ë ¥í•œ 1íšŒë¶„ëŸ‰ í”Œë¡¯ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìœ„ ê·œì¹™ëŒ€ë¡œ ì›ê³ ë¥¼ ì‘ì„±.


	ì¶œë ¥ í˜•ì‹ (Result)

	- ì–¸ì–´: í•œêµ­ì–´

	- í˜•ì‹: ìš”ì²­ëœ í˜ì´ì§€ ìˆ˜ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„±ëœ ì›ê³ ë¥¼ ê¼­!! ë§ˆí¬ë‹¤ìš´ íƒìŠ¤íŠ¸ ë¬¸ì„œë¡œ ì œê³µ.

	- íƒ€ì´í‹€: ì›ê³ ì˜ ì œëª© ì‘ì„±
	
	- ë¶„ëŸ‰: í•œê¸€ ê¸€ìë¡œ 6000ì ì´ìƒ(ê³µë°± ë¯¸í¬í•¨).
				  A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).



	í’ˆì§ˆ ê¸°ì¤€

	- ë²„ì¶”ì–¼ ìœ íŠœë²„ì™€ ì›¹ì†Œì„¤ì„ ì¦ê¸°ëŠ” ë…ìê°€ ì‰½ê²Œ ì´í•´í•˜ê³  ëª°ì…í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€.

	- ì›¹ì†Œì„¤ì˜ ê³ ìœ í•œ íŠ¹ì„±ê³¼ ë§¤ë ¥ êµ¬í˜„.

	- AI ê²€ì¶œê¸°ë¥¼ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì“°ê¸°.

	- ëª¨ë“  AI ê²€ì¶œ íšŒí”¼ ì›ì¹™ì˜ ì² ì €í•œ ì ìš©.


	ì‘ì—… íë¦„ ê°€ì´ë“œ

	ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”Œë¡¯ì„ ê¸°ë³¸ìœ¼ë¡œ 1íšŒë¶„ ê¸€ì“°ê¸°ì— ëŒ€í•œ ìƒì„¸ ì ˆì°¨ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.


	ì²« ì¶œë ¥  : ì´ì œ ë³¸ë¬¸ ì‘ì„±ì„ ì‹œì‘ í•˜ê² ìŠµë‹ˆë‹¤.


	í™•ì •ëœ ê°œìš”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ì²­ ë¶„ëŸ‰ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„± ì›ê³ ë¥¼ ì‘ì„±.


	ì‘ì„± ê²°ê³¼:
	- ì´ ë¶„ëŸ‰: [ì‹¤ì œ ì‘ì„±ëœ í•œê¸€ ê¸€ì ìˆ˜].
	- ì˜ˆìƒ í˜ì´ì§€: ì•½ [í˜ì´ì§€ ìˆ˜]í˜ì´ì§€.

	í’ˆì§ˆ ì²´í¬:
	- âœ… ë¶„ëŸ‰ ì ì •ì„± (Â±5% ì´ë‚´).
	- âœ… ëª©ì°¨ìƒ ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš© ì ì ˆì„±.
	- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
	- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
	- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).
	- âœ… ì›ê³ ì˜ íƒ€ì´í‹€ ì‘ì„±.

	âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­

	1. ë¶„ëŸ‰ ì¤€ìˆ˜ëŠ” Â±5% ì´ë‚´ë¡œ ì—„ê²©íˆ ê´€ë¦¬.
	2. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
	3. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.




	í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

	AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

	1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
	- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
	- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
	- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
	- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
	- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
	- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
	- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
	- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
	- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

	3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
	- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
	- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
	- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

	4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
	- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
	- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
	- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
	- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

	5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
	- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

	6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
	- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
	- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
	- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
	- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
	- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.`;

    // --- ì´ˆê¸°í™” ë° UI í•¨ìˆ˜ë“¤ ---
    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData();
        await loadStoryList();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.querySelector('.sidebar-backdrop');
        sidebar.classList.toggle('active');
        backdrop.classList.toggle('active');
    }

    function switchTab(tabName) {
        document.querySelectorAll('.top-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        const targetBtn = Array.from(document.querySelectorAll('.top-tab-btn')).find(b => b.onclick.toString().includes(tabName));
        if(targetBtn) targetBtn.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    async function loadContextData() {
        try {
            const [sRes, wRes, cRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`),
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            const settings = await sRes.json();
            const world = await wRes.json();
            const chars = await cRes.json();
			
			const worldText = world.map(s => `=== ${s.title} ===\n${s.description || 'ë‚´ìš© ì—†ìŒ'}`).join('\n\n---\n\n');
		    const charsText = chars.map(c => `=== ${c.name} (ì—­í• : ${c.role || 'ë¯¸ì§€ì •'}) ===\n${c.description || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}`).join('\n\n---\n\n');
			
			projectTitle = settings.title || "Project";

            contextData = `
            [ì‘í’ˆ ì œëª©]: ${projectTitle}
            [ì„¸ê³„ê´€]: ${worldText}
            [ë“±ì¥ì¸ë¬¼]: ${charsText}
            `;
        } catch (e) {
            console.warn("Context load failed", e);
        }
    }

    async function loadStoryList() {
        const listEl = document.getElementById('storyList');
        try {
            const res = await fetch(`/api/stories?setting_id=${settingId}`);
            if(!res.ok) throw new Error("Load failed");
            
            globalStories = await res.json();
            globalStories.sort((a,b) => a.episode_number - b.episode_number);

            listEl.innerHTML = '';
            if(globalStories.length === 0) {
                listEl.innerHTML = '<li style="padding:20px; text-align:center; color:#999;">ì‘ì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì§‘í•„ íƒ­ì—ì„œ ë¨¼ì € ê¸€ì„ ì¨ì£¼ì„¸ìš”.</li>';
                return;
            }

            globalStories.forEach(story => {
                const li = document.createElement('li');
                li.className = `story-item ${story.id === currentStoryId ? 'active' : ''}`;
                li.innerHTML = `
                    <div style="font-weight:bold;">${story.title}</div>
                    <div class="story-meta">${story.episode_number}í™” Â· ${story.content.length}ì</div>
                `;
                li.onclick = () => selectStory(story);
                listEl.appendChild(li);
            });

            if (!currentStoryId && globalStories.length > 0) {
                selectStory(globalStories[0]);
            }

        } catch(e) { console.error(e); }
    }

    function selectStory(story) {
        currentStoryId = story.id;
        document.getElementById('currentTitle').innerText = story.title;
        document.getElementById('mainEditor').value = story.content;
        
        // ëŒ€ìƒ ë³¸ë¬¸ ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('targetEditor').value = "";

        const listEl = document.getElementById('storyList');
        Array.from(listEl.children).forEach(li => li.classList.remove('active'));
        const idx = globalStories.findIndex(s => s.id === story.id);
        if(listEl.children[idx]) listEl.children[idx].classList.add('active');
    }

    // ğŸŒŸ [ì¶”ê°€ë¨] ë©”ì¸ ì—ë””í„°ì—ì„œ ì„ íƒ(ë“œë˜ê·¸)í•œ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    function getSelectionFromEditor() {
        const mainEditor = document.getElementById('mainEditor');
        const start = mainEditor.selectionStart;
        const end = mainEditor.selectionEnd;
        
        if (start === end) {
            alert("ë©”ì¸ ì—ë””í„°ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
            return;
        }

        const selectedText = mainEditor.value.substring(start, end);
        document.getElementById('targetEditor').value = selectedText;
    }

    // ğŸŒŸ [ìˆ˜ì •ë¨] AI ìˆ˜ì • ìš”ì²­ (ë¶€ë¶„/ì „ì²´ ë¡œì§ ë¶„ê¸°)
    async function requestAiRevision() {
        const mainContent = document.getElementById('mainEditor').value;
        const targetContent = document.getElementById('targetEditor').value.trim(); // ëŒ€ìƒ ë³¸ë¬¸
        const prompt = document.getElementById('aiPrompt').value;

        if (!currentStoryId) return alert("íšŒì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        if (!mainContent.trim()) return alert("ë³¸ë¬¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        if (!prompt.trim()) return alert("ìˆ˜ì • ì§€ì‹œì‚¬í•­(í”„ë¡¬í”„íŠ¸)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // ëª¨ë“œ ê²°ì •: targetContentê°€ ìˆìœ¼ë©´ 'ë¶€ë¶„ ìˆ˜ì •', ì—†ìœ¼ë©´ 'ì „ì²´ ìˆ˜ì •'
        const isPartialEdit = targetContent.length > 0;
        lastEditMode = isPartialEdit ? "partial" : "full";
        lastTargetOriginal = targetContent; // ë‚˜ì¤‘ì— êµì²´í•˜ê¸° ìœ„í•´ ì›ë³¸ ì €ì¥

        const contentToProcess = isPartialEdit ? targetContent : mainContent;

        const btn = document.querySelector('.btn-ai-action');
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‘ì—… ì¤‘...';
		let promptPayload ='';
		let finalSystemInstruction = '';
        try {
            // ë¶€ë¶„ ìˆ˜ì •ì¼ ê²½ìš° ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì•½ê°„ ì¡°ì •í•˜ì—¬ ë¬¸ë§¥ë§Œ ì°¸ê³ í•˜ë„ë¡ í•¨
             finalSystemInstruction = systemInstruction;
			
			 promptPayload =`[ìˆ˜ì • ì§€ì‹œì‚¬í•­]
                            ${prompt}`;
			finalSystemInstruction += `
						[ë°°ê²½ì§€ì‹] ${contextData}
						[í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸] ${contentToProcess}
						`;
            if (isPartialEdit) {
                finalSystemInstruction = `
					ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ì „ë¬¸ êµì • ì—ë””í„°ì…ë‹ˆë‹¤.
					ì‚¬ìš©ìê°€ ì œê³µí•˜ëŠ” [í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸]ì˜ ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬, ì§€ì •ëœ [ìˆ˜ì • ëŒ€ìƒ í…ìŠ¤íŠ¸]ë¥¼ [ìˆ˜ì • ì§€ì‹œì‚¬í•­]ì— ë§ì¶° ë‹¤ì‹œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì„ë¬´ì…ë‹ˆë‹¤.

					âš  **ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Strict Rules)**
					1. **ê²°ê³¼ë¬¼ ì¶œë ¥ ë²”ìœ„**: [í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸]ì„ ë‹¤ì‹œ ì¶œë ¥í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ì˜¤ì§ **[ìˆ˜ì • ëŒ€ìƒ í…ìŠ¤íŠ¸]ê°€ ë³€í˜•ëœ ê²°ê³¼ë¬¼ë§Œ** ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
					2. **ë¬¸ì²´ ìœ ì§€**: [í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸]ì˜ í†¤ì•¤ë§¤ë„ˆ(ì–´íˆ¬, ì‹œì , ë¶„ìœ„ê¸°)ë¥¼ í•´ì¹˜ì§€ ì•Šê³  ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
					3. **í¬ë§·**: ì„¤ëª…, ì¸ì‚¬ë§, ë”°ì˜´í‘œ, ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡(\`\`\`) ë“±ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³ , ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
					4. **ë§¥ë½ íŒŒì•…**: ìˆ˜ì •í•  ë¶€ë¶„ì´ [í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸]ì˜ ì–´ëŠ ìœ„ì¹˜ì¸ì§€ íŒŒì•…í•˜ê³ , ì•ë’¤ ë¬¸ì¥ê³¼ ë§¤ë„ëŸ½ê²Œ ì—°ê²°ë˜ë„ë¡ ì¡°ì‚¬ë‚˜ ì ‘ì†ì‚¬ë¥¼ ì¡°ì •í•˜ì‹­ì‹œì˜¤.
					
					[í˜„ì¬ ì‘ì—… í…ìŠ¤íŠ¸] ${mainContent}
					`;
				 promptPayload = `
					[ìˆ˜ì • ëŒ€ìƒ í…ìŠ¤íŠ¸ (Target)]
					${targetContent}

					[ìˆ˜ì • ì§€ì‹œì‚¬í•­ (Instruction)]
					${prompt}
					`;
            }
			
          
            console.log(promptPayload);
            console.log(finalSystemInstruction);
            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                    contents: [{
                        parts: [{
                            text: promptPayload
                        }]
                    }],
                systemInstruction: { parts: [{ text: finalSystemInstruction }] },
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error.message);
            
            const newText = data.candidates[0].content.parts[0].text;
            
            // ëª¨ë‹¬ ë„ìš°ê¸°
            openDiffModal(contentToProcess, newText, isPartialEdit);

        } catch (e) {
            console.error(e);
            alert("AI ìš”ì²­ ì‹¤íŒ¨: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }

    // ğŸŒŸ [ìˆ˜ì •ë¨] ëª¨ë‹¬ ì œì–´ ë° ì ìš© ë¡œì§
    const diffModal = document.getElementById('diffModal');
    let pendingNewText = "";

    function openDiffModal(oldText, newText, isPartial) {
        document.getElementById('oldTextContent').innerText = oldText;
        document.getElementById('newTextContent').innerText = newText;
        document.getElementById('diffModeBadge').innerText = isPartial ? "ë¶€ë¶„ ìˆ˜ì •" : "ì „ì²´ ìˆ˜ì •";
        document.getElementById('diffModeBadge').style.color = isPartial ? "#d35400" : "#2c3e50";
        document.getElementById('diffModeBadge').style.backgroundColor = isPartial ? "#fadbd8" : "#eee";

        pendingNewText = newText;
        diffModal.style.display = 'flex';
    }

    function closeDiffModal() {
        diffModal.style.display = 'none';
        pendingNewText = "";
    }

    function applyAiResult() {
        if (!pendingNewText) return;

        const mainEditor = document.getElementById('mainEditor');

        if (lastEditMode === "partial") {
            // ë¶€ë¶„ ìˆ˜ì • ëª¨ë“œ: ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì•„ êµì²´
            // ì£¼ì˜: replaceëŠ” ì²« ë²ˆì§¸ ì¼ì¹˜ í•­ëª©ë§Œ êµì²´í•©ë‹ˆë‹¤.
            if (mainEditor.value.includes(lastTargetOriginal)) {
                mainEditor.value = mainEditor.value.replace(lastTargetOriginal, pendingNewText);
                // ì ìš© í›„ ëŒ€ìƒ ì…ë ¥ì°½ ë¹„ìš°ê¸° (ì„ íƒ ì‚¬í•­)
                // document.getElementById('targetEditor').value = ""; 
                alert("ë¶€ë¶„ ìˆ˜ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("ì˜¤ë¥˜: ë³¸ë¬¸ì—ì„œ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(ê·¸ ì‚¬ì´ì— ë³¸ë¬¸ì„ ìˆ˜ì •í•˜ì…¨ë‚˜ìš”?)");
                return; // ë‹«ì§€ ì•Šê³  ìœ ì§€
            }
        } else {
            // ì „ì²´ ìˆ˜ì • ëª¨ë“œ: ë®ì–´ì“°ê¸°
            mainEditor.value = pendingNewText;
        }

        closeDiffModal();
    }

    // ì €ì¥
    async function saveStory() {
        if (!currentStoryId) return;
        const content = document.getElementById('mainEditor').value;
        const currentStory = globalStories.find(s => s.id === currentStoryId);
        
        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: currentStory.title,
                    episode_number: currentStory.episode_number,
                    content: content
                })
            });

            if (res.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadStoryList();
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨");
            }
        } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    // --- ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ë“¤ (ê¸°ì¡´ ìœ ì§€) ---
    async function downloadSettingsTxt() {
        try {
            const [sRes, wRes, cRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`).then(r => r.json()),
                fetch(`/api/worldsettings?setting_id=${settingId}`).then(r => r.json()),
                fetch(`/api/characters?setting_id=${settingId}`).then(r => r.json())
            ]);

            let text = `[ ì œëª© ] ${sRes.title}\n\n`;
            text += `====================================\n[ ì„¸ê³„ê´€ ì„¤ì • ]\n====================================\n`;
            if (wRes && wRes.length > 0) {
                wRes.forEach(item => {
                    text += `â–  ${item.title}\n`;
                    if (item.keywords) text += `   - í‚¤ì›Œë“œ: ${item.keywords}\n`;
                    text += `   ${item.description || 'ë‚´ìš© ì—†ìŒ'}\n\n`;
                });
            } else { text += `(ë“±ë¡ëœ ì„¸ê³„ê´€ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.)\n\n`; }
            
            text += `====================================\n[ ë“±ì¥ì¸ë¬¼ ]\n====================================\n`;
            if (cRes && cRes.length > 0) {
                cRes.forEach(char => {
                    text += `â–  ${char.name} [${char.role || 'ì—­í•  ë¯¸ì •'}]\n`;
                    text += `   ${char.description || 'ë‚´ìš© ì—†ìŒ'}\n\n`;
                });
            } else { text += `(ë“±ë¡ëœ ë“±ì¥ì¸ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.)\n\n`; }
            
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${sRes.title}_ì„¤ì •ì§‘.txt`;
            link.click();
        } catch (e) {
            console.error(e);
            alert("ì„¤ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function downloadTextFile() {
        if (globalStories.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        let combined = `[ ${projectTitle} ]\n\n`;
        globalStories.forEach(s => {
            combined += `\n=== ${s.episode_number}í™”: ${s.title} ===\n\n${s.content}\n\n`;
        });
        const blob = new Blob([combined], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${projectTitle}_Full.txt`;
        link.click();
    }

    function copyToClipboard() {
        if (globalStories.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        let combined = "";
        globalStories.forEach(s => combined += `=== ${s.episode_number}í™”: ${s.title}=== \n${s.content}\n\n`);
        navigator.clipboard.writeText(combined).then(()=>alert("ë³µì‚¬ì™„ë£Œ"));
    }

    async function downloadBackup() {
        const allData = { project: projectTitle, stories: globalStories };
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${projectTitle}_Backup.json`;
        link.click();
    }

    async function deleteProject() {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const res = await fetch(`/api/delete-settings?id=${settingId}`, { method: 'DELETE' });
            if(res.ok) window.location.href = 'index.html';
        } catch(e) { alert("ì‚­ì œ ì˜¤ë¥˜"); }
    }

    init();
</script>

</body>
</html>