<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìºë¦­í„° - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --accent-color: #50c878; /* ìºë¦­í„° ê°•ì¡°ìƒ‰ (ì´ˆë¡) */
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --danger-color: #ff4d4f;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--accent-color); font-weight: bold; }

        /* ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1000px; margin: 30px auto; padding: 20px; }

        .header-area {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .header-area h2 { margin: 0; border-left: 5px solid var(--accent-color); padding-left: 10px; }

        .btn-add {
            background-color: var(--accent-color); color: white; border: none; padding: 10px 18px;
            border-radius: 25px; font-size: 0.95rem; cursor: pointer; box-shadow: 0 4px 6px rgba(80, 200, 120, 0.3);
        }

        /* ğŸŒŸ [NEW] AI ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .ai-section {
            background: white; border: 1px solid #c8e6c9; border-radius: 12px; padding: 20px;
            margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-header { font-size: 1.1rem; font-weight: bold; color: #2e7d32; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .ai-desc { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .ai-textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            min-height: 80px; resize: vertical; font-family: inherit; margin-bottom: 10px;
        }
        .ai-textarea:focus { outline: 2px solid var(--accent-color); border-color: transparent; }
        .btn-ai-gen {
            width: 100%; background-color: #2e7d32; color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            transition: background 0.2s;
        }
        .btn-ai-gen:hover { background-color: #1b5e20; }
        .btn-ai-gen:disabled { background-color: #a5d6a7; cursor: not-allowed; }

        /* ìºë¦­í„° ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
        }
        .char-card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee;
            display: flex; flex-direction: column; transition: transform 0.2s;
        }
        .char-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .char-icon {
            width: 50px; height: 50px; background: #eefbf3; color: var(--accent-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .role-badge { background: #f0f0f0; color: #555; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .role-badge.main { background: #e3f2fd; color: #1976d2; }
        .char-name { font-weight: bold; font-size: 1.2rem; color: #2c3e50; }
        .card-desc { font-size: 0.9rem; color: #555; margin-top: 5px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
        .card-actions { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; color: #999; }
        .action-btn:hover { color: var(--primary-color); }
        .action-btn.delete:hover { color: var(--danger-color); }

        /* ê³µí†µ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-input, .form-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #eee; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-submit { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }

        /* ğŸŒŸ [NEW] AI ë¯¸ë¦¬ë³´ê¸° ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .preview-list { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .preview-item {
            border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa;
            display: flex; gap: 10px; align-items: flex-start;
        }
        .preview-check { margin-top: 5px; transform: scale(1.2); cursor: pointer; }
        .preview-content { flex: 1; }
        .preview-role { font-size: 0.8rem; color: #2e7d32; font-weight: bold; margin-bottom: 2px; }
        .preview-name { font-weight: bold; margin-bottom: 4px; }
        .preview-desc { font-size: 0.85rem; color: #666; }

    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="write.html"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a> 
        <a href="#" class="nav-item" data-target="plot.html"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
        <a href="#" class="nav-item" data-target="write_scene.html"><i class="fas fa-layer-group"></i> ì¥ë©´ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item active"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item" data-target="plan.html"><i class="fas fa-magic"></i> ê¸°íš</a>
        <a href="#" class="nav-item" data-target="roadmap.html"><i class="fas fa-magic"></i> ë¡œë“œë§µ</a>
        <a href="#" class="nav-item" data-target="treatment.html"><i class="fas fa-magic"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</a>
    </div>
</nav>

<div class="container">
    <div class="ai-section">
        <div class="ai-header">
            <i class="fas fa-robot"></i> AI ê¸°ë°˜ ë“±ì¥ì¸ë¬¼ êµ¬ì„±
        </div>
        <div class="ai-desc">
            í˜„ì¬ í”Œë¡¯ê³¼ ì„¸ê³„ê´€ì— ë§ì¶° í•„ìš”í•œ ë“±ì¥ì¸ë¬¼ì„ AIê°€ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.<br>
            <small class="text-gray-500">(ì£¼ì¸ê³µ ì™¸ì— ì•…ë‹¹, ì¡°ë ¥ì, ì—‘ìŠ¤íŠ¸ë¼ ë“±ì„ ìš”ì²­í•´ë³´ì„¸ìš”.)</small>
        </div>
        <textarea id="aiPrompt" class="ai-textarea" placeholder="ì˜ˆ: ì£¼ì¸ê³µì„ ê´´ë¡­íˆëŠ” í•™êµ ì¼ì§„ 3ëª…ê³¼ ê·¸ë“¤ì˜ ë¦¬ë”ë¥¼ ë§Œë“¤ì–´ì¤˜. ë˜ëŠ” ì£¼ì¸ê³µì˜ ìˆ¨ê²¨ì§„ ì¡°ë ¥ìë¥¼ ì¶”ì²œí•´ì¤˜."></textarea>
        <button id="btnAiGen" class="btn-ai-gen" onclick="generateAiCharacters()">
            <i class="fas fa-magic"></i> AIë¡œ ë“±ì¥ì¸ë¬¼ ìƒì„±í•˜ê¸°
        </button>
    </div>

    <div class="header-area">
        <h2>ë“±ì¥ì¸ë¬¼ ê´€ë¦¬</h2>
        <button class="btn-add" onclick="openModal('add')"><i class="fas fa-user-plus"></i> ì§ì ‘ ì¶”ê°€</button>
    </div>

    <div id="charGrid" class="grid-container">
        <div style="grid-column: 1/-1; text-align:center; padding: 40px; color: #999;">
            <i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...
        </div>
    </div>
</div>

<div id="charModal" class="modal-overlay">
    <div class="modal">
        <h3 id="modalTitle">ì¸ë¬¼ ì¶”ê°€</h3>
        <input type="hidden" id="editId">
        <div class="form-group"><label>ì´ë¦„</label><input type="text" id="inputName" class="form-input"></div>
        <div class="form-group"><label>ì—­í• </label><input type="text" id="inputRole" class="form-input"></div>
        <div class="form-group"><label>ì„¤ëª…</label><textarea id="inputDesc" class="form-textarea" rows="4"></textarea></div>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal('charModal')">ì·¨ì†Œ</button>
            <button class="btn-submit" onclick="saveCharacter()">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="aiPreviewModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-check-double"></i> ìƒì„±ëœ ì¸ë¬¼ í™•ì¸</h3>
        <p style="font-size:0.9rem; color:#666;">ì¶”ê°€í•  ì¸ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        
        <div id="aiResultList" class="preview-list">
            </div>

        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal('aiPreviewModal')">ì·¨ì†Œ</button>
            <button class="btn-submit" onclick="saveBulkCharacters()">ì„ íƒ í•­ëª© ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');
    let charList = [];
    let aiGeneratedData = []; // AIê°€ ë§Œë“  ì„ì‹œ ë°ì´í„°

    function init() {
        if (!settingId) {
            alert("í”„ë¡œì íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        loadCharacters();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    // --- ê¸°ë³¸ CRUD ---
    async function loadCharacters() {
        const grid = document.getElementById('charGrid');
        try {
            const res = await fetch(`/api/characters?setting_id=${settingId}`);
            charList = await res.json();
            
            grid.innerHTML = '';
            if (charList.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#aaa;">ë“±ë¡ëœ ì¸ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            charList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'char-card';
                card.onclick = (e) => { if(!e.target.closest('.action-btn')) openModal('edit', item.id); };
                
                const isMain = item.role && (item.role.includes('ì£¼ì¸ê³µ') || item.role.includes('ë©”ì¸'));
                const badgeClass = isMain ? 'role-badge main' : 'role-badge';

                card.innerHTML = `
                    <div class="card-header">
                        <div class="char-icon"><i class="fas fa-user"></i></div>
                        ${item.role ? `<span class="${badgeClass}">${item.role}</span>` : ''}
                    </div>
                    <div class="char-name">${item.name}</div>
                    <div class="card-desc">${item.description || ''}</div>
                    <div class="card-actions">
                        <button class="action-btn delete" onclick="deleteCharacter(event, ${item.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (e) { console.error(e); }
    }

    // --- ğŸŒŸ AI ìƒì„± ë¡œì§ ---
   // --- ğŸŒŸ AI ìƒì„± ë¡œì§ (3~5ëª… ì¶”ì²œ) ---
    async function generateAiCharacters() {
        const prompt = document.getElementById('aiPrompt').value.trim();
        if (!prompt) return alert("ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.getElementById('btnAiGen');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)';

        try {
            // 1. ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ì„¤ì •, ì„¸ê³„ê´€, ê¸°ì¡´ ìºë¦­í„°)
            const [sRes, wRes] = await Promise.all([
                fetch(`/api/load-settings?id=${settingId}`).then(r => r.json()),
                fetch(`/api/worldsettings?setting_id=${settingId}`).then(r => r.json())
            ]);
            
            // ê¸°ì¡´ ìºë¦­í„° ì´ë¦„ë“¤ë§Œ ì¶”ì¶œ (ì¤‘ë³µ ë°©ì§€ìš©)
            const existNames = charList.map(c => c.name).join(', ');

            // 2. í”„ë¡¬í”„íŠ¸ êµ¬ì„± (3~5ëª… ìš”ì²­ ì¶”ê°€)
            const fullPrompt = `
                [ì—­í• ] ì›¹ì†Œì„¤ ìºë¦­í„° ë””ìì´ë„ˆ
                [ì‘í’ˆ ì œëª©] ${sRes.title}
                [ì¤„ê±°ë¦¬] ${sRes.plotDetails || 'ë¯¸ì •'}
                [ì„¸ê³„ê´€] ${wRes.map(w => w.title).join(', ')}
                [ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìºë¦­í„°] ${existNames}

                [ìš”ì²­ ì‚¬í•­]
                ${prompt}

                [ì¶œë ¥ ì¡°ê±´]
                1. ìœ„ ìš”ì²­ì— ë§ëŠ” ìƒˆë¡œìš´ ë“±ì¥ì¸ë¬¼ì„ **ìµœì†Œ 3ëª…ì—ì„œ ìµœëŒ€ 5ëª…ê¹Œì§€** ìƒì„±í•˜ì„¸ìš”.
                2. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìºë¦­í„° ì´ë¦„ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
                3. ê° ìºë¦­í„°ëŠ” ì´ë¦„, ì—­í• , ì„¤ëª…(ì„±ê²©/íŠ¹ì§•)ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.
                4. ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì€ **JSON ë°°ì—´ í˜•ì‹(Array)**ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”. ë§ˆí¬ë‹¤ìš´(\`\`\`)ì´ë‚˜ ì‚¬ì¡±(ì„¤ëª…) ê¸ˆì§€.
                5. **ì¤‘ìš”: description ì•ˆì—ëŠ” ì¤„ë°”ê¿ˆ(\\n)ê³¼ ê¸€ë¨¸ë¦¬ ê¸°í˜¸(-, *)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± ìˆê²Œ ì‘ì„±í•˜ì„¸ìš”.**

                [JSON ì˜ˆì‹œ]
                [
                    { 
                        "name": "ì´ë¦„1", 
						"role": "ì—­í• 1",
                        "description": " - ë‚˜ì´: 28ì„¸\\n\\n - ì§ì±…: í•œë¹›ì˜ ë¹„ì„œì‹¤ì¥\\n\\n - ì™¸ëª¨: 165cm, ë‹¨ë°œë¨¸ë¦¬, í”„ë¡œí˜ì…”ë„í•œ ì´ë¯¸ì§€\\n\\n - ì„±ê²©: ì™„ë²½ì£¼ì˜ì\\nì—…ë¬´ ëŠ¥ë ¥ íƒì›”\\nëƒ‰ì² í•˜ì§€ë§Œ ë”°ëœ»í•œ ë©´ë„ ìˆìŒ\\n\\n - ë°°ê²½: ê±´ì¶•í•™ê³¼ í•œë¹›ì˜ ëŒ€í•™ ì„ ë°°\\në¹„ê°ì„±ìì§€ë§Œ ì‹¤ë¬´ ëŠ¥ë ¥ìœ¼ë¡œ ì¸ì •ë°›ìŒ\\ní•œë¹›ì˜ ìµœì¸¡ê·¼ì´ì ì¡°ë ¥ì\\n\\n - ì—­í• : í•œë¹›ì˜ ì¼ì • ê´€ë¦¬\\ní”„ë¡œì íŠ¸ ì‹¤ë¬´ ì´ê´„\\nëŒ€ì™¸ í˜‘ìƒ ëŒ€í–‰\\n\\n - ê´€ê³„:í•œë¹›ì„ ì¡´ê²½í•˜ì§€ë§Œ í•„ìš”ì‹œ ì§ì–¸\\nì •ì”¨ ê°€ì¡±ë“¤ê³¼ë„ ì¹œë°€\\n" 
                    },
                    { 
                        "name": "ì´ë¦„2", 
						"role": "ì—­í• 2",
                        "description": " - ë‚˜ì´: 22ì„¸\\n\\n - ì§ì±…: í•œë¹›ì˜ ë¹„ì„œì‹¤ì¥\\n\\n - ì™¸ëª¨: 165cm, ë‹¨ë°œë¨¸ë¦¬, í”„ë¡œí˜ì…”ë„í•œ ì´ë¯¸ì§€\\n\\n - ì„±ê²©: ì™„ë²½ì£¼ì˜ì\\nì—…ë¬´ ëŠ¥ë ¥ íƒì›”\\nëƒ‰ì² í•˜ì§€ë§Œ ë”°ëœ»í•œ ë©´ë„ ìˆìŒ\\n\\n - ë°°ê²½: ê±´ì¶•í•™ê³¼ í•œë¹›ì˜ ëŒ€í•™ ì„ ë°°\\në¹„ê°ì„±ìì§€ë§Œ ì‹¤ë¬´ ëŠ¥ë ¥ìœ¼ë¡œ ì¸ì •ë°›ìŒ\\ní•œë¹›ì˜ ìµœì¸¡ê·¼ì´ì ì¡°ë ¥ì\\n\\n - ì—­í• : í•œë¹›ì˜ ì¼ì • ê´€ë¦¬\\ní”„ë¡œì íŠ¸ ì‹¤ë¬´ ì´ê´„\\nëŒ€ì™¸ í˜‘ìƒ ëŒ€í–‰\\n\\n - ê´€ê³„:í•œë¹›ì„ ì¡´ê²½í•˜ì§€ë§Œ í•„ìš”ì‹œ ì§ì–¸\\nì •ì”¨ ê°€ì¡±ë“¤ê³¼ë„ ì¹œë°€\\n" 
                    }
                ]
            `;

            // 3. API í˜¸ì¶œ
            const aiRes = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gemini-3.0-flash",
                    payload: { contents: [{ parts: [{ text: fullPrompt }] }] }
                })
            });
            const aiData = await aiRes.json();
            
            // 4. ì‘ë‹µ íŒŒì‹±
            let text = aiData.candidates[0].content.parts[0].text;
            // JSON í¬ë§·íŒ… ì •ë¦¬ (Markdown ì½”ë“œë¸”ë¡ ë° ê³µë°± ì œê±°)
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
            
            aiGeneratedData = JSON.parse(text);

            if (!Array.isArray(aiGeneratedData) || aiGeneratedData.length === 0) {
                throw new Error("AIê°€ ìœ íš¨í•œ ìºë¦­í„° ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }

            // 5. ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°
            openAiPreviewModal();

        } catch (e) {
            console.error(e);
            alert("ìƒì„± ì‹¤íŒ¨: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> AIë¡œ ë“±ì¥ì¸ë¬¼ ìƒì„±í•˜ê¸°';
        }
    }

    function openAiPreviewModal() {
        const listContainer = document.getElementById('aiResultList');
        listContainer.innerHTML = '';

        aiGeneratedData.forEach((char, idx) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `
                <input type="checkbox" class="preview-check" id="char_chk_${idx}" checked>
                <div class="preview-content">
                    <div class="preview-role">${char.role}</div>
                    <div class="preview-name">${char.name}</div>
                    <div class="preview-desc">${char.description}</div>
                </div>
            `;
            listContainer.appendChild(div);
        });

        document.getElementById('aiPreviewModal').style.display = 'flex';
    }

    async function saveBulkCharacters() {
        // ì„ íƒëœ í•­ëª©ë§Œ í•„í„°ë§
        const selectedChars = [];
        aiGeneratedData.forEach((char, idx) => {
            const chk = document.getElementById(`char_chk_${idx}`);
            if (chk && chk.checked) {
                selectedChars.push({
                    setting_id: settingId, // í•„ìˆ˜ ID ì¶”ê°€
                    name: char.name,
                    role: char.role,
                    description: char.description
                });
            }
        });

        if (selectedChars.length === 0) {
            alert("ì„ íƒëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            // ì œê³µí•´ì£¼ì‹  Bulk API í˜¸ì¶œ
            const res = await fetch('/api/characters/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ characters: selectedChars })
            });

            if (res.ok) {
                alert(`${selectedChars.length}ëª…ì˜ ì¸ë¬¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                closeModal('aiPreviewModal');
                loadCharacters(); // ëª©ë¡ ê°±ì‹ 
                document.getElementById('aiPrompt').value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
            } else {
                const err = await res.json();
                alert("ì €ì¥ ì‹¤íŒ¨: " + err.message);
            }
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // --- ìˆ˜ë™ ëª¨ë‹¬ ê´€ë ¨ ---
    function openModal(mode, id = null) {
        const modal = document.getElementById('charModal');
        document.getElementById('editId').value = id || '';
        document.getElementById('inputName').value = '';
        document.getElementById('inputRole').value = '';
        document.getElementById('inputDesc').value = '';

        if (mode === 'edit') {
            const item = charList.find(c => c.id === id);
            if (item) {
                document.getElementById('inputName').value = item.name;
                document.getElementById('inputRole').value = item.role;
                document.getElementById('inputDesc').value = item.description;
            }
        }
        modal.style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    async function saveCharacter() {
        const id = document.getElementById('editId').value;
        const name = document.getElementById('inputName').value;
        if(!name) return alert("ì´ë¦„ í•„ìˆ˜");

        const payload = {
            setting_id: settingId,
            name: name,
            role: document.getElementById('inputRole').value,
            description: document.getElementById('inputDesc').value
        };

        const url = id ? `/api/characters/${id}` : '/api/characters';
        const method = id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                closeModal('charModal');
                loadCharacters();
            }
        } catch(e) { alert("ì˜¤ë¥˜"); }
    }

    async function deleteCharacter(e, id) {
        e.stopPropagation();
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`/api/characters/${id}`, { method: 'DELETE' });
        loadCharacters();
    }

    init();
</script>

</body>
</html>