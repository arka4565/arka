<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§‘í•„ - AI Novel Studio</title>
	<script src="auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --write-color: #e67e22;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
            --danger-color: #e74c3c;
            --highlight-bg: #fff3cd;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ --- */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 1001;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px;
            border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--write-color); font-weight: bold; }

        /* --- ë©”ì¸ ë ˆì´ì•„ì›ƒ --- */
        .workspace-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ë°±ë“œë¡­ */
        .sidebar-backdrop {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999;
        }

        /* ì¢Œì¸¡: íšŒì°¨ ëª©ë¡ */
        .episode-sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: #fafafa; color: var(--write-color); font-weight: bold;
        }
        .btn-close-sidebar { display: none; background: none; border: none; font-size: 1.2rem; color: #666; cursor: pointer; }
        .ep-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; padding-bottom: 50px; }
        .ep-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .ep-item:hover { background: #f8f9fa; }
        .ep-item.active { background: #fff3e0; border-left: 4px solid var(--write-color); font-weight: bold; }
        .ep-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }

        /* ìš°ì¸¡: ì—ë””í„° ì˜ì—­ */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            position: relative;
            width: 100%;
        }

        /* 1. ì—ë””í„° íˆ´ë°” */
        .editor-toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: #fafafa; gap: 10px; flex-shrink: 0;
        }
        .btn-mobile-menu {
            display: none; background: white; border: 1px solid #ddd;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; color: #555;
        }
        .ep-title-input {
            flex: 1; font-size: 1.1rem; font-weight: bold; border: none;
            border-bottom: 2px solid transparent; background: transparent; padding: 5px;
            min-width: 0;
        }
        .ep-title-input:focus { border-bottom-color: var(--write-color); outline: none; }
        
        .toolbar-actions { display: flex; gap: 5px; align-items: center; flex-shrink: 0; }
        .tool-btn {
            background: white; border: 1px solid #ccc; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-save { background: var(--write-color); color: white; border: none; }
        .btn-delete { color: var(--danger-color); border-color: var(--danger-color); }

        /* 2. AI ìˆ˜ì • ë„êµ¬ */
        .ai-tools {
            padding: 10px; background: #fff8f0; border-bottom: 1px solid #eee;
            display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-shrink: 0;
        }
        .ai-btn {
            font-size: 0.85rem; padding: 6px 12px; border: 1px solid #ffcc80;
            background: white; border-radius: 15px; color: #e67e22; cursor: pointer;
            white-space: nowrap;
        }

        /* ë¬¸ë§¥/ì„¤ì • íŒ¨ë„ (Plot ì €ì¥ìš©ìœ¼ë¡œ ì¬í™œìš©) */
        .context-panel {
            background: #fdfbff;
            border-bottom: 1px solid #eee;
            padding: 10px 15px;
            flex-shrink: 0;
        }
        .context-header {
            font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .context-input {
            width: 100%; padding: 8px; border: 1px solid #d1c4e9; border-radius: 6px;
            font-size: 0.9rem; resize: vertical; min-height: 40px; height: 40px;
            transition: height 0.3s;
        }
        .context-input:focus { height: 80px; }

        .btn-save-small {
            background: var(--write-color); color: white; border: none;
            padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;
            margin-left: 5px;
        }
        .btn-save-small:hover { background: #d35400; }
        
        /* ğŸŒŸ ìš”ì•½ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë³´ë¼ìƒ‰ ê³„ì—´) */
        .btn-summ-small {
            background: #9b59b6; color: white; border: none;
            padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;
            margin-left: 10px;
        }
        .btn-summ-small:hover { background: #8e44ad; }

        /* 4. ë©”ì¸ ì—ë””í„° */
        #mainEditor {
            flex: 1; width: 100%; border: none; resize: none; padding: 20px;
            font-size: 1.05rem; line-height: 1.8; outline: none; font-family: 'Pretendard', serif;
        }

        /* 5. í•˜ë‹¨ ì´ì–´ì“°ê¸° íŒ¨ë„ */
        .ai-bottom-panel {
            padding: 10px; background: #fdfbff; border-top: 1px solid #eee;
            display: flex; gap: 10px; padding-bottom: 20px; flex-shrink: 0;
        }
        .ai-prompt-input {
            flex: 1; padding: 10px; border: 1px solid #d1c4e9; border-radius: 6px; font-size: 16px;
        }
        .btn-generate {
            background: #9b59b6; color: white; border: none; padding: 0 20px;
            border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: bold;
        }

        /* --- ëª¨ë‹¬ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal {
            background: white; width: 90%; max-width: 600px; padding: 20px;
            border-radius: 10px; max-height: 80vh; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        .diff-box {
            padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.95rem;
            line-height: 1.6; background: #f9f9f9; border: 1px solid #eee;
            max-height: 200px; overflow-y: auto; white-space: pre-wrap;
        }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 900px) {
            .episode-sidebar {
                position: absolute; top: 0; left: 0; height: 100%;
                transform: translateX(-100%); 
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .episode-sidebar.active { transform: translateX(0); }
            
            .btn-close-sidebar { display: block; }
            .btn-mobile-menu { display: block; }
            .sidebar-backdrop.active { display: block; }
            
            .ep-title-input { font-size: 1rem; }
            #mainEditor { padding: 15px; }
			#charCount {
				position: fixed; 
				bottom: 80px; 
				right: 15px;
				background: rgba(255, 255, 255, 0.95);
				border: 1px solid #ddd;
				padding: 6px 12px;
				border-radius: 20px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				font-size: 0.75rem;
				z-index: 1000;
				display: flex !important;
				gap: 5px;
				align-items: center;
			}
			.ep-title-input { min-width: 0; flex: 1; }
			#charCount span[style*="color:#ddd"] { color: #ccc !important; }
        }
    </style>
</head>
<body>
<script src="include.js"></script>
<div data-include="nav.html"></div>

<div class="workspace-container">
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <aside class="episode-sidebar" id="sidebar">
        <div class="sidebar-header">
            <span><i class="fas fa-list-ol"></i> íšŒì°¨ ëª©ë¡</span>
            <button class="btn-close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <ul id="episodeList" class="ep-list">
            <li style="padding:15px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</li>
        </ul>
        <div style="padding:10px; border-top:1px solid #eee;">
             <button class="tool-btn" style="width:100%; background:#f8f9fa;" onclick="createNewEpisode()">
                 <i class="fas fa-plus"></i> ìƒˆ íšŒì°¨ ì¶”ê°€
             </button>
        </div>
    </aside>

    <main class="editor-area">
        <div class="editor-toolbar">
            <button class="btn-mobile-menu" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            
            <input type="text" id="episodeTitle" class="ep-title-input" placeholder="íšŒì°¨ ì œëª©">
            <div class="toolbar-actions">
                <span id="charCount" class="char-counter">0ì</span>
                <span id="saveStatus" style="font-size:0.8rem; color:#888; display:none;"></span>
                <button class="tool-btn btn-delete" onclick="deleteCurrentStory()"><i class="fas fa-trash-alt"></i></button>
                <button class="tool-btn btn-save" onclick="saveCurrentEpisode()"><i class="fas fa-save"></i></button>
            </div>
        </div>

        <div class="ai-tools" style="display:none;">
            <button class="ai-btn" onclick="openAiEdit('polish')"><i class="fas fa-magic"></i> ë‹¤ë“¬ê¸°</button>
            <button class="ai-btn" onclick="openAiEdit('expand')"><i class="fas fa-expand-alt"></i> ë¬˜ì‚¬</button>
            <button class="ai-btn" onclick="openAiEdit('fix')"><i class="fas fa-check-double"></i> ë§ì¶¤ë²•</button>
        </div>

        <div class="context-panel" style="border-top:1px solid #eee;">
            <div class="context-header">
                <span><i class="fas fa-list-alt"></i> íšŒì°¨ ì¤„ê±°ë¦¬ (Plot)</span>
                <div>
                    <button class="btn-summ-small" onclick="summarizeContent(this)">
                        <i class="fas fa-magic"></i> ë³¸ë¬¸ ìš”ì•½
                    </button>
                    <button class="btn-save-small" onclick="savePlotOnly()">
                        <i class="fas fa-save"></i> ì¤„ê±°ë¦¬ ì €ì¥
                    </button>
                </div>
            </div>
            <textarea id="plotInput" class="context-input" placeholder="ì´ íšŒì°¨ì˜ í•µì‹¬ ì¤„ê±°ë¦¬ë¥¼ ê¸°ë¡í•˜ì„¸ìš”. (ìš”ì•½ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë³¸ë¬¸ ë‚´ìš©ì„ ìš”ì•½í•´ì¤ë‹ˆë‹¤)"></textarea>
        </div>

        <textarea id="mainEditor" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..." oninput="updateCharCount()"></textarea>

        <div class="ai-bottom-panel">
            <input type="text" id="nextPrompt" class="ai-prompt-input" placeholder="ë‹¤ìŒ ì¥ë©´ ì§€ì‹œ (ì„ íƒ)">
            <button class="btn-generate" onclick="generateNext()"><i class="fas fa-pen-nib"></i> ì´ì–´ì“°ê¸°</button>
        </div>
    </main>
</div>

<div id="aiDiffModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-robot"></i> AI ìˆ˜ì • ì œì•ˆ</h3>
        <p style="font-size:0.9rem; color:#666;">ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        <div class="diff-box" style="background:#ffeef0; color:#c0392b; border-color:#ffccd0;" id="originalText"></div>
        <div style="text-align:center;"><i class="fas fa-arrow-down" style="color:#999;"></i></div>
        <div class="diff-box" style="background:#e8f5e9; color:#27ae60; border-color:#c8e6c9;" id="newText"></div>
        <div class="modal-btns">
            <button class="tool-btn" onclick="closeAiModal()">ì·¨ì†Œ</button>
            <button class="tool-btn btn-save" onclick="applyAiChange()">ì ìš©í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let currentStoryId = null; 
    let globalStories = []; 
    // RAGìš© ë°ì´í„° ë³€ìˆ˜
    let allWorldSettings = [];
    let allCharacters = [];
    let dynamicContext = "";  

    const baseSystemInstruction = `
    âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)
    (ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ì™€ ë™ì¼ - ìƒëµ)
    `;

    function updateCharCount() {
       const text = document.getElementById('mainEditor').value;
        const munpiaTotal = text.replace(/\n/g, '').length;
        const noSpace = text.replace(/\s/g, '').length; 
        document.getElementById('charCount').innerHTML = 
            `<span style="color:#888; font-size:0.9em;">ê³µë°±í¬í•¨ ${munpiaTotal}ì</span> <span style="color:#ddd;">|</span> <span style="color:var(--write-color); font-weight:bold;">ê³µë°±ì œì™¸ ${noSpace}ì</span>`;
    }

    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData(); 
        await loadStoryList();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.querySelector('.sidebar-backdrop');
        sidebar.classList.toggle('active');
        backdrop.classList.toggle('active');
    }

    async function loadContextData() {
        try {
            const [wRes, cRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            allWorldSettings = await wRes.json();
            allCharacters = await cRes.json();
        } catch (e) { console.warn("Context load failed", e); }
    }

    function getRelevantContext(userInput) {
        if (!userInput || userInput.trim() === "") return "";
        const searchText = userInput;
        let relevantWorld = allWorldSettings.filter(w => {
            if (searchText.includes(w.title)) return true;
            if (w.keywords) {
                const keywords = w.keywords.split(',').map(k => k.trim());
                return keywords.some(k => k && searchText.includes(k));
            }
            return false;
        });
        let relevantChars = allCharacters.filter(c => searchText.includes(c.name));
        let context = "";
        if (relevantWorld.length > 0) {
            context += "[ê´€ë ¨ ì„¸ê³„ê´€ ì •ë³´]\n" + relevantWorld.map(w => `ğŸ“Œ ${w.title}: ${w.description}`).join('\n\n') + "\n\n";
        }
        if (relevantChars.length > 0) {
            context += "[ë“±ì¥ì¸ë¬¼ ì •ë³´ (ê´€ë ¨ë¨)]\n" + relevantChars.map(c => `ğŸ‘¤ ${c.name} (${c.role})\n- íŠ¹ì§•: ${c.description}`).join('\n\n');
        }
        return context;
    }

    async function loadPreviousStories(epNum) {
        if (!epNum || epNum <= 1) {
            dynamicContext = "";
            return;
        }
        try {
            const res = await fetch(`/api/previous-stories?setting_id=${settingId}&episode_number=${epNum}`);
            if(res.ok) {
                const prevStories = await res.json();
                if (prevStories.length > 0) {
                    const summary = prevStories.map(s => `[${s.episode_number}í™” ìš”ì•½]:\n${s.content}...`).join('\n');
                    dynamicContext = `\n[ì´ì „ ì´ì•¼ê¸° íë¦„ (ì°¸ê³ ìš©)]:\n${summary}`;
                } else { dynamicContext = ""; }
            }
        } catch (e) { dynamicContext = ""; }
    }

    async function loadStoryList(targetId = null) {
        const listEl = document.getElementById('episodeList');
        try {
            const res = await fetch(`/api/stories?setting_id=${settingId}`);
            if (!res.ok) throw new Error("Load failed");
            
            globalStories = await res.json();
            globalStories.sort((a, b) => a.episode_number - b.episode_number);

            listEl.innerHTML = '';
            if (globalStories.length === 0) {
                listEl.innerHTML = '<li style="padding:15px; text-align:center; color:#999;">ì‘ì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                clearEditor(true);
                return;
            }

            globalStories.forEach((story) => {
				const li = document.createElement('li');
                li.className = `ep-item ${story.id === currentStoryId ? 'active' : ''}`;
                const count = story.content ? story.content.replace(/\n/g, '').length : 0;
                li.innerHTML = `
                    <div style="font-weight:bold;">${story.title}</div>
                    <div class="ep-meta">${story.episode_number}í™” Â· ê³µë°±í¬í•¨ ${count}ì</div>
                `;
                li.onclick = () => selectStory(story);
                listEl.appendChild(li);
            });

            if (targetId) {
                const target = globalStories.find(s => s.id === targetId);
                if (target) selectStory(target);
            }
        } catch (e) { console.error(e); }
    }

    function selectStory(story) {
        currentStoryId = story.id;
        document.getElementById('episodeTitle').value = story.title;
        document.getElementById('mainEditor').value = story.content || ''; 
        document.getElementById('plotInput').value = story.content_plot || ''; 

        document.getElementById('mainEditor').disabled = false;
        updateCharCount();
        const listEl = document.getElementById('episodeList');
        Array.from(listEl.children).forEach(li => li.classList.remove('active'));
        const idx = globalStories.findIndex(s => s.id === story.id);
        if (listEl.children[idx]) listEl.children[idx].classList.add('active');

        if (window.innerWidth <= 900) toggleSidebar();
        loadPreviousStories(story.episode_number);
    }

    function clearEditor(disable = false) {
        currentStoryId = null;
        document.getElementById('episodeTitle').value = '';
        document.getElementById('mainEditor').value = '';
        document.getElementById('plotInput').value = ''; // ğŸŒŸ
        document.getElementById('mainEditor').disabled = disable;
        updateCharCount();
    }

    async function createNewEpisode() {
        let maxNum = 0;
        if (globalStories.length > 0) maxNum = Math.max(...globalStories.map(s => s.episode_number));
        const nextNum = maxNum + 1;
        const title = `${nextNum}í™”: ì œëª© ì—†ìŒ`;
        
        const payload = {
            setting_id: settingId,
            episode_number: nextNum,
            title: title,
            content: " ", 
            content_plot: "", // ğŸŒŸ
            prompt: "User Created"
        };

        try {
            const res = await fetch('/api/stories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                const result = await res.json();
                await loadStoryList(result.id);
                loadPreviousStories(nextNum);
                if (window.innerWidth <= 900) toggleSidebar();
            } else { alert("ìƒì„± ì‹¤íŒ¨"); }
        } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function saveCurrentEpisode() {
        if (!currentStoryId) return alert("ì €ì¥í•  íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const title = document.getElementById('episodeTitle').value;
        const content = document.getElementById('mainEditor').value;
        const plot = document.getElementById('plotInput').value; // ğŸŒŸ ì¤„ê±°ë¦¬ ê°€ì ¸ì˜¤ê¸°

        const currentStory = globalStories.find(s => s.id === currentStoryId);
        
        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    episode_number: currentStory.episode_number, 
                    title: title, 
                    content: content,
                    content_plot: plot // ğŸŒŸ í•¨ê»˜ ì €ì¥
                })
            });
            if (res.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadStoryList(); // ëª©ë¡ ê°±ì‹  (ë°ì´í„° ë™ê¸°í™”)
            } else { alert("ì €ì¥ ì‹¤íŒ¨"); }
        } catch (e) { alert("ì˜¤ë¥˜"); }
    }

    async function savePlotOnly() {
        if (!currentStoryId) return alert("ì €ì¥í•  íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.");
        await saveCurrentEpisode();
    }
    
    // ğŸŒŸ [NEW] ë³¸ë¬¸ ìš”ì•½ ê¸°ëŠ¥
    async function summarizeContent(btn) {
        const content = document.getElementById('mainEditor').value;
        if (!content || content.trim().length < 50) {
            return alert("ìš”ì•½í•  ë³¸ë¬¸ ë‚´ìš©ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.");
        }
		const currentStory = globalStories.find(s => s.id === currentStoryId);
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìš”ì•½ ì¤‘...';
// 3. íšŒì°¨ ë²ˆí˜¸ì™€ ì œëª© í™•ì • (ì œëª©ì€ í™”ë©´ ê°’ì„ ìš°ì„  ì‚¬ìš©)
        const epNum = currentStory.episode_number;
        const epTitle = currentStory.title ;
        try {
            const prompt = `
				[ì˜ˆì‹œ]
				 =====Xí™”. ì œëª©=====	 
				 ì‚¬ê±´íë¦„: ë§ˆë‚˜ ë³€ì´ ì‘ë¬¼(ìƒì¶”, ê¹»ì) ì²« ìˆ˜í™• ë° ì‚¼ê²¹ì‚´ íŒŒí‹°(ëŸ­ìŠ¤ë„ ì±„ì†Œ ë§›ì— ëˆˆì„ ëœ¸) 
->  ì²« ë¼ì´ë¸Œ ë°©ì†¡ìœ¼ë¡œ ì•¼ì‹¬ ì°¨ê²Œ 'ASMR ë¨¹ë°©'ì„ ì‹œë„í–ˆìœ¼ë‚˜, ë£¨ë¯¸ê°€ ë§ˆì´í¬ë¥¼ ì”¹ì–´ë¨¹ê³  ëŸ­ìŠ¤ê°€ ë”¸ê¾¹ì§ˆì„ ë©ˆì¶”ì§€ ì•Šì•„ ê°œê·¸ ë°©ì†¡ìœ¼ë¡œ ì „ë½(ì˜¤íˆë ¤ ì¡°íšŒìˆ˜ í­ë°œ) 
-> "CG ì•„ë‹ˆëƒ"ëŠ” ì˜ì‹¬ê³¼ ì•…í”Œì—ë„ ìƒì²˜ë°›ì§€ ì•Šê³  "ìš°ë¦¬ê°€ í–‰ë³µí•˜ë©´ ê·¸ë§Œ"ì´ë¼ ë„˜ê¸°ëŠ” ë©˜íƒˆê°‘ ë¯¼ìš°
				 
                [ì§€ì‹œ]
                ì•„ë˜ [ë³¸ë¬¸ ë‚´ìš©]ì„ ì½ê³ , í•´ë‹¹ íšŒì°¨ì˜ í•µì‹¬ ì¤„ê±°ë¦¬ë¥¼ ìš”ì•½í•´ì¤˜.
                
                ***ì¤‘ìš”: ìš”ì•½ë¬¸ì˜ ì²« ì¤„ì€ ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì´ ì‹œì‘í•  ê²ƒ***
                =====${epNum}í™”. ${epTitle}=====
                
                ì „ì²´ì ì¸ ì‚¬ê±´ íë¦„(4ê°œ~5ê°œ)ì— ì£¼ì¸ê³µì˜ ì‹¬ë¦¬ ë³€í™”ê°€ ì˜ ë“œëŸ¬ë‚˜ê²Œ ì‘ì„±í•´.
                *í‘œì‹œë‚˜ ë¶ˆí•„ìš”í•œ ë§ˆí¬ë‹¤ìš´ ì—†ì´ í…ìŠ¤íŠ¸ë¡œë§Œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´.

                [ë³¸ë¬¸ ë‚´ìš©]
                ${content.slice(0, 15000)} 
            `;
				

            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                    contents: [{ parts: [{ text: prompt }] }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if(data.candidates) {
                const summary = data.candidates[0].content.parts[0].text.trim();
                document.getElementById('plotInput').value = summary;
            } else {
                alert("AI ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");
            }

        } catch(e) {
            console.error(e);
            alert("ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function deleteCurrentStory() {
        if (!currentStoryId) return alert("ì‚­ì œí•  íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, { method: 'DELETE' });
            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentStoryId = null;
                clearEditor(true);
                loadStoryList();
            } else { alert("ì‚­ì œ ì‹¤íŒ¨"); }
        } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }
    
    async function generateNext() {
        if (!currentStoryId) return alert("íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        
        const promptInput = document.getElementById('nextPrompt');
        const userInstruction = promptInput.value;
        // ë¬¸ë§¥ ì£¼ì…ì´ í•„ìš”í•˜ë‹¤ë©´ ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥ (í˜„ì¬ UIìƒ inputì€ ì œê±°ë¨)
        const contextInput = ""; 
        
        const editor = document.getElementById('mainEditor');
        const currentText = editor.value;

        const btn = document.querySelector('.btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>...';

        try {
            const searchSource = `${currentText.slice(-1000)} ${userInstruction}`;
            const optimizedContext = getRelevantContext(searchSource);

            let fullSystemInstruction = baseSystemInstruction;
            fullSystemInstruction += `\n\n--- [ì°¸ê³ í•  ì„¤ì •] ---\n${optimizedContext}`;

            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                    systemInstruction: { parts: [{ text: fullSystemInstruction }] },
                    contents: [{
                        parts: [{
                            text: `[í˜„ì¬ ë³¸ë¬¸] ...${currentText.slice(-1500)}\n[ìš”ì²­] ë‹¤ìŒ ì¥ë©´ì„ ì´ì–´ ì¨ì¤˜. ì§€ì‹œ: ${userInstruction || 'ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡'}`
                        }]
                    }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if(data.candidates) {
                const newContent = data.candidates[0].content.parts[0].text;
                editor.value += "\n\n" + newContent;
                editor.scrollTop = editor.scrollHeight;
                promptInput.value = ''; 
                updateCharCount();
            } else { alert("AI ì‘ë‹µ ì—†ìŒ"); }
        } catch (e) { alert("ìƒì„± ì‹¤íŒ¨"); } 
        finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-pen-nib"></i> ì´ì–´ì“°ê¸°';
        }
    }

    async function openAiEdit(mode) {
        const editor = document.getElementById('mainEditor');
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);

        if (!selectedText.trim()) return alert("ìˆ˜ì •í•  ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");

        let instruction = "";
        if(mode === 'polish') instruction = "ë¬¸ì¥ì„ ë‹¤ë“¬ì–´ì¤˜.";
        if(mode === 'expand') instruction = "ë¬˜ì‚¬ë¥¼ í’ì„±í•˜ê²Œ ëŠ˜ë ¤ì¤˜.";
        if(mode === 'fix') instruction = "ë§ì¶¤ë²•ì„ êµì •í•´ì¤˜.";

        const modal = document.getElementById('aiDiffModal');
        modal.dataset.start = start;
        modal.dataset.end = end;

        try {
            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                    contents: [{
                        parts: [{ text: `ì›ë¬¸: ${selectedText}\nì§€ì‹œ: ${instruction}\nì¡°ê±´: ìˆ˜ì •ëœ ë¬¸ì¥ë§Œ ì¶œë ¥.` }]
                    }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            const newText = data.candidates[0].content.parts[0].text;

            document.getElementById('originalText').innerText = selectedText;
            document.getElementById('newText').innerText = newText;
            modal.dataset.newText = newText;
            modal.style.display = 'flex';

        } catch (e) { alert("AI ìš”ì²­ ì‹¤íŒ¨"); }
    }

    function closeAiModal() { document.getElementById('aiDiffModal').style.display = 'none'; }

    function applyAiChange() {
        const modal = document.getElementById('aiDiffModal');
        const newText = modal.dataset.newText;
        const start = parseInt(modal.dataset.start);
        const end = parseInt(modal.dataset.end);
        const editor = document.getElementById('mainEditor');
        editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
        updateCharCount();
        closeAiModal();
    }

    init();
</script>

</body>
</html>