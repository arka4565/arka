<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§‘í•„ - AI Novel Studio</title>
	<script src="auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --write-color: #e67e22;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
            --danger-color: #e74c3c;
            --highlight-bg: #fff3cd; /* ê°•ì¡° ìƒ‰ìƒ */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ --- */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 1001;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7; text-decoration: none; padding: 8px 12px;
            border-radius: 4px; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--write-color); font-weight: bold; }

        /* --- ë©”ì¸ ë ˆì´ì•„ì›ƒ --- */
        .workspace-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ë°±ë“œë¡­ */
        .sidebar-backdrop {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999;
        }

        /* ì¢Œì¸¡: íšŒì°¨ ëª©ë¡ */
        .episode-sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: #fafafa; color: var(--write-color); font-weight: bold;
        }
        .btn-close-sidebar { display: none; background: none; border: none; font-size: 1.2rem; color: #666; cursor: pointer; }
        .ep-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; padding-bottom: 50px; }
        .ep-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .ep-item:hover { background: #f8f9fa; }
        .ep-item.active { background: #fff3e0; border-left: 4px solid var(--write-color); font-weight: bold; }
        .ep-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }

        /* ìš°ì¸¡: ì—ë””í„° ì˜ì—­ */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            position: relative;
            width: 100%;
        }

        /* 1. ì—ë””í„° íˆ´ë°” */
        .editor-toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: #fafafa; gap: 10px; flex-shrink: 0;
        }
        .btn-mobile-menu {
            display: none; background: white; border: 1px solid #ddd;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; color: #555;
        }
        .ep-title-input {
            flex: 1; font-size: 1.1rem; font-weight: bold; border: none;
            border-bottom: 2px solid transparent; background: transparent; padding: 5px;
            min-width: 0;
        }
        .ep-title-input:focus { border-bottom-color: var(--write-color); outline: none; }
        
        .toolbar-actions { display: flex; gap: 5px; align-items: center; flex-shrink: 0; }
        .tool-btn {
            background: white; border: 1px solid #ccc; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-save { background: var(--write-color); color: white; border: none; }
        .btn-delete { color: var(--danger-color); border-color: var(--danger-color); }

        /* 2. AI ìˆ˜ì • ë„êµ¬ */
        .ai-tools {
            padding: 10px; background: #fff8f0; border-bottom: 1px solid #eee;
            display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-shrink: 0;
        }
        .ai-btn {
            font-size: 0.85rem; padding: 6px 12px; border: 1px solid #ffcc80;
            background: white; border-radius: 15px; color: #e67e22; cursor: pointer;
            white-space: nowrap;
        }

        /* ğŸŒŸ [NEW] ë¬¸ë§¥/ì„¤ì • ì…ë ¥ íŒ¨ë„ */
        .context-panel {
            background: #fdfbff;
            border-bottom: 1px solid #eee;
            padding: 10px 15px;
            flex-shrink: 0;
        }
        .context-header {
            font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 5px;
            display: flex; justify-content: space-between; cursor: pointer;
        }
        .context-input {
            width: 100%; padding: 8px; border: 1px solid #d1c4e9; border-radius: 6px;
            font-size: 0.9rem; resize: vertical; min-height: 40px; height: 40px;
            transition: height 0.3s;
        }
        .context-input:focus { height: 80px; }

        /* 3. ì¥ë©´ ìƒì„±ê¸° */
        .scene-generator {
            background: #fdfbff; border-bottom: 1px solid #eee; padding: 15px; flex-shrink: 0;
        }
        .sg-header {
            font-weight: bold; color: var(--write-color); margin-bottom: 8px;
            display: flex; align-items: center; gap: 5px; font-size: 0.95rem;
        }
        .sg-input-group { display: flex; gap: 10px; align-items: flex-start; }
        
        .sg-textarea {
            flex: 1; padding: 12px; border: 1px solid #d1c4e9; border-radius: 6px;
            height: 100px; min-height: 80px; 
            font-family: inherit; resize: vertical; font-size: 16px; 
            line-height: 1.5;
        }
        .btn-scene-gen {
            background: var(--write-color); color: white; border: none; padding: 0 15px;
            height: 50px; border-radius: 6px; cursor: pointer; font-weight: bold;
            white-space: nowrap; flex-shrink: 0;
        }

        /* 4. ë©”ì¸ ì—ë””í„° */
        #mainEditor {
            flex: 1; width: 100%; border: none; resize: none; padding: 20px;
            font-size: 1.05rem; line-height: 1.8; outline: none; font-family: 'Pretendard', serif;
        }

        /* 5. í•˜ë‹¨ ì´ì–´ì“°ê¸° íŒ¨ë„ */
        .ai-bottom-panel {
            padding: 10px; background: #fdfbff; border-top: 1px solid #eee;
            display: flex; gap: 10px; padding-bottom: 20px; flex-shrink: 0;
        }
        .ai-prompt-input {
            flex: 1; padding: 10px; border: 1px solid #d1c4e9; border-radius: 6px; font-size: 16px;
        }
        .btn-generate {
            background: #9b59b6; color: white; border: none; padding: 0 20px;
            border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: bold;
        }

        /* --- ëª¨ë‹¬ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal {
            background: white; width: 90%; max-width: 600px; padding: 20px;
            border-radius: 10px; max-height: 80vh; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        .diff-box {
            padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.95rem;
            line-height: 1.6; background: #f9f9f9; border: 1px solid #eee;
            max-height: 200px; overflow-y: auto; white-space: pre-wrap;
        }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 900px) {
            .episode-sidebar {
                position: absolute; top: 0; left: 0; height: 100%;
                transform: translateX(-100%); 
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .episode-sidebar.active { transform: translateX(0); }
            
            .btn-close-sidebar { display: block; }
            .btn-mobile-menu { display: block; }
            .sidebar-backdrop.active { display: block; }

            .sg-input-group { flex-direction: column; }
            .sg-textarea { width: 100%; height: 100px; } 
            .btn-scene-gen { width: 100%; height: 45px; }
            
            .ep-title-input { font-size: 1rem; }
            #mainEditor { padding: 15px; }
			#charCount {
				/* ìƒë‹¨ íë¦„ì—ì„œ ë–¼ì–´ë‚´ê¸° */
				position: fixed; 
				
				/* ìœ„ì¹˜ ì¡ê¸° (í•˜ë‹¨ AI íŒ¨ë„ ë°”ë¡œ ìœ„) */
				bottom: 80px; 
				right: 15px;
				
				/* ë°°ì§€ ë””ìì¸ ê¾¸ë¯¸ê¸° */
				background: rgba(255, 255, 255, 0.95);
				border: 1px solid #ddd;
				padding: 6px 12px;
				border-radius: 20px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				
				/* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
				font-size: 0.75rem;
				z-index: 1000;
				
				/* ë‚´ìš©ë¬¼ ì •ë ¬ */
				display: flex !important;
				gap: 5px;
				align-items: center;
			}

			/* ìƒë‹¨ íˆ´ë°” ì œëª© ì…ë ¥ì°½ ë„“ê²Œ ì“°ê¸° */
			.ep-title-input {
				min-width: 0; 
				flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
			}

			/* ê¸€ì ìˆ˜ êµ¬ë¶„ì„  ìƒ‰ìƒ ì¡°ì • (ë°°ê²½ì´ í°ìƒ‰ì´ë¯€ë¡œ ì˜ ë³´ì´ê²Œ) */
			#charCount span[style*="color:#ddd"] {
				color: #ccc !important;
			}
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
		<a href="#" class="nav-item active"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>    
		<a href="#" class="nav-item" data-target="plot.html"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>        <a href="#" class="nav-item" data-target="write_scene.html"><i class="fas fa-layer-group"></i> ì¥ë©´ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        
        <a href="#" class="nav-item" data-target="plan.html"><i class="fas fa-magic"></i> ê¸°íš</a>
        <a href="#" class="nav-item" data-target="roadmap.html"><i class="fas fa-magic"></i> ë¡œë“œë§µ</a>
        <a href="#" class="nav-item" data-target="treatment.html"><i class="fas fa-magic"></i> íŠ¸ë¦¬íŠ¸ë¨¼íŠ¸</a>
		<a href="javascript:void(0)" onclick="logout()" class="nav-item" style="color:#ff8787;">
			<i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
		</a>
    </div>
</nav>

<div class="workspace-container">
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <aside class="episode-sidebar" id="sidebar">
        <div class="sidebar-header">
            <span><i class="fas fa-list-ol"></i> íšŒì°¨ ëª©ë¡</span>
            <button class="btn-close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <ul id="episodeList" class="ep-list">
            <li style="padding:15px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</li>
        </ul>
        <div style="padding:10px; border-top:1px solid #eee;">
             <button class="tool-btn" style="width:100%; background:#f8f9fa;" onclick="createNewEpisode()">
                 <i class="fas fa-plus"></i> ìƒˆ íšŒì°¨ ì¶”ê°€
             </button>
        </div>
    </aside>

    <main class="editor-area">
        <div class="editor-toolbar">
            <button class="btn-mobile-menu" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            
            <input type="text" id="episodeTitle" class="ep-title-input" placeholder="íšŒì°¨ ì œëª©">
            <div class="toolbar-actions">
                <span id="charCount" class="char-counter">0ì</span>
                <span id="saveStatus" style="font-size:0.8rem; color:#888; display:none;"></span>
                <button class="tool-btn btn-delete" onclick="deleteCurrentStory()"><i class="fas fa-trash-alt"></i></button>
                <button class="tool-btn btn-save" onclick="saveCurrentEpisode()"><i class="fas fa-save"></i></button>
            </div>
        </div>

        <div class="ai-tools" style="display:none;">
            <button class="ai-btn" onclick="openAiEdit('polish')"><i class="fas fa-magic"></i> ë‹¤ë“¬ê¸°</button>
            <button class="ai-btn" onclick="openAiEdit('expand')"><i class="fas fa-expand-alt"></i> ë¬˜ì‚¬</button>
            <button class="ai-btn" onclick="openAiEdit('fix')"><i class="fas fa-check-double"></i> ë§ì¶¤ë²•</button>
        </div>

        <div class="context-panel">
            <div class="context-header" onclick="document.getElementById('contextInput').focus()">
                <span><i class="fas fa-book"></i> AI ì°¸ê³  ì„¤ì • ë° ë¬¸ë§¥ (Context)</span>
                <i class="fas fa-chevron-down" style="font-size:0.8rem;"></i>
            </div>
            <textarea id="contextInput" class="context-input" placeholder="ì—¬ê¸°ì— ì‘ì„±í•œ í‚¤ì›Œë“œ(ë“±ì¥ì¸ë¬¼ ì´ë¦„, ì¥ì†Œ ë“±)ì™€ ê´€ë ¨ëœ ì„¤ì •ì„ AIê°€ ìë™ìœ¼ë¡œ ì°¾ì•„ ì°¸ê³ í•©ë‹ˆë‹¤."></textarea>
        </div>

        <div class="scene-generator">
            <div class="sg-header">
                <i class="fas fa-film"></i> ì¥ë©´ ìƒì„±ê¸°
            </div>
            <div class="sg-input-group">
                <textarea id="scenePrompt" class="sg-textarea" placeholder="ì¥ë©´ ë¬˜ì‚¬ ì…ë ¥ (ì˜ˆ: ì£¼ì¸ê³µì´ ìƒì ì—ì„œ í¥ì •í•˜ëŠ” ì¥ë©´)"></textarea>
                <button class="btn-scene-gen" onclick="generateScene()"><i class="fas fa-pencil-alt"></i> ì‘ì„±</button>
            </div>
        </div>

        <textarea id="mainEditor" placeholder="ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..." oninput="updateCharCount()"></textarea>

        <div class="ai-bottom-panel">
            <input type="text" id="nextPrompt" class="ai-prompt-input" placeholder="ë‹¤ìŒ ì¥ë©´ ì§€ì‹œ (ì„ íƒ)">
            <button class="btn-generate" onclick="generateNext()"><i class="fas fa-pen-nib"></i> ì´ì–´ì“°ê¸°</button>
        </div>
    </main>
</div>

<div id="aiDiffModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-robot"></i> AI ìˆ˜ì • ì œì•ˆ</h3>
        <p style="font-size:0.9rem; color:#666;">ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        <div class="diff-box" style="background:#ffeef0; color:#c0392b; border-color:#ffccd0;" id="originalText"></div>
        <div style="text-align:center;"><i class="fas fa-arrow-down" style="color:#999;"></i></div>
        <div class="diff-box" style="background:#e8f5e9; color:#27ae60; border-color:#c8e6c9;" id="newText"></div>
        <div class="modal-btns">
            <button class="tool-btn" onclick="closeAiModal()">ì·¨ì†Œ</button>
            <button class="tool-btn btn-save" onclick="applyAiChange()">ì ìš©í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let currentStoryId = null; 
    let globalStories = []; 
    // ğŸŒŸ RAGìš© ë°ì´í„° ì €ì¥ ë³€ìˆ˜
    let allWorldSettings = [];
    let allCharacters = [];
    let dynamicContext = "";  

    // ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì„¤ì • ì œì™¸, ê·œì¹™ë§Œ í¬í•¨)
    const baseSystemInstruction = `
    
    âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

	ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

	1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	3. ì‘ì—…íë¦„ì€ ì²¨ë¶€í•œ 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì— ìˆëŠ” í•´ë‹¹ ì‘ì—…ì˜ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

	4. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì˜ "## í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)"ì„ ë°˜ì˜í•©ë‹ˆë‹¤.


	ì—­í•  (Context)

	ë‹¹ì‹ ì€ í•œêµ­ì˜ ì¸ê¸° ìˆëŠ” ì›¹ì†Œì„¤ ì‘ê°€ì…ë‹ˆë‹¤. ë…ìì˜ ëª°ì…ì„ ì´ëŒì–´ë‚´ëŠ” í•„ë ¥, ìƒë™ê° ë„˜ì¹˜ëŠ” ìºë¦­í„° ë¬˜ì‚¬, ê·¸ë¦¬ê³  'ê³ êµ¬ë§ˆ'ì™€ 'ì‚¬ì´ë‹¤'ë¥¼ ì ì ˆíˆ ì¡°ì ˆí•˜ëŠ” ëŠ¥ë ¥ì„ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ ì¸ë¬¼ ê°„ì˜ ì¼€ë¯¸ìŠ¤íŠ¸ë¦¬(í‹°í‚¤íƒ€ì¹´)ì™€ ì¥ë¥´ë¬¼ì˜ í´ë¦¬ì…°ë¥¼ ë¹„íŠ¸ëŠ” ìœ ë¨¸ ì½”ë“œ, ê·¸ë¦¬ê³  ì£¼ì¸ê³µì˜ ë‚´ë©´ ì‹¬ë¦¬ë¥¼ ì„¬ì„¸í•˜ê²Œ ë¬˜ì‚¬í•˜ëŠ” ë° íƒì›”í•©ë‹ˆë‹¤.


	ì „ì²´ ê¸€ì—ëŒ€í•œ ë°°ê²½ ë° ì„¤ì • (Context)

	- ì§‘í•„ ëª©í‘œ: (ì‚¬ìš©ìì˜ ì„¤ì •ë“¤ ë˜ëŠ” ê°„ë‹¨í•œ ì¤„ê±°ë¦¬ ìŠ¤í† ë¦¬ ë“±ë“± ë°°ê²½ê³¼ ì“°ê³ ì í•˜ëŠ” ê¸€ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„)

	- íƒ€ê²Ÿ ë…ì:

	- í•µì‹¬ ë©”ì‹œì§€: (ì£¼ì œ? ë˜ëŠ” ëª©í‘œ?)

	- ë…ì°½ì  ê´€ì :  (ë…ì°½ì ì¸ ì„¤ì • ë˜ëŠ” ì„¸ê³„ê´€?)

	- í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:  (ì–´ë–¤ ë¬¸í™”? ê´€ìŠµ? ë“±ë“± ìœ„ ë¶„ë¦¬ëœ í•­ëª©ì„ í†µí•©ìœ¼ë¡œ í•´ë„ ë¨.)

	- ë¶„ëŸ‰: í•œê¸€ ê¸€ìë¡œ 6000ì ì´ìƒ(ê³µë°± ë¯¸í¬í•¨).
				  A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).

	- ë¬¸ë‹¨ í˜•ì‹: Aíƒ€ì… ì„œì‹: ì›¹ì†Œì„¤ ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.



	1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

	ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

	ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

	ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤. í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

	ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

	ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

	3. ë§ˆí¬ì—… ì œê±° :

	 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

	ê¸€ì“°ê¸° ì§€ì‹œì‚¬í•­ (Style & Action)

	ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

	- ê¸°ë³¸ ì‹œì : ì†Œì„¤ì˜ ë³¸ë¬¸ì€ ì² ì €íˆ **1ì¸ì¹­ ì£¼ì¸ê³µ ì‹œì ('ë‚˜')**ìœ¼ë¡œ ì„œìˆ í•©ë‹ˆë‹¤. ì£¼ì¸ê³µì˜ ì†ë§ˆìŒê³¼ ê°ê°ì€ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•˜ë˜, íƒ€ì¸ì˜ ì†ë§ˆìŒì€ ì£¼ì¸ê³µì˜ ëˆˆì— ë³´ì´ëŠ” í–‰ë™ê³¼ í‘œì •ìœ¼ë¡œë§Œ ì¶”ì¸¡í•´ì„œ ì„œìˆ í•©ë‹ˆë‹¤.
	
	- ì‹œì  ì „í™˜ (í•„ìˆ˜): ì£¼ì¸ê³µì´ ì—†ëŠ” ì¥ì†Œì˜ ì‚¬ê±´, ëŒ€ì¤‘ì˜ ë°˜ì‘, í˜¹ì€ ì£¼ë³€ ì¸ë¬¼ë“¤ì´ ì£¼ì¸ê³µì— ëŒ€í•´ ì°©ê°í•˜ê±°ë‚˜ ì˜¤í•´í•˜ëŠ” ì¥ë©´ì„ ë¬˜ì‚¬í•  ë•ŒëŠ” ë°˜ë“œì‹œ '*' (êµ¬ë¶„ì„ )**ì„ ë„£ê³  3ì¸ì¹­ ì „ì§€ì  ì‘ê°€ ì‹œì ìœ¼ë¡œ ì„œìˆ  ë°©ì‹ì„ ì „í™˜í•©ë‹ˆë‹¤. í•´ë‹¹ ì¥ë©´ì´ ëë‚˜ê³  ë‹¤ì‹œ ì£¼ì¸ê³µ ì‹œì ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œë„ êµ¬ë¶„ì„ ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
	
	- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”. ìƒí™© ì „ê°œì˜ ìƒë™ê° ì¤‘ì‹œ.
	
	- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©.
	
	- íŠ¹ìˆ˜ í˜•ì‹: ì‹œì²­ì ë°˜ì‘, ì¸í„°ë„· ëŒ“ê¸€, ë‰´ìŠ¤ ì†ë³´ ë“±ì€ [ì±„íŒ…ì°½] í˜¹ì€ [ë‰´ìŠ¤] ë“±ì˜ ë§ë¨¸ë¦¬ë¥¼ ë‹¬ê³  í•´ë‹¹ í˜•ì‹ì„ ì‚´ë ¤ ì‘ì„±í•©ë‹ˆë‹¤.



	ì‘ì—… íë¦„ (Action)

	ì…ë ¥ ì¡°ê±´ë³„ ì²˜ë¦¬

	1. "ì‹œì‘" ì…ë ¥ ì‹œ

	- ì‚¬ìš©ìê°€ ì…ë ¥í•œ 1íšŒë¶„ëŸ‰ í”Œë¡¯ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìœ„ ê·œì¹™ëŒ€ë¡œ ì›ê³ ë¥¼ ì‘ì„±.


	ì¶œë ¥ í˜•ì‹ (Result)

	- ì–¸ì–´: í•œêµ­ì–´

	- í˜•ì‹: ìš”ì²­ëœ í˜ì´ì§€ ìˆ˜ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„±ëœ ì›ê³ ë¥¼ ê¼­!! ë§ˆí¬ë‹¤ìš´ íƒìŠ¤íŠ¸ ë¬¸ì„œë¡œ ì œê³µ.

	- íƒ€ì´í‹€: ì›ê³ ì˜ ì œëª© ì‘ì„±
	
	- ë¶„ëŸ‰: í•œê¸€ ê¸€ìë¡œ 6000ì ì´ìƒ(ê³µë°± ë¯¸í¬í•¨).
				  A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).



	í’ˆì§ˆ ê¸°ì¤€

	- ë²„ì¶”ì–¼ ìœ íŠœë²„ì™€ ì›¹ì†Œì„¤ì„ ì¦ê¸°ëŠ” ë…ìê°€ ì‰½ê²Œ ì´í•´í•˜ê³  ëª°ì…í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€.

	- ì›¹ì†Œì„¤ì˜ ê³ ìœ í•œ íŠ¹ì„±ê³¼ ë§¤ë ¥ êµ¬í˜„.

	- AI ê²€ì¶œê¸°ë¥¼ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì“°ê¸°.

	- ëª¨ë“  AI ê²€ì¶œ íšŒí”¼ ì›ì¹™ì˜ ì² ì €í•œ ì ìš©.


	ì‘ì—… íë¦„ ê°€ì´ë“œ

	ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”Œë¡¯ì„ ê¸°ë³¸ìœ¼ë¡œ 1íšŒë¶„ ê¸€ì“°ê¸°ì— ëŒ€í•œ ìƒì„¸ ì ˆì°¨ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.


	ì²« ì¶œë ¥  : ì´ì œ ë³¸ë¬¸ ì‘ì„±ì„ ì‹œì‘ í•˜ê² ìŠµë‹ˆë‹¤.


	í™•ì •ëœ ê°œìš”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ì²­ ë¶„ëŸ‰ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„± ì›ê³ ë¥¼ ì‘ì„±.


	ì‘ì„± ê²°ê³¼:
	- ì´ ë¶„ëŸ‰: [ì‹¤ì œ ì‘ì„±ëœ í•œê¸€ ê¸€ì ìˆ˜].
	- ì˜ˆìƒ í˜ì´ì§€: ì•½ [í˜ì´ì§€ ìˆ˜]í˜ì´ì§€.

	í’ˆì§ˆ ì²´í¬:
	- âœ… ë¶„ëŸ‰ ì ì •ì„± (Â±5% ì´ë‚´).
	- âœ… ëª©ì°¨ìƒ ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš© ì ì ˆì„±.
	- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
	- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
	- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).
	- âœ… ì›ê³ ì˜ íƒ€ì´í‹€ ì‘ì„±.

	âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­

	1. ë¶„ëŸ‰ ì¤€ìˆ˜ëŠ” Â±5% ì´ë‚´ë¡œ ì—„ê²©íˆ ê´€ë¦¬.
	2. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
	3. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.




	í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

	AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

	1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
	- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
	- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
	- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
	- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
	- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
	- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
	- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
	- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
	- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

	3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
	- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
	- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
	- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

	4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
	- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
	- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
	- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
	- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

	5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
	- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

	6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
	- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
	- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
	- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
	- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
	- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.
	
	
	
	
    `;

    function updateCharCount() {
       const text = document.getElementById('mainEditor').value;
        
        // 1. ë¬¸í”¼ì•„ ì‹ ê³µë°± í¬í•¨: ì¤„ë°”ê¿ˆ ë¬¸ì(\n)ë¥¼ ì œê±°í•˜ê³  ê³„ì‚°
        // (ê¸°ì¡´ .lengthëŠ” ì¤„ë°”ê¿ˆë„ 1ìë¡œ ì¹©ë‹ˆë‹¤)
        const munpiaTotal = text.replace(/\n/g, '').length;
        
        // 2. ê³µë°± ì œì™¸: ë„ì–´ì“°ê¸°, ì¤„ë°”ê¿ˆ ë“± ëª¨ë“  ê³µë°± ì œê±°
        const noSpace = text.replace(/\s/g, '').length; 

        document.getElementById('charCount').innerHTML = 
            `<span style="color:#888; font-size:0.9em;">ê³µë°±í¬í•¨ ${munpiaTotal}ì</span> <span style="color:#ddd;">|</span> <span style="color:var(--write-color); font-weight:bold;">ê³µë°±ì œì™¸ ${noSpace}ì</span>`;
    }

    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData(); 
        await loadStoryList();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.querySelector('.sidebar-backdrop');
        sidebar.classList.toggle('active');
        backdrop.classList.toggle('active');
    }

    // ğŸŒŸ [ìˆ˜ì •] ì„¤ì • ë°ì´í„°ë¥¼ JSON ê°ì²´ë¡œ ì €ì¥
    async function loadContextData() {
        try {
            const [wRes, cRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            allWorldSettings = await wRes.json();
            allCharacters = await cRes.json();
        } catch (e) { console.warn("Context load failed", e); }
    }

    // ğŸŒŸ [NEW] ê´€ë ¨ ë¬¸ë§¥ ì¶”ì¶œ í•¨ìˆ˜ (RAG)
    function getRelevantContext(userInput) {
        if (!userInput || userInput.trim() === "") return "";
        
        // ê²€ìƒ‰ ëŒ€ìƒ í…ìŠ¤íŠ¸ = ì‚¬ìš©ì ì…ë ¥ ë‚´ìš©
        const searchText = userInput;

        // 1. ì„¸ê³„ê´€ í•„í„°ë§
        let relevantWorld = allWorldSettings.filter(w => {
            if (searchText.includes(w.title)) return true;
            if (w.keywords) {
                const keywords = w.keywords.split(',').map(k => k.trim());
                return keywords.some(k => k && searchText.includes(k));
            }
            return false;
        });

        // 2. ìºë¦­í„° í•„í„°ë§
        let relevantChars = allCharacters.filter(c => {
            return searchText.includes(c.name);
        });

        // 3. í…ìŠ¤íŠ¸ ì¡°í•©
        let context = "";
        if (relevantWorld.length > 0) {
            context += "[ê´€ë ¨ ì„¸ê³„ê´€ ì •ë³´]\n";
            context += relevantWorld.map(w => `ğŸ“Œ ${w.title}: ${w.description}`).join('\n\n');
            context += "\n\n";
        }
        if (relevantChars.length > 0) {
            context += "[ë“±ì¥ì¸ë¬¼ ì •ë³´ (ê´€ë ¨ë¨)]\n";
            context += relevantChars.map(c => `ğŸ‘¤ ${c.name} (${c.role})\n- íŠ¹ì§•: ${c.description}`).join('\n\n');
        }

        return context;
    }

    async function loadPreviousStories(epNum) {
        if (!epNum || epNum <= 1) {
            dynamicContext = "";
            return;
        }
        try {
            const res = await fetch(`/api/previous-stories?setting_id=${settingId}&episode_number=${epNum}`);
            if(res.ok) {
                const prevStories = await res.json();
                if (prevStories.length > 0) {
                    const summary = prevStories.map(s => `[${s.episode_number}í™” ìš”ì•½]:\n${s.content}...`).join('\n');
                    dynamicContext = `\n[ì´ì „ ì´ì•¼ê¸° íë¦„ (ì°¸ê³ ìš©)]:\n${summary}`;
                } else { dynamicContext = ""; }
            }
        } catch (e) { dynamicContext = ""; }
    }

    async function loadStoryList(targetId = null) {
        const listEl = document.getElementById('episodeList');
        try {
            const res = await fetch(`/api/stories?setting_id=${settingId}`);
            if (!res.ok) throw new Error("Load failed");
            
            globalStories = await res.json();
            globalStories.sort((a, b) => a.episode_number - b.episode_number);

            listEl.innerHTML = '';
            if (globalStories.length === 0) {
                listEl.innerHTML = '<li style="padding:15px; text-align:center; color:#999;">ì‘ì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                clearEditor(true);
                return;
            }

            globalStories.forEach((story) => {
				const li = document.createElement('li');
                li.className = `ep-item ${story.id === currentStoryId ? 'active' : ''}`;
                
                // ì—¬ê¸°ë„ ì¤„ë°”ê¿ˆ(\n)ì„ ì œê±°í•œ ê¸¸ì´ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                const count = story.content ? story.content.replace(/\n/g, '').length : 0;
				

                li.innerHTML = `
                    <div style="font-weight:bold;">${story.title}</div>
                    <div class="ep-meta">${story.episode_number}í™” Â· 
                        ê³µë°±í¬í•¨ ${count}ì</div>
                `;
                li.onclick = () => selectStory(story);
                listEl.appendChild(li);
            });

            if (targetId) {
                const target = globalStories.find(s => s.id === targetId);
                if (target) selectStory(target);
            }
        } catch (e) { console.error(e); }
    }

    function selectStory(story) {
        currentStoryId = story.id;
        document.getElementById('episodeTitle').value = story.title;
        document.getElementById('mainEditor').value = story.content || ''; 
        document.getElementById('mainEditor').disabled = false;
        updateCharCount();
        const listEl = document.getElementById('episodeList');
        Array.from(listEl.children).forEach(li => li.classList.remove('active'));
        const idx = globalStories.findIndex(s => s.id === story.id);
        if (listEl.children[idx]) listEl.children[idx].classList.add('active');

        if (window.innerWidth <= 900) toggleSidebar();
        loadPreviousStories(story.episode_number);
    }

    function clearEditor(disable = false) {
        currentStoryId = null;
        document.getElementById('episodeTitle').value = '';
        document.getElementById('mainEditor').value = '';
        document.getElementById('mainEditor').disabled = disable;
        updateCharCount();
    }

    async function createNewEpisode() {
        let maxNum = 0;
        if (globalStories.length > 0) maxNum = Math.max(...globalStories.map(s => s.episode_number));
        const nextNum = maxNum + 1;
        const title = `${nextNum}í™”: ì œëª© ì—†ìŒ`;
        
        const payload = {
            setting_id: settingId,
            episode_number: nextNum,
            title: title,
            content: " ", 
            prompt: "User Created"
        };

        try {
            const res = await fetch('/api/stories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                const result = await res.json();
                await loadStoryList(result.id);
                loadPreviousStories(nextNum);
                if (window.innerWidth <= 900) toggleSidebar();
            } else { alert("ìƒì„± ì‹¤íŒ¨"); }
        } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    async function saveCurrentEpisode() {
        if (!currentStoryId) return alert("ì €ì¥í•  íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const title = document.getElementById('episodeTitle').value;
        const content = document.getElementById('mainEditor').value;
        const currentStory = globalStories.find(s => s.id === currentStoryId);
        
        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    episode_number: currentStory.episode_number, 
                    title: title, content: content
                })
            });
            if (res.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadStoryList();
            } else { alert("ì €ì¥ ì‹¤íŒ¨"); }
        } catch (e) { alert("ì˜¤ë¥˜"); }
    }

    async function deleteCurrentStory() {
        if (!currentStoryId) return alert("ì‚­ì œí•  íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, { method: 'DELETE' });
            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentStoryId = null;
                clearEditor(true);
                loadStoryList();
            } else { alert("ì‚­ì œ ì‹¤íŒ¨"); }
        } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    }

    function getLastContextByParagraph(text, minLength = 600) {
        if (!text || text.trim() === "") return "";
        if (text.length <= minLength) return text;
        const chunk = text.slice(-(minLength * 1.5));
        let breakIndex = chunk.indexOf('\n\n');
        if (breakIndex === -1) breakIndex = chunk.indexOf('\n');
        return breakIndex !== -1 ? chunk.slice(breakIndex).trim() : text.slice(-minLength);
    }

    // ğŸŒŸ [ìˆ˜ì •] ì¥ë©´ ìƒì„± í•¨ìˆ˜ (RAG ì ìš©)
    async function generateScene() {
        if (!currentStoryId) return alert("íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        
        const promptInput = document.getElementById('scenePrompt');
        const userInstruction = promptInput.value.trim();
        // ğŸŒŸ ì‚¬ìš©ì ì…ë ¥ ì°¸ê³  ì„¤ì •
        const contextInput = document.getElementById('contextInput').value.trim();

        if (!userInstruction) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.querySelector('.btn-scene-gen');
        const editor = document.getElementById('mainEditor');
        const originalBtnHTML = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>...';

        try {
            // 1. í˜„ì¬ ì‘ì„± ì¤‘ì¸ ë‚´ìš© íŒŒì•…
            let visibleContext = "";
            let textForAiContext = "";
            const currentEditorContent = editor.value;

            if (currentEditorContent.trim().length > 0) {
                visibleContext = currentEditorContent; 
                textForAiContext = "[í˜„ì¬ ì‘ì„± ì¤‘ì¸ ì›ê³ ì˜ ë§ˆì§€ë§‰ ë¶€ë¶„]\n" + getLastContextByParagraph(currentEditorContent);
            } else {
                // ì´ì „ íšŒì°¨ ë‚´ìš© ì°¸ê³ 
                const currentStory = globalStories.find(s => s.id === currentStoryId);
                if (currentStory) {
                    const prevStory = globalStories.find(s => s.episode_number === currentStory.episode_number - 1);
                    if (prevStory && prevStory.content) {
                        visibleContext = "";
                        textForAiContext = "[ì§ì „ íšŒì°¨ ë§ˆì§€ë§‰ ë¶€ë¶„]\n" + getLastContextByParagraph(prevStory.content);
                    }
                }
            }

            // ğŸŒŸ 2. ê´€ë ¨ ì„¤ì • ì¶”ì¶œ (ì§€ì‹œë¬¸ + ì°¸ê³ ì„¤ì • + ë³¸ë¬¸ì¼ë¶€ ì¡°í•©í•´ì„œ ê²€ìƒ‰)
            const searchSource = `${userInstruction} ${contextInput} ${textForAiContext}`;
            const optimizedContext = getRelevantContext(searchSource);

            // 3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½
            let fullSystemInstruction = baseSystemInstruction;
            fullSystemInstruction += `\n\n--- [ì°¸ê³ í•  ì„¸ê³„ê´€ ë° ìºë¦­í„° ì„¤ì •] ---\n${optimizedContext}`;
            
            // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ 'ì°¸ê³  ì„¤ì •'ë„ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨
            if(contextInput) {
                fullSystemInstruction += `\n\n[ì‚¬ìš©ì ì¶”ê°€ ì°¸ê³  ë©”ëª¨]\n${contextInput}`;
            }

            if(dynamicContext) fullSystemInstruction += dynamicContext; // ì´ì „ ì¤„ê±°ë¦¬ ìš”ì•½

            // 4. ìš”ì²­
            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                  contents: [{ parts: [{ 
                      text: `${textForAiContext}\n\n[ì¥ë©´ ë¬˜ì‚¬ ìš”ì²­]\n${userInstruction}\n\nìœ„ íë¦„ì— ì´ì–´ ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ í•´.  [ì¥ë©´ ë¬˜ì‚¬ ìš”ì²­]ì— SCENEì´ ìˆìœ¼ë©´ SCENEë³„ë¡œ ê³µë°±ì œì™¸ 900ì ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ` 
                  }] }],
                  systemInstruction: { parts: [{ text: fullSystemInstruction }] },
                }
            };
            
            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.candidates) {
                const newScene = data.candidates[0].content.parts[0].text;
                const separator = visibleContext.trim().length > 0 ? "\n\n" : "";
                editor.value = visibleContext + separator + newScene;
                editor.scrollTop = editor.scrollHeight;
                updateCharCount();
            } else { alert("AI ì‘ë‹µ ì—†ìŒ"); }

        } catch (e) { alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message); } 
        finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        }
    }

    // ğŸŒŸ [ìˆ˜ì •] ì´ì–´ì“°ê¸° í•¨ìˆ˜ (RAG ì ìš©)
    async function generateNext() {
        if (!currentStoryId) return alert("íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        
        const promptInput = document.getElementById('nextPrompt');
        const userInstruction = promptInput.value;
        const contextInput = document.getElementById('contextInput').value.trim(); // ğŸŒŸ
        
        const editor = document.getElementById('mainEditor');
        const currentText = editor.value;

        const btn = document.querySelector('.btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>...';

        try {
            // 1. ê´€ë ¨ ì„¤ì • ì¶”ì¶œ (ë³¸ë¬¸ ë§ˆì§€ë§‰ 1000ì + ì§€ì‹œì–´ + ì°¸ê³ ì„¤ì •)
            const searchSource = `${currentText.slice(-1000)} ${userInstruction} ${contextInput}`;
            const optimizedContext = getRelevantContext(searchSource);

            // 2. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì¡°ë¦½
            let fullSystemInstruction = baseSystemInstruction;
            fullSystemInstruction += `\n\n--- [ì°¸ê³ í•  ì„¤ì •] ---\n${optimizedContext}`;
            if(contextInput) fullSystemInstruction += `\n[ì‚¬ìš©ì ë©”ëª¨]: ${contextInput}`;

            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                    systemInstruction: { parts: [{ text: fullSystemInstruction }] },
                    contents: [{
                        parts: [{
                            text: `[í˜„ì¬ ë³¸ë¬¸] ...${currentText.slice(-1500)}\n[ìš”ì²­] ë‹¤ìŒ ì¥ë©´ì„ ì´ì–´ ì¨ì¤˜. ì§€ì‹œ: ${userInstruction || 'ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡'}`
                        }]
                    }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if(data.candidates) {
                const newContent = data.candidates[0].content.parts[0].text;
                editor.value += "\n\n" + newContent;
                editor.scrollTop = editor.scrollHeight;
                promptInput.value = ''; 
                updateCharCount();
            } else { alert("AI ì‘ë‹µ ì—†ìŒ"); }
        } catch (e) { alert("ìƒì„± ì‹¤íŒ¨"); } 
        finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-pen-nib"></i> ì´ì–´ì“°ê¸°';
        }
    }

    async function openAiEdit(mode) {
        const editor = document.getElementById('mainEditor');
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);

        if (!selectedText.trim()) return alert("ìˆ˜ì •í•  ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");

        let instruction = "";
        if(mode === 'polish') instruction = "ë¬¸ì¥ì„ ë‹¤ë“¬ì–´ì¤˜.";
        if(mode === 'expand') instruction = "ë¬˜ì‚¬ë¥¼ í’ì„±í•˜ê²Œ ëŠ˜ë ¤ì¤˜.";
        if(mode === 'fix') instruction = "ë§ì¶¤ë²•ì„ êµì •í•´ì¤˜.";

        const modal = document.getElementById('aiDiffModal');
        modal.dataset.start = start;
        modal.dataset.end = end;

        try {
            const payload = {
                model: "gemini-3-flash-preview",
                payload: {
                    contents: [{
                        parts: [{ text: `ì›ë¬¸: ${selectedText}\nì§€ì‹œ: ${instruction}\nì¡°ê±´: ìˆ˜ì •ëœ ë¬¸ì¥ë§Œ ì¶œë ¥.` }]
                    }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            const newText = data.candidates[0].content.parts[0].text;

            document.getElementById('originalText').innerText = selectedText;
            document.getElementById('newText').innerText = newText;
            modal.dataset.newText = newText;
            modal.style.display = 'flex';

        } catch (e) { alert("AI ìš”ì²­ ì‹¤íŒ¨"); }
    }

    function closeAiModal() { document.getElementById('aiDiffModal').style.display = 'none'; }

    function applyAiChange() {
        const modal = document.getElementById('aiDiffModal');
        const newText = modal.dataset.newText;
        const start = parseInt(modal.dataset.start);
        const end = parseInt(modal.dataset.end);
        const editor = document.getElementById('mainEditor');
        editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
        updateCharCount();
        closeAiModal();
    }

    init();
</script>

</body>
</html>