<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§‘í•„ - AI Novel Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --write-color: #e67e22; /* ì§‘í•„ ê°•ì¡°ìƒ‰ (ì£¼í™©ìƒ‰) */
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --nav-bg: #2c3e50;
            --nav-text: #ecf0f1;
            --border-color: #ddd;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ë„¤ë¹„ê²Œì´ì…˜ --- */
        .navbar {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-logo { font-weight: bold; font-size: 1.1rem; color: white; text-decoration: none; }
        .nav-links { display: flex; gap: 5px; overflow-x: auto; }
        .nav-item {
            color: #bdc3c7;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; background: var(--write-color); font-weight: bold; }

        /* --- ë©”ì¸ ë ˆì´ì•„ì›ƒ --- */
        .workspace-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ì¢Œì¸¡: íšŒì°¨ ëª©ë¡ */
        .episode-sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            color: var(--write-color);
            font-weight: bold;
        }
        .ep-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ep-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ep-item:hover { background: #f8f9fa; }
        .ep-item.active { background: #fff3e0; border-left: 4px solid var(--write-color); font-weight: bold; }
        .ep-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }

        /* ìš°ì¸¡: ì—ë””í„° ì˜ì—­ */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            position: relative;
        }

        /* 1. ì—ë””í„° íˆ´ë°” (ì œëª©, ì €ì¥) */
        .editor-toolbar {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }
        .ep-title-input {
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            padding: 5px;
            width: 100%;
            max-width: 600px;
            transition: border-color 0.3s;
        }
        .ep-title-input:focus { border-bottom-color: var(--write-color); outline: none; }
        
        .toolbar-actions { display: flex; gap: 8px; align-items: center; }
        .tool-btn {
            background: white; border: 1px solid #ccc; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:hover { background: #eee; }
        .btn-save { background: var(--write-color); color: white; border: none; }
        .btn-save:hover { background: #d35400; }

        /* 2. AI ìˆ˜ì • ë„êµ¬ (ë¬¸ì¥ ë‹¤ë“¬ê¸° ë“±) */
        .ai-tools {
            padding: 8px 20px;
            background: #fff8f0;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        .ai-btn {
            font-size: 0.85rem; padding: 5px 12px; border: 1px solid #ffcc80;
            background: white; border-radius: 15px; color: #e67e22; cursor: pointer;
            white-space: nowrap; transition: background 0.2s;
        }
        .ai-btn:hover { background: #fff3e0; }

        /* 3. ì¥ë©´ ìƒì„±ê¸° (Scene Generator) */
        .scene-generator {
            background: #fdfbff;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
        }
        .sg-header {
            font-weight: bold;
            color: var(--write-color);
            margin-bottom: 8px;
            display: flex; align-items: center; gap: 5px;
            font-size: 0.95rem;
        }
        .sg-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .sg-textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1c4e9;
            border-radius: 6px;
            height: 60px;
            font-family: inherit;
            resize: vertical;
            font-size: 0.95rem;
        }
        .sg-textarea:focus { outline: 2px solid var(--write-color); border-color: transparent; }
        
        .btn-scene-gen {
            background: var(--write-color);
            color: white;
            border: none;
            padding: 0 20px;
            height: 60px; /* textareaì™€ ë†’ì´ ë§ì¶¤ */
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .btn-scene-gen:hover { background: #d35400; }

        /* 4. ë©”ì¸ í…ìŠ¤íŠ¸ ì—ë””í„° */
        #mainEditor {
            flex: 1;
            width: 100%;
            border: none;
            resize: none;
            padding: 30px 40px;
            font-size: 1.1rem;
            line-height: 1.8;
            outline: none;
            font-family: 'Pretendard', serif;
        }

        /* 5. í•˜ë‹¨ AI ì´ì–´ì“°ê¸° íŒ¨ë„ */
        .ai-bottom-panel {
            padding: 15px 20px;
            background: #fdfbff;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .ai-prompt-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1c4e9;
            border-radius: 6px;
        }
        .btn-generate {
            background: #9b59b6; color: white; border: none;
            padding: 0 20px; border-radius: 6px; cursor: pointer;
            white-space: nowrap;
        }
        .btn-generate:hover { background: #8e44ad; }

        /* --- ëª¨ë‹¬ (AI ìˆ˜ì • ê²°ê³¼) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 2000;
            justify-content: center; align-items: center;
        }
        .modal { background: white; width: 90%; max-width: 600px; padding: 25px; border-radius: 10px; }
        .diff-box { padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.95rem; line-height: 1.6; background: #f9f9f9; border: 1px solid #eee; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 900px) {
            .workspace-container { flex-direction: column; }
            .episode-sidebar { width: 100%; max-height: 150px; border-right: none; border-bottom: 1px solid #ddd; }
            #mainEditor { padding: 15px; }
            .ep-title-input { font-size: 1rem; }
            .sg-input-group { flex-direction: column; }
            .btn-scene-gen { width: 100%; height: 40px; }
            .sg-textarea { width: 100%; height: 60px; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="index.html" class="nav-logo"><i class="fas fa-chevron-left"></i> ëª©ë¡</a>
    </div>
    <div class="nav-links">
        <a href="#" class="nav-item" data-target="settings.html"><i class="fas fa-cog"></i> ì„¤ì •</a>
        <a href="#" class="nav-item" data-target="world.html"><i class="fas fa-globe"></i> ì„¸ê³„ê´€</a>
        <a href="#" class="nav-item" data-target="characters.html"><i class="fas fa-users"></i> ìºë¦­í„°</a>
        <a href="#" class="nav-item" data-target="plot.html"><i class="fas fa-project-diagram"></i> í”Œë¡¯</a>
        <a href="#" class="nav-item active"><i class="fas fa-pen-fancy"></i> ì§‘í•„</a>
        <a href="#" class="nav-item" data-target="edit.html"><i class="fas fa-magic"></i> ìƒì„¸í¸ì§‘</a>
    </div>
</nav>

<div class="workspace-container">
    <aside class="episode-sidebar">
        <div class="sidebar-header">
            <span><i class="fas fa-list-ol"></i> íšŒì°¨ ëª©ë¡</span>
            <button class="tool-btn" onclick="createNewEpisode()" title="ìƒˆ íšŒì°¨ ì¶”ê°€"><i class="fas fa-plus"></i></button>
        </div>
        <ul id="episodeList" class="ep-list">
            <li style="padding:15px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</li>
        </ul>
    </aside>

    <main class="editor-area">
        <div class="editor-toolbar">
            <input type="text" id="episodeTitle" class="ep-title-input" placeholder="íšŒì°¨ ì œëª© (ì˜ˆ: 1í™”. ì‹œì‘)">
           <div class="toolbar-actions">
                <span id="saveStatus" style="font-size:0.8rem; color:#888; margin-right:5px;"></span>
                <button class="tool-btn btn-delete" onclick="deleteCurrentStory()" title="í˜„ì¬ íšŒì°¨ ì‚­ì œ">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="tool-btn btn-save" onclick="saveCurrentEpisode()"><i class="fas fa-save"></i> ì €ì¥</button>
            </div>
        </div>

        <div class="ai-tools">
            <button class="ai-btn" onclick="openAiEdit('polish')"><i class="fas fa-magic"></i> ë¬¸ì¥ ë‹¤ë“¬ê¸°</button>
            <button class="ai-btn" onclick="openAiEdit('expand')"><i class="fas fa-expand-alt"></i> ë¬˜ì‚¬ ê°•í™”</button>
            <button class="ai-btn" onclick="openAiEdit('fix')"><i class="fas fa-check-double"></i> ë§ì¶¤ë²•/ì˜¤íƒ€</button>
        </div>

        <div class="scene-generator">
            <div class="sg-header">
                <i class="fas fa-film"></i> ì¥ë©´ ìƒì„±ê¸°
                <span style="font-size:0.8rem; color:#666; font-weight:normal; margin-left:5px;">ì›í•˜ëŠ” ìƒí™©ì„ ì…ë ¥í•˜ë©´ AIê°€ ì¥ë©´ì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤.</span>
            </div>
            <div class="sg-input-group">
                <textarea id="scenePrompt" class="sg-textarea" placeholder="ì˜ˆ: ì£¼ì¸ê³µì´ ìƒì ì—ì„œ ë¬¼ê±´ ê°’ì„ ê¹ìœ¼ë ¤ë‹¤ ì£¼ì¸ê³¼ ë§ë‹¤íˆ¼ì„ ë²Œì´ëŠ” ì¥ë©´"></textarea>
                <button class="btn-scene-gen" onclick="generateScene()"><i class="fas fa-pencil-alt"></i> ì¥ë©´ ì‘ì„±</button>
            </div>
        </div>

        <textarea id="mainEditor" placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>

        <div class="ai-bottom-panel">
            <input type="text" id="nextPrompt" class="ai-prompt-input" placeholder="AIì—ê²Œ ë‹¤ìŒ ì¥ë©´ì„ ì§€ì‹œí•˜ì„¸ìš” (ì˜ˆ: ëª¬ìŠ¤í„°ê°€ ê°‘ìê¸° ë“±ì¥í•¨)">
            <button class="btn-generate" onclick="generateNext()"><i class="fas fa-pen-nib"></i> ì´ì–´ì“°ê¸°</button>
        </div>
    </main>
</div>

<div id="aiDiffModal" class="modal-overlay">
    <div class="modal">
        <h3><i class="fas fa-robot"></i> AI ìˆ˜ì • ì œì•ˆ</h3>
        <p style="font-size:0.9rem; color:#666;">ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        
        <div class="diff-box" style="background:#ffeef0; color:#c0392b; border-color:#ffccd0;" id="originalText"></div>
        <div style="text-align:center;"><i class="fas fa-arrow-down" style="color:#999;"></i></div>
        <div class="diff-box" style="background:#e8f5e9; color:#27ae60; border-color:#c8e6c9;" id="newText"></div>

        <div class="modal-btns">
            <button class="tool-btn" onclick="closeAiModal()">ì·¨ì†Œ</button>
            <button class="tool-btn btn-save" onclick="applyAiChange()">ì ìš©í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const settingId = urlParams.get('setting_id');

    let currentStoryId = null; 
    let globalStories = []; 
    
    // AI ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ ë³€ìˆ˜
    let staticContext = "";   // ì„¸ê³„ê´€ + ìºë¦­í„° (ê³ ì •)
    let dynamicContext = "";  // ì´ì „ ì¤„ê±°ë¦¬ (íšŒì°¨ë³„ ë³€ë™)
    let contextData = "";     // ìµœì¢… í•©ë³¸

    // ì´ˆê¸°í™”
    async function init() {
        if (!settingId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = 'index.html';
            return;
        }
        setupNav();
        await loadContextData(); 
        await loadStoryList();
    }

    function setupNav() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const target = item.dataset.target;
            if (target) item.href = `${target}?setting_id=${settingId}`;
        });
    }
	let systemInstruction = `âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

	ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

	1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	3. ì‘ì—…íë¦„ì€ ì²¨ë¶€í•œ 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì— ìˆëŠ” í•´ë‹¹ ì‘ì—…ì˜ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

	4. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì˜ "## í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)"ì„ ë°˜ì˜í•©ë‹ˆë‹¤.


	ì—­í•  (Context)

	ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ë¶„ì•¼ì˜ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì‘ê°€ì´ì ì˜¤íƒ€ì¿  ë¬¸í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‹¬ì§€ì–´ ì¸í„°ë„· ë°©ì†¡, ë²„ì¸„ì–¼ ë°©ì†¡ ë“± ê´€ë ¨ ì‚¬ì—…ì— ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ìœ íŠœë¸Œë‚˜ ì‡¼ì¸ , í‹°í†¡ê´€ë ¨ ì»¨í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.


	ì „ì²´ ê¸€ì—ëŒ€í•œ ë°°ê²½ ë° ì„¤ì • (Context)

	- ì§‘í•„ ëª©í‘œ: (ì‚¬ìš©ìì˜ ì„¤ì •ë“¤ ë˜ëŠ” ê°„ë‹¨í•œ ì¤„ê±°ë¦¬ ìŠ¤í† ë¦¬ ë“±ë“± ë°°ê²½ê³¼ ì“°ê³ ì í•˜ëŠ” ê¸€ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„)

	- íƒ€ê²Ÿ ë…ì:

	- í•µì‹¬ ë©”ì‹œì§€: (ì£¼ì œ? ë˜ëŠ” ëª©í‘œ?)

	- ë…ì°½ì  ê´€ì :  (ë…ì°½ì ì¸ ì„¤ì • ë˜ëŠ” ì„¸ê³„ê´€?)

	- í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:  (ì–´ë–¤ ë¬¸í™”? ê´€ìŠµ? ë“±ë“± ìœ„ ë¶„ë¦¬ëœ í•­ëª©ì„ í†µí•©ìœ¼ë¡œ í•´ë„ ë¨.)

	- ë¶„ëŸ‰: í•œê¸€ ê¸€ìë¡œ ì•½ 7000ì (ê³µë°± ë¯¸í¬í•¨).
				  A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).

	- ë¬¸ë‹¨ í˜•ì‹: Aíƒ€ì… ì„œì‹: ì›¹ì†Œì„¤ ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.



	1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

	ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

	ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

	ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤. í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

	ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

	ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

	3. ë§ˆí¬ì—… ì œê±° :

	 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

	ê¸€ì“°ê¸° ì§€ì‹œì‚¬í•­ (Style & Action)

	ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

	- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
	- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.
	- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©, ê°ˆë“±ê³¼ í•´ê²°ì˜ ê·¹ì  êµ¬ì„±.
	- íŠ¹ìˆ˜ í˜•ì‹: ì‹œì²­ì(ë…ì) ê´€ë ¨ ì„œìˆ ì€ ì±„íŒ…ì°½ í˜•ì‹ìœ¼ë¡œ ìµœëŒ€í•œ ì±„íŒ…ì˜ ì¬ë¯¸ë¡œ ì„œìˆ .


	ì‘ì—… íë¦„ (Action)

	ì…ë ¥ ì¡°ê±´ë³„ ì²˜ë¦¬

	1. "ì‹œì‘" ì…ë ¥ ì‹œ

	- ì‚¬ìš©ìê°€ ì…ë ¥í•œ 1íšŒë¶„ëŸ‰ í”Œë¡¯ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìœ„ ê·œì¹™ëŒ€ë¡œ ì›ê³ ë¥¼ ì‘ì„±.


	ì¶œë ¥ í˜•ì‹ (Result)

	- ì–¸ì–´: í•œêµ­ì–´

	- í˜•ì‹: ìš”ì²­ëœ í˜ì´ì§€ ìˆ˜ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„±ëœ ì›ê³ ë¥¼ ê¼­!! ë§ˆí¬ë‹¤ìš´ íƒìŠ¤íŠ¸ ë¬¸ì„œë¡œ ì œê³µ.

	- íƒ€ì´í‹€: ì›ê³ ì˜ ì œëª© ì‘ì„±

	- ë¶„ëŸ‰: í•œê¸€ ê¸€ìë¡œ ì•½ 7000ì (ê³µë°± ë¯¸í¬í•¨).
				  A5 ê¸°ì¤€ ì•½ 10~12í˜ì´ì§€ (1í˜ì´ì§€ë‹¹ í•œê¸€ê¸°ì¤€ ê³µë°± ë¯¸í¬í•¨ 700ì).



	í’ˆì§ˆ ê¸°ì¤€

	- ë²„ì¶”ì–¼ ìœ íŠœë²„ì™€ ì›¹ì†Œì„¤ì„ ì¦ê¸°ëŠ” ë…ìê°€ ì‰½ê²Œ ì´í•´í•˜ê³  ëª°ì…í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€.

	- ì›¹ì†Œì„¤ì˜ ê³ ìœ í•œ íŠ¹ì„±ê³¼ ë§¤ë ¥ êµ¬í˜„.

	- AI ê²€ì¶œê¸°ë¥¼ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì“°ê¸°.

	- ëª¨ë“  AI ê²€ì¶œ íšŒí”¼ ì›ì¹™ì˜ ì² ì €í•œ ì ìš©.


	ì‘ì—… íë¦„ ê°€ì´ë“œ

	ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”Œë¡¯ì„ ê¸°ë³¸ìœ¼ë¡œ 1íšŒë¶„ ê¸€ì“°ê¸°ì— ëŒ€í•œ ìƒì„¸ ì ˆì°¨ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.


	ì²« ì¶œë ¥  : ì´ì œ ë³¸ë¬¸ ì‘ì„±ì„ ì‹œì‘ í•˜ê² ìŠµë‹ˆë‹¤.


	í™•ì •ëœ ê°œìš”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ì²­ ë¶„ëŸ‰ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„± ì›ê³ ë¥¼ ì‘ì„±.


	ì‘ì„± ê²°ê³¼:
	- ì´ ë¶„ëŸ‰: [ì‹¤ì œ ì‘ì„±ëœ í•œê¸€ ê¸€ì ìˆ˜].
	- ì˜ˆìƒ í˜ì´ì§€: ì•½ [í˜ì´ì§€ ìˆ˜]í˜ì´ì§€.

	í’ˆì§ˆ ì²´í¬:
	- âœ… ë¶„ëŸ‰ ì ì •ì„± (Â±5% ì´ë‚´).
	- âœ… ëª©ì°¨ìƒ ìœ„ì¹˜ì— ë§ëŠ” ë‚´ìš© ì ì ˆì„±.
	- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
	- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
	- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).
	- âœ… ì›ê³ ì˜ íƒ€ì´í‹€ ì‘ì„±.

	âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­

	1. ë¶„ëŸ‰ ì¤€ìˆ˜ëŠ” Â±5% ì´ë‚´ë¡œ ì—„ê²©íˆ ê´€ë¦¬.
	2. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
	3. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.




	í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

	AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

	1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
	- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
	- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
	- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
	- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
	- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

	2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
	- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
	- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
	- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
	- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

	3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
	- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
	- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
	- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

	4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
	- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
	- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
	- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
	- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

	5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
	- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
	- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
	- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

	6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
	- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
	- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
	- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
	- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
	- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.	
	`;

    // 1. ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ì„¸ê³„ê´€, ìºë¦­í„°) - ê³ ì •ê°’
    async function loadContextData() {
        try {
            const [wRes, cRes] = await Promise.all([
                fetch(`/api/worldsettings?setting_id=${settingId}`),
                fetch(`/api/characters?setting_id=${settingId}`)
            ]);
            const world = await wRes.json();
            const chars = await cRes.json();
			const worldText = 	world.map(s =>
				  `=== ${s.title} ===\n${s.description || 'ë‚´ìš© ì—†ìŒ'}`
		  ).join('\n\n---\n\n');
		  const charsText = chars.map(c =>
              `=== ${c.name} (ì—­í• : ${c.role || 'ë¯¸ì§€ì •'}) ===\n${c.description || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}`
			 ).join('\n\n---\n\n');
			 
            staticContext = `
            [ì„¸ê³„ê´€]: ${worldText}
            [ë“±ì¥ì¸ë¬¼]: ${charsText}
            `;
            
            contextData = staticContext;
        } catch (e) {
            console.warn("Context load failed", e);
        }
    }

    // 2. ë™ì  ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ì´ì „ ìŠ¤í† ë¦¬ ìš”ì•½) - íšŒì°¨ ì„ íƒ ì‹œ í˜¸ì¶œ
    async function loadPreviousStories(epNum) {
        if (!epNum || epNum <= 1) {
            dynamicContext = "";
            contextData = staticContext;
            return;
        }

        try {
            const res = await fetch(`/api/previous-stories?setting_id=${settingId}&episode_number=${epNum}`);
            if(res.ok) {
                const prevStories = await res.json();
                if (prevStories.length > 0) {
					// ğŸŒŸ [ìˆ˜ì •ë¨] ìë¥´ì§€ ì•Šê³  ì „ì²´ ë‚´ìš©(s.content)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    const summary = prevStories.map(s => {
                        return `[${s.episode_number}í™” ì „ì²´ ë‚´ìš©]:\n${s.content}\n`;
                    }).join('\n================\n');
                    dynamicContext = `\n[ì´ì „ ì´ì•¼ê¸° íë¦„]:\n${summary}`;
                } else {
                    dynamicContext = "";
                }
            }
        } catch (e) {
            console.warn("Previous stories load failed", e);
            dynamicContext = "";
        }
        // ìµœì¢… í•©ì¹˜ê¸°
        contextData = staticContext + dynamicContext;
    }

    // ëª©ë¡ ë¡œë“œ (GET /api/stories)
    async function loadStoryList(targetId = null) {
        const listEl = document.getElementById('episodeList');
        try {
            const res = await fetch(`/api/stories?setting_id=${settingId}`);
            if (!res.ok) throw new Error("Load failed");
            
            globalStories = await res.json();
            // 1í™”ë¶€í„° ì •ë ¬
            globalStories.sort((a, b) => a.episode_number - b.episode_number);

            listEl.innerHTML = '';
            if (globalStories.length === 0) {
                listEl.innerHTML = '<li style="padding:15px; text-align:center; color:#999; font-size:0.9rem;">ì‘ì„±ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.<br>+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</li>';
                clearEditor(true);
                return;
            }

            globalStories.forEach((story) => {
                const li = document.createElement('li');
                li.className = `ep-item ${story.id === currentStoryId ? 'active' : ''}`;
                li.innerHTML = `
                    <div style="font-weight:bold;">${story.title}</div>
                    <div class="ep-meta">${story.episode_number}í™” Â· ${story.content ? story.content.length : 0}ì</div>
                `;
                li.onclick = () => selectStory(story);
                listEl.appendChild(li);
            });

            // ìë™ ì„ íƒ
            if (targetId) {
                const target = globalStories.find(s => s.id === targetId);
                if (target) selectStory(target);
            } else if (!currentStoryId && globalStories.length > 0) {
                selectStory(globalStories[0]); // ì²« ì§„ì…ì‹œ 1í™” ì„ íƒ
            } else if (currentStoryId) {
                // UI ê°±ì‹  (active ë³µêµ¬)
                const current = globalStories.find(s => s.id === currentStoryId);
                if (current) {
                     const idx = globalStories.findIndex(s => s.id === currentStoryId);
                     if(listEl.children[idx]) listEl.children[idx].classList.add('active');
                }
            }

        } catch (e) {
            console.error(e);
            listEl.innerHTML = '<li style="color:red; padding:10px;">ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜</li>';
        }
    }

    function selectStory(story) {
        currentStoryId = story.id;
        document.getElementById('episodeTitle').value = story.title;
        document.getElementById('mainEditor').value = story.content || ''; 
        document.getElementById('mainEditor').disabled = false;
        
        // ëª©ë¡ ìŠ¤íƒ€ì¼ ê°±ì‹ 
        const listEl = document.getElementById('episodeList');
        Array.from(listEl.children).forEach(li => li.classList.remove('active'));
        const idx = globalStories.findIndex(s => s.id === story.id);
        if (listEl.children[idx]) listEl.children[idx].classList.add('active');

        // ğŸŒŸ [ì¤‘ìš”] í•´ë‹¹ íšŒì°¨ ë²ˆí˜¸ ê¸°ì¤€ ì´ì „ ìŠ¤í† ë¦¬ ë¡œë“œ
        loadPreviousStories(story.episode_number);
    }

    function clearEditor(disable = false) {
        currentStoryId = null;
        document.getElementById('episodeTitle').value = '';
        document.getElementById('mainEditor').value = '';
        document.getElementById('mainEditor').disabled = disable;
    }
	// ğŸŒŸ [ì¶”ê°€] í…ìŠ¤íŠ¸ì˜ ëë¶€ë¶„ì„ ë¬¸ë‹¨(\n) ë‹¨ìœ„ë¡œ ê¹”ë”í•˜ê²Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getLastContextByParagraph(text, minLength = 600) {
        if (!text || text.trim() === "") return "";

        // 1. ì „ì²´ ê¸¸ì´ê°€ ìµœì†Œ ê¸¸ì´ë³´ë‹¤ ì§§ìœ¼ë©´ ê·¸ëƒ¥ ë‹¤ ë°˜í™˜
        if (text.length <= minLength) return text;

        // 2. ëì—ì„œë¶€í„° (ìµœì†Œ ê¸¸ì´ * 1.5) ë§Œí¼ ë„‰ë„‰í•˜ê²Œ ì˜ë¼ëƒ„
        const chunk = text.slice(-(minLength * 1.5));

        // 3. ê·¸ ì•ˆì—ì„œ 'ì¤„ë°”ê¿ˆ(\n)'ì´ ì²˜ìŒ ë‚˜ì˜¤ëŠ” ìœ„ì¹˜ë¥¼ ì°¾ìŒ (ë¬¸ë‹¨ ì‹œì‘ì )
        // \n\n (ë¹ˆ ì¤„)ì´ ìˆìœ¼ë©´ ê±°ê¸°ê°€ ê°€ì¥ í™•ì‹¤í•œ ë¬¸ë‹¨ êµ¬ë¶„
        let breakIndex = chunk.indexOf('\n\n');
        
        // \n\nì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ \n(ì—”í„°)ì„ ì°¾ìŒ
        if (breakIndex === -1) {
            breakIndex = chunk.indexOf('\n');
        }

        // 4. ì¤„ë°”ê¿ˆì„ ì°¾ì•˜ìœ¼ë©´ ê·¸ ë’¤ë¶€í„° ëê¹Œì§€ ë°˜í™˜, ëª» ì°¾ì•˜ìœ¼ë©´ ê·¸ëƒ¥ ìë¥¸ê±° ë°˜í™˜
        if (breakIndex !== -1) {
            return chunk.slice(breakIndex).trim(); // ì•ë¶€ë¶„ ì°Œêº¼ê¸° ë²„ë¦¬ê³  ë°˜í™˜
        } else {
            return text.slice(-minLength); // ì¤„ë°”ê¿ˆì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ê¸€ììˆ˜ëŒ€ë¡œ ìë¦„
        }
    }

    // ìƒˆ íšŒì°¨ ìƒì„± (POST /api/stories)
    async function createNewEpisode() {
        let maxNum = 0;
        if (globalStories.length > 0) {
            maxNum = Math.max(...globalStories.map(s => s.episode_number));
        }
        const nextNum = maxNum + 1;
        const title = `${nextNum}í™”: ì œëª© ì—†ìŒ`;
        
        const payload = {
            setting_id: settingId,
            episode_number: nextNum,
            title: title,
            content: " ", // í•„ìˆ˜ê°’ ê³µë°± ì²˜ë¦¬
            prompt: "User Created"
        };

        try {
            const res = await fetch('/api/stories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                const result = await res.json();
                await loadStoryList(result.id);
                // ìƒˆ íšŒì°¨ ê¸°ì¤€ ì´ì „ ìŠ¤í† ë¦¬ ë¡œë“œ
                loadPreviousStories(nextNum);
                document.getElementById('episodeTitle').focus();
            } else {
                alert("ìƒì„± ì‹¤íŒ¨");
            }
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }

	

    // ì €ì¥ (PUT /api/stories/:id)
    async function saveCurrentEpisode() {
        if (!currentStoryId) {
            alert("ì €ì¥í•  íšŒì°¨ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const title = document.getElementById('episodeTitle').value;
        const content = document.getElementById('mainEditor').value;
        const statusEl = document.getElementById('saveStatus');
        
        const currentStory = globalStories.find(s => s.id === currentStoryId);
        const epNum = currentStory ? currentStory.episode_number : 999;

        statusEl.innerText = "ì €ì¥ ì¤‘...";

        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    episode_number: epNum, 
                    title: title,
                    content: content
                })
            });

            if (res.ok) {
                statusEl.innerText = "ì €ì¥ë¨ " + new Date().toLocaleTimeString();
                setTimeout(() => { statusEl.innerText = ""; }, 3000);
                loadStoryList(currentStoryId); // ì œëª© ë³€ê²½ ë°˜ì˜
            } else {
                statusEl.innerText = "ì €ì¥ ì‹¤íŒ¨";
            }
        } catch (e) {
            console.error(e);
            statusEl.innerText = "ì˜¤ë¥˜";
        }
    }
 // ğŸŒŸ [ì¶”ê°€ë¨] ì‚­ì œ ê¸°ëŠ¥
    async function deleteCurrentStory() {
        if (!currentStoryId) {
            alert("ì‚­ì œí•  íšŒì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!confirm("ì •ë§ë¡œ ì´ íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë‚´ìš©ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
            return;
        }

        try {
            const res = await fetch(`/api/stories/${currentStoryId}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                currentStoryId = null; // ì„ íƒ í•´ì œ
                clearEditor(true); // ì—ë””í„° ë¹„í™œì„±í™”
                await loadStoryList(); // ëª©ë¡ ê°±ì‹ 
            } else {
                const err = await res.json();
                alert("ì‚­ì œ ì‹¤íŒ¨: " + (err.error || err.message));
            }
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }
    // --- AI ê¸°ëŠ¥ë“¤ ---

    // 1. ì¥ë©´ ìƒì„±ê¸° (Scene Generator) - [NEW]
    async function generateScene() {
        if (!currentStoryId) return alert("íšŒì°¨ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        
        const promptInput = document.getElementById('scenePrompt');
        const userInstruction = promptInput.value.trim();
        if (!userInstruction) return alert("ì–´ë–¤ ì¥ë©´ì„ ì“¸ì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const btn = document.querySelector('.btn-scene-gen');
        const editor = document.getElementById('mainEditor');
        const originalBtnHTML = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì‘ì„± ì¤‘...';

		// B. ì—ë””í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ -> 'ì§ì „ íšŒì°¨'ì˜ ë§ˆì§€ë§‰ ë¬¸ë‹¨ë“¤ì„ ê°€ì ¸ì˜´
		let prevContext ="";
		const currentStory = globalStories.find(s => s.id === currentStoryId);
		if (currentStory) {
			// í˜„ì¬ íšŒì°¨ ë²ˆí˜¸ - 1 ì— í•´ë‹¹í•˜ëŠ” íšŒì°¨ ì°¾ê¸°
			const prevStory = globalStories.find(s => s.episode_number === currentStory.episode_number - 1);
			//console.log(prevStory.content)
			if (prevStory && prevStory.content) {
				 prevContext = getLastContextByParagraph(prevStory.content);
			} else {
			}
		}

        try {
            //const currentContent = editor.value.slice(-1000); // ìµœê·¼ 1000ì ì°¸ê³ 
			systemInstruction+=`[ë°°ê²½ì§€ì‹] ${contextData}`
            const payload = {
                model: "gemini-2.5-flash",
                payload: {
                    contents: [{
                        parts: [{
                            text: `                    
                            [ìš”ì²­] ì•„ë˜ ì§€ì‹œì‚¬í•­ì— ë§ì¶° ìƒˆë¡œìš´ ì¥ë©´ì„ ì§‘í•„í•´.
                            ì§€ì‹œì‚¬í•­: "${userInstruction}"
                            `
                        }]
                    }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                }
            };
			//console.log(payload);
            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            // ì‘ë‹µ ì²˜ë¦¬
            if (data.candidates && data.candidates[0].content) {
                const newScene = data.candidates[0].content.parts[0].text;
                const separator = editor.value.length > 0 ? "\n\n" : "";
               
				editor.value = prevContext + separator+newScene;
                editor.scrollTop = editor.scrollHeight;
                
                // (ì„ íƒì‚¬í•­) ì„±ê³µ í›„ ì…ë ¥ì°½ ë¹„ìš°ê¸°
                // promptInput.value = ''; 
            } else {
                console.error("API ì‘ë‹µ ì˜¤ë¥˜:", data); // ë””ë²„ê¹…ìš© ë¡œê·¸
                alert("AI ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤. (API í‚¤ë‚˜ ëª¨ë¸ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
            }
			
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ ë°œìƒ");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        }
    }

    // 2. ì´ì–´ì“°ê¸° (Continue)
    async function generateNext() {
        if (!currentStoryId) return alert("íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        
        const promptInput = document.getElementById('nextPrompt');
        const userInstruction = promptInput.value;
        const editor = document.getElementById('mainEditor');
        const currentText = editor.value;

        const btn = document.querySelector('.btn-generate');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìƒì„± ì¤‘...';
		systemInstruction+=`
                            [ë°°ê²½ì§€ì‹] ${contextData}
                            [í˜„ì¬ ë³¸ë¬¸] ${currentText}
							`
        try {
            const payload = {
                model: "gemini-2.5-flash",
                payload: {
                    contents: [{
                        parts: [{
                            text: `
                            [ìš”ì²­] ë‹¤ìŒ ì¥ë©´ì„ ì´ì–´ ì¨ì¤˜. 
                            ì§€ì‹œì‚¬í•­: ${userInstruction || 'ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì¤˜'}
                            `
                        }]
                    }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if(data.candidates) {
                const newContent = data.candidates[0].content.parts[0].text;
                editor.value += "\n\n" + newContent;
                editor.scrollTop = editor.scrollHeight;
                promptInput.value = ''; 
            } else {
                alert("AI ì‘ë‹µ ì—†ìŒ");
            }
        } catch (e) {
            console.error(e);
            alert("ìƒì„± ì‹¤íŒ¨");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-pen-nib"></i> ì´ì–´ì“°ê¸°';
        }
    }

    // 3. ìˆ˜ì • ë„êµ¬ (Polish/Fix)
    async function openAiEdit(mode) {
        const editor = document.getElementById('mainEditor');
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);

        if (!selectedText.trim()) {
            alert("ìˆ˜ì •í•  ë¬¸ì¥ì„ ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        let instruction = "";
        if(mode === 'polish') instruction = "ë¬¸ì¥ì„ ë‹¤ë“¬ì–´ì¤˜.";
        if(mode === 'expand') instruction = "ë¬˜ì‚¬ë¥¼ í’ì„±í•˜ê²Œ ëŠ˜ë ¤ì¤˜.";
        if(mode === 'fix') instruction = "ë§ì¶¤ë²•ì„ êµì •í•´ì¤˜.";

        const modal = document.getElementById('aiDiffModal');
        modal.dataset.start = start;
        modal.dataset.end = end;

        try {
            const payload = {
                model: "gemini-2.5-flash",
                payload: {
                    contents: [{
                        parts: [{
                            text: `ì›ë¬¸: ${selectedText}\nì§€ì‹œ: ${instruction}\nì¡°ê±´: ìˆ˜ì •ëœ ë¬¸ì¥ë§Œ ì¶œë ¥.`
                        }]
                    }]
                }
            };

            const res = await fetch('/api/generate-text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            const newText = data.candidates[0].content.parts[0].text;

            document.getElementById('originalText').innerText = selectedText;
            document.getElementById('newText').innerText = newText;
            modal.dataset.newText = newText;
            modal.style.display = 'flex';

        } catch (e) {
            alert("AI ìš”ì²­ ì‹¤íŒ¨");
        }
    }

    function closeAiModal() {
        document.getElementById('aiDiffModal').style.display = 'none';
    }

    function applyAiChange() {
        const modal = document.getElementById('aiDiffModal');
        const newText = modal.dataset.newText;
        const start = parseInt(modal.dataset.start);
        const end = parseInt(modal.dataset.end);
        
        const editor = document.getElementById('mainEditor');
        const fullText = editor.value;

        editor.value = fullText.substring(0, start) + newText + fullText.substring(end);
        closeAiModal();
    }

    init();
</script>

</body>
</html>