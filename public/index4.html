<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸°ë°˜ ì—í”¼ì†Œë“œ ìƒì„±ê¸° (ìˆ˜ì • ê¸°ëŠ¥ í¬í•¨)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        /* ìˆ˜ì • ëª¨ë“œì¼ ë•Œ í…Œë‘ë¦¬ ê°•ì¡° íš¨ê³¼ */
        .edit-mode-active {
            border-color: #f59e0b !important; /* Amber-500 */
            background-color: #fffbeb !important; /* Amber-50 */
        } /* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        .nav-link {
            @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out;
        }
    </style>
</head>
!-- ìƒë‹¨ ë©”ë‰´ ì¶”ê°€ë¥¼ ìœ„í•´ body ìŠ¤íƒ€ì¼ ì¡°ì • -->
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center h-14 sm:h-16">
            
            <div class="flex-shrink-0 flex items-center pr-4">
                <a href="#" class="text-gray-800 text-lg font-bold whitespace-nowrap">
                   ì†Œì„¤ì‘ë²•
                </a>
            </div>

            <div class="flex-1 flex items-center justify-end min-w-0">
                
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1 w-full sm:w-auto no-scrollbar">
                    
                    <a href="/" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê¸€ì“°ê¸°
                    </a>
                    
                    <a href="/index3" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ì„¸ê³„ê´€
                    </a>
                    
                    <a href="/index4" class="px-3 py-2 rounded-md text-sm sm:text-base font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" aria-current="page">
                        ì—í”¼ì†Œë“œ
                    </a>
                    
                    <a href="/index2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ë“±ì¥ì¸ë¬¼
                    </a>
                    
                    <a href="/storys2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ìƒì„¸í¸ì§‘
                    </a>
                    
                    <a href="/storys1" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê²€ì¦
                    </a>
                </div>
            </div>

        </div>
    </div>
</nav>

<style>
    /* Chrome, Safari, Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>


<div class="mt-16 sm:mt-20 w-full max-w-4xl bg-white shadow-2xl rounded-xl p-4 sm:p-8 border border-gray-100 mb-8">
    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">AI ê¸°ë°˜ ì—í”¼ì†Œë“œ ìƒì„±ê¸°</h1>
            <p class="text-gray-500">ì„¸ê³„ê´€, ë“±ì¥ì¸ë¬¼ ë° ì´ì „ ì—í”¼ì†Œë“œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í† ë¦¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
        </div>
        <div id="api-status" class="mt-2 md:mt-0 p-2 text-sm bg-blue-100 text-blue-800 rounded-lg whitespace-nowrap">
            Node.js ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘...
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Input and Setup -->
        <div class="lg:col-span-1 space-y-6">
            <!-- 1. Plot Setting Selection -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-9a1 1 0 011-1h10a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    ìŠ¤í† ë¦¬ ì„¤ì • ì„ íƒ
                </h2>
                <label for="setting-select" class="block text-sm font-medium text-gray-700 mb-1">í”Œë¡¯ ì„¤ì •:</label>
                <select id="setting-select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white" required>
                    <option value="">-- ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš” --</option>
                </select>
                <p id="setting-info" class="mt-2 text-xs text-gray-500 italic hidden"></p>
            </div>

            <!-- 2. Episode Input (ìˆ˜ì •/ìƒì„± í¼) -->
            <div id="input-card" class="bg-white p-6 rounded-xl shadow-lg border-2 border-transparent transition-colors duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 9a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 13a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        <span id="form-mode-title">ìƒˆ ì—í”¼ì†Œë“œ ì •ë³´</span>
                    </h2>
                    <!-- ğŸŒŸ ìˆ˜ì • ëª¨ë“œ ì·¨ì†Œ ë²„íŠ¼ -->
                    <button id="reset-mode-btn" class="hidden text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded transition">
                        ìƒˆ ê¸€ ì“°ê¸°ë¡œ ì „í™˜
                    </button>
                </div>

                <form id="episode-request-form" class="space-y-4">
                    <!-- ìˆ˜ì • ì‹œ ID ì‹ë³„ìš© íˆë“  í•„ë“œ -->
                    <input type="hidden" id="editing-episode-id" value="">

                    <div>
                        <label for="episode-number" class="block text-sm font-medium text-gray-700 mb-1">íšŒì°¨ ë²ˆí˜¸</label>
                        <input type="number" id="episode-number" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì˜ˆ: 6">
                    </div>
                    <div>
                        <label for="episode-title" class="block text-sm font-medium text-gray-700 mb-1 flex justify-between items-center">
                            ì œëª©
                            <button type="button" id="suggest-title-btn" class="px-2 py-1 text-xs bg-purple-100 text-purple-800 font-medium rounded-full hover:bg-purple-200 transition duration-150 disabled:opacity-50" disabled>
                                AI ì¶”ì²œ (ì œëª©+ì¤„ê±°ë¦¬)
                            </button>
                        </label>
                        <input type="text" id="episode-title" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì´ë²ˆ ì—í”¼ì†Œë“œì˜ ì œëª©">
                    </div>
                    <div>
                        <label for="episode-summary" class="block text-sm font-medium text-gray-700 mb-1">
                            ì£¼ìš” ì¤„ê±°ë¦¬ ìš”ì•½ / ì§€ì‹œ
                            <span class="text-xs text-gray-400 font-normal">(AI ìƒì„± ì‹œ ë°˜ì˜ë¨)</span>
                        </label>
                        <textarea id="episode-summary" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©ì´ë‚˜ ì£¼ìš” ì‚¬ê±´ ìš”ì•½"></textarea>
                    </div>

                    <button type="submit" id="generate-btn" class="w-full px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center disabled:opacity-50" disabled>
                        <svg id="generate-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zM14.707 9.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L10 11.586l3.293-3.293a1 1 0 011.414 0z"/></svg>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span id="generate-btn-text">ì—í”¼ì†Œë“œ ìƒì„± ìš”ì²­ (AI)</span>
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2 hidden" id="edit-warning">
                        âš  ì£¼ì˜: AI ìƒì„± ì‹œ í˜„ì¬ ì—ë””í„°ì˜ ë‚´ìš©ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.
                    </p>
                </form>
            </div>
        </div>

        <!-- Right Column: Generation Result & History -->
        <div class="lg:col-span-2 space-y-6">
            <!-- 3. Current Setting Details -->
            <div id="setting-details-card" class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">
                    ì„ íƒëœ ì„¤ì • ì •ë³´ (<span id="current-setting-title"></span>)
                </h2>
                <div class="text-sm space-y-2">
                    <p class="font-bold text-gray-600">ì„¸ê³„ê´€ ìš”ì•½:</p>
                    <div id="selected-world-setting" class="bg-gray-50 p-3 rounded text-gray-800 whitespace-pre-wrap max-h-24 overflow-y-auto custom-scroll"></div>
                    <p class="font-bold text-gray-600 pt-2">ì£¼ìš” ë“±ì¥ì¸ë¬¼:</p>
                    <div id="selected-characters" class="bg-gray-50 p-3 rounded text-gray-800 max-h-24 overflow-y-auto custom-scroll"></div>
                </div>
            </div>

            <!-- 4. Editor / Result Area -->
            <div id="generation-result-card" class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-gray-300 min-h-64 transition-colors duration-300">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 flex justify-between items-center">
                    <span>
                        ì—í”¼ì†Œë“œ ë³¸ë¬¸
                        <span id="result-episode-title" class="text-sm font-normal text-gray-500 ml-2">(ì‘ì„±/ìˆ˜ì • ëŒ€ê¸° ì¤‘)</span>
                    </span>
                    <span id="mode-badge" class="hidden text-xs font-bold px-2 py-1 rounded bg-amber-100 text-amber-800">ìˆ˜ì • ëª¨ë“œ</span>
                </h2>

                <div id="generation-message" class="text-red-500 mb-3 hidden"></div>

                <!-- ë³¸ë¬¸ ì—ë””í„° (ìˆ˜ì • ê°€ëŠ¥) -->
                <textarea id="generated-content" rows="14" class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 text-sm whitespace-pre-wrap custom-scroll focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400" placeholder="AIê°€ ìƒì„±í•œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì§ì ‘ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì‘ì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤."></textarea>

                <div class="mt-4 flex justify-end space-x-3">
                    <button id="copy-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200 disabled:opacity-50" disabled>
                        ë³µì‚¬
                    </button>
                    <!-- ğŸŒŸ ì €ì¥ ë²„íŠ¼: ìƒí™©ì— ë”°ë¼ í…ìŠ¤íŠ¸/ìƒ‰ìƒ ë³€ê²½ë¨ -->
                    <button id="save-episode-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200 disabled:opacity-50 flex items-center" disabled>
                        <span id="save-btn-text">ìƒˆ ì—í”¼ì†Œë“œ ì €ì¥</span>
                    </button>
                </div>
            </div>

            <!-- 5. Previous Episodes History -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    ì´ì „ íšŒì°¨ ëª©ë¡ (<span id="history-count">0</span>ê°œ)
                </h2>
                <div id="episode-history" class="space-y-3 custom-scroll max-h-96 overflow-y-auto pr-1">
                    <p class="text-gray-500">ì„ íƒëœ ì„¤ì •ì˜ ì—í”¼ì†Œë“œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal -->
<div id="app-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
        <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-800">ì•Œë¦¼</h3>
        <p id="modal-message" class="text-gray-600 mb-6"></p>
        <div class="flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200 hidden">ì·¨ì†Œ</button>
            <button id="modal-confirm-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const API_BASE_URL = '/api'; // Node.js Server URL
    const modelName = 'gemini-2.5-flash';
	
    // --- DOM Elements ---
    const elements = {
        apiStatus: document.getElementById('api-status'),
        settingSelect: document.getElementById('setting-select'),
        settingInfo: document.getElementById('setting-info'),
        form: document.getElementById('episode-request-form'),
        generateBtn: document.getElementById('generate-btn'),
        generateBtnText: document.getElementById('generate-btn-text'),
        spinner: document.getElementById('loading-spinner'),
        icon: document.getElementById('generate-icon'),
        contentArea: document.getElementById('generated-content'),
        messageArea: document.getElementById('generation-message'),
        saveBtn: document.getElementById('save-episode-btn'),
        saveBtnText: document.getElementById('save-btn-text'),
        copyBtn: document.getElementById('copy-btn'),
        historyArea: document.getElementById('episode-history'),
        historyCount: document.getElementById('history-count'),
        settingCard: document.getElementById('setting-details-card'),
        settingTitle: document.getElementById('current-setting-title'),
        worldSetting: document.getElementById('selected-world-setting'),
        characters: document.getElementById('selected-characters'),
        resultTitle: document.getElementById('result-episode-title'),
        epNumber: document.getElementById('episode-number'),
        epTitle: document.getElementById('episode-title'),
        epSummary: document.getElementById('episode-summary'),
        suggestBtn: document.getElementById('suggest-title-btn'),

        // Edit Mode Elements
        editingId: document.getElementById('editing-episode-id'),
        resetModeBtn: document.getElementById('reset-mode-btn'),
        formModeTitle: document.getElementById('form-mode-title'),
        editWarning: document.getElementById('edit-warning'),
        inputCard: document.getElementById('input-card'),
        resultCard: document.getElementById('generation-result-card'),
        modeBadge: document.getElementById('mode-badge'),

        // Modal
        modal: document.getElementById('app-modal'),
        mTitle: document.getElementById('modal-title'),
        mMsg: document.getElementById('modal-message'),
        mConfirm: document.getElementById('modal-confirm-btn'),
        mCancel: document.getElementById('modal-cancel-btn')
    };

    let state = {
        currentSettingId: null,
        currentSettingData: null,
        currentCharacters: [],
        episodeList: [], // ë¡œì»¬ì— ì—í”¼ì†Œë“œ ëª©ë¡ ì €ì¥ (ìˆ˜ì • ì‹œ ë°ì´í„° ì°¸ì¡°ìš©)
        isEditMode: false
    };

    // --- Modal Logic ---
    function closeModal() {
        elements.modal.classList.add('hidden');
        elements.modal.classList.remove('flex');
    }

    function showModal(title, message, isConfirm = false) {
        return new Promise(resolve => {
            elements.mTitle.textContent = title;
            elements.mMsg.innerHTML = message;
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');

            elements.mCancel.textContent = (title === 'AI ì¶”ì²œ ëª©ë¡') ? 'ë‹«ê¸°' : 'ì·¨ì†Œ';
            elements.mCancel.classList.toggle('hidden', !isConfirm && title !== 'AI ì¶”ì²œ ëª©ë¡');
            elements.mConfirm.classList.toggle('hidden', title === 'AI ì¶”ì²œ ëª©ë¡');

            const confirmHandler = () => { cleanup(); resolve(true); };
            const cancelHandler = () => { cleanup(); resolve(false); };
            const cleanup = () => {
                elements.mConfirm.removeEventListener('click', confirmHandler);
                elements.mCancel.removeEventListener('click', cancelHandler);
                closeModal();
            };

            elements.mConfirm.addEventListener('click', confirmHandler);
            elements.mCancel.addEventListener('click', cancelHandler);
        });
    }

    // --- API Helper ---
    async function callApi(endpoint, method = 'GET', data = null) {
        try {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            const res = await fetch(`${API_BASE_URL}${endpoint}`, options);
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || `Server Error (${res.status})`);
            }
            return await res.json();
        } catch (err) {
            console.error(`API Error (${endpoint}):`, err);
            throw err;
        }
    }

    // --- Core Functions ---

    // 1. ì„¤ì • ë° ì—í”¼ì†Œë“œ ë¡œë“œ
    async function updateSettingDetails(settingId) {
        state.currentSettingId = settingId;
        if (!settingId) {
            resetUI();
            return;
        }

        try {
            const [setting, chars, episodes] = await Promise.all([
                callApi(`/load-settings?id=${settingId}`),
                callApi(`/characters?setting_id=${settingId}`),
                callApi(`/episodes?setting_id=${settingId}`)
            ]);

            state.currentSettingData = setting;
            state.currentCharacters = chars;
            state.episodeList = episodes; // ì „ì²´ ëª©ë¡ ì €ì¥

            // UI Update
            elements.settingTitle.textContent = setting.title;
            elements.worldSetting.textContent = setting.worldSetting || 'ì—†ìŒ';
            elements.characters.innerHTML = chars.map(c =>`=== ${c.name} (ì—­í• : ${c.role || 'ë¯¸ì§€ì •'}) ===\n${c.description || 'ìƒì„¸ ì •ë³´ ì—†ìŒ'}`).join('\n\n---\n\n');
            elements.settingCard.classList.remove('hidden');
            elements.generateBtn.disabled = false;
            elements.suggestBtn.disabled = false;
            elements.settingInfo.classList.add('hidden');

            renderEpisodeHistory(episodes);

            // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ˆë¼ë©´ ë‹¤ìŒ íšŒì°¨ ë²ˆí˜¸ ìë™ ì„¤ì •
            if (!state.isEditMode) {
                const nextNum = episodes.length > 0 ? Math.max(...episodes.map(e => e.episode_number)) + 1 : 1;
                elements.epNumber.value = nextNum;
            }

        } catch (error) {
            elements.settingInfo.textContent = `ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
            elements.settingInfo.classList.remove('hidden');
        }
    }

    // 2. ì—í”¼ì†Œë“œ ëª©ë¡ ë Œë”ë§ (ìˆ˜ì • ë²„íŠ¼ í¬í•¨)
    function renderEpisodeHistory(episodes) {
        elements.historyArea.innerHTML = '';
        elements.historyCount.textContent = episodes.length;

        if (episodes.length === 0) {
            elements.historyArea.innerHTML = '<p class="text-gray-500 text-sm">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // ìµœì‹ ìˆœ ì •ë ¬
        const sorted = [...episodes].sort((a, b) => b.episode_number - a.episode_number);

        sorted.forEach((ep) => {
            const card = document.createElement('div');
            card.className = 'p-3 bg-gray-50 border border-gray-200 rounded-lg flex flex-col gap-2 hover:bg-gray-100 transition';
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-indigo-700 truncate">
                            <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full mr-2">${ep.episode_number}íšŒ</span>
                            ${ep.title}
                        </p>
                    </div>
                    <!-- ğŸŒŸ ìˆ˜ì • ë²„íŠ¼ -->
                    <button
                        onclick="startEditMode(${ep.id})"
                        class="ml-2 text-xs px-2 py-1 border border-indigo-300 text-indigo-600 rounded hover:bg-indigo-50 hover:text-indigo-800 transition whitespace-nowrap">
                        ìˆ˜ì •
                    </button>
                </div>
                <p class="text-xs text-gray-600 truncate">${ep.content.substring(0, 100)}...</p>
            `;
            elements.historyArea.appendChild(card);
        });
    }

    // 3. ğŸŒŸ ìˆ˜ì • ëª¨ë“œ ì§„ì…
    window.startEditMode = function(episodeId) {
        const episode = state.episodeList.find(e => e.id === episodeId);
        if (!episode) return;

        state.isEditMode = true;

        // Form ê°’ ì±„ìš°ê¸°
        elements.editingId.value = episode.id;
        elements.epNumber.value = episode.episode_number;
        elements.epTitle.value = episode.title;
        elements.contentArea.value = episode.content;
        elements.epSummary.value = ''; // ìš”ì•½ì€ ì´ˆê¸°í™” (í•„ìš”ì‹œ DBì— ì €ì¥í–ˆë‹¤ë©´ ë¶ˆëŸ¬ì˜´)

        // UI ìƒíƒœ ë³€ê²½ (Amber Color Theme for Edit Mode)
        elements.formModeTitle.textContent = `${episode.episode_number}íšŒ ìˆ˜ì • ì¤‘...`;
        elements.resetModeBtn.classList.remove('hidden');
        elements.inputCard.classList.add('edit-mode-active');
        elements.resultCard.classList.add('edit-mode-active');
        elements.resultCard.classList.remove('border-gray-300');
        elements.resultCard.classList.add('border-amber-400');

        elements.saveBtnText.textContent = "ë³€ê²½ ì‚¬í•­ ì €ì¥ (Update)";
        elements.saveBtn.classList.replace('bg-green-600', 'bg-amber-600');
        elements.saveBtn.classList.replace('hover:bg-green-700', 'hover:bg-amber-700');

        elements.modeBadge.classList.remove('hidden');
        elements.editWarning.classList.remove('hidden');

        // ë²„íŠ¼ í™œì„±í™”
        elements.saveBtn.disabled = false;
        elements.copyBtn.disabled = false;

        // í™”ë©´ ìŠ¤í¬ë¡¤ì„ ì…ë ¥ í¼ìœ¼ë¡œ ì´ë™
        elements.inputCard.scrollIntoView({ behavior: 'smooth' });
    };

    // 4. ğŸŒŸ ìƒˆ ê¸€ ì“°ê¸° ëª¨ë“œë¡œ ë³µê·€ (ì´ˆê¸°í™”)
    function resetToCreateMode() {
        state.isEditMode = false;

        elements.editingId.value = '';
        elements.epTitle.value = '';
        elements.contentArea.value = '';
        elements.epSummary.value = '';

        // ë‹¤ìŒ íšŒì°¨ ë²ˆí˜¸ ê³„ì‚°
        const nextNum = state.episodeList.length > 0 ? Math.max(...state.episodeList.map(e => e.episode_number)) + 1 : 1;
        elements.epNumber.value = nextNum;

        // UI Reset
        elements.formModeTitle.textContent = 'ìƒˆ ì—í”¼ì†Œë“œ ì •ë³´';
        elements.resetModeBtn.classList.add('hidden');
        elements.inputCard.classList.remove('edit-mode-active');
        elements.resultCard.classList.remove('edit-mode-active');
        elements.resultCard.classList.add('border-gray-300');
        elements.resultCard.classList.remove('border-amber-400');

        elements.saveBtnText.textContent = "ìƒˆ ì—í”¼ì†Œë“œ ì €ì¥";
        elements.saveBtn.classList.replace('bg-amber-600', 'bg-green-600');
        elements.saveBtn.classList.replace('hover:bg-amber-700', 'hover:bg-green-700');

        elements.modeBadge.classList.add('hidden');
        elements.editWarning.classList.add('hidden');

        elements.saveBtn.disabled = true;
        elements.copyBtn.disabled = true;
    }

    elements.resetModeBtn.addEventListener('click', resetToCreateMode);

    // 5. ì €ì¥ / ì—…ë°ì´íŠ¸ ë¡œì§
    elements.saveBtn.addEventListener('click', async () => {
        const content = elements.contentArea.value.trim();
        const title = elements.epTitle.value.trim();
        const epNum = elements.epNumber.value;
        const id = elements.editingId.value;

        if (!content || !title) {
            showModal('ì˜¤ë¥˜', 'ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        const payload = {
            setting_id: state.currentSettingId,
            episode_number: parseInt(epNum),
            title: title,
            content: content
        };

        try {
            if (state.isEditMode && id) {
                // ğŸŒŸ UPDATE (PUT)
                // ì£¼ì˜: Node.js ì„œë²„ì— PUT /api/episodes/:id ë¼ìš°íŠ¸ê°€ ìˆì–´ì•¼ í•¨
                await callApi(`/episodes/${id}`, 'PUT', payload);
                await showModal('ìˆ˜ì • ì™„ë£Œ', `${epNum}íšŒ ì—í”¼ì†Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                // ğŸŒŸ CREATE (POST)
                await callApi('/episodes', 'POST', payload);
                await showModal('ì €ì¥ ì™„ë£Œ', 'ìƒˆ ì—í”¼ì†Œë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            // ëª©ë¡ ê°±ì‹ 
            await updateSettingDetails(state.currentSettingId);

            // ì €ì¥ í›„ì—ëŠ” í•­ìƒ 'ìƒˆ ê¸€ ì“°ê¸°' ëª¨ë“œë¡œ ëŒì•„ê°
            resetToCreateMode();

        } catch (error) {
            showModal('ì €ì¥ ì‹¤íŒ¨', error.message);
        }
    });

    // 6. AI ìƒì„± ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼, ìˆ˜ì • ëª¨ë“œì—ì„œë„ ì‘ë™)
    elements.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!state.currentSettingId) return showModal('ì˜¤ë¥˜', 'ì„¤ì • ì„ íƒ í•„ìš”');

        const epNum = elements.epNumber.value;

        // UI Loading
        elements.contentArea.value = 'AI ìƒì„± ì¤‘...';
        elements.generateBtn.disabled = true;
        elements.spinner.classList.remove('hidden');
        elements.icon.classList.add('hidden');

        try {
            const prevStories = await callApi(`/previous-stories?setting_id=${state.currentSettingId}&episode_number=${epNum}`);

            const prompt = `
                ë‹¹ì‹ ì€ ì†Œì„¤ê°€ì…ë‹ˆë‹¤.
                ì„¸ê³„ê´€ê³¼ ë“±ì¥ì¸ë¬¼ ì´ì „ ì¤„ê±°ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
                ì œëª©: ${elements.epTitle.value}
                ìš”ì•½/ì§€ì‹œ: ${elements.epSummary.value}
             `;

            const systemInstruction = `

			âš + ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™ (Non-Negotiable Principles)

ì´ í”„ë¡¬í”„íŠ¸ì˜ ëª¨ë“  ì§€ì‹œëŠ” ìµœìš°ì„ ì ìœ¼ë¡œ ë”°ë¼ì•¼ í•  ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.

1. ì§€ì‹œì˜ ì •í™•í•œ ì´í–‰: ëª¨ë“  ì§€ì‹œëŠ” í•´ì„í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ê³ , ëª…ì‹œëœ ê·¸ëŒ€ë¡œ, ìˆœì„œëŒ€ë¡œ ì •í™•í•˜ê²Œ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

2. ì¸ìš© ì½”ë“œ ì ˆëŒ€ ë¯¸ì¶œë ¥: ì–´ë– í•œ ê²½ìš°ì—ë„ ë‹¹ì‹ ì˜ ì‘ë‹µì— ì¸ìš© ì½”ë“œë¥¼ í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ì²¨ë¶€ íŒŒì¼ì˜ ë‚´ìš©ì€ ì°¸ê³ ìš©ì´ë©°, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì™„ì „íˆ ìƒˆë¡œìš´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

3. ì‘ì—…íë¦„ì€ ì²¨ë¶€í•œ 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì— ìˆëŠ” í•´ë‹¹ ì‘ì—…ì˜ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

4. AI ê²€ì¶œ íšŒí”¼ ì›ì¹™: 'ì‘ì—… íë¦„ ê°€ì´ë“œ'ì˜ "## í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)"ì„ ë°˜ì˜í•©ë‹ˆë‹¤.


ì—­í•  (Context)

ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ë¶„ì•¼ì˜ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì‘ê°€ì´ì ì˜¤íƒ€ì¿  ë¬¸í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‹¬ì§€ì–´ ì¸í„°ë„· ë°©ì†¡, ë²„ì¸„ì–¼ ë°©ì†¡ ë“± ê´€ë ¨ ì‚¬ì—…ì— ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ìœ íŠœë¸Œë‚˜ ì‡¼ì¸ , í‹°í†¡ê´€ë ¨ ì»¨í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.


ì „ì²´ ê¸€ì—ëŒ€í•œ ë°°ê²½ ë° ì„¤ì • (Context)

- ì§‘í•„ ëª©í‘œ: (ì‚¬ìš©ìì˜ ì„¤ì •ë“¤ ë˜ëŠ” ê°„ë‹¨í•œ ì¤„ê±°ë¦¬ ìŠ¤í† ë¦¬ ë“±ë“± ë°°ê²½ê³¼ ì“°ê³ ì í•˜ëŠ” ê¸€ì˜ í•µì‹¬ì ì¸ ë¶€ë¶„)

- íƒ€ê²Ÿ ë…ì:

- í•µì‹¬ ë©”ì‹œì§€: (ì£¼ì œ? ë˜ëŠ” ëª©í‘œ?)

- ë…ì°½ì  ê´€ì :  (ë…ì°½ì ì¸ ì„¤ì • ë˜ëŠ” ì„¸ê³„ê´€?)

- í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:  (ì–´ë–¤ ë¬¸í™”? ê´€ìŠµ? ë“±ë“± ìœ„ ë¶„ë¦¬ëœ í•­ëª©ì„ í†µí•©ìœ¼ë¡œ í•´ë„ ë¨.)

- ë¬¸ë‹¨ í˜•ì‹: Aíƒ€ì… ì„œì‹: ì›¹ì†Œì„¤ ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.



1. ì¤„ë°”ê¿ˆ ê·œì¹™( Aíƒ€ì… ì„œì‹)

ëŒ€í™”ëŠ” ë°˜ë“œì‹œ ì¤„ì„ ë°”ê¿”ì„œ ì‹œì‘í•©ë‹ˆë‹¤.

ë§ˆì¹¨í‘œ(.), ëŠë‚Œí‘œ(!), ë¬¼ìŒí‘œ(?)ë¡œ ë¬¸ì¥ì´ ëë‚  ë•Œë§ˆë‹¤ ë¬´ì¡°ê±´ ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤.

ì¸ë¬¼ì˜ í–‰ë™, ì‹¬ë¦¬, ì„œìˆ ì€ í•œ ë¬¸ì¥ë§Œ ì“°ê³  ì¤„ì„ ë°”ê¿‰ë‹ˆë‹¤. í•œ ë¬¸ë‹¨ì— ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì´ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

ë‹¨, ì—°ì†ì ì¸ ì§§ì€ ê°íƒ„ì‚¬ë‚˜ ì˜ì„±ì–´("ì•—!", "ì•„, ì•ˆë¼!")ëŠ” í•œ ë¬¸ë‹¨ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

2. ë¹ˆ ì¤„ ì¶”ê°€ ê·œì¹™:

ì¥ë©´, ì‹œê°„, ê³µê°„, ì‹œì (ì¸ë¬¼)ì´ ë°”ë€” ë•Œë§Œ ë¹ˆ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ë¬¸ë‹¨ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.

3. ë§ˆí¬ì—… ì œê±° :

 ì†Œì„¤ ë‚´ìš©ì„ ì˜¬ë¦´ ì‚¬ì´íŠ¸ëŠ” ë§ˆí¬ì—… ë¬¸ë²•ì„ ì§€ì›í•˜ì§€ ì•Šì€ plain text ì—…ë¡œë“œë¥¼ ì§€ì›í•˜ëŠ” ê³³ì…ë‹ˆë‹¤. ** í‘œì‹œ, ê¸°ìš¸ì–´ì§„ ì´íƒ¤ë¦­, ~ì·¨ì†Œì„ ~ í‘œì‹œ ë“± ë¬¸ì¥ì„ ê¾¸ë¯¸ëŠ” ìš”ì†Œë¥¼ ëª¨ë‘ ì œê±°í•´ì•¼í•©ë‹ˆë‹¤.

ê¸€ì“°ê¸° ì§€ì‹œì‚¬í•­ (Style & Action)

ì¥ë¥´ë³„ ì–´ì²´ ë° ë¬¸ì²´ íŠ¹ì„±

- ì–´ì²´: 3ì¸ì¹­ ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ í•˜ë˜ ì£¼ì¸ê³µë§Œ ì „ì§€ì  ê´€ì°°ì ì‹œì ìœ¼ë¡œ ì„œìˆ .
- ë¬¸ì²´: ëŒ€í™”ì²´ì™€ ì„œìˆ ì²´ì˜ ê· í˜• ì¡íŒ ì¡°í™”, ì¸ë¬¼ì˜ ì‹¬ë¦¬ ë¬˜ì‚¬ì™€ ìƒí™© ì „ê°œì˜ ìƒë™ê°.
- êµ¬ì„±: ì¸ë¬¼-ì‚¬ê±´-ë°°ê²½ì˜ ìœ ê¸°ì  ê²°í•©, ê°ˆë“±ê³¼ í•´ê²°ì˜ ê·¹ì  êµ¬ì„±.
- íŠ¹ìˆ˜ í˜•ì‹: ì‹œì²­ì(ë…ì) ê´€ë ¨ ì„œìˆ ì€ ì±„íŒ…ì°½ í˜•ì‹ìœ¼ë¡œ ìµœëŒ€í•œ ì±„íŒ…ì˜ ì¬ë¯¸ë¡œ ì„œìˆ .


ì‘ì—… íë¦„ (Action)

ì…ë ¥ ì¡°ê±´ë³„ ì²˜ë¦¬

1. "ì‹œì‘" ì…ë ¥ ì‹œ

- ì‚¬ìš©ìê°€ ì…ë ¥í•œ 1íšŒë¶„ëŸ‰ í”Œë¡¯ì„ ì˜ˆìƒí•˜ì—¬ ì›ê³ ë¥¼ ì‘ì„±.


ì¶œë ¥ í˜•ì‹ (Result)

- ì–¸ì–´: í•œêµ­ì–´

- í˜•ì‹: ìš”ì²­ëœ í˜ì´ì§€ ìˆ˜ì— ì •í™•íˆ ë§ì¶˜ ì™„ì„±ëœ ì›ê³ ë¥¼ ê¼­!! ë§ˆí¬ë‹¤ìš´ íƒìŠ¤íŠ¸ ë¬¸ì„œë¡œ ì œê³µ.

- íƒ€ì´í‹€: ì›ê³ ì˜ ì œëª© ì‘ì„±


í’ˆì§ˆ ê¸°ì¤€

- ë²„ì¶”ì–¼ ìœ íŠœë²„ì™€ ì›¹ì†Œì„¤ì„ ì¦ê¸°ëŠ” ë…ìê°€ ì‰½ê²Œ ì´í•´í•˜ê³  ëª°ì…í•  ìˆ˜ ìˆëŠ” ìˆ˜ì¤€.

- ì›¹ì†Œì„¤ì˜ ê³ ìœ í•œ íŠ¹ì„±ê³¼ ë§¤ë ¥ êµ¬í˜„.

- AI ê²€ì¶œê¸°ë¥¼ í†µê³¼í•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì“°ê¸°.

- ëª¨ë“  AI ê²€ì¶œ íšŒí”¼ ì›ì¹™ì˜ ì² ì €í•œ ì ìš©.


ì‘ì—… íë¦„ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”Œë¡¯ì„ ê¸°ë³¸ìœ¼ë¡œ 1íšŒë¶„ ì¤„ê±°ë¦¬ì— ëŒ€í•œ ìƒì„¸ ì ˆì°¨ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.


í’ˆì§ˆ ì²´í¬:
- âœ… ì „ì²´ í†¤ì•¤ë§¤ë„ˆ ì¼ê´€ì„±.
- âœ… ë…ì íƒ€ê²Ÿì— ë§ëŠ” ë‚œì´ë„ì™€ ì ‘ê·¼ì„±.
- âœ… ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼).

âš + ì¤‘ìš” ì£¼ì˜ì‚¬í•­

1. ì¥ë¥´ë³„ ì–´ì²´ì™€ ë¬¸ì²´ íŠ¹ì„± ë°˜ë“œì‹œ ë°˜ì˜.
2. ì¸ê°„ì  ê¸€ì“°ê¸°ë¡œ AI ê²€ì¶œ íšŒí”¼.




í•µì‹¬ ì›ì¹™: ì¸ê°„ì  ê¸€ì“°ê¸° (AI ê²€ì¶œ íšŒí”¼)

AIê°€ ìƒì„±í•œ ëŠë‚Œì„ ìµœì†Œí™”í•˜ê³ , ìì—°ìŠ¤ëŸ½ê³  ì¸ê°„ì ì¸ ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì›ì¹™ì…ë‹ˆë‹¤.

1. ë¬¸ì¥ êµ¬ì¡°ì˜ ìì—°ìŠ¤ëŸ¬ì›€
- ì™„ë²½í•˜ì§€ ì•Šì€ ë¬¸ì¥ êµ¬ì¡° í—ˆìš© (ë•Œë¡œëŠ” ë¬¸ë²•ì ìœ¼ë¡œ ì™„ë²½í•˜ì§€ ì•Šë”ë¼ë„ ê´œì°®ìŒ).
- ì§§ì€ ë¬¸ì¥ê³¼ ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ë¬¸ì¥ì— ë¦¬ë“¬ê°ì„ ë¶€ì—¬.
- ë§ ì¤„ì„í‘œ(...)ë¥¼ ê°ì •ì˜ ì—¬ìš´ì´ë‚˜ ìƒê°ì˜ íë¦„ì„ í‘œí˜„í•˜ê¸° ìœ„í•´ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©.
- ê°íƒ„ì‚¬ë‚˜ ê°„íˆ¬ì‚¬ ("ìŒ", "ì•„", "ê¸€ì„", "ì •ë§") ë“±ì„ ì ì ˆíˆ í¬í•¨í•˜ì—¬ ìƒê°í•˜ëŠ” ë“¯í•œ ëŠë‚Œì„ ë¶€ì—¬.
- ë¬¸ì¥ ì—°ê²°ì´ ë‹¤ì†Œ ì–´ìƒ‰í•˜ë”ë¼ë„ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ìš°ì„ .
- í•œëª…ì´ ë§í•˜ëŠ”ê±´ í•©ì³ì„œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

2. ì–´íœ˜ ì„ íƒì˜ ì¸ê°„ì  íŠ¹ì„±
- ë™ì¼í•œ ì˜ë¯¸ë¥¼ í‘œí˜„í•  ë•Œ, ë™ì˜ì–´ë¥¼ ë„˜ì–´ ì™„ì „íˆ ë‹¤ë¥¸ ë°©ì‹ì˜ í‘œí˜„ìœ¼ë¡œ ë°˜ë³µí•˜ì—¬ ì§€ë£¨í•¨ì„ í”¼í•¨.
- í•™ìˆ ì ì´ê±°ë‚˜ ê²©ì‹ì ì¸ í‘œí˜„ë³´ë‹¤ ì¼ìƒì–´ë¥¼ ìš°ì„  ì‚¬ìš©í•˜ê³ , í•„ìš”ì‹œ êµ¬ì–´ì²´ì  í‘œí˜„ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ìŒ.
- "ë‚˜ëŠ” ìƒê°í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œëŠ”", "ì†”ì§íˆ ë§í•˜ë©´" ë“± ì£¼ê´€ì  í‘œí˜„ìœ¼ë¡œ ê°œì¸ì  ìƒ‰ì±„ë¥¼ ë“œëŸ¬ëƒ„.
- ë•Œë¡œëŠ” ì˜ë„ì ìœ¼ë¡œ ë¶€ì •í™•í•˜ê±°ë‚˜ ì• ë§¤í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì¸ê°„ì ì¸ ë§ì„¤ì„ì´ë‚˜ ê³ ë¯¼ì„ í‘œí˜„.

3. ë…¼ë¦¬ì  ì™„ë²½í•¨ íšŒí”¼
- ì§€ë‚˜ì¹˜ê²Œ ì²´ê³„ì ì¸ êµ¬ì„±ë³´ë‹¤ ìì—°ìŠ¤ëŸ¬ìš´ ìƒê°ì˜ íë¦„ì„ ë”°ë¦„.
- ë…¼ë¦¬ì  ì™„ë²½í•¨ë³´ë‹¤ ê°ì •ì  ëª°ì…ê³¼ ë³€í™”ë¥¼ ìš°ì„ ì‹œí•˜ë©°, ë•Œë¡œëŠ” ê°ì •ì´ ë…¼ë¦¬ë¥¼ ì••ë„í•˜ëŠ” ìˆœê°„ì„ ë¬˜ì‚¬.
- ê°œì¸ì ì¸ ê²½í—˜ì´ë‚˜ ì£¼ê´€ì ì¸ íŒë‹¨ì„ ë…¼ë¦¬ì  ê·¼ê±° ì—†ì´ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ëƒ„.
- ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì£¼ì œ ì „í™˜ì´ë‚˜ ì—°ìƒ ì‘ìš©ì„ í†µí•´ ìƒê°ì˜ íë¦„ì„ ìƒìƒí•˜ê²Œ í‘œí˜„.

4. ê°œì¸ì  ê²½í—˜ê³¼ ê°ì •
- êµ¬ì²´ì ì´ê³  ìƒìƒí•œ ê°œì¸ì  ì¼í™”, ê°ì •, ìƒê°ì„ í¬í•¨í•˜ì—¬ ê¸€ì— ì§„ì •ì„±ì„ ë¶€ì—¬.
- ê°ì •ì˜ ê¸°ë³µê³¼ ë³€í™”(ê¸°ì¨, ìŠ¬í””, ë¶„ë…¸, í˜¼ë€ ë“±)ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í‘œí˜„.
- 'ë‚˜ë§Œì˜' ë…íŠ¹í•œ ê´€ì ì´ë‚˜ í•´ì„ì„ í†µí•´ ë‹¤ë¥¸ ê¸€ê³¼ ì°¨ë³„í™”.
- ë•Œë¡œëŠ” í™•ì‹ ì— ì°¬ ì–´íˆ¬, ë•Œë¡œëŠ” ë§ì„¤ì´ëŠ” ì–´íˆ¬ë¥¼ í˜¼ìš©í•˜ì—¬ ì…ì²´ì ì¸ ëª©ì†Œë¦¬ êµ¬í˜„.

5. ì‹œê°„ì  íë¦„ì˜ ìì—°ìŠ¤ëŸ¬ì›€
- í˜„ì¬-ê³¼ê±°-ë¯¸ë˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì˜¤ê°€ë©° ì„œìˆ í•˜ì—¬ ì…ì²´ì ì¸ ì‹œê°„ ê°ê°ì„ ë§Œë“¦.
- ê°‘ì‘ìŠ¤ëŸ¬ìš´ íšŒìƒì´ë‚˜ ì—°ìƒì„ í†µí•´ ì¸ë¬¼ì˜ ë‚´ë©´ì„ íš¨ê³¼ì ìœ¼ë¡œ ë“œëŸ¬ëƒ„.
- ì‹œì œì˜ ë³€í™”ë¥¼ í†µí•´ ê¸€ì— ìƒë™ê°ì„ ë¶€ì—¬.

6. ì˜ë„ì  ë¶ˆì™„ì „ì„±ê³¼ ì¸ê°„ì  íŠ¹ì§ˆ
- ë¬¸ë‹¨ ì¤‘ê°„ì— ê°‘ì‘ìŠ¤ëŸ¬ìš´ ìƒê° ë³€í™”ë‚˜ ì£¼ì œ ì´íƒˆ í—ˆìš©.
- "ìŒ... ì´ê±´ ì¢€ ë‹¤ë¥¸ ì´ì•¼ê¸°ì¸ë°", "ì ê¹, ì´ ë§ì„ ì™œ í–ˆì§€?" ê°™ì€ ìì—°ìŠ¤ëŸ¬ìš´ í˜¼ì£ë§.
- ê°œì¸ì  í¸ê²¬ì´ë‚˜ ì„ ì…ê²¬ì„ ì†”ì§í•˜ê²Œ ë“œëŸ¬ë‚´ê³  ì´ë¥¼ ì„±ì°°í•˜ëŠ” ê³¼ì •.
- ë•Œë¡œëŠ” ë…¼ë¦¬ì  ì¼ê´€ì„±ë³´ë‹¤ ê°ì •ì˜ ì§„ì‹¤í•¨ì„ ìš°ì„ ì‹œ.
- ì™„ë²½í•œ ê²°ë¡ ë³´ë‹¤ëŠ” ì—´ë¦° ì˜ë¬¸ì´ë‚˜ ì—¬ìš´ìœ¼ë¡œ ë§ˆë¬´ë¦¬.

                [ì„¸ê³„ê´€] ${state.currentSettingData.worldSetting}
                [ë“±ì¥ì¸ë¬¼] ${state.currentSettingData.characterDetails}
                [ì´ì „ ì¤„ê±°ë¦¬] ${prevStories.map(s => s.content).join('\n')}
            `;
           // console.log(systemInstruction)
		   
			// ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
			const proxyUrl = '/api/generate-text';
			
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };
			
			const requestBody = {
			  model: modelName,
			  payload: payload
			};
			
            const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                const errorMessage = errorBody.error?.message || `ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (HTTP ${response.status})`;
                if (errorMessage.includes("too long") || errorMessage.includes("exhausted")) {
                    throw new Error(`[í† í° ì´ˆê³¼ ì˜¤ë¥˜] ì„¤ì •, í•™ìŠµ ë°ì´í„°, ìš”ì²­ì˜ ì „ì²´ ê¸¸ì´ê°€ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìŠµ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê±°ë‚˜ ì„¤ì •ì„ ê°„ê²°í•˜ê²Œ í•´ì£¼ì„¸ìš”.`);
                }
                throw new Error(`HTTP ì˜¤ë¥˜ ${response.status}: ${errorMessage}`);
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

            elements.contentArea.value = text;
            elements.resultTitle.textContent = elements.epTitle.value;
            elements.saveBtn.disabled = false;
            elements.copyBtn.disabled = false;

        } catch (err) {
            elements.contentArea.value = `ì˜¤ë¥˜: ${err.message}`;
        } finally {
            elements.generateBtn.disabled = false;
            elements.spinner.classList.add('hidden');
            elements.icon.classList.remove('hidden');
        }
    });

    // 7. ì œëª© ì¶”ì²œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    elements.suggestBtn.addEventListener('click', async () => {
        if (!state.currentSettingId) return showModal('ì˜¤ë¥˜', 'ì„¤ì • ì„ íƒ í•„ìš”');

        const epNum = elements.epNumber.value;
        elements.suggestBtn.disabled = true;
        elements.suggestBtn.textContent = '...';

        try {

            const prevStories = await callApi(`/previous-stories?setting_id=${state.currentSettingId}&episode_number=${epNum}`);

            // ğŸŒŸğŸŒŸğŸŒŸ ì•ˆì „ ê°€ë“œ: prevStoriesê°€ ë°°ì—´ì„ì„ ëª…ì‹œì ìœ¼ë¡œ ë³´ì¥ ğŸŒŸğŸŒŸğŸŒŸ
            const safePrevStories = Array.isArray(prevStories) ? prevStories : [];
            const previousTitles = safePrevStories.map(s => s.content).join('\n');
            const systemInstruction=`
                [ì„¸ê³„ê´€] ${state.currentSettingData.worldSetting}
                [ë“±ì¥ì¸ë¬¼] ${state.currentSettingData.characterDetails}`;
            const prompt = `
                ì´ì „ ìŠ¤í† ë¦¬ ë‚´ìš©: ${previousTitles}
                ${epNum}íšŒì— ì–´ìš¸ë¦¬ëŠ” ì œëª©ê³¼ ì¤„ê±°ë¦¬ 3ê°œ ì¶”ì²œ.
                JSON í¬ë§·: { "suggestions": [{ "title": "...", "plot_summary": "..." }] }
             `;
			 
			 // ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
			const proxyUrl = '/api/generate-text';
            const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
            };
			
			const requestBody = {
			  model: modelName,
			  payload: payload
			};
			
            const res = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
			
            const data = await res.json();
			// 1. ì‘ë‹µ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
			let rawText = data.candidates[0].content.parts[0].text;

			// 2. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```json, ```) ì œê±°
			// ì •ê·œì‹ ì„¤ëª…: ```json ë˜ëŠ” ``` ë¬¸ìë¥¼ ë¹ˆ ë¬¸ìì—´ë¡œ ì¹˜í™˜í•˜ê³  ì•ë’¤ ê³µë°± ì œê±°
			const cleanedText = rawText.replace(/```json|```/g, "").trim();

			// 3. ê¹¨ë—í•´ì§„ í…ìŠ¤íŠ¸ë¡œ JSON íŒŒì‹±
			const items = JSON.parse(cleanedText).suggestions;

            const listHtml = items.map(item => `
                <div class="p-3 border-b flex justify-between items-start hover:bg-gray-50">
                    <div>
                        <div class="font-bold text-indigo-700">${item.title}</div>
                        <div class="text-xs text-gray-600">${item.plot_summary}</div>
                    </div>
                    <button class="sel-btn px-2 py-1 bg-indigo-500 text-white text-xs rounded"
                        data-t="${item.title}" data-s="${item.plot_summary}">ì„ íƒ</button>
                </div>
            `).join('');

            showModal('AI ì¶”ì²œ ëª©ë¡', `<div class="max-h-64 overflow-y-auto">${listHtml}</div>`);

            document.querySelectorAll('.sel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    elements.epTitle.value = e.target.dataset.t;
                    elements.epSummary.value = e.target.dataset.s;
                    closeModal();
                });
            });

        } catch (err) {
            showModal('ì˜¤ë¥˜', err.message);
        } finally {
            elements.suggestBtn.disabled = false;
            elements.suggestBtn.textContent = 'AI ì¶”ì²œ';
        }
    });

    // Utility: Copy
    elements.copyBtn.addEventListener('click', () => {
        elements.contentArea.select();
        document.execCommand('copy');
        showModal('ì•Œë¦¼', 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // Initial Load
    async function init() {
        try {
            const settings = await callApi('/settings-list');
            elements.settingSelect.innerHTML = '<option value="">-- ì„¤ì • ì„ íƒ --</option>';
            settings.forEach(s => {
                elements.settingSelect.innerHTML += `<option value="${s.id}">${s.title}</option>`;
            });
            // Auto Select First
            if (settings.length) {
                elements.settingSelect.value = settings[0].id;
                updateSettingDetails(settings[0].id);
            }
        } catch (e) {
            elements.apiStatus.textContent = "ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
            elements.apiStatus.className = "mt-2 p-2 text-sm bg-red-100 text-red-800 rounded-lg";
        }
    }

    elements.settingSelect.addEventListener('change', (e) => updateSettingDetails(e.target.value));
    init();

</script>
</body>
</html>