<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸ê³„ê´€ êµ¬ì„± ê´€ë¦¬</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter í°íŠ¸ ì‚¬ìš© */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f9;
    }
    .container-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .input-style {
      border: 1px solid #d1d5db;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .input-style:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
      outline: none;
    }
    /* ì„¸ê³„ê´€ ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ ìµœëŒ€ 4ì¤„ë¡œ ì œí•œí•˜ê³  ë„˜ì¹˜ëŠ” ë‚´ìš©ì„ ì¤„ì„í‘œ(...) ì²˜ë¦¬í•˜ëŠ” CSS */
    .world-description-truncate {
      display: -webkit-box; /* Flexbox ë ˆì´ì•„ì›ƒì„ ì‚¬ìš© */
      -webkit-box-orient: vertical; /* ìš”ì†Œë¥¼ ìˆ˜ì§ìœ¼ë¡œ ë°°ì¹˜ */
      -webkit-line-clamp: 4; /* í‘œì‹œë  ìµœëŒ€ ì¤„ ìˆ˜ ì„¤ì • (4ì¤„ì´ ëŒ€ëµ 100~120ì ë‚´ì™¸) */
      overflow: hidden; /* ë„˜ì¹˜ëŠ” ë‚´ìš©ì€ ìˆ¨ê¹€ */
      text-overflow: ellipsis; /* ìˆ¨ê²¨ì§„ í…ìŠ¤íŠ¸ ëŒ€ì‹  ì¤„ì„í‘œ í‘œì‹œ */
    }
    /* ëª¨ë‹¬ ë°±ë“œë¡­ ë° ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999; /* Z-Indexë¥¼ ë†’ì—¬ ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í™•ì‹¤íˆ í‘œì‹œë˜ë„ë¡ ìˆ˜ì • */
    }
    .modal-content {
      max-height: 90vh;
    } /* ë©”ë‰´ í•­ëª© ìŠ¤íƒ€ì¼ - í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘ìš´ ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    .nav-link {
      @apply px-3 py-2 rounded-md text-sm font-medium text-gray-700 transition duration-150 ease-in-out;
    }
  </style>
</head>
!-- ìƒë‹¨ ë©”ë‰´ ì¶”ê°€ë¥¼ ìœ„í•´ body ìŠ¤íƒ€ì¼ ì¡°ì • -->
<body class="p-0 min-h-screen flex flex-col items-center">

<nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-lg">
  <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
    <div class="relative flex items-center justify-between h-14 sm:h-16">
      <div class="flex-1 flex items-center justify-start">
        <!-- íƒ€ì´í‹€ í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘¡ê²Œ ë³€ê²½ -->
        <a href="#" class="flex-shrink-0 text-gray-800 text-lg font-bold">

        </a>
      </div>
      <div class="flex items-center sm:ml-6">
        <!-- ë©”ë‰´ í•­ëª©ë“¤ì„ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ, ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • -->
        <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1">
          <!-- í˜„ì¬ í˜ì´ì§€ (ê¸€ì“°ê¸°) í™œì„±í™” - íŒŒë€ìƒ‰ìœ¼ë¡œ ê°•ì¡° -->
          <a href="/" class="nav-link hover:bg-gray-100">
            ê¸€ì“°ê¸°
          </a>
          <!-- ì¼ë°˜ ë§í¬ - hover ì‹œ ì—°í•œ íšŒìƒ‰ ë°°ê²½ -->
          <a href="/index3" class="nav-link bg-blue-100 text-blue-800 hover:bg-blue-200" aria-current="page" >
            ì„¸ê³„ê´€êµ¬ì„±ê´€ë¦¬
          </a>
          <a href="/index4" class="nav-link hover:bg-gray-100">
            ì—í”¼ì†Œë“œìƒì„±ê¸°
          </a>
          <a href="/index2" class="nav-link hover:bg-gray-100">
            ë“±ì¥ì¸ë¬¼ê´€ë¦¬
          </a>
          <a href="/storys2" class="nav-link hover:bg-gray-100">
            íšŒì°¨ ìƒì„¸ í¸ì§‘
          </a>
          <a href="/storys1" class="nav-link hover:bg-gray-100">
            ì†Œì„¤ ë‚´ìš© ê²€ì¦
          </a>
        </div>
      </div>
    </div>
  </div>
</nav><nav class="fixed top-0 left-0 z-50 w-full bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <div class="relative flex items-center h-14 sm:h-16">
            
            <div class="flex-shrink-0 flex items-center pr-4">
                <a href="#" class="text-gray-800 text-lg font-bold whitespace-nowrap">
                   ì†Œì„¤ì‘ë²•
                </a>
            </div>

            <div class="flex-1 flex items-center justify-end min-w-0">
                
                <div class="flex space-x-1 sm:space-x-4 overflow-x-auto whitespace-nowrap py-1 w-full sm:w-auto no-scrollbar">
                    
                    <a href="/" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê¸€ì“°ê¸°
                    </a>
                    
                    <a href="/index3" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ì„¸ê³„ê´€
                    </a>
                    
                    <a href="/index4" class="px-3 py-2 rounded-md text-sm sm:text-base font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" aria-current="page">
                        ì—í”¼ì†Œë“œ
                    </a>
                    
                    <a href="/index2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ë“±ì¥ì¸ë¬¼
                    </a>
                    
                    <a href="/storys2" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ìƒì„¸í¸ì§‘
                    </a>
                    
                    <a href="/storys1" class="px-3 py-2 rounded-md text-sm sm:text-base font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                        ê²€ì¦
                    </a>
                </div>
            </div>

        </div>
    </div>
</nav>

<style>
    /* Chrome, Safari, Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
</style>


<div id="app" class="mt-16 sm:mt-20 w-full max-w-4xl bg-white shadow-2xl rounded-xl p-4 sm:p-8 border border-gray-100 mb-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800">ì„¸ê³„ê´€ (World Setting) êµ¬ì„± ê´€ë¦¬</h1>
    <p class="text-gray-500">í”Œë¡¯ ì„¤ì •ì— ì—°ê²°ë˜ëŠ” ì„¸ê³„ê´€ ì •ë³´ë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
  </header>

  <!-- ë¡œë”© ë° ì˜¤ë¥˜ ë©”ì‹œì§€ -->
  <div id="message-container" class="mb-4 hidden">
    <div id="loading-spinner" class="text-center p-4 text-indigo-600 hidden">
      <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      ë°ì´í„° ë¡œë“œ ì¤‘...
    </div>
    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg hidden" role="alert">
      <strong class="font-bold">ì˜¤ë¥˜ ë°œìƒ!</strong>
      <span id="error-text" class="block sm:inline"></span>
    </div>
  </div>

  <!-- 1. í”Œë¡¯ ì„¤ì • ì„ íƒ ì˜ì—­ -->
  <div class="container-card p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. ë¶€ëª¨ í”Œë¡¯ ì„¤ì • ì„ íƒ</h2>
    <div class="flex flex-col md:flex-row items-center gap-4">
      <select id="setting-select" class="input-style flex-grow w-full md:w-auto bg-white disabled:bg-gray-100">
        <option value="" disabled selected>í”Œë¡¯ ì„¤ì •(Plot Setting)ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>
      <div class="text-sm text-gray-500 w-full md:w-auto">í˜„ì¬ ì„ íƒ ID: <span id="selected-setting-id" class="font-mono font-semibold text-indigo-600">ì—†ìŒ</span></div>
    </div>
  </div>

  <!-- 2. AI ê¸°ë°˜ ì„¸ê³„ê´€ êµ¬ì„± ì„¹ì…˜ (NEW) -->
  <div class="container-card p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">2. AI ê¸°ë°˜ ì„¸ê³„ê´€ êµ¬ì„±</h2>
    <form id="ai-world-setting-form">
      <p class="text-sm text-gray-500 mb-3">ì„ íƒëœ í”Œë¡¯ì— ë§ì¶° AIì—ê²Œ ì„¸ê³„ê´€ ìƒì„±ì„ ìš”ì²­í•˜ì„¸ìš”. (ì˜ˆ: "ë§ˆë²•ê³¼ ê¸°ê³„ ë¬¸ëª…ì´ ê³µì¡´í•˜ëŠ” ì„¸ê³„ë¥¼ ë§Œë“¤ì–´ì¤˜.")</p>

      <textarea id="ai-prompt" rows="2" required class="input-style w-full resize-none mb-4" placeholder="AI ì„¸ê³„ê´€ ìƒì„± ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”. (í•„ìˆ˜)"></textarea>

      <button type="submit" id="ai-generate-btn" disabled class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors disabled:bg-green-300 flex items-center justify-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M4.343 4.343l-.707.707m1.414 14.142l-.707.707m12.728-.707l-.707-.707M6.343 17.657l-4.243 4.243M17.657 6.343l4.243-4.243m-1.414 14.142l4.243-4.243"></path></svg>
        AIë¡œ ì„¸ê³„ê´€ êµ¬ì„±í•˜ê¸°
      </button>
    </form>

    <!-- AI ìƒì„± ê²°ê³¼ ê²€í†  ì˜ì—­ -->
    <div id="ai-results-container" class="mt-6 hidden">
      <h3 class="text-lg font-semibold text-gray-700 mb-3">AI ìƒì„± ê²°ê³¼ ê²€í† </h3>
      <div id="ai-world-review" class="space-y-3 p-3 bg-gray-50 border rounded-lg">
        <p class="text-center text-gray-400">AI ìƒì„± ìš”ì²­ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      <button id="ai-save-btn" disabled class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors mt-4 disabled:bg-indigo-300">
        AI ì„¸ê³„ê´€ DBì— ì¶”ê°€
      </button>
    </div>
  </div>

  <!-- 3. ìƒˆë¡œìš´ ì„¸ê³„ê´€ ìˆ˜ë™ ì¶”ê°€/ë“±ë¡ ì˜ì—­ (ê¸°ì¡´ Section 2) -->
  <div class="container-card p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">3. ìƒˆë¡œìš´ ì„¸ê³„ê´€ ìˆ˜ë™ ì¶”ê°€</h2>
    <form id="add-world-setting-form">
      <div class="grid grid-cols-1 gap-4 mb-4">
        <div>
          <label for="world-title" class="block text-sm font-medium text-gray-700 mb-1">ì„¸ê³„ê´€ ì œëª© (í•„ìˆ˜)</label>
          <input type="text" id="world-title" required class="input-style w-full" placeholder="ì˜ˆ: ì¤‘ì„¸ ë§ˆë²• ì™•êµ­, ë¯¸ë˜ ë„ì‹œ A.I. 505">
        </div>
        <div>
          <label for="world-description" class="block text-sm font-medium text-gray-700 mb-1">ìƒì„¸ ì„¤ëª…</label>
          <textarea id="world-description" rows="4" class="input-style w-full resize-none" placeholder="ì„¸ê³„ì˜ ì—­ì‚¬, ì§€ë¦¬, ì£¼ìš” ê·œì¹™, íŠ¹ì§• ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ í•˜ì„¸ìš”."></textarea>
        </div>
      </div>
      <button type="submit" id="add-world-btn" disabled class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors disabled:bg-indigo-300">
        ì„¸ê³„ê´€ ì¶”ê°€ ë° ì—°ê²°í•˜ê¸°
      </button>
    </form>
  </div>

  <!-- 4. ë“±ë¡ëœ ì„¸ê³„ê´€ ëª©ë¡ ì˜ì—­ (ê¸°ì¡´ Section 3) -->
  <div class="container-card p-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">4. ë“±ë¡ëœ ì„¸ê³„ê´€ ëª©ë¡ (ì„ íƒëœ í”Œë¡¯ ID: <span id="list-setting-id" class="font-mono text-indigo-600">ì—†ìŒ</span>)</h2>
    <div id="world-settings-list" class="space-y-4">
      <p id="list-placeholder" class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">
        í”Œë¡¯ ì„¤ì •ì„ ì„ íƒí•˜ì‹œë©´ ì—°ê²°ëœ ì„¸ê³„ê´€ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </p>
      <!-- ì„¸ê³„ê´€ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
    </div>
  </div>
</div>

<!-- ì„¸ê³„ê´€ ìˆ˜ì • ëª¨ë‹¬ (ë ˆì´ì–´ íŒì—…) -->
<div id="edit-modal" class="modal-backdrop fixed inset-0 hidden flex items-center justify-center p-4" aria-modal="true" role="dialog">
  <div class="modal-content container-card w-full max-w-lg overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-900">ì„¸ê³„ê´€ ìˆ˜ì •</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>

      <form id="edit-world-setting-form" class="space-y-4">
        <input type="hidden" id="edit-id">

        <div class="text-sm font-medium text-gray-500">ID: <span id="edit-display-id" class="font-mono text-indigo-600"></span></div>

        <div>
          <label for="edit-title" class="block text-sm font-medium text-gray-700 mb-1">ì„¸ê³„ê´€ ì œëª© (í•„ìˆ˜)</label>
          <input type="text" id="edit-title" required
                 class="input-style w-full border-yellow-400" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div>
          <label for="edit-description" class="block text-sm font-medium text-gray-700 mb-1">ìƒì„¸ ì„¤ëª…</label>
          <textarea id="edit-description" rows="8"
                    class="input-style w-full resize-none border-yellow-400" placeholder="ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        </div>

        <div class="flex justify-end space-x-3 pt-4">
          <button type="button" onclick="closeModal()"
                  class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
            ì·¨ì†Œ
          </button>
          <button type="submit" id="modal-save-btn"
                  class="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700 transition-colors flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            ì €ì¥
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // í˜„ì¬ëŠ” Firebase ëŒ€ì‹  ê°€ìƒì˜ MySQL API ì—”ë“œí¬ì¸íŠ¸ì™€ í†µì‹ í•©ë‹ˆë‹¤.
  const apiBaseUrl = '/api';
  // NOTE: ì§€ì†ì ì¸ ë¡œë”©(í´ë§) ë¡œì§ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.

  let selectedSettingId = null;

  const modelName = 'gemini-2.5-flash';
  // JSON ìŠ¤í‚¤ë§ˆ: AIê°€ ìƒì„±í•  ì„¸ê³„ê´€ ê°ì²´ ì •ì˜
  const WORLD_SETTING_SCHEMA = {
    type: "OBJECT",
    description: "A single, detailed world setting.",
    properties: {
      title: { type: "STRING", description: "The concise title of the world setting, in Korean." },
      description: { type: "STRING", description: "A detailed description of the world's history, geography, main rules, and unique features. Must be at least 200 characters long, in Korean." }
    },
    propertyOrdering: ["title", "description"],
    required: ["title", "description"]
  };


  // DOM ìš”ì†Œ
  const settingSelect = document.getElementById('setting-select');
  const selectedSettingIdSpan = document.getElementById('selected-setting-id');
  const listSettingIdSpan = document.getElementById('list-setting-id');
  const addWorldSettingForm = document.getElementById('add-world-setting-form');
  const addWorldBtn = document.getElementById('add-world-btn');
  const worldSettingsList = document.getElementById('world-settings-list');
  const listPlaceholder = document.getElementById('list-placeholder');

  // AI ê´€ë ¨ DOM ìš”ì†Œ
  const aiWorldSettingForm = document.getElementById('ai-world-setting-form');
  const aiPromptTextarea = document.getElementById('ai-prompt');
  const aiGenerateBtn = document.getElementById('ai-generate-btn');
  const aiResultsContainer = document.getElementById('ai-results-container');
  const aiWorldReview = document.getElementById('ai-world-review');
  const aiSaveBtn = document.getElementById('ai-save-btn');

  // ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œ
  const editModal = document.getElementById('edit-modal');
  const editWorldSettingForm = document.getElementById('edit-world-setting-form');
  const editIdInput = document.getElementById('edit-id');
  const editDisplayIdSpan = document.getElementById('edit-display-id');
  const editTitleInput = document.getElementById('edit-title');
  const editDescriptionTextarea = document.getElementById('edit-description');
  const modalSaveBtn = document.getElementById('modal-save-btn');

  // ë©”ì‹œì§€ ë° ë¡œë”©
  const loadingSpinner = document.getElementById('loading-spinner');
  const errorMessageDiv = document.getElementById('error-message');
  const errorTextSpan = document.getElementById('error-text');

  let aiGeneratedWorldSetting = null;
  let currentWorldSettings = [];

  // -----------------------------------------------------
  // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
  // -----------------------------------------------------

  function showLoading(show) {
    loadingSpinner.classList.toggle('hidden', !show);
    const isErrorVisible = !errorMessageDiv.classList.contains('hidden');
    document.getElementById('message-container').classList.toggle('hidden', !show && !isErrorVisible);
  }

  function showError(message) {
    errorTextSpan.textContent = message;
    errorMessageDiv.classList.remove('hidden');
    document.getElementById('message-container').classList.remove('hidden');
    showLoading(false);
  }

  function hideError() {
    errorMessageDiv.classList.add('hidden');
    document.getElementById('message-container').classList.add('hidden');
  }

  async function fetchWithExponentialBackoff(url, options = {}, maxRetries = 3) {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        const response = await fetch(url, options);

        if (response.ok) {
          return response;
        }

        if (attempt === maxRetries - 1) {
          const errorBody = await response.text();
          throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status} ${response.statusText}. ìƒì„¸: ${errorBody}`);
        }

      } catch (error) {
        console.warn(`API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempt + 1}/${maxRetries}): ${error.message}`);
        if (attempt === maxRetries - 1) {
          throw new Error(`ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: ${error.message}`);
        }
      }

      const delay = Math.pow(2, attempt) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  // -----------------------------------------------------
  // ë‹¨ì¼ í•­ëª© ì¡°íšŒ API í•¨ìˆ˜
  // -----------------------------------------------------

  /**
   * DBì—ì„œ íŠ¹ì • ì„¸ê³„ê´€ í•­ëª©ì„ ê³ ìœ  IDë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.
   * GET /api/worldsettings/:id
   */
  async function fetchWorldSettingById(id) {
    const url = `${apiBaseUrl}/worldsettings/${id}`;
    const response = await fetchWithExponentialBackoff(url);

    if (response.status === 404) {
      // ì„œë²„ì— í•­ëª©ì´ ì—†ëŠ” ê²½ìš°
      return null;
    }

    if (!response.ok) {
      const errorBody = await response.json();
      throw new Error(`ë‹¨ì¼ ì„¸ê³„ê´€ ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${errorBody.error || 'ì•Œ ìˆ˜ ì—†ìŒ'}`);
    }

    return await response.json();
  }

  // -----------------------------------------------------
  // ëª¨ë‹¬ (ë ˆì´ì–´ íŒì—…) ê´€ë ¨ í•¨ìˆ˜
  // -----------------------------------------------------

  /**
   * ëª¨ë‹¬ì„ ë‹«ê³  UIë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
   */
  function closeModal() {
    editModal.classList.add('hidden');
  }

  /**
   * ë¡œì»¬ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì • ëª¨ë‹¬ í•„ë“œë¥¼ ì±„ì›ë‹ˆë‹¤.
   * openEditModalì—ì„œ DB ìµœì‹  ë°ì´í„°ë¥¼ ë°›ì€ í›„ í˜¸ì¶œë©ë‹ˆë‹¤.
   */
  function _populateEditModal(worldToEdit) {
    // ëª¨ë‹¬ í•„ë“œì— ë°ì´í„° ì±„ìš°ê¸° (worldToEdit ê°ì²´ë¥¼ ì§ì ‘ ì‚¬ìš©)
    editIdInput.value = worldToEdit.id;
    editDisplayIdSpan.textContent = worldToEdit.id;
    editTitleInput.value = worldToEdit.title;
    editDescriptionTextarea.value = worldToEdit.description || '';

    // ëª¨ë‹¬ ì—´ê¸°
    editModal.classList.remove('hidden');
  }

  /**
   * ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” ì§„ì…ì .
   * 1. DBì—ì„œ ìµœì‹  ë‹¨ì¼ í•­ëª©ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   * 2. ë¡œì»¬ ìºì‹œë¥¼ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ë™ê¸°í™”í•©ë‹ˆë‹¤.
   * 3. ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
   * * @param {string} id - ìˆ˜ì •í•  ì„¸ê³„ê´€ ID
   */
  async function openEditModal(id) {
    hideError();
    showLoading(true);

    try {
      // 1. ë‹¨ì¼ í•­ëª© ì¡°íšŒ API í˜¸ì¶œ
      const latestWorld = await fetchWorldSettingById(id);

      if (!latestWorld) {
        showError(`ì„¸ê³„ê´€ ID ${id}ê°€ ì„œë²„ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
        await fetchWorldSettings(selectedSettingId);
        return;
      }

      // 2. ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ (ìºì‹œ ë™ê¸°í™”)
      const index = currentWorldSettings.findIndex(w => String(w.id) === String(id));
      let finalWorld = latestWorld;

      if (index !== -1) {
        // 2a. í•­ëª©ì„ ë¡œì»¬ì—ì„œ ì°¾ì€ ê²½ìš°: ìµœì‹  ë°ì´í„°ë¡œ ëŒ€ì²´
        currentWorldSettings[index] = finalWorld;
      } else {
        // 2b. í•­ëª©ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° (ì‚¬ìš©ìì˜ ì¤‘ë³µ ë¬¸ì œ ì›ì¸):
        // í•­ëª©ì„ ì¶”ê°€í•˜ì§€ ì•Šê³ , ë¡œì»¬ ìºì‹œì˜ ìƒíƒœê°€ ì˜ëª»ë˜ì—ˆë‹¤ê³  íŒë‹¨í•˜ì—¬ ì „ì²´ ëª©ë¡ì„ ê°•ì œ ë™ê¸°í™”í•©ë‹ˆë‹¤.
        console.warn(`ê²½ê³ : ID ${id}ì˜ ì„¸ê³„ê´€ì´ ë¡œì»¬ ìºì‹œì— ì—†ì–´ ì „ì²´ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (currentWorldSettingsê°€ ì—…ë°ì´íŠ¸ ë¨)
        await fetchWorldSettings(selectedSettingId);

        // ìƒˆë¡œê³ ì¹¨ëœ ë°°ì—´ì—ì„œ í•­ëª©ì„ ë‹¤ì‹œ ì°¾ìŠµë‹ˆë‹¤.
        const reloadedWorld = currentWorldSettings.find(w => String(w.id) === String(id));

        if (reloadedWorld) {
          finalWorld = reloadedWorld; // ìƒˆë¡œ ì°¾ì€ í•­ëª©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        } else {
          // ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ì°¾ì§€ ëª»í–ˆë‹¤ë©´ ì„œë²„ì—ë„ ì—†ëŠ” ê²ƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          throw new Error("ìºì‹œ ë™ê¸°í™” í›„ì—ë„ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // 3. ëª¨ë‹¬ UI ì¤€ë¹„ ë° ì—´ê¸°
      _populateEditModal(finalWorld);

    } catch (error) {
      console.error("ì„¸ê³„ê´€ ë‹¨ì¼ ì¡°íšŒ ë° ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:", error);
      showError(`ì„¸ê³„ê´€ ë¡œë“œ ì‹¤íŒ¨ (ID: ${id}): ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  /**
   * ëª¨ë‹¬ í¼ ì œì¶œ ì‹œ í˜¸ì¶œë˜ì–´ ì—…ë°ì´íŠ¸ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
   */
  async function saveWorldSetting() {
    const id = editIdInput.value;
    const newTitle = editTitleInput.value.trim();
    const newDescription = editDescriptionTextarea.value.trim();

    if (!newTitle) {
      showError("ì„¸ê³„ê´€ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
      return;
    }

    hideError();
    modalSaveBtn.disabled = true;
    modalSaveBtn.textContent = 'ì €ì¥ ì¤‘...';
    showLoading(true);

    try {
      const payload = {
        title: newTitle,
        description: newDescription,
      };

      // PUT /api/worldsettings/:id í˜¸ì¶œ
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/worldsettings/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.status !== 200) {
        const errorBody = await response.json();
        throw new Error(`APIê°€ ì„¸ê³„ê´€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status}, ë©”ì‹œì§€: ${errorBody.error || 'ì•Œ ìˆ˜ ì—†ìŒ'})`);
      }

      // --- ì‘ë‹µì„± í–¥ìƒ ë¡œì§ ---
      // 1. ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
      const index = currentWorldSettings.findIndex(w => String(w.id) === String(id));
      if (index !== -1) {
        currentWorldSettings[index].title = newTitle;
        currentWorldSettings[index].description = newDescription;
      }

      // 2. ëª¨ë‹¬ ë‹«ê¸°
      closeModal();

      // 3. API í˜¸ì¶œ ì—†ì´ ë¡œì»¬ ë°ì´í„°ë¡œ ëª©ë¡ ì¦‰ì‹œ ë Œë”ë§ (ì¦‰ê°ì ì¸ ì‹œê°ì  í”¼ë“œë°± ì œê³µ)
      renderWorldSettings(currentWorldSettings);

      // 4. (ì„ íƒì ) ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ„í•´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì „ì²´ ìƒˆë¡œê³ ì¹¨
      fetchWorldSettings(selectedSettingId, false);
      // ------------------------------------

    } catch (error) {
      console.error("ì„¸ê³„ê´€ ìˆ˜ì • ì˜¤ë¥˜:", error);
      showError(`ì„¸ê³„ê´€ ìˆ˜ì • ì‹¤íŒ¨ (ID: ${id}): ${error.message}`);
    } finally {
      modalSaveBtn.disabled = false;
      modalSaveBtn.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> ì €ì¥';
      showLoading(false);
    }
  }

  // -----------------------------------------------------
  // AI ê¸°ë°˜ ì„¸ê³„ê´€ ìƒì„± ë¡œì§
  // -----------------------------------------------------

  async function generateWorldSettingAI(prompt) {
    hideError();
    aiGenerateBtn.disabled = true;
    aiGenerateBtn.textContent = 'AIê°€ ì„¸ê³„ê´€ êµ¬ì„± ì¤‘...';
    showLoading(true);
    aiResultsContainer.classList.add('hidden');
    aiGeneratedWorldSetting = null;

    const systemPrompt = `
                ë‹¹ì‹ ì€ ìŠ¤í† ë¦¬ ì‘ê°€ë¥¼ ìœ„í•œ ì „ë¬¸ì ì¸ ì„¸ê³„ê´€ ìƒì„± AIì…ë‹ˆë‹¤.
                ì‚¬ìš©ìê°€ ì œê³µí•œ ìš”ì²­ê³¼ ë¶€ëª¨ í”Œë¡¯ ì„¤ì •ì— ë§ì¶° ë…ì°½ì ì´ê³  ìƒì„¸í•œ ì„¸ê³„ê´€ì„ ìƒì„±í•˜ì„¸ìš”.
                ë°˜ë“œì‹œ ë‹¤ìŒ JSON ìŠ¤í‚¤ë§ˆë¥¼ ì¤€ìˆ˜í•˜ëŠ” í•œêµ­ì–´ JSON ê°ì²´ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.
                ì„¸ê³„ê´€ ìƒì„¸ ì„¤ëª…ì€ ìµœì†Œ 200ì ì´ìƒìœ¼ë¡œ ë§¤ìš° ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
            `;

    const userQuery = `
                í˜„ì¬ ë¶€ëª¨ í”Œë¡¯ ì„¤ì • ID: ${selectedSettingId}
                ìš”ì²­: ${prompt}
                ì´ í”Œë¡¯ì— ì–´ìš¸ë¦¬ëŠ” ì„¸ê³„ê´€ì„ JSON í˜•ì‹ì˜ ê°ì²´ë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”.
            `;

   
 // ğŸ”´ ì¤‘ìš” ë³€ê²½: API ìš”ì²­ ì£¼ì†Œë¥¼ í”„ë¡ì‹œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
    const proxyUrl = '/api/generate-text';
    
    // Gemini APIê°€ ì‹¤ì œë¡œ ë°›ì„ Payload
    const geminiPayload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: { parts: [{ text: systemPrompt }] },
	   generationConfig: {
        responseMimeType: "application/json",
        responseSchema: WORLD_SETTING_SCHEMA
      },
    };
	
	// í”„ë¡ì‹œ ì„œë²„ë¡œ ë³´ë‚¼ Payload (modelê³¼ Geminiìš© payloadë¥¼ ê°ìŒˆ)
    const requestBody = {
      model: modelName,
      payload: geminiPayload
    };


    try {
      const response = await fetchWithExponentialBackoff(proxyUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const result = await response.json();

      const jsonPart = result.candidates?.[0]?.content?.parts?.find(p => p.text)?.text;

      if (jsonPart) {
        const parsedJson = JSON.parse(jsonPart);
        aiGeneratedWorldSetting = parsedJson;
        renderAIWorldSettingForReview(aiGeneratedWorldSetting);
      } else {
        throw new Error("AI ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }

    } catch (error) {
      console.error("AI ì„¸ê³„ê´€ ìƒì„± ì˜¤ë¥˜:", error);
      showError(`AI ì„¸ê³„ê´€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
      aiGenerateBtn.disabled = false;
      aiGenerateBtn.textContent = 'AIë¡œ ì„¸ê³„ê´€ êµ¬ì„±í•˜ê¸°';
      showLoading(false);
    }
  }

  function renderAIWorldSettingForReview(world) {
    aiWorldReview.innerHTML = '';
    aiResultsContainer.classList.add('hidden');
    aiSaveBtn.disabled = true;

    if (!world || !world.title || !world.description) {
      aiWorldReview.innerHTML = '<p class="text-center text-red-500">AIê°€ ìœ íš¨í•œ ì„¸ê³„ê´€ ì •ë³´ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì œëª© ë˜ëŠ” ì„¤ëª… ëˆ„ë½)</p>';
      return;
    }

    const worldCard = document.createElement('div');
    worldCard.className = 'container-card p-4 border border-green-300 bg-green-50 shadow-md';

    worldCard.innerHTML = `
                <h3 class="text-xl font-bold text-gray-900 mb-2">${world.title} (AI ì œì•ˆ)</h3>
                <div class="mt-2 p-3 bg-white border border-green-100 rounded">
                    <p class="text-sm font-semibold text-gray-700 mb-1">ìƒì„¸ ì„¤ëª…:</p>
                    <p class="text-sm text-gray-600 whitespace-pre-wrap">${world.description}</p>
                </div>
                <p class="text-xs text-gray-500 mt-2">ì´ ì„¸ê³„ê´€ì„ í™•ì¸í•˜ê³  ë§ˆìŒì— ë“¤ë©´ 'DBì— ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.</p>
            `;

    aiWorldReview.appendChild(worldCard);
    aiResultsContainer.classList.remove('hidden');
    aiSaveBtn.disabled = false;
  }

  async function saveAIWorldSetting() {
    if (!aiGeneratedWorldSetting || !selectedSettingId) return;

    aiSaveBtn.disabled = true;
    aiSaveBtn.textContent = 'ì €ì¥ ì¤‘...';
    showLoading(true);
    hideError();

    try {
      const payload = {
        setting_id: selectedSettingId,
        title: aiGeneratedWorldSetting.title,
        description: aiGeneratedWorldSetting.description,
      };

      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/worldsettings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.status !== 201 && response.status !== 200) {
        throw new Error(`APIê°€ ì„¸ê³„ê´€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
      }

      // UI ì—…ë°ì´íŠ¸ ë° ì •ë¦¬
      aiGeneratedWorldSetting = null;
      aiResultsContainer.classList.add('hidden');
      aiPromptTextarea.value = '';

      // DB ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      fetchWorldSettings(selectedSettingId);

    } catch (error) {
      console.error("AI ì„¸ê³„ê´€ ì €ì¥ ì˜¤ë¥˜:", error);
      showError(`AI ì„¸ê³„ê´€ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      aiSaveBtn.disabled = false;
      aiSaveBtn.textContent = 'AI ì„¸ê³„ê´€ DBì— ì¶”ê°€';
      showLoading(false);
    }
  }

  // -----------------------------------------------------
  // ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
  // -----------------------------------------------------

  function initializeApp() {
    console.log("ì„¸ê³„ê´€ ê´€ë¦¬ ì•± ì´ˆê¸°í™” ì‹œì‘.");
    fetchSettings();
  }

  async function fetchSettings() {
    showLoading(true);
    hideError();

    try {
      // í”Œë¡¯ ì„¤ì • ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/settings-list`);
      const settings = await response.json();

      // ê¸°ì¡´ ì˜µì…˜ì„ ì œê±°í•˜ê³  ìƒˆ ì˜µì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
      Array.from(settingSelect.options).forEach((opt, index) => {
        if (index > 0) opt.remove();
      });

      if (settings && settings.length > 0) {
        settings.forEach(data => {
          const option = document.createElement('option');
          option.value = data.id;
          option.textContent = `${data.title} (ID: ${data.id}) - ì—í”¼ì†Œë“œ ${data.episode_number || 1}`;
          settingSelect.appendChild(option);
        });
        settingSelect.disabled = false;
      } else {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'ë“±ë¡ëœ í”Œë¡¯ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
        settingSelect.appendChild(option);
        settingSelect.disabled = true;
      }

    } catch (error) {
      console.error("ì„¤ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      showError(`ì„¤ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  /**
   * ì„ íƒëœ ì„¤ì • IDì— ë”°ë¼ ì„¸ê³„ê´€ ëª©ë¡ì„ í•œ ë²ˆë§Œ ë¡œë“œí•©ë‹ˆë‹¤. (í´ë§ ë¡œì§ ì œê±°)
   */
  function loadWorldSettings(settingId) {
    fetchWorldSettings(settingId);
  }

  async function fetchWorldSettings(settingId, showLoadingIndicator = true) {
    if (!settingId) return;

    if (showLoadingIndicator) {
      showLoading(true);
    }
    hideError();

    try {
      // ì„ íƒëœ setting_idì— ì—°ê²°ëœ ì„¸ê³„ê´€ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
      const url = `${apiBaseUrl}/worldsettings?setting_id=${settingId}`;
      const response = await fetchWithExponentialBackoff(url);
      const worldSettings = await response.json();

      currentWorldSettings = worldSettings; // ë°ì´í„°ë¥¼ ë¡œì»¬ ë³€ìˆ˜ì— ì €ì¥

      renderWorldSettings(worldSettings);

    } catch (error) {
      console.error("ì„¸ê³„ê´€ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
      showError(`ì„¸ê³„ê´€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (ID: ${settingId}): ${error.message}`);
    } finally {
      if (showLoadingIndicator) {
        showLoading(false);
      }
    }
  }

  /**
   * ì„¸ê³„ê´€ ë°ì´í„°ë¥¼ HTML ë¦¬ìŠ¤íŠ¸ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
   */
  function renderWorldSettings(worldSettings) {
    worldSettingsList.innerHTML = '';

    if (worldSettings.length === 0) {
      listPlaceholder.classList.remove('hidden');
      listPlaceholder.textContent = 'ì´ í”Œë¡¯ ì„¤ì •ì— ì—°ê²°ëœ ì„¸ê³„ê´€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”!';

      // ë””ë²„ê¹… ë¡œê·¸
      console.log(`[RENDER COMPLETE] ì„¸ê³„ê´€ ëª©ë¡ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. (ID ëª©ë¡: [])`);
      return;
    }
    listPlaceholder.classList.add('hidden');

    // ì´ì œ ì¸ë¼ì¸ í¸ì§‘ ë¡œì§ ì—†ì´, ëª¨ë“  í•­ëª©ì„ ë³´ê¸° ëª¨ë“œ ì¹´ë“œë¡œë§Œ ë Œë”ë§í•©ë‹ˆë‹¤.
    worldSettings.forEach(world => {
      worldSettingsList.appendChild(renderViewWorldCard(world));
    });

    // ë””ë²„ê¹… ë¡œê·¸ (ì¶”ê°€): í˜„ì¬ ë¡œì»¬ ë°ì´í„°ì˜ ID ëª©ë¡ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
    const renderedIds = worldSettings.map(w => w.id).join(', ');
    console.log(`[RENDER COMPLETE] ì„¸ê³„ê´€ ëª©ë¡ ${worldSettings.length}ê°œ ë Œë”ë§ ì™„ë£Œ. (ID ëª©ë¡: [${renderedIds}])`);
  }

  /**
   * ì„¸ê³„ê´€ ë°ì´í„°ë¥¼ ì¼ë°˜ ë³´ê¸° ëª¨ë“œ ì¹´ë“œë¡œ ë Œë”ë§í•©ë‹ˆë‹¤. (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í¬í•¨)
   */
  function renderViewWorldCard(world) {
    const worldCard = document.createElement('div');
    worldCard.id = `world-card-${world.id}`;
    worldCard.className = 'container-card p-4 border border-blue-100 bg-blue-50 hover:shadow-lg transition-shadow';

    worldCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold text-gray-900">${world.title}</h3>
                    <div class="flex space-x-2">
                        <!-- 'editWorldSetting' ëŒ€ì‹  ìƒˆë¡œìš´ í•¨ìˆ˜ 'openEditModal'ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. -->
                        <button onclick="openEditModal('${world.id}')"
                                class="text-sm text-blue-500 hover:text-blue-700 font-semibold p-1 rounded hover:bg-blue-100 transition-colors">
                            ìˆ˜ì •
                        </button>
                        <button onclick="deleteWorldSetting('${world.id}')"
                                class="text-sm text-red-500 hover:text-red-700 font-semibold p-1 rounded hover:bg-red-100 transition-colors">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
                <p class="text-sm font-medium text-blue-600 mt-1">ì„¸ê³„ê´€ ID: ${world.id}</p>
                <div class="mt-3 pt-2 border-t border-blue-200">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${world.description.substring(0, 200) || 'ìƒì„¸ ì„¤ëª… ì—†ìŒ'}</p>
                </div>
            `;
    return worldCard;
  }

  /**
   * ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ì–´ DELETE APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
   */
  async function deleteWorldSetting(id) {
    // ì»¤ìŠ¤í…€ ëª¨ë‹¬ì´ í•„ìš”í•˜ì§€ë§Œ ì„ì‹œë¡œ confirm() ìœ ì§€
    if (!confirm(`ì •ë§ë¡œ ID: ${id} ì¸ ì„¸ê³„ê´€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }

    hideError();
    showLoading(true);

    try {
      // DELETE /api/worldsettings/:id í˜¸ì¶œ
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/worldsettings/${id}`, {
        method: 'DELETE',
      });

      if (response.status !== 200) {
        const errorBody = await response.json();
        throw new Error(`APIê°€ ì„¸ê³„ê´€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status}, ë©”ì‹œì§€: ${errorBody.error || 'ì•Œ ìˆ˜ ì—†ìŒ'})`);
      }

      // ì„±ê³µ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      fetchWorldSettings(selectedSettingId);

    } catch (error) {
      console.error("ì„¸ê³„ê´€ ì‚­ì œ ì˜¤ë¥˜:", error);
      showError(`ì„¸ê³„ê´€ ì‚­ì œ ì‹¤íŒ¨ (ID: ${id}): ${error.message}`);
    } finally {
      showLoading(false);
    }
  }

  // -----------------------------------------------------
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  // -----------------------------------------------------

  // ì„¤ì • ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
  settingSelect.addEventListener('change', (e) => {
    selectedSettingId = e.target.value;
    selectedSettingIdSpan.textContent = selectedSettingId;
    listSettingIdSpan.textContent = selectedSettingId;
    addWorldBtn.disabled = !selectedSettingId; // ìˆ˜ë™ ì¶”ê°€ ë²„íŠ¼ í™œì„±í™”
    aiGenerateBtn.disabled = !selectedSettingId; // AI ë²„íŠ¼ í™œì„±í™”

    // ëª¨ë‹¬ ë° AI ê²°ê³¼ ì´ˆê¸°í™”
    closeModal();
    aiGeneratedWorldSetting = null;
    aiResultsContainer.classList.add('hidden');

    if (selectedSettingId) {
      // ë°ì´í„° í´ë§ ëŒ€ì‹ , ì„¤ì • ì„ íƒ ì‹œ í•œ ë²ˆë§Œ ëª©ë¡ì„ ë¡œë“œí•©ë‹ˆë‹¤.
      loadWorldSettings(selectedSettingId);
    } else {
      // ì„ íƒ í•´ì œ ì‹œ ëª©ë¡ ì´ˆê¸°í™”
      worldSettingsList.innerHTML = '';
      listPlaceholder.classList.remove('hidden');
      listPlaceholder.textContent = 'í”Œë¡¯ ì„¤ì •ì„ ì„ íƒí•˜ì‹œë©´ ì—°ê²°ëœ ì„¸ê³„ê´€ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
    }
  });

  // AI ì„¸ê³„ê´€ ìƒì„± í¼ ì œì¶œ
  aiWorldSettingForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!selectedSettingId) return;
    const prompt = aiPromptTextarea.value.trim();
    if (prompt) {
      generateWorldSettingAI(prompt);
    } else {
      showError("AI ìƒì„± ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    }
  });

  // AI ìƒì„± ì„¸ê³„ê´€ DB ì €ì¥
  aiSaveBtn.addEventListener('click', saveAIWorldSetting);


  // ìƒˆë¡œìš´ ì„¸ê³„ê´€ ìˆ˜ë™ ì¶”ê°€ í¼ ì œì¶œ ì´ë²¤íŠ¸
  addWorldSettingForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!selectedSettingId) return;

    const title = document.getElementById('world-title').value.trim();
    const description = document.getElementById('world-description').value.trim();

    if (!title) {
      showError("ì„¸ê³„ê´€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    hideError();

    addWorldBtn.disabled = true;
    addWorldBtn.textContent = 'ì¶”ê°€ ì¤‘...';

    try {
      const payload = {
        setting_id: selectedSettingId,
        title: title,
        description: description,
      };

      // ìƒˆë¡œìš´ ì„¸ê³„ê´€ì„ DBì— ì¶”ê°€ (POST /api/worldsettings)
      const response = await fetchWithExponentialBackoff(`${apiBaseUrl}/worldsettings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.status !== 201 && response.status !== 200) {
        throw new Error(`APIê°€ ì„¸ê³„ê´€ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
      }

      addWorldSettingForm.reset();
      // ì¶”ê°€ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      fetchWorldSettings(selectedSettingId);

    } catch (error) {
      console.error("ì„¸ê³„ê´€ ì¶”ê°€ ì˜¤ë¥˜:", error);
      showError(`ì„¸ê³„ê´€ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      addWorldBtn.disabled = false;
      addWorldBtn.textContent = 'ì„¸ê³„ê´€ ì¶”ê°€ ë° ì—°ê²°í•˜ê¸°';
    }
  });

  // ëª¨ë‹¬ í¼ ì œì¶œ ì´ë²¤íŠ¸: ì‹¤ì œ ì €ì¥ ë¡œì§ ì—°ê²°
  editWorldSettingForm.addEventListener('submit', (e) => {
    e.preventDefault();
    saveWorldSetting();
  });


  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
  window.openEditModal = openEditModal; // ìˆ˜ì •ëœ í•¨ìˆ˜ ë…¸ì¶œ (DB ì¡°íšŒ ë‹´ë‹¹)
  window.deleteWorldSetting = deleteWorldSetting;
  window.closeModal = closeModal; // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ ë…¸ì¶œ
  window.loadWorldSettings = loadWorldSettings; // ìƒˆ ë¡œì§ í•¨ìˆ˜ ë…¸ì¶œ

  // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
  initializeApp();

</script>
</body>
</html>